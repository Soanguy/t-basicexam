% macros=mkvi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \module
%D   [     file=t-basicexam,
%D      version=2024-10-24,
%D        title=basicexam,
%D     subtitle=Memoir Ever,
%D       author=商无辛(Shueng Mosan),
%D         date=2024-6-1,
%D    copyright=商无辛(Shueng Mosan),
%D      license=,
%D          url=]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\startmodule[basicexam]
\unprotect
%D \placecontent
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{模塊參數 / Module Setups / モジュール　セットアップ}

%D \starttabulate[|r|lB|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC mode=   \NC student \NC will show point and hide answer                \NC\NR
%D \NC mode=   \NC teacher \NC will show point and answer                     \NC\NR
%D \NC mode=   \NC check   \NC will show some infos to console                \NC\NR
%D \HL
%D \NC layout= \NC twoup   \NC print two virtual pages on each physical page. \NC\NR
%D \NC layout= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \NC footer= \NC default \NC show subject and page at footer                \NC\NR
%D \NC footer= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \stoptabulate

\setupmodule[mode=student,layout=default,footer=none]
% \doifnotmode{mkiv}{\writestatus{error}{needs luatex}\wait\end}% check context version

% 1 for module
% 2 for question
% 3 for papertitle
% 9 for font

\startinterface english
  \setinterfacemessage{basicexam}{1}{There are unknown parameters in --, please check.}
  \setinterfacemessage{basicexam}{2}{Question (--): answer is (--).}
  \setinterfacemessage{basicexam}{3}{You defined --, but you don't assign a value to it. Please check.}
  \setinterfacemessage{basicexam}{9}{-- is not installed, some -- will not display properly.}
\stopinterface

% \showmessage{basicexam}{2}{}%

\newif\iflay_twoup   \lay_twoupfalse
\newif\ifhdr_default \hdr_defaultfalse

\processallactionsinset[\currentmoduleparameter{mode}][
     teacher=>{\enablemode[teacher]},
     student=>{\enablemode[student]},
       check=>{\enablemode[check]},
  \v!default=>{\enablemode[student]},
  \v!unknown=>\showmessage{basicexam}{1}{mode},
]

\processallactionsinset[\currentmoduleparameter{layout}][
       twoup=>\lay_twouptrue,
        none=>\relax,
  \v!default=>\relax,
  \v!unknown=>\showmessage{basicexam}{1}{layout},
]

\processallactionsinset[\currentmoduleparameter{footer}][
        none=>{\relax},
  \v!default=>\hdr_defaulttrue,
  \v!unknown=>\showmessage{basicexam}{1}{footer},
]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 注意 ⚠️
%% 在定义命令时，参数后不可以直接断行，会导致参数查找失败。
%%（可能是因为 tex 认为参数后断行，则参数的结束分界符为断行，而非括号）
%% \def\foo#1{ .. some word ...}   \foo{..} 将正确运行
%% \def\foo#1
%%     { .. some word ...}         \foo{..} 将导致失败
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 注意 ⚠️
%% 在 lua 中使用 循环 等结构时，要注意 % 百分比符号的使用。不可以直接在关键字后
%% 使用。会导致运行出错：'do' expected near 'docontext' 等消息。
%% for i > 10 do % do 和 % 号之间有空格，  会正常运行
%% for i > 10 do%  do 和 % 号之间没有空格，会运行错误
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%\newcount\itindexn \itindexn=1
%%\def\itvariable{\ifcase\itindexn%
%%                       \or a\or b\or c\or d\or e%
%%                       \or f\or g\or h\or i\or j%
%%                       \or k\or l\or m\or n\or o%
%%                       \or p\or q\or r\or s\or t%
%%                       \or u\or v\or w\or x\or y\or z
%%                \fi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\begingroup
%\catcode`\%=12\relax
%\gdef\percentchar{%}
%\endgroup
%\ctxlua{context(string.format("\percentchar8s",456))}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{尚未處理的組合　/ Command under handling / 未完成のコマンド}

%D 設置頁面
%D 2UP Printing
%D \starttyping
%D \setuppapersize[user pagesize][real pagesize,real orientation]
%D \setuparranging[page arrange method]
%D more info : https://wiki.contextgarden.net/Command/setuparranging
%D             https://wiki.contextgarden.net/Imposition
%D \stoptyping
%D 例如：
%D \starttyping
%D \setuppapersize[A4][A3,landscape]
%D \setuparranging[2SIDE]%[2UP]
%D \setuppagenumbering[alternative=singlesided]%{doublesided}]
%D \stoptyping

\iflay_twoup
  \setuppapersize[A4][A3,landscape]
  \setuparranging[2SIDE]% 2SIDE start page at odd [2UP] start at even
  \setuppagenumbering[alternative={doublesided}]%singlesided]
\fi

%D \section{定义其后环境所需命令}

%D 定义关键词
\definesystemconstant{close}
\definesystemconstant{choice}
\definesystemconstant{answer}
\definesystemconstant{problem}
\definesystemconstant{question}
\definesystemconstant{material}
\definesystemconstant{optclose}

\startinterface all
\setinterfaceconstant {class}          {class}
\setinterfaceconstant {answer}         {answer}
\setinterfaceconstant {point}          {point}
\setinterfaceconstant {example}        {example}
\setinterfaceconstant {showanswer}     {showanswer}
\setinterfaceconstant {showpoint}      {showpoint}
\setinterfaceconstant {answerstyle}    {answerstyle}
\setinterfaceconstant {answercolor}    {answercolor}
\setinterfaceconstant {answerlabel}    {answerlabel}
\setinterfaceconstant {pointstyle}     {pointstyle}
\setinterfaceconstant {pointcolor}     {pointcolor}
\setinterfaceconstant {pointlabel}     {pointlabel}
\setinterfaceconstant {autoright}      {autoright}
\setinterfaceconstant {inlineleft}     {inlineleft}
\setinterfaceconstant {inlineright}    {inlineright}
\setinterfaceconstant {inlinechoice}   {inlinechoice}
\stopinterface
%D 安装定义命名空间和环境助手
\installnamespace          {close}
\installcommandhandler \????close     {close}     \????close
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifmode_quickcheck     \mode_quickcheckfalse
\newif\ifmode_check          \mode_checkfalse
\newif\ifmode_showanswer     \mode_showanswerfalse
\newif\ifmode_showpoint      \mode_showpointfalse
\newif\ifmode_showscript     \mode_showscriptfalse
\newif\ifmode_example        \mode_examplefalse
\newif\ifenv_question        \env_questionfalse
\newif\ifenv_problem         \env_problemfalse
\newif\ifenv_choice          \env_choicefalse
\newif\ifenv_material        \env_materialfalse
\newif\ifenv_close           \env_closefalse
\newif\ifenv_writing         \env_writingfalse
\newif\ifenv_subwriting      \env_subwritingfalse
\newif\ifenv_answer          \env_answerfalse
\newif\ifenv_toplevel        \env_topleveltrue
\newif\ifenv_botlevel        \env_botlevelfalse
\newif\ifitem_pitem          \item_pitemfalse
\newif\ifitem_fillin         \item_fillinfalse
\newif\ifitem_inlinechoice   \item_inlinechoicefalse
\newif\ifchoice_check        \choice_checkfalse
\newif\ifcontinue_counter    \continue_counterfalse
\newif\ifclose_counter_reset \close_counter_resetfalse

\newdimen\d_width_cit
\newdimen\d_width_cit_max
\newdimen\d_compared_maxwidth
\newdimen\d_maxwidth_with_label
\newcount\c_currentitemnumber% 封裝在 inititemnumber 和 incrementitemnumber 中
\newcount\c_totalitemnumber% 封裝在 recurseditemnumber 中
\newcount\c_steppoint% 封裝在 install_point 命令中
\newcount\c_steppoint_temp
\newcount\c_stepscore
\newcount\c_stepscore_temp
\newcount\c_closetest
\newcount\c_closetest_tempa
\newcount\c_example_question
\newcount\c_envcounter_toggle
\newcount\c_fillin_number
\newcount\current_total_choice_number% 當前選項 ABCD 總計數, 获取已经计算后的 totalitemnumber
\newcount\current_available_columns%可排版的最多列數
\newcount\parentitemnumber% \parentitemnumber 会等于父级列表环境的序号

\definecounter[Unicode][way=bychapter]
\definecounter[Unicode_toplevel]        % for level 1 : question or problem
\definecounter[Unicode_midlevel]        % for level 2 : problem or level 1
\definecounter[Unicode_botlevel]        % for level 3 : only for level 2
\definecounter[strc_close_counter]      % 为 close 环境可以继续 question 序号而设置

\def\inititemnumber{\c_currentitemnumber=0\relax\c_totalitemnumber=0\relax}
\def\incrementitemnumber{\global\advance\c_currentitemnumber by 1\relax}
\def\recurseditemnumber%%遞歸出總序號
  {\ifnum       \c_totalitemnumber > \c_currentitemnumber%
         \global\c_totalitemnumber = \c_totalitemnumber%
   \else \global\c_totalitemnumber = \numexpr\c_currentitemnumber\relax\fi}
%% 這三個命令可以遞歸小題總數，
%% 他們分別封裝在 set_envcounter, set_itemcount,installdatacollectorhelper 中
\def\save_question_order{\setcounter[strc_close_counter][\currentitemnumber]\savecounter[strc_close_counter]}
\def\restore_question_order{\restorecounter[strc_close_counter]}
\def\EQuestionID{E-\somenamedheadnumber{chapter}{current}-\number\c_example_question}
\def\QuestionID{\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}
\def\HelperID{\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]}
\def\increaseEQuestionID{\advance\c_example_question by  1\relax}
\def\decreaseEQuestionID{\advance\c_example_question by -1\relax}
\def\increaseQuestionID{\ifmode_example\increaseEQuestionID\else\incrementcounter[Unicode]\fi}
\def\decreaseQuestionID{\ifmode_example\decreaseEQuestionID\else\decrementcounter[Unicode]\fi}

\definetextbackground[env_answer]
\defineitemgroup     [env_question]
\defineitemgroup     [env_problem]
\defineitemgroup     [env_example]
\defineitemgroup     [env_choice]
\definebar           [fillin_text]
\definemarking       [title]
\definemarking       [subject]
\definedataset[Answer_collector]
\definedataset[Answer_collectorhelper]
\definedataset[Subwriting_collector]
\newwrite\examanswer

\def\exam_write_answer{%
  \immediate\openout\examanswer=\jobname -answer.txt\relax
  \immediate\write\examanswer{
    \QuestionID                \space\string @
    \currentenvironment        \space\string @
    \currentuserorder          \space\string @
    \pass_parameter_answer}%
 % \closeout\examanswer
}

\ifmode_check
  \immediate\openout\examanswer=\jobname -answer.txt\relax
  \immediate\write\examanswer{
    \string questionid  \space\string @
    \string environment \space\string @
    \string userorder   \space\string @
    \string answer}
\fi

\startuseMPgraphic{rules:under:wave}
    vardef lsin primary x =
        lua("mp.print(math.sin(" & decimal x & "))")
    enddef ;
    draw function(1, "x", "lsin(1.2*x)", 0, RuleWidth, .1pt)
         shifted (0,RuleFactor*RuleOffset+RuleDepth)
         withpen pencircle scaled RuleThickness
         withcolor RuleColor ;
    setbounds currentpicture to unitsquare xysized(RuleWidth,RuleHeight) ;
\stopuseMPgraphic

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% no need here
%\defineconversion [hiragana]      [あ,い,う,え,お,か,き,く,け,こ,さ,し,す,せ,そ,
%                                   た,ち,つ,て,と,な,に,ぬ,ね,の,は,ひ,ふ,へ,ほ,
%                                   ま,み,む,め,も,や,ゆ,よ,ら,り,る,れ,ろ,わ,ん]
%\defineconversion [katakana]      [ア,イ,ウ,エ,オ,カ,キ,ク,ケ,コ,サ,シ,ス,セ,ソ,
%                                   タ,チ,ツ,テ,ト,ナ,ニ,ヌ,ネ,ノ,ハ,ヒ,フ,ヘ,ホ,
%                                   マ,ミ,ム,メ,モ,ヤ,ユ,ヨ,ラ,リ,ル,レ,ロ,ワ,ン]
%\defineconversion [hiragana-iroha][い,ろ,は,に,ほ,へ,と,ち,り,ぬ,る,を,わ,か,よ,
%                                   た,れ,そ,つ,ね,な,ら,む,う,ゐ,の,お,く,や,ま,
%                                   け,ふ,こ,え,て,あ,さ,き,ゆ,め,み,し,ゑ,ひ,も,
%                                   せ,す,ん]
%\defineconversion [katakana-iroha][イ,ロ,ハ,ニ,ホ,ヘ,ト,チ,リ,ヌ,ル,ヲ,ワ,カ,ヨ,
%                                   タ,レ,ソ,ツ,ネ,ナ,ラ,ム,ウ,ヰ,ノ,オ,ク,ヤ,マ,
%                                   ケ,フ,コ,エ,テ,ア,サ,キ,ユ,メ,ミ,シ,ヱ,ヒ,モ,
%                                   セ,ス,ン]
%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ego=section isea=subsection
\definelabelclass [exam] [0]
\setuplabeltext   [cn]   [section={第,部分},subsection={第,节}]
\setupexamtext    [cn]   [point={分}, answer={答案:},  page={第,页},    totalpage={共,页}]
\setupexamtext    [hans] [point={分}, answer={答案:},  page={第,页},    totalpage={共,页}]% work with memos module
\setupexamtext    [hant] [point={分}, answer={答案:},  page={第,頁},    totalpage={共,頁}]% work with memos module
\setupexamtext    [en]   [point={pts},answer={answer:},page={pages},    totalpage={total,pages}]
\setupexamtext    [ja]   [point={点}, answer={答え:},  page={第,ページ},totalpage={共,ページ}]

\definehead [tu]   [chapter]
\definehead [ego]  [section]       % me  latin
\definehead [isea] [subsection]    % he or she latin
\definehead [heu]  [subsubsection] % och
\setuphead  [tu]   [placehead=empty]
\setuphead  [ego]  [sectionsegments=section,style=\ssa]
\setupheads [isea] [style=\hwa]
\setupheads [tu,ego,isea]
                   [indentnext=yes,align=flushleft,
                   before={\blank[quarterline]},
                   after={\blank[quarterline]},
                   sectionconversionset=examnum]
\definelist[tu]
\setuplist [tu][style={\feature[+][tabularnumbers]}]
\definestructureconversionset[examnum][chinesenumerals][chinesenumerals]

\ifhdr_default
  \definedelimitedtext    [paren]   [location=text]
  \setupdelimitedtext     [paren:1] [left={（\nobreak}, right={\nobreak）}]
  \setupdelimitedtext     [paren:2] [left={\,[~}, right={~]\,}]
  \setupdelimitedtext     [paren:3] [left={\,\{~}, right={~\}\,}]
  \setupmarking[subject][expansion=yes]
  \setupfooter [state=start]
  \startsetups hdr:infos
  \framed[height=max,align=lohi,frame=off]{%
    \getmarking[subject][page][current]
    \paren{\examtexts{page}{\pagenumber},\ %
           \examtexts{totalpage}{\lastpagenumber}}%
    }
  \stopsetups
  \setupfootertexts[\setups{hdr:infos}]
\fi

%%%%% setupinfos 设置试卷抬头信息和格式
%D \section{繪製卷頭 / print title / タイトルの作成}
%D
%D The following command simply shows how to define, set and draw a new test paper information.

%D \startitemize[nowhite,packed,joinedup]
%D \item 通過 \type{\definepapertitle[PaperTitleName]} 命令可以新建卷頭信息，
%D \item 通過  \type{\setuppapertitle[PaperTitleName]} 命令可以設定卷頭信息，
%D \item 通過   \type{\makepapertitle[PaperTitleName]} 命令可以繪製卷頭結果。
%D \stopitemize

%D \type{\definepapertitle} and \type{\setuppapertitle} accept one required and two optional parameters.
%D The first parameter is the name of the test paper.
%D The second parameter is the name of the parent test paper, which can be inherited by setting the parent.
%D The third parameter can directly set the relevant style and content.
%D The order can be set through ‘list’ parameters.
%D The default order is ‘secret, title, subject, information, notice’.

%D Once you've defined the {\bf list} parameter,
%D it will automatically expand the relevant parameters to define its style.
%D For example, if you define a {\bf title} parameter in the {\bf list},
%D it will automatically expand the following parameters:

%D \type{\setuppapertitle[list={title,and some other info}]}

%D \starttabulate[|r|l|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC title       \NC  titlealign   \NC \NC\NR
%D \NC titlestyle  \NC  beforetitle  \NC \NC\NR
%D \NC titlecolor  \NC  aftertitle   \NC \NC\NR
%D \HL
%D \stoptabulate

%D \startbuffer
%D  \definepapertitle[papertitles]
%D  \setuppapertitle [papertitles][
%D     list={secret,title,subject,information,notice},
%D     subjectsuffix=学科试卷,
%D     secretstyle=\ss,
%D     titlestyle=\ssa,
%D     subjectstyle=\ssb,
%D     informationstyle=\ttx,
%D     noticestyle=\rm\it,
%D     secretalign=flushleft,
%D     titlealign=center,
%D     subjectalign=center,
%D     informationalign=center,
%D     noticealign=flushleft,
%D     secret={绝密 ★ 启用前},
%D     title={2021 年普通高等学校招生全国统一考试},
%D     subject={日语},
%D     information={总分:150 分，考试时间:120 分钟},
%D     notice={注意事项：
%D       \startitemize[n,packed,joinedup]
%D         \item 答题前，务必将自己的姓名、准考证号填写在%
%D               答题卡规定的位置上。%
%D         \item 答选择题时，必须使用 2B 铅笔将答题卡上对%
%D               应题目的答案标号涂黑。如需改动，用橡皮擦%
%D               擦干净后，再选涂其它答案标号。答非选择题%
%D               时，必须使用 0.5 毫米黑色签字笔，将答案%
%D               书写在答题卡规定的位置上。所有題目必须在答%
%D               题卡上作答，在试题卷上答题无效。 %
%D         \item 考试结束后，将试题卷和答题卡一并交回。
%D         \stopitemize},
%D     ]
%D  \makepapertitle [papertitles]
%D  %If you want, you can also change the key value directly here.like
%D  % \makepapertitle [papertitles][title=new paper title]
%D \stopbuffer
%D \typebuffer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\installnamespace {papertitle}
\installnamespace {papertitlealternative}
\installnamespace {papertitlerenderings}

\installcommandhandler \????papertitle            {papertitle}            \????papertitle
\installcommandhandler \????papertitlealternative {papertitlealternative} \????papertitlealternative

\def\doifemptyelsex#1#2{\doifelse{#1}{}{#2}{#1}}
\def\definepapertitlevariable#1{\begingroup% #1=element name
    \parindent0pt\relax\par%
    \doifelse{\namedpapertitleparameter{\currentpapertitle}{#1align}}{}%
             {\setupalign[center]}%
             {\setupalign[\namedpapertitleparameter{\currentpapertitle}{#1align}]}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{before#1}}{}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1style}}{}%
    \expandafter\begincsname\namedpapertitleparameter{\currentpapertitle}{#1color}\endcsname
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1}}%
                   {\showmessage{basicexam}{3}{#1}}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{after#1}}{}%
    \par\endgroup}

\tolerant\def\makepapertitle[#1][#2]%
  {\begingroup\cdef\currentpapertitle{#1}%
  \ifarguments\or\or\setuppapertitle[#1][#2]\fi
  \edef\currentpapertitlealternative{\papertitleparameter\c!alternative}%
  \ifcsname\currentpapertitlealternativehash\s!parent\endcsname \else
    \let\currentpapertitlealternative\s!default
  \fi
  \usesetupsparameter\papertitleparameter
  \edef\p_renderingsetup{\papertitlealternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \marking[subject]{\papertitleparameter{subject}
                    \papertitleparameter{subjectsuffix}}
  \marking[title]{\papertitleparameter\c!title}
  \endgroup}

%D At the same time, you can define your own test paper title template through {\bf alternative}.
%D here is an example for default alternative.

\definepapertitlealternative
  [\s!default]
  [\c!renderingsetup=\????papertitlerenderings:\s!default]

\startsetups[\????papertitlerenderings:\s!default]
  \edef\currentlist{\papertitleparameter\c!list}
  \edef\currenttitle{\papertitleparameter\c!title}
  \expandafter\expandafter\expandafter\tu\expandafter{\currenttitle}
  \processcommacommand[\currentlist]\definepapertitlevariable
\stopsetups

\setuppapertitle [
  \c!alternative=\s!default,
  subjectsuffix=学科试卷,
  list={secret,title,subject,information,signinformation,notice},
  ]
\setuppapertitle [
    secretstyle=\ss,
    titlestyle=\ssa,
    subjectstyle=\ssb,
    informationstyle=\ttx,
    noticestyle=\rm\it,
    secretalign=flushleft,
    titlealign=center,
    subjectalign=center,
    informationalign=center,
    noticealign=flushleft,
    secret={绝密 ★ 启用前},
    title={\currentdate[year] 年普通高等学校招生全国统一考试},
    subject={英语},
    signinformation={{姓名:     }{\blackrule[width=4em,height=.2pt]}
                     {准考证号: }{\blackrule[width=4em,height=.2pt]}},
    information={全卷共12页，满分150分，考试时间120分钟。},
    notice={考生注意：
            \startitemize[n,packed,joinedup]
            \item 答题前，请务必将自己的姓名、准考证号用黑色字迹的签字笔
                  或钢笔分别填写在试题卷和答题纸规定的位置上。 %
            \item 答题时，请按照答题纸上“注意事项”的要求，在答题纸相应的
                  位置上规范作答，在本试题卷上的作答一律无效。 %
            \stopitemize},
]

\definepapertitle[newpaper]
%% #1 = newpapertitle #2 = setup elements of newpapertitle
%% \makepapertitle[newpaper][title=OOOOOOO]
%% quickly get elements at header and footer:
%% \getmarking[title][page][first] :: \getmarking[title][current]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设定一些可能用得到的符号 / Symbol Defination / シンボルの定義}

\doifelsefontpresent{NotoSansSymbols2-Regular}{}{
  \showmessage{basicexam}{9}{NotoSansSymbols2 font,symbol}}
\definefontsynonym[NotoSansSymbols2][file:NotoSansSymbols2-Regular]
\def\notosymb#1{\getglyphstyled{NotoSansSymbols2}{\tochar{n:#1}}}

\definesymbol[marksquare]          [\notosymb{☐}]
\definesymbol[markcircle]          [\notosymb{○}]
\definesymbol[marknotcheck]        [\notosymb{⍻}]
\definesymbol[markcheck]           [\notosymb{🗸}]
\definesymbol[markheavycheck]      [\notosymb{✓}]
\definesymbol[marksquarecheck]     [\notosymb{\rlap{☐}\,\raise.2em\hbox{🗸}}]
\definesymbol[marksquareheavycheck][\notosymb{\rlap{☐}\,\raise.2em\hbox{✓}}]
\definesymbol[markcirclecheck]     [\notosymb{\rlap{○}\,\raise.2em\hbox{🗸}}]
\definesymbol[markcircleheavycheck][\notosymb{\rlap{○}\,\raise.2em\hbox{✓}}]
\definesymbol[markcross]           [\notosymb{✗}]
\definesymbol[markheavycross]      [\notosymb{✘}]
\definesymbol[marksquarecross]     [\notosymb{\rlap{☐}\,\raise.1em\hbox{✗}}]
\definesymbol[marksquareheavycross][\notosymb{\rlap{☐}\,\raise.1em\hbox{✘}}]
\definesymbol[markcirclecross]     [\notosymb{\rlap{○}\,\raise.1em\hbox{✗}}]
\definesymbol[markcircleheavycross][\notosymb{\rlap{○}\,\raise.1em\hbox{✘}}]

%D It is important to note that these symbols require
%D the font {\bf NotoSansSymbols2} to be pre-installed.
%D
%D \starttabulate[|l|r|l|r|]
%D \NC \type{\symbol{marksquare}}           \NC \symbol{marksquare}
%D \VL \type{\symbol{markcircle}}           \NC \symbol{markcircle}          \NC\NR\HL
%D \NC \type{\symbol{markcheck}}            \NC \symbol{markcheck}
%D \VL \type{\symbol{markcross}}            \NC \symbol{markcross}           \NC\NR
%D \NC \type{\symbol{markheavycheck}}       \NC \symbol{markheavycheck}
%D \VL \type{\symbol{markheavycross}}       \NC \symbol{markheavycross}      \NC\NR
%D \NC \type{\symbol{marksquarecheck}}      \NC \symbol{marksquarecheck}
%D \VL \type{\symbol{marksquarecross}}      \NC \symbol{marksquarecross}     \NC\NR
%D \NC \type{\symbol{marksquareheavycheck}} \NC \symbol{marksquareheavycheck}
%D \VL \type{\symbol{marksquareheavycross}} \NC \symbol{marksquareheavycross}\NC\NR
%D \NC \type{\symbol{markcirclecheck}}      \NC \symbol{markcirclecheck}
%D \VL \type{\symbol{markcirclecross}}      \NC \symbol{markcirclecross}     \NC\NR
%D \NC \type{\symbol{markcircleheavycheck}} \NC \symbol{markcircleheavycheck}
%D \VL \type{\symbol{markcircleheavycross}} \NC \symbol{markcircleheavycross}\NC\NR
%D \NC \type{\symbol{marknotcheck}}         \NC \symbol{marknotcheck}
%D \VL                                      \NC                              \NC\NR
%D \stoptabulate

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\choice_answerstatus        {\datasetvariable{Choice_collector}{\QuestionID}{answerstatus}}
\def\point_totalpoint           {\datasetvariable{Answer_collector}{\QuestionID}{totalpoint}}
\def\point_point                {\datasetvariable{Answer_collector}{\QuestionID}{point}}
\def\currentavailablecolumns    {}
\def\currentrealavailablecolumns{}
\def\currentitemmaxwidth        {}
\def\currentanswerstatus        {}
\def\example_mode{\ifmode_example NOTICE: MODE EXAMPLE IS ON !\fi}
\def\level_status{\ifenv_toplevel <env_toplevel>\else%
                  \ifenv_botlevel <env_botlevel>\else%
                                  <env_midlevel>\fi\fi}

\def\mode_status{\ifmode_check      <M:C>\fi%check
                 \ifmode_showanswer <M:A>\fi%answer
                 \ifmode_showpoint  <M:P>\fi%point
                 \ifmode_example    <M:E>\fi}

\startluacode
  local report = logs.reporter("question info")

  local function center_text(text, total_width)
      local text_length = #text
      local left_padding = math.floor((total_width - text_length) / 2)
      local right_padding = total_width - left_padding - text_length
      return string.rep(' ', left_padding) .. text .. string.rep(' ', right_padding)
  end

  local function center_report(centerinfos)
      for _, row in ipairs(centerinfos) do
          local centered_line = center_text(row, 60)
          report(centered_line)
      end
  end

  local lines = {
      "NOTICE: MODE CHECK   IS ON !",
      "Notice,Cinfos only show choice env information",
      "CU means 'current' , if CUuserorder ≠ CUorder,",
      "It maybe because START parameter is enabled.  ",
      "Notice,MODE EXAMPLE wont provide data infos   "
  }

  function formatted_report(data)
    -- 定义格式化字符串，加入竖线作为分隔符
    local format_str = "%15s  %-20s  %15s  %-20s"

    report("----------------------------------------------------------------")
    center_report(lines,60)

    -- 输出数据
    for _, row in ipairs(data) do
        report(format_str:format(row[1], row[2], row[3], row[4]))
    end
    report("----------------------------------------------------------------")
  end
\stopluacode

\def\check_info{
      {"","\example_mode","",""},
      {"Name         ", "Content                                                             ",
       "Cinfos       ", "Content                                                             "},
      {"CUitemgroup  ", "\datasetvariable{Answer_collector}{\QuestionID}{envid}              ",
       "CUparen      ", "\currentparentitemgroup                                             "},
      {"QuestionID   ", "\QuestionID                                                         ",
       "HelperID     ", "\HelperID                                                           "},
      {"order        ", "\currentorder                                                       ",
       "userorder    ", "\currentuserorder                                                   "},
      {"point        ", "\datasetvariable{Answer_collector}    {\QuestionID}{point}          ",
       "             ", "                                                                    "},
      {"totalnumber  ", "\datasetvariable{Answer_collector}    {\QuestionID}{totalnumber}    ",
       "Htotalnumber ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}"},
      {"totalpoint   ", "\datasetvariable{Answer_collector}    {\QuestionID}{totalpoint}     ",
       "Htotalpoint  ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{totalpoint}     "},
      {"CUCmaxwidth  ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{itemmaxwidth}   ",
       "Cavailable   ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns} &
                         \datasetvariable{Answer_collectorhelper}{\HelperID}{realavailablecolumns}"},
      {"answer       ", "\datasetvariable{Answer_collector}    {\QuestionID}{answer}         ",
       "             ", "                                                                    "},
      {"Hanswer      ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{answer}         ",
       "             ", "                                                                    "},
      {"mode.status  ", "\mode_status                                                        ",
       "level.check  ", "\level_status                                                       "},
      {"Canswerstatus", "\choice_answerstatus                                                ",
       "             ", "                                                                    "},
}

\def\show_check_info#1%
 {\begingroup
  \ifmode_check%
    \ifdefined\currentorder%
      \let\old_currentorder\currentorder
      \let\old_currentorder\currentuserorder
    \else%
      \def\currentorder{    {\ttx currentorder didn't define}}
      \def\currentuserorder{{\ttx currentorder didn't define}}
    \fi%
    \directlua{formatted_report({#1})}
  \fi
  \endgroup}

\def\dimtonum #1{\number\numexpr \dimexpr #1\relax*635/65536\relax }
\newcount\cnt_floor
\def\floor#1{\floorhelper#1.\relax}
\def\floorhelper#1.#2\relax{\ifx\relax#2\relax#1%
    \else\if.#2#1\else\floorhelphelper{#1}#2\fi\fi}
\def\floorhelphelper#1#2.{\ifnum#2>0%
    \floorhelphelphelper#1\relax\relax\relax\else#1\fi}
\def\floorhelphelphelper#1#2\relax{%
  \if-#1\relax-\cnt_floor=0#2\relax%
  \advance\cnt_floor by 1\relax%
  \number\cnt_floor\relax%
  \else\cnt_floor=0#1#2\relax%
  \number\cnt_floor\relax\fi%
}

\def\initcollectanswer{\directlua{MultiAnswerCollector = {}}}
\def\collectanswer#1{\directlua{table.insert(MultiAnswerCollector, [[#1]])}}
\def\collectedanswer{\directlua{tex.sprint(table.concat(MultiAnswerCollector,","))}}

\def\set_envitem_counter{%
  \ifdefined\currentenvnumber
    \edef\prevenvnumber{\currentenvnumber}%
  \fi\initcollectanswer% 初始化多项答案收集器
  \ifenv_answer    \advance\c_envcounter_toggle by 10\relax\else
                    \global\c_envcounter_toggle=0\relax%
  \ifenv_question   \global\c_envcounter_toggle=1\relax \edef\currentenvironment  {question}\fi
  \ifenv_problem    \global\c_envcounter_toggle=2\relax \edef\currentenvironment   {problem}\fi
  \ifenv_choice     \global\c_envcounter_toggle=3\relax \edef\currentenvironment    {choice}\fi
  \ifenv_material   \global\c_envcounter_toggle=4\relax \edef\currentenvironment  {material}\fi
  \ifenv_close      \global\c_envcounter_toggle=5\relax \edef\currentenvironment     {close}\fi
  \ifenv_writing    \global\c_envcounter_toggle=6\relax \edef\currentenvironment   {writing}\fi
  \ifenv_subwriting \global\c_envcounter_toggle=7\relax \edef\currentenvironment{subwriting}\fi
  \fi
  \doif{\csname \currentenvironment parameter\endcsname\c!example}{true}% 专用于测试是否开启了 example mode
       {\mode_exampletrue\global\c_envcounter_toggle=999\relax}
  \edef\currentenvnumber{\the\c_envcounter_toggle}}

%% 注意，只要某个条件不关闭，他就会一直开启。例如：
% {\env_topleveltrue
%    1. \ifenv_toplevel top \else bot \fi  % top
%    \env_toplevelfalse\env_botleveltrue   % 关闭了 toplevel 才能正确输出
%    2. \ifenv_toplevel top \else bot \fi  % bot
%    3. \ifenv_botlevel bot \else top \fi} % bot
% 一定要关闭，因为默认并没有设置 top 和 bot 的二元关系。
% 所以即便是专门测试 bot 是否开启的 3 ，
% 也只会在关闭 top 的情况下获取正确的结果。

\def\current_user_order#1{% get user order which can by changed by START
    \number\csname #1order\endcsname% 獲得的結果類似於 2(4)
    \ifnum\rawcountervalue[Unicode_botlevel]=0\else%
    (\rawcountervalue[Unicode_botlevel])\fi}

\def\set_currentuserorder[#1]{% set order that user setted
  \ifcsname #1order\endcsname\else
    \expandafter\newcount\csname #1order\endcsname\fi
  \ifenv_toplevel\csname #1order\endcsname=\currentitemnumber
            \else\csname #1order\endcsname=\parentitemnumber \fi
  \edef\currentid{\QuestionID}%
  \edef\currentorder{% get unique order ( no chapter number )
    \somenamedheadnumber{chapter}{current}-%
    \rawcountervalue[Unicode_toplevel]-%
    \rawcountervalue[Unicode_midlevel]-%
    \rawcountervalue[Unicode_botlevel]}%
  \edef\currentuserorder{\current_user_order{#1}}%获取 上面定义的 #1order
  \expandafter\show_check_info{\check_info}%
% % ==  \currentid ++ \currentorder @@ \currentorder
}%专为子级设计来获取父级序号，否则直接获取当前序号

\tolerant\def\set_count_envlevel[#1]{% #1 定義 #2order
% 如果 cur = prev， 說明已經有了上層環境， 判定為 中層環境，
% 如果 prev 未被定義， 說明沒有上層環境， 判定為  上層環境
  \setcounter[Unicode_midlevel][0]%
  \setcounter[Unicode_botlevel][0]%
  \ifdefined\prevenvnumber
    \ifx\currentenvnumber\prevenvnumber
        \env_topleveltrue \incrementcounter[Unicode_toplevel]%
   \else\env_toplevelfalse\incrementcounter[Unicode_midlevel]\fi
   \else\env_topleveltrue \incrementcounter[Unicode_toplevel]\fi
  \parentitemnumber=\currentitemnumber\relax
  \set_currentuserorder[#1]% 创建 #2order 以备使用
  \inititemnumber%初始化子題目計數器
}

\tolerant\def\set_count_itemlevel[#1]{%
  \env_toplevelfalse
  \ifdefined\prevenvnumber
    \ifx\currentenvnumber\prevenvnumber
        \env_botlevelfalse\incrementcounter[Unicode_midlevel]\else
        \env_botleveltrue \incrementcounter[Unicode_botlevel]\fi
   \else\env_botlevelfalse\incrementcounter[Unicode_midlevel]%
  \fi\ifenv_subwriting\env_botleveltrue\fi
  \set_currentuserorder[#1]%
  \incrementitemnumber%增長子題目計數器
}

%%% id        由 章節號 + 題號 組成，題號在每一章節中重新從 1 計數
%%% envid     當前列表名稱和層數
%%% order     當前子題號，例如 第一題 ： 1 第六題第三小題 ： 6(3)
%%% userorder 當前列表序號(可獲取被start更改後的序號)

\def\installdatacollector%
  {\writestatus{basicexam}{Question (\currentuserorder): answer is (\currentanswer).}%顯示題號和答案到控制檯
  \ifmode_check\exam_write_answer\fi
  \setdataset [Answer_collector][\QuestionID]%收集答案並在未來展開
              [id={\QuestionID},%
                envid={\currentenvironment : \the\c_envcounter_toggle : \currentitemgroup},%
                order={\number\currentorder},%
                userorder={\currentuserorder},%
                answer={\pass_parameter_answer},%
                point={\currentpoint},%
                totalnumber={\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}},%
                totalpoint={\datasetvariable {Answer_collectorhelper}{\HelperID}{totalpoint}},]}

\protected\def\installdatacollectorhelper{%
  \recurseditemnumber%
  \setdataset [Answer_collectorhelper][\HelperID]%收集信息並在未來展開
              [totalitemnumber={\the\c_totalitemnumber},
               totalpoint={\currenttotalpoint},
               availablecolumns={\currentavailablecolumns},
               realavailablecolumns={\currentrealavailablecolumns},
               itemmaxwidth={\currentitemmaxwidth},
               answer={\currentanswer},
               answerstatus={\check_choice_answerstatus},
              ]%
}

% 环境层级一览
% question 环境                 % close 环境                      % material 环境
%    choice 环境                %       closechoice 项目    ⭕    % question 环境
%       citem 项目        ⭕    % optclose 环境                   %    choice 环境
%    problem 环境               %       ocitem 项目         ⭕    %       citem 项目    ⭕
%       pitem 项目        ⭕    %       specialocitem 项目  ⭕
%         fillin 项目     ⭕
% ======================================================================================
% writing 环境            ⭕
%     subwriting 环境
%

% 获取当前环境的答案，并传递给最终的 answer dataset
\def\pass_parameter_answer{%
  \ifenv_writing\short_writing_answer\else
    \ifempty\currentanswer there is no answer setted.\else
  \currentanswer\fi\fi}

\def\check_choice_answerstatus{\ifchoice_check checked!\else%
    unchecked!please set the answer manually by add [*] parameter to citem command.\fi}

\def\paren#1{(#1)}

\protected\def\install_point[#1]{%
  \edef\p_showpoint{\csname #1parameter\endcsname{showpoint}}%
  \ifempty\p_showpoint\else
    \ifx\p_showpoint\s!true\mode_showpointtrue
    \else\mode_showpointfalse
  \fi\fi
  \ifx\currentmode\c!point
    \ifdefined\currentpoint\edef\prevpoint{\currentpoint}\fi
    \edef\p_point{\csname #1parameter\endcsname\c!point}%暫時定義
    \ifempty\p_point
      \ifenv_toplevel% 當處於頂層時， 由於 prev 也未定義， 會拋出錯誤
      \edef\currentpoint{0}\else% 因此， 直接賦值未 0
      \edef\currentpoint{\prevpoint}\fi
    \else%
      \ifenv_subwriting
        \edef\currentpoint{\namedwritingparameter{subwriting}\c!point}%
      \else
        \edef\currentpoint{\csname #1parameter\endcsname\c!point}%
      \fi
    \fi
    \ifempty\currentpoint% 抓取當前分數值
      \scratchcounter\zerocount
    \else
      \scratchcounter\currentpoint
    \fi
    \ifenv_toplevel% 重置分數計算
      \c_steppoint\zerocount
      \c_steppoint_temp\zerocount
    \fi
    \global\c_steppoint_temp\scratchcounter
    \ifnum\c_steppoint=0
      \global\c_steppoint=\c_steppoint_temp
    \else%
      \global\c_steppoint=\numexpr\c_steppoint+\c_steppoint_temp\relax
    \fi% 遞歸出總分數
    \ifenv_toplevel% 如果有子題目， 不應當 計算 question 本身的分值, 但這似乎增加了編譯次數
      \edef\p_totalitemnumber{\datasetvariable{Answer_collector}{\QuestionID}{totalnumber}}%
      \doifelsesomething{\p_totalitemnumber}{\scratchcounter\p_totalitemnumber}{\scratchcounter\zerocount}%
      \writestatus{question info}{currentsteppoint is \the\c_steppoint ::\the\c_steppoint_temp}%
      % 不知道為什麼， 但增加輸出 steppoint 可以獲取正確的最終計數。
      \ifnum\scratchcounter>1\global\c_steppoint=\numexpr\c_steppoint-\c_steppoint_temp\relax\fi
      \xdef\currenttotalpoint{\number\currentpoint}%
    \else%
      \xdef\currenttotalpoint{\number\c_steppoint}%
    \fi%
  \fi
}

\def\install_answer[#1]{%
  \edef\p_showanswer{\csname  #1parameter\endcsname\c!showanswer}%
  \ifempty\p_showanswer\else
    \ifx\p_showanswer\s!true
           \mode_showanswertrue
      \else\mode_showanswerfalse
  \fi\fi
  \ifx\currentmode\c!answer
    \ifdefined\currentanswer\edef\prevanswer{\currentanswer}\fi
    \edef\p_answer{\csname #1parameter\endcsname\c!answer}%暫時定義
    \ifenv_subwriting\edef\p_answer{\writingparameter\c!answer}\fi
    \ifempty\p_answer
      \edef\currentanswer{\prevanswer}%
    \else%
      \edef\currentanswer{\csname #1parameter\endcsname\c!answer}%
      \ifdefined\prevanswer
        \ifempty\prevanswer\else
          \ifx\currentanswer\prevanswer\relax\else
            \writestatus{question info}{%
              \currentuserorder     : Two conflicting answers have been detected,
                                      check and delete unnecessary answers.}%
            \writestatus{question info}{%
              \string\prevanswer    : \prevanswer .
              \string\currentanswer : \currentanswer .}%
          \fi
        \fi
      \fi
    \fi
  \fi}

\tolerant\protected\def\show_pointoranswer_text[#1]#*[#2]{{
  \unskip\csname #1parameter\endcsname{#2style}%
  \switchtocolor[\csname #1parameter\endcsname{#2color}]%
  \paren {\csname left_assigned#2label\endcsname % like=>answer : blabla
    \ifx\currentmode\c!point% if #2 = point
      \ifenv_toplevel
        \point_totalpoint
      \else
        \ifenv_answer\point_point\else
        \currentpoint\fi
      \fi
    \else% if #2 = answer。因为 currentXXXanswer 是有定义内容的，
      \ifmode_example You're in EXAMPLE MODE!\else
        \ifenv_writing\short_writing_answer\else
        \datasetvariable{Answer_collector}{\QuestionID}{answer}\fi
      \fi% 直接獲取當前 QID 答案
    \fi
  \csname right_assigned#2label\endcsname}}}

\def\p_assigned_currentlabel#1#2{%
  \expandafter\edef%
    \csname p_current#1#2label%
      \expandafter\expandafter%
        \expandafter\endcsname%
          \expandafter\expandafter%
            \expandafter{%
              \csname #1parameter\endcsname{#2label}}}

\def\p_pass_currentlabel[#1]{\p_assign_currentlabel[#1,,]}
\def\p_assign_currentlabel[#1,#2,#3]#4%
 {\expandafter\def\csname  left_assigned#4label\endcsname {#1}%
  \expandafter\def\csname right_assigned#4label\endcsname {#2}}

\tolerant\protected\def\installpointoranswer[#1]#*[#2]{%#1 parameter %#2 modename
  \edef\currentmode{#2}% check point or answer
  \install_point[#1]%
  \install_answer[#1]%
  \p_assigned_currentlabel{#1}{#2}%
  \expandafter\expandafter%
    \expandafter\p_pass_currentlabel%
      \expandafter\expandafter%
        \expandafter[%
            \csname p_current#1#2label\endcsname]{#2}%
  \begingroup
  \csname ifmode_show#2\endcsname
    \show_pointoranswer_text[#1][#2]%
  \fi
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion[tnum][\addff{tabularnumbers}]
\protected\def\installitemgroupoption[#1][#2]{%
  \setupitemgroup[env_#1][each][
                                    \c!margin={\csname #2parameter\endcsname\c!margin},%
                                \c!leftmargin={\csname #2parameter\endcsname\c!leftmargin},%
                               \c!rightmargin={\csname #2parameter\endcsname\c!rightmargin},%
                        \c!leftmargindistance={\csname #2parameter\endcsname\c!leftmargindistance},%
                       \c!rightmargindistance={\csname #2parameter\endcsname\c!rightmargindistance},%
                                \c!indentnext={\csname #2parameter\endcsname\c!indentnext},%
                                     \c!width={\csname #2parameter\endcsname\c!width},%
                                    \c!factor={\csname #2parameter\endcsname\c!factor},%
                                  \c!distance={\csname #2parameter\endcsname\c!distance},%
                                      \c!step={\csname #2parameter\endcsname\c!step},%
                                     \c!align={\csname #2parameter\endcsname\c!align},%
                                  \c!symalign={\csname #2parameter\endcsname\c!symalign},%
                                     \c!color={\csname #2parameter\endcsname\c!color},%
                                 \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                                     \c!style={\csname #2parameter\endcsname\c!style},%
                                  \c!marstyle={\csname #2parameter\endcsname\c!marstyle},%
                                  \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
                                 \c!headstyle={\csname #2parameter\endcsname\c!headstyle},%
                                  \c!marcolor={\csname #2parameter\endcsname\c!marcolor},%
                                  \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
                                 \c!headcolor={\csname #2parameter\endcsname\c!headcolor},%
                                \c!beforehead={\csname #2parameter\endcsname\c!beforehead},%
                                  \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
                                  \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
                                 \c!afterhead={\csname #2parameter\endcsname\c!afterhead},%
                                    \c!before={\csname #2parameter\endcsname\c!before},%
                                 \c!inbetween={\csname #2parameter\endcsname\c!inbetween},%
                                     \c!after={\csname #2parameter\endcsname\c!after},%
                                   \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                              \c!placestopper={\csname #2parameter\endcsname\c!placestopper},%
                                   \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                                     \c!inner={\csname #2parameter\endcsname\c!inner},%
                                         \c!n={\csname #2parameter\endcsname\c!n},%
                                     \c!items={\csname #2parameter\endcsname\c!items},%
                                    \c!levels={\csname #2parameter\endcsname\c!levels},%
                                  \c!lefttext={\csname #2parameter\endcsname\c!lefttext},%
                                 \c!righttext={\csname #2parameter\endcsname\c!righttext},%
                                      \c!left={\csname #2parameter\endcsname\c!left},%
                                     \c!right={\csname #2parameter\endcsname\c!right},%
                             \c!packcriterium={\csname #2parameter\endcsname\c!packcriterium},%
                                 \c!criterium={\csname #2parameter\endcsname\c!criterium},%
                              \c!textdistance={\csname #2parameter\endcsname\c!textdistance},%
                         \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
                         \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
                                   \c!command={\csname #2parameter\endcsname\c!command},%
                                 \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                               \c!alignsymbol={\csname #2parameter\endcsname\c!alignsymbol},%
                                    \c!symbol={\csname #2parameter\endcsname\c!symbol},%
                                    \c!option={\csname #2parameter\endcsname\c!option},%
                                  %  \c!start={\csname #2parameter\endcsname\c!start},%
                                     \c!start={\csname #2parameter\endcsname\c!start},%
                                     \c!state={\csname #2parameter\endcsname\c!state},% % beware, "" == start
                                       \c!way={\csname #2parameter\endcsname\c!way},% % wont work if continue on
                                    \c!prefix={\csname #2parameter\endcsname\c!prefix},%
                        \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
                          \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
                       \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
                             \c!prefixstarter={\csname #2parameter\endcsname\c!prefixstarter},%
                             \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
                                 \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                            \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
                                 \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                           \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
                        \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
                          \c!numberconversion={\csname #2parameter\endcsname\c!numberconversion},%
                       \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
                             \c!numberstarter={\csname #2parameter\endcsname\c!numberstarter},%
                             \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
                            \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
                      %               \c!prefix={\csname #2parameter\endcsname\c!prefix},%
                      %        \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
                      %   \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
                      %     \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
                      %  \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
                      %            \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                      %       \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
                      %      \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
                      %   \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
                      %  \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
                            %  \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
                            % \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
                           ]%
}

\protected\def\installcounteroption[#1][#2]{%
  \cdef\currentenv_counter{\v_strc_itemgroups_counter}%
}

%D \section{设置 question 环境}

%D The \tex{question} environment command can be used to set the stem.
%D Simply wrap the stem between the \tex{startquestion} \tex{stopquestion} commands.
%D At the same time, we have defined a short command \tex{question},
%D which is used as a synonym for \tex{startquestion} \tex{stopquestion}
%D
%D \startbuffer
%D   \startquestion
%D     The environment is located in: \currentitemgroup 。
%D   \stopquestion
%D   \startquestion
%D     The environment is located in: \currentitemgroup 。
%D   \stopquestion
%D   \question {The environment is located in: \currentitemgroup 。}
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The \tex{question} environment command inherits the option settings for
%D the \tex{itemgroup} environment. Therefore, you can modify the environment
%D using \tex{setupquestion} in the same way you modify \tex{itemgroup}.
%D
%D \bgroup
%D   \startbuffer
%D     \setupquestion[color=green,style=\ss,start=22,
%D                    option={n,packed,joinedup,nowhite,}]
%D     \startquestion
%D       The environment is located in: \currentitemgroup 。
%D     \stopquestion
%D   \stopbuffer
%D   \typebuffer
%D   \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D \egroup

%D question 环境可以设置 {\bf 答案} 和 {\bf 分值}。该键值详细的设置如下：
%D \starttabulate[|l|l|l|l|]
%D \NC showanswer \NC answer \NC answerstyle    \NC answercolor \NC\NR
%D \NC            \NC        \NC answerlabel    \NC answerlabel \NC\NR\HL
%D \NC showpoint  \NC point  \NC pointstyle     \NC pointcolor  \NC\NR
%D \NC            \NC        \NC pointprelabel  \NC pointlabel  \NC\NR
%D \stoptabulate

%D \startbuffer
%D   \setupquestion[start=1,option={n,packed,joinedup,nowhite,}]
%D   \startquestion[showpoint=true,point=5,pointlabel={points},
%D                  showanswer=true,answer={new answer},answerstyle={\tt},]
%D     The environment is located in: \currentitemgroup 。
%D   \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D 此外，question 设置了一个特殊的键值 example=true，可以是当前题目不被录入答案。
%D 在(v20241023)中，通过不太正常的方式设置了 example 后的题目可以自动重置回到序数 1。
%D 或许，可以设置一个新的键值，来设定 example 之后的题目是重置为 1 还是接续上一个序号。
%D 此外，由于 question 内置了一个 item， 因此可以使用 reference 来创建引用。

%D {\bf 關於 point 和 answer 的設定: }
%D point 的分值默認是一整個題目的總分數。如果當前字環境為 problem，只要為每個 pitem
%D 設計了 point 的分值，該模塊就會自動計算。answer 的獲取也是一樣。在設計時，
%D pitem 默認是擁有多個同級項目的。也就是說，會在同一個 question 環境中，有多個子答案。
%D 我們無法獲知應該使用哪一個作為當前環境的答案。同樣的道理，每個 question 環境內只有一個
%D choice 環境，只需要直接為 question 環境配置分值即可。choice 環境並不能配置分數。

\installnamespace          {question}
\installcommandhandler \????question  {question}  \????question

\appendtoks
  \setuevalue        {\currentquestion}{\directnamedquestion[\currentquestion]}%
  \setuevalue{\e!start\currentquestion}{\startnamedquestion [\currentquestion]}%
  \setuevalue{\e!stop \currentquestion}{\stopnamedquestion}%
\to \everydefinequestion

\tolerant\protected\def\directnamedquestion[#S#1]#*[#S#2]{%
  \groupedcommand{\startnamedquestion[#1][#2]}%
                 {\stopnamedquestion}}

\tolerant\protected\def\startnamedquestion[#S#1]#*[#S#2]%
 {\begingroup
  \scratchcounterone\currentitemnumber\relax
% 因為 setcountlevel 用到了 scratchcounter,這裡使用新的計數器抓取命令
  \def\currentquestion{#1}\setupcurrentquestion[#2]%
  \edef\p_class{\questionparameter\c!class}%
  \edef\p_start{\questionparameter\c!start}%
  \edef\p_reset{\questionparameter\c!reset}%
  \edef\p_option{\questionparameter\c!option}%
  \edef\p_defaultoption{n,packed,nowhite,joinedup,continue}%
  \ifx\p_class\s!question
    \env_questiontrue\set_envitem_counter\fi
  \ifx\p_class\s!problem
    \env_problemtrue \set_envitem_counter\fi
  \ifx\p_class\s!optclose
    \env_closetrue   \set_envitem_counter\fi
  \ifx\p_reset\s!true
    \resetcounter[itemgroup:env_question]\fi
  \ifx\p_class\s!question
    \ifmode_example
    \installitemgroupoption[example][question]%
    \startitemgroup[env_example]\else
    \installitemgroupoption[question][question]%
    \startitemgroup[env_question]\fi
    \item[\questionparameter\c!reference]%
    \increaseQuestionID% 具有獨立答案，增長 QID
    \set_count_envlevel  [question]%
    \installpointoranswer[question][point]%
    \installpointoranswer[question][answer]
  \fi
  \ifx\p_class\s!problem
    \ifmode_example
    \installitemgroupoption[example][question]%
    \startitemgroup[env_example]\else
    \installitemgroupoption[problem][question]%
    \startitemgroup[env_problem]\fi
    \set_count_envlevel [problem]%
    \ifenv_toplevel\else
      \decreaseQuestionID% 直接获取 question 的 ID
      \parentitemnumber=\scratchcounterone\relax
    \fi
  \fi
  \ifx\p_class\s!optclose
    \ifmode_example
    \installitemgroupoption[example][question]%
    \startitemgroup[env_example]\else
    \installitemgroupoption[question][question]%
    \startitemgroup[env_question]
    \fi
    \leftskip=0pt\relax
    \set_count_envlevel[question]
  \fi
  \save_question_order\removeunwantedspaces}

\protected\def\stopnamedquestion{%
  \ifnum\c_envcounter_toggle=1\relax
  \installdatacollectorhelper
  \installdatacollector\fi
  \ifx\p_class\s!problem
    \installdatacollectorhelper
  \fi
  \initcollectanswer
  \stopitemgroup
  \endgroup}

\definequestion[question]

\setupquestion
  [class=question,
  %example=,
  %showpoint=false,
  %point=,
  pointstyle=\ttx,
  %pointcolor=,
  %pointprelabel=,
  pointlabel={,\examtexts{point}},
  %showanswer=false,
  %answer=,
  answerlabel={\examtexts{answer},},
  answerstyle=\ss,
  answercolor=red,
  indenting=no,
  way=bychapter,
  numberconversion=tnum,]

\setupquestion
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 problem 环境 / Problem Environment}

%D The environment \tex{problem} command can set up multiple aggregate issues,
%D and the environment has a specific subcommand \tex{pitem} to list each issue.
%D It can be used to set fill-in-the-blank, Q&A, and other questions.

%D \startbuffer
%D \startproblem
%D \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The problem environment only inherits the key-value pairs from the itemgroup environment
%D and does not set any new key-values. In the current version (v20241023),
%D the settings for answers and scores have been removed. Because, under the problem environment,
%D there are usually many pitems, and each question may have its own score and answer.
%D Therefore, for design purposes, the answers and scores of each question are directly set through \tex{pitem}.

%D \startbuffer
%D \startproblem
%D \startpitem[showpoint=true,point=5]         The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem[showanswer=true,answer={newer}] The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem[]                               The environment is located in: \currentitemgroup 。 \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D Unlike the \tex{question} environment, where all ordinal numbers are sequential,
%D the \tex{problem} environment is recounted each time it starts.

%D If you want to add stems to the \tex{problem} environment,
%D you can place the \tex{problem} environment in the \tex{question} environment.

%D \startbuffer
%D \startquestion
%D   The environment is located in: \currentitemgroup 。
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D If you want to set a fill-in-the-blank question, you can use the \tex{fillin} command.
%D The use of \tex{fillin} and \tex{startanswer} will be mentioned later.
%D
%D \startbuffer
%D \setupanswer[showanswer=true]
%D \startquestion
%D   The environment is located in: \currentitemgroup 。
%D     \setuppitem[showanswer=true]
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \fillin{env_question:1}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[mp=rules:under:wave]{env_question:1}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem
%D     	The environment is located in: \fillin[empty=number]{env_question:2}。
%D     \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes]{env_question:3}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes,left={(},right={)}]{env_question:4}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D In addition to this, you can define a new problem environment via \tex{defineproblem}\type{[XXX]},
%D which will generate two new commands \tex{startXXX} , \tex{\stopXXX}

\definequestion[problem]
\def\setupproblem{\setupquestion[problem]}

\setupproblem
  [\c!class=\s!problem,
   \c!lefttext={(},
   \c!righttext={)},
   \c!option={n,packed,joinedup,nowhite},]

%D \section{设置 choice 环境}
%D 該環境命令只能置於 \tex{question} 環境之下。該環境有一個子項目：
%D \tex{startcitem}
%D \tex{stopcitem}。
%D \starttyping
%D  \startcitem {選項內容} \stopcitem
%D \stoptyping

%D 可以通過 \type{[*]} 來標記正確答案。如果想要設置多選題，只需要對每個正確答案添加 \type{[*]} 即可。
%D \startbuffer
%D \setupquestion[showanswer=true]
%D \startquestion
%D     The environment is located in: \currentitemgroup 。
%D     \startchoice
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup 。
%D     \startchoice
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup 。
%D     \startchoice
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D 同時為 \tex{startcitem}\tex{stopcitem} 定義了同義命令 \tex{citem} 和 \tex{fragilecitem}。
%D \tex{fragilecitem}命令可以不通過界定花括號來排版選項，但可能會引發未知問題，
%D 特別是選項中含有空格時。\tex{citem} 則需要將選項包裹在花括號中。
%D \starttyping
%D  \citem {選項內容}
%D  \fragilecitem 選項內容
%D \stoptyping

%D 该环境继承了一部分 itemgroup 的键值，就如同前两个命令一样。
%D 不同于 question 具有answer 和 point 两种键值，该环境只具有 answer 相关的键值，来特别地
%D 设置是否显示答案和配置答案樣式。
%D 因为 choice 环境的特殊性，point 键值通过 question 环境来显示。和 question 環境的區別是
%D question 环境的 answer 控制答案是否显示在题干以及设置相关样式。
%D choice   环境的 answer 控制答案是否显示在选项以及设置相关样式。

%D 另外，choice 環境有一個特別的值：
%D maxiwidth key is for calcaluted max width of choice and waited to be compare，
%D notice this key is maxiwidth ,and difference from maxwidth which
%D for setupitemgroup command

\installnamespace          {choice}
\installcommandhandler \????choice    {choice}    \????choice

\appendtoks
  \setuevalue        {\currentchoice}{\directnamedchoice[\currentchoice]}%
  \setuevalue{\e!start\currentchoice}{\startnamedchoice [\currentchoice]}%
  \setuevalue{\e!stop \currentchoice}{\stopnamedchoice}%
\to \everydefinechoice

\setupchoice [answerstyle=\ss\tf,
              answercolor=red,
              inlinechoice=false,
              point=\questionparameter\c!point,
              maxiwidth=.9\textwidth,
              numberconversion=A,]

\tolerant\protected\def\directnamedchoice[#1]#*[#2]#*#:#3%
{\begingroup
  \def\currentchoice{#1}\setupcurrentchoice[#2]%
  \startnamedchoice[#1]%
    \def\citem_temp##1{\startcitem##1\stopcitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \processcommacommand[#3]\citem_temp
  \stopnamedchoice\endgroup}

\tolerant\protected\def\startnamedchoice[#S#1]#*[#S#2]%
 {\begingroup\def\currentchoice{#1}%
  \ifnum\c_envcounter_toggle = 2\relax
    \errmessage{you cannot put choice in problem environment.
                choice env can only be putted in question environment.}\fi
  \env_choicetrue\set_envitem_counter
  \ifdefined\currentuserorder
    \expandafter\show_check_info{\check_info}%
  \else
    \ifnum\c_envcounter_toggle = 3\relax
    \else \set_count_envlevel[choice]\fi
  \fi
  \doifelsesomething{\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}}% arg_1
     {\scratchcounter\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}}% arg_2
     {\scratchcounter\zerocount}% arg_3
  \current_total_choice_number=\number\scratchcounter\relax
  \doifelsesomething{\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\zerocount}%
  \current_available_columns=\number\scratchcounter\relax
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%    % if calc_horizontal_num >= tbl_cit_count
%%    %                                      set horizontal = tbl_cit_count
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count ~= 1
%%    %                                  set horizontal = two % calc_horizontal_num
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count == 1
%%    %                                      set horizontal = 1
%%    % 特别的， 3 选项 且 可排版最大列数为 2 时，排版 1 行
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \startluacode
  tbl_num_temp = {"one","two","three","four",
                  "five","six","seven","eight","nine"}
  local   tbl_cit_count         = tex.count['current_total_choice_number']
  local   available_columns     = tex.count['current_available_columns']
          available_columns_arg = ""
  if     (tbl_cit_count == 3) and (available_columns   <  tbl_cit_count)
  then    available_columns_arg = "one"
  elseif (tbl_cit_count >  1) and (available_columns   >= tbl_cit_count)
  then    available_columns_arg = "horizontal," .. tbl_num_temp[tbl_cit_count]
  elseif (tbl_cit_count >= 1) and (available_columns   <=            1 )
  then    available_columns_arg = "one"
  else    available_columns_arg = "horizontal,two"
  end
  \stopluacode
  \edef\currentrealavailablecolumns{\ctxlua{context(available_columns_arg,"")}}%
  \setupcurrentchoice[#2]%
  \edef\currentanswer  {\choiceparameter\c!answer      }%
  \edef\p_option       {\choiceparameter\c!option      }%
  \edef\p_showanswer   {\choiceparameter\c!showanswer  }%
  \edef\p_choicetype   {\choiceparameter\c!inlinechoice}%
  \edef\p_correctsymbol{\choiceparameter{correctsymbol}}%
  \edef\p_defaultoption{A,packed,nowhite,joinedup}%
  \installitemgroupoption[choice][choice]%
  \ifx\p_choicetype\s!true
    \startitemgroup[env_choice][text,\p_option]\else
    \startitemgroup[env_choice][\ctxlua{context(available_columns_arg,"")},\p_option]\fi
  \choiceparameter\c!inlineleft
  \ifmode_showanswer\else
    \ifx\p_showanswer\s!true
         \mode_showanswertrue
    \else\mode_showanswerfalse\fi
  \fi\removeunwantedspaces}

\protected\def\stopnamedchoice{%
  \removemarkedcontent[inlinechoice_punctuation]%
  \d_maxwidth_with_label = \dimexpr\d_width_cit_max     +
                           \d_strc_itemgroups_list_width   \relax
  \d_compared_maxwidth   = \choiceparameter{maxiwidth}     \relax
  \startluacode
    local a = tex.dimen['d_compared_maxwidth']
    local b = tex.dimen['d_maxwidth_with_label']
          c = math.floor(a/b)
  \stopluacode
%%   \d_compared_maxwidth 是可排版的最長寬度。
%%   a 和 b 將寬度數字化， 以備比較出可排版的欄數。
%%   因為取消了 choice 作為上級環境時的 \set_count_envlevel 因此，重定義 order。
%%   取消原因是 讓 choice 直接獲取 question 環境的 order。
  \edef\currentchoiceanswer{\collectedanswer}%
  \ifempty\currentchoiceanswer
    \edef\currentanswer{\prevanswer}% 讓 choice 繼承 前一個答案
  \else
    \edef\currentanswer{\collectedanswer}%
  \fi
  \def\currentavailablecolumns{\ctxlua{context(c,"")}}%
  \def\currentitemmaxwidth    {\the\d_width_cit_max}%
  \doifelsesomething{\choiceparameter\c!point}%
    {\scratchcountertwo\choiceparameter\c!point}%
    {\scratchcountertwo\zerocount}%
  \edef\currentpoint     {\the\scratchcountertwo}%
  \edef\currenttotalpoint{\the\scratchcountertwo}%
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer
  \choiceparameter\c!inlineright
  \stopitemgroup
  \endgroup}

\setupchoice
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=.5\emwidth,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={A,packed,joinedup,nowhite,},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definechoice[choice]
\definechoice[inlinechoice]
\tolerant\def\setupinlinechoice[#1]{\setupchoice[inlinechoice][#1]}

\setupinlinechoice[option={text,8,packed,joinedup,nowhite,},
                   inlinechoice=\s!true,
                   correctsymbol={\symbol{marksquarecheck}},
                   inlineleft={ (\nobreak},
                   inlineright={\nobreak ) },
                   %lefttext={},
                   %righttext={},
                   answerstyle=\ss,
                   %stopper=,
                   %showanswer=,% shoule be empty before used
                   separator={\removeunwantedspaces,\space},
                   ]

%D \section{设置 writing 环境}
%D 目前该环境只是初步的设计。
%D 如果只有同级的多个作文题目，只需要使用 writing 环境即可。
%D 但是，当一个作文体下面有多个子题目时，需要将子题目放到 subwriting 环境当中。

%D \startbuffer
%D \setupwriting[showanswer=true,showpoint=true]
%D \startwriting[point=45]
%D   作文题目说明
%D   \startanswer
%D     参考作文 1
%D   \stopanswer
%D \stopwriting
%D
%D \startwriting
%D 作文题目说明
%D   \startsubwriting[point=450]
%D     sub 作文题目说明
%D     \startanswer
%D       参考作文 2
%D     \stopanswer
%D   \stopsubwriting
%D   \startsubwriting[point=4588]
%D     sub 作文题目说明
%D     \startanswer
%D     参考作文 3
%D     \stopanswer
%D   \stopsubwriting
%D \stopwriting
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {writing}
\installcommandhandler \????writing   {writing}   \????writing

\appendtoks
  \setuevalue{\e!start\currentwriting}{\startnamedwriting[\currentwriting]}%
  \setuevalue{\e!stop \currentwriting}{\stopnamedwriting}%
\to \everydefinewriting

\tolerant\protected\def\startnamedwriting[#S#1]#*[#S#2]
  {\begingroup\env_writingtrue\set_envitem_counter
  \edef\currentwriting{#1}%
  \setupanswer[showanswer=false]%
  \setupcurrentwriting[#2]%注意，writing 没有单独的 itemgroup 环境
  \edef\short_writing_answer{\writingparameter\c!answer}%
  \edef\currentanswer{\writingparameter\c!answer}%
  \edef\getanswercontent{}%
  \edef\p_writingtype{\writingparameter{subwriting}}%
  \installitemgroupoption[question][writing]%
  \startitemgroup[env_question]%
  \item[\writingparameter\c!reference]%
  \ifx\p_writingtype\s!true
    \env_subwritingtrue
    \set_envitem_counter
    \ifnum\currentitemnumber=1\relax
          \decreaseQuestionID\increaseQuestionID
    \else\increaseQuestionID\fi
    \set_count_itemlevel[subwriting]%
  % 当具有多个子写作环境时，才增长 QID ，
  % 否则削减至 父级 QID（相当于继承）
  \else
    \increaseQuestionID
    \set_count_envlevel[writing]
  \fi
  \installpointoranswer[writing][point]%
  \installpointoranswer[writing][answer]%
  \save_question_order\removeunwantedspaces}

\protected\def\stopnamedwriting{%
  \ifnum\c_totalitemnumber<2\relax% 只有一個子項目
    \ifenv_subwriting% 是子作文
      \installdatacollector%
      \installdatacollectorhelper%
      \initcollectanswer
    \else% 是作文
      \edef\currentpoint{\writingparameter\c!point}
      \edef\currenttotalpoint{\writingparameter\c!point}
      \c_totalitemnumber=1\relax
      \installdatacollector%
      \installdatacollectorhelper%
      \initcollectanswer
    \fi
  \else% 擁有多個子項目
  \fi\stopitemgroup\endgroup}


\setupwriting
  [\c!answer={参见参考作文。},
   \c!pointlabel={,\examtexts{point}},
   \c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definewriting[writing]
\definewriting[subwriting]
\def\setupsubwriting{\setupwriting[subwriting]}
\setupsubwriting
  [answer={参见参考作文。},
   subwriting=true,
   pointlabel={,\examtexts{point}},]

%D \section{设置 answer 环境}
%D 在(v20241023)中，删除了 answer 环境的标签通过 description 来进行设置。
%D 整体环境通过 textbackground 环境进行设置。
%D 该环境提供了一個特殊的鍵值 sctipt，該鍵值主要用於創建答題區域。
%D 該鍵值和 showanswer 鍵值是互斥的，不應該同時啟用。

%D \tex{answer} 是爲師生兩版設置的命令。但目前該命令和相關設置還具有諸多不足之處。
%D 只需要將該環境置於題目下方，即可獲取當前題目設定的答案，並可以爲其編寫答案解析。
%D
%D \startbuffer
%D \startquestion[showanswer=true,answer={answer for \currentitemgroup },point=12]
%D     The environment is located in: \currentitemgroup 。
%D     注意：\tex{answer} 可以獲取父環境或同級環境的答案而不必再次設置。
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \startquestion[showanswer=true,point=1]]
%D     The environment is located in: \currentitemgroup 。
%D     注意：\tex{answer} 可以獲取父環境或同級環境的答案而不必再次設置。
%D     \startchoice
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D \startbuffer
%D \startquestion[showanswer=true]
%D   The environment is located in: \currentitemgroup 。
%D     \startproblem[showanswer=true,left={(},right={)},distance=1em,stopper={}]
%D     \startpitem[showanswer=true,answer={Pitem 1},point=10]
%D        The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 2},point=20]
%D        The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 3},point=30]
%D        The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%%%%%%%

\installnamespace {answer}
\installnamespace {answeralternative}
\installnamespace {answerrenderings}

\installcommandhandler \????answer            {answer}            \????answer
\installcommandhandler \????answeralternative {answeralternative} \????answeralternative

\appendtoks
    \frozen\instance\protected\edefcsname        \currentanswer\endcsname{\answer_direct_instance}%
    \frozen\protected\instance\edefcsname\e!start\currentanswer\endcsname{\answer_start_instance [\currentanswer]}%
    \frozen\protected\instance\letcsname \e!stop \currentanswer\endcsname\answer_stop_instance
\to \everydefineanswer

\tolerant\protected\def\answer_direct_instance[#S#1]#:#2%
  {\begingroup
   \cdef\currentanswer{#1}%
   \doif{\answerparameter{showanswer}}{true}{\mode_showanswertrue}%
   \ifmode_showanswer
     \useanswerstyleandcolor\c!style\c!color
     \answerparameter\s!command
     {#2}
   \fi
   \endgroup
   \edef\currentanswer{#2\collectanswer{#2}}
   \edef\prevanswer   {\currentanswer}}
   % 只有一個功能， 收集答案。
   % 具備簡單的樣式控制和控制答案顯隱。
   % \setupanswer[command=\groupedcommand{\bf}{},style=,color=,showanswer=]

\permanent\protected\def\startanswer
  {\begingroup
   \edef\currentanswer_bak{\currentanswer}%
   \lettonothing\currentanswer
   \doifelsenextoptionalcs\answer_start_delayed\answer_start_indeed}

\def\answer_start_delayed[#S#1]%
  {\doifelseassignmentcs{#1}%
     \answer_start_delayed_parameters
     \answer_start_delayed_name
   [#1]}

\def\answer_start_delayed_parameters[#S#1]%
  {\setupcurrentanswer[#1]%
   \answer_start_indeed}

\def\answer_start_delayed_name[#1]%
  {\cdef\currentanswer{#1}%
   \checkanswerparent
   \doifelsenextoptionalcs\answer_start_delayed_parameters\answer_start_indeed}

\protected\tolerant\def\answer_start_instance[#S#1]#*[#S#2]%
  {\begingroup\env_answertrue\set_envitem_counter
   \edef\currentanswer_bak{\currentanswer}% 備份之前的答案
 %  \lettonothing\currentanswer%釋放currentanswer
% currentanswer 命令已經被其他環境定義為答案獲取命令，
% 此處的 currentanswer 是定義環境命令，需要重新釋放。
   \cdef\currentanswer{#1}%
   \setupcurrentanswer[#2]%
   \grabbufferdatadirect
   % {\s!answer:\currentanswer}%
     {\s!answer}% unnested, as before
     {\e!start\currentanswer}%
     {\e!stop \currentanswer}}

\def\answer_start_indeed
  {\grabbufferdatadirect
   % {\s!answer:\currentanswer}%
     {\s!answer}% unnested, as before
     {\csstring\startanswer}%
     {\csstring\stopanswer}}

\permanent\protected\def\stopanswer
  {\answerparameter\c!before
   \dostarttagged\t!answer\currentanswer
   \begingroup
   \useanswerstyleandcolor\c!style\c!color
   \usealignparameter\answerparameter
   \edef\currentansweralternative{\answerparameter\c!alternative}%
   \ifcsname\currentansweralternativehash\s!parent\endcsname \else
     \let\currentansweralternative\s!default
   \fi
   \usesetupsparameter\answerparameter
   \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
   \directsetup\p_renderingsetup
   \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
     {\getbufferdata[\s!answer]}%
% 需要注意，该命令会传递给 dataset，不同于 writing 环境的 currentanswer
% currentanswer 的目的是设置较短的作文答案。
% getanswercontent 则是设置完整的作文答案。
% 如果需要為其他環境獲取解析內容， 應該需要重定義命令（answer + currentQID）
   \endgroup
   \dostoptagged
   \answerparameter\c!after
   \endgroup}

\aliased\let\answer_stop_instance\stopanswer

% kind of nested, when we need it:
%
% \permanent\tolerant\protected\def\getanswer      [#1]{\normalexpanded{\getbufferdata[\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}
% \permanent\tolerant\protected\def\getinlineanswer[#1]{\normalexpanded{\inlinebuffer [\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}

% unnested, as before:

\permanent\tolerant\protected\def\getanswerbuffer      [#1]{\getbufferdata[\s!answer]}
\permanent\tolerant\protected\def\getinlineanswerbuffer[#1]{\inlinebuffer [\s!answer]}

\defineansweralternative
  [\s!default]
  [\c!renderingsetup=\????answerrenderings:\s!default]

% \startsetups[\????answerrenderings:\s!default]
%     \answerparameter\c!before
%     \usesetupsparameter\answerparameter
%     \getbufferdata[\s!answer]
%     \answerparameter\c!after
% \stopsetups

\startsetups[\????answerrenderings:\s!default]
  \doif{\answerparameter  {showscript}}{true}{\mode_showscripttrue\mode_showanswerfalse}%
  \doif{\answerparameter\c!showanswer} {true}{\mode_showanswertrue\mode_showscriptfalse}%
  \doif{\answerparameter\c!showpoint}  {true}{\mode_showpointtrue}%
  \setuptextbackground[env_answer]%
  [location=paragraph,width=local,
  leftoffset=1ex,rightoffset=1ex,
  %topoffset=.5ex,bottomoffset=.5ex,
  before={\leftskip=0pt\startnarrower},
  after={\stopnarrower},
  background=\answerparameter\c!background,
  backgroundcolor=\answerparameter\c!backgroundcolor,
  corner=\answerparameter\c!corner,
  frame=\answerparameter\c!frame,
  framecolor=\answerparameter\c!framecolor,
  rulethickness=\answerparameter\c!rulethickness,
  ]%
  \startenv_answer
  \useanswerstyleandcolor\c!style\c!color
  \ifenv_material% 可以用来做文章翻译或内容解释，
    \getanswerbuffer%          % 也可以直接放置在文章之后，或这每一个段落之后
  \else
    \ifmode_showscript
        \answerparameter{scriptcontent}%
    \else
      \noindent
      \begingroup
      \edef\currentmode{answer}%
      \p_assigned_currentlabel{answer}{answer}%
      \expandafter\expandafter%
        \expandafter\p_pass_currentlabel%
          \expandafter\expandafter%
            \expandafter[%
                \csname p_currentansweranswerlabel\endcsname]{answer}%
      \ifmode_showanswer
        \show_pointoranswer_text[answer][answer]%
      \fi\endgroup
      \begingroup
      \edef\currentmode{point}%
      \p_assigned_currentlabel{answer}{point}%
      \expandafter\expandafter%
        \expandafter\p_pass_currentlabel%
          \expandafter\expandafter%
            \expandafter[%
                \csname p_currentanswerpointlabel\endcsname]{point}%
      \ifmode_showpoint
        \show_pointoranswer_text[answer][point]%
      \fi\endgroup
      \ifmode_showanswer
          \answerparameter\c!inbetween
          \getanswerbuffer
      \fi
    \fi
  \fi
  \stopenv_answer
\stopsetups

\tolerant\protected\def\startoldanswer[#1]#:#2\stopoldanswer%
{\begingroup\env_answertrue\set_envitem_counter
  \lettonothing\currentanswer%釋放currentanswer
  \lettonothing\getanswerbuffer\lettonothing\getinlineanswerbuffer
  % currentanswer 命令已經被其他環境定義為答案獲取命令，
  % 此處的 currentanswer 是定義環境命令，需要重新釋放。
  \cdef\currentanswer{#1}%
  \setupcurrentanswer[#2]%
  \edef\getanswerbuffer{#2}%
  \usesetupsparameter\answerparameter
  \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
    {#2}%%
% 需要注意，该命令会传递给 dataset，不同于 writing 环境的 currentanswer
% currentanswer 的目的是设置较短的作文答案。
% getanswercontent 则是设置完整的作文答案。
% 如果需要為其他環境獲取解析內容， 應該需要重定義命令（answer + currentQID）
\endgroup}

\startuseMPgraphic{normalframeMP}
  draw unitsquare xyscaled (\overlaywidth, \overlayheight);
\stopuseMPgraphic
\defineoverlay       [normalframeOL][\useMPgraphic{normalframeMP}]

%%%%% NOTICE : 目前，當用戶主動輸入值和選項值發生衝突時，並未設置警告信息!!!!
\def\getanswerforanswer{% used for answer env to auto get answer
  \ifenv_writing\short_writing_answer
  \else\datasetvariable{Answer_collector}{\QuestionID}{answer}\fi}

\def\getpointforanswer{% used for answer env to auto get point
  \datasetvariable{Answer_collector}{\QuestionID}{point}}

\setupanswer
  [showanswer=true,
  showpoint=true,
  answer=\getanswerforanswer,
  point=\getpointforanswer,
  answerlabel={{\examtexts{answer}}},
  pointlabel={,\examtexts{point}},
  pointstyle=\answerparameter\c!style,
  pointcolor=\answerparameter\c!color,
  answerstyle=\answerparameter\c!style,
  answercolor=\answerparameter\c!color,
  style=\ss\it,
  before=\blank[halfline],
  after=\blank[halfline],
  inbetween={\par},
  showscript=false,
  %scriptcontent={},
  \c!alternative=\s!default,
  background=normalframeOL,%% for env_answer textbackground
  %backgroundcolor=,
  %corner=,
  frame=on,
  %framecolor=,
  %rulethickness=,
  ]
\defineanswer[answer]

%D \section{设置 pitem,citem 命令}

\installnamespace                {pitem}
\installsimplecommandhandler \????pitem     {pitem}     \????pitem

\setuppitem    [%showpoint=,
                %point=,
                pointstyle=\ttx,
                %pointcolor=,
                pointlabel={,\examtexts{point}},
                answerlabel={\examtexts{answer},},
                %showanswer=,
                %answer=,
                answerstyle=\ss,
                answercolor=red,
                %reference=,
                ]

\tolerant\protected\def\startpitem[#1]{\begingroup%
  \item_pitemtrue\increaseQuestionID%
  \iffirstargument\setuppitem[#1]\fi%
  \startitem[\pitemparameter{reference}]%
    \ifenv_question% 設計上的問題，此時 pitem 處於 botlevel，否則處於 toplevel。
    \set_count_itemlevel [pitem]\else\ifenv_problem%
    \set_count_envlevel  [pitem]\fi\fi%
    \installpointoranswer[pitem][point]%
    \installpointoranswer[pitem][answer]%
  \removeunwantedspaces}

\def\stoppitem{%
  \ifitem_fillin\edef\currentanswer{\collectedanswer}\fi
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer% 清空收集 fillin 的答案
  \stopitem\endgroup}

%D [*](用于标记正确答案)

\installnamespace                {citem}
\installsimplecommandhandler \????citem     {citem}     \????citem

\setupcitem[
  %style=,
  %color=,
]

\protected\def\check_correct_choice#1#2{%
  \usecitemstyleandcolor\c!style\c!color
  \ifmode_showanswer
    \edef\p_correctmark_m{*}\edef\p_correctmark_p{#1}%
    \ifx\p_correctmark_p\p_correctmark_m
      \edef\p_answerstyle{\choiceparameter\c!answerstyle}%
      \edef\p_answercolor{\choiceparameter\c!answercolor}%
      \ifx\p_choicetype\s!true
        \bgroup
          \ifempty\p_answerstyle
                  \questionparameter\c!answerstyle
            \else\choiceparameter  \c!answerstyle\fi
          \ifempty\p_answercolor
                  \switchtocolor[\questionparameter\c!answercolor]%
            \else \switchtocolor[\choiceparameter  \c!answercolor]\fi
        \sym{\ifempty\p_correctsymbol\symbol{marksquarecheck}\else
                     \p_correctsymbol\fi}% correct inline choice
        #2\collectanswer{#2}\egroup
      \else
        \startitem[\citemparameter\c!reference]{%
          \ifempty\p_answerstyle
                  \questionparameter\c!answerstyle
            \else\choiceparameter  \c!answerstyle\fi
          \ifempty\p_answercolor
                  \switchtocolor[\questionparameter\c!answercolor]%
            \else \switchtocolor[\choiceparameter  \c!answercolor]\fi
                  #2}
        \stopitem% correct normal choice
      \fi
    \else
      \startitem[\citemparameter\c!reference]#2\stopitem% correct choice without *
    \fi
  \else
    \startitem[\citemparameter\c!reference]#2\stopitem%  choice
  \fi
  \ifx\p_choicetype\s!true
    \markcontent[inlinechoice_punctuation]{\choiceparameter\c!separator}%
  \fi}

\protected\def\get_citem_text[#1]{\setbox0=\hbox{#1}%
    \d_width_cit = \the\wd0\relax%relax is neccessary
    \ifdim \d_width_cit_max > \d_width_cit%
           \d_width_cit_max = \d_width_cit_max%
    \else  \d_width_cit_max = \d_width_cit%
    \fi}%%%% 遞歸計算出最大寬度

\tolerant\protected\def\startcitem[#1]#*[#2]#:#3\stopcitem{% #1 correct answer
  \ifsecondargument\setupcitem[#2]\fi%                     #2 option
  \get_citem_text[#3]%                                     #3 choice content
  \edef\p_correctmark_p{#1}\edef\p_correctmark_m{*}%
%  \set_count_itemlevel[citem]
  \incrementitemnumber
  \ifx\p_choicetype\s!true\else
  \ifx\p_correctmark_p\p_correctmark_m
    \edef\currentanswerindex{\the\c_currentitemnumber}
    \edef\correct_choice_index{\convertnumber{\choiceparameter{numberconversion}}{\currentanswerindex}}%
    \collectanswer{\correct_choice_index}% collect current normal answer
  \fi\fi
  \doif{#1}{*}{\choice_checktrue}%
  \check_correct_choice{#1}{#3}%
  \removeunwantedspaces}

%D \section{定义同义命令}

%D \startquestion[showanswer=true]
%D \fastchoice{a,\correct{F},{[*]E},}
%D \stopquestion

%D \startquestion[showanswer=true]
%D \fastchoicealt{a,\correct{F},{[*]sF}}
%D \stopquestion

\def\pitem{\dosingleempty\pitem_indeed}
\def\pitem_indeed[#1]#2{
  \startpitem[#1]{#2}\stoppitem}

\def\citem{\dosingleempty\citem_indeed}
\def\citem_indeed[#1]#2{%
  \startcitem[#1]{#2}\stopcitem}

\tolerant\protected\def\fastchoice[#1]#:#2{
  \startchoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopchoice}

\tolerant\protected\def\fastchoicealt[#1]#:#2{
  \startinlinechoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopinlinechoice}

%D 谨慎使用下面的 fragilecitem，他并不安全。很有可能导致错误

\bgroup
\obeylines
\gdef\xcitem{\bgroup\obeylines\dosingleempty\doxcitem}%
\gdef\doxcitem[#1]#2
  {\egroup%
  \doifsomethingelse{#1}%
  {\startcitem[*]#2\stopcitem}%
  {\startcitem #2\stopcitem}%
  }%
\egroup

\let\fragilecitem\xcitem

%D \section{設置 fillin 命令}
%D 該命令建議在 pitem 環境內進行使用。
%D 當然，同時由於 pitem 本身也有 answer 鍵值，可以通過該鍵值進行設定。

%D fillin 命令主要依靠 bar 命令實現的。基本上按照修改 bar 命令即可修改 fillin 命令。
%D fillin 命令有兩個參考 textnote 的參數： empty 和 n。
%D empty=yes，隱藏答案；empty=number 顯示數字； empty=none 顯示答案。
%D n=* 隱藏答案,長度為答案長度； n=NUMBER 控制 bar 的長度。

%D bar 主要有四種樣式，可以通過 mp 參數進行設置：
%D rules:under:dots    %rules:under:random
%D rules:under:dash    %rules:under:wave

%D 新增一个 align=autoright 来让 fillin 对齐右方。但必须同时设置 n=0 才会正常工作。

\installnamespace          {fillin}
\installcommandhandler \????fillin    {fillin}    \????fillin

\setupfillin[%foregroundcolor=,
             %before=,after=,
             %left=,right=,
             %repeat=,mp=
              rule=fillin_text,% 引用 bar 命令
              empty=none,
              continue=yes,
              unit=em,
              order=foreground,
              method=0,
              %color=gray,
              width=4em,
              n=10,
              dy=-0.4,
              max=3,
              offset=-.1,
              rulethickness=.05,
              foregroundstyle=\ss,]

\tolerant\protected\def\fillin[#1]#:#2{%
  \item_pitemfalse\item_fillintrue
  \begingroup\removeunwantedspaces
  \iffirstargument\setupfillin[#1]\fi
  \setupbar[fillin_text][%
           rulethickness=\fillinparameter{rulethickness},
         foregroundcolor=\fillinparameter{foregroundcolor},
         foregroundstyle=\fillinparameter{foregroundstyle},
                continue=\fillinparameter{continue},
                    unit=\fillinparameter{unit},
                   order=\fillinparameter{order},
                  method=\fillinparameter{method},
                      dy=\fillinparameter{dy},
                     max=\fillinparameter{max},
                   width=\fillinparameter{width},
                    left=\fillinparameter{left},
                   right=\fillinparameter{right},
                  repeat=\fillinparameter{repeat},
                   color=\fillinparameter{color},
                  offset=\fillinparameter{offset},
                   empty=\fillinparameter{empty},
                      mp=\fillinparameter{mp}]%
  \global\advance\c_fillin_number by 1\relax
  \edef\p_n{\fillinparameter\c!n}%
  \edef\p_empty{\fillinparameter\c!empty}%
  \edef\p_number{\number\c_fillin_number}%
  \edef\p_align{\fillinparameter\c!align}%
  \edef\currentbar{\fillinparameter\c!rule}%
  \ifx\p_align\c!autoright
    \unskip\nobreak\hfill\penalty50\hskip2em\hbox{}\nobreak\hfill\fi
  \fillinparameter\c!before\fillinparameter\c!left
  \ifx\p_n\wildcardsymbol
     \donefalse
     \ifx\p_empty\v!yes\donetrue
     \else\ifx\p_empty\v!number\donetrue
     \else\ifx\p_empty\v!none\donetrue
     \fi\fi\fi
     \ifdone
      \ifmode_showanswer
        \setupfillin[empty=none]%
      \else
        \setupbar[\currentbar][\c!empty=\v!yes]%
      \fi
      \edef\p_empty{\fillinparameter\c!empty}%
    \fi
     \inlinebar[\currentbar]\bgroup
        \wordboundary#2\egroup
   \else
    \ifmode_showanswer\setupfillin[empty=none]\fi
    \edef\p_empty{\fillinparameter\c!empty}%
    \inlinebar[\currentbar]\bgroup
      \wordboundary\scratchcounter\numexpr\p_n\relax
      \ifx\p_empty\v!yes
        \interwordspacesbefore\scratchcounter
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!number
        \interwordspacesbefore\scratchcounter
        \zwnj\runninghbox{\resetbar\p_number}\zwnj
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!none
        \scratchcounter\numexpr\p_n/\plustwo\relax
        \interwordspacesbefore\scratchcounter
        \zwnj{{#2}}\zwnj
        \interwordspacesafter\scratchcounter
      \else#2\fi\fi\fi
    \egroup
   \fi
  \fillinparameter\c!right\fillinparameter\c!after
  \ifx\p_align\c!autoright
    \parfillskip=0pt \finalhyphendemerits=0 \par\fi
  \aftergrouped{\edef\currentanswer{\collectanswer{#2}#2}}
  \endgroup}

%D \section{設置 material 環境}
%D 顧名思義，\tex{material} 環境用來放置大段文本材料。
%D 該環境比較特殊，它設置了多個子實例來進行更完善的設置。
%D 除了 \tex{setupmaterial[number]} 這個實例繼承了 \tex{setupcounter} 的全部鍵值之外，
%D 其他實例都是新定義的鍵值。

%D 這些實例分別是：
%D \startitemize[nowhite,joinedup,packed]
%D \item \tex{setupmaterial[number]}    設置 該環境標題的 {\bf 序號};
%D \item \tex{setupmaterial[title]}     設置 該環境的 {\bf 標題} 相關的樣式;
%D \item \tex{setupmaterial[author]}    設置 該環境文章的 {\bf 作者} 相關的樣式;
%D \item \tex{setupmaterial[source]}    設置 該環境文章的 {\bf 具體來源} 的相關樣式。
%D \item \tex{setupmaterial[indicator]} 設置 該環境文章的 {\bf 畫線序號文字} 的相關樣式。
%D \stopitemize

%D 此外，\type{title},\type{author},\type{source} 的名稱是通過 \tex{setupmaterial}
%D 來直接設置。此外， 該環境具有一個特殊的子命令 \tex{indicator} 來標記文章中的提問的部分並
%D 進行添加數字標識 --- （一）畫線文字。因此，\tex{setupmaterial} 還具有一個鍵值 indicator
%D 通過 \type{indicator=reset} 對 indicator 進行重置，每當開啓一個新的 material 環境。
%D 通過 \type{indicator=continue} 對 indicator 取消重置，它將持續計數。
%D 當然，也可以直接通過 \tex{setupmaterial[indicator][reset=true]} 來啓用重新計數

%D 以上所有實例都具有以下鍵值：
%D before after align style color
%D 此外，\tex{setupmaterial} 可以通过 spacebefore 和spaceafter 来控制环境前后的垂直距离

%D notice , if you want change [start = number] after a chapter ,
%D you should use \tex{resetcount[COUNTER_NAME]} to reset current counter
%D to the number of start you've setted.
%D otherwise, you need put [start = number] before the chapter you want
%D to reset the counter.

%D \startbuffer
%D \setupmaterial[title][color=green]
%D \startmaterial[title={Knuth},author={Mos},source={Yelu}]
%D \input knuth
%D \stopmaterial
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {material}
\installcommandhandler \????material  {material}  \????material
\installcounterassociation {material}

\appendtoks
   \registermaterialcounter\currentmaterial
   \definecounter[\currentmaterial]%
\to \everydefinematerial

\appendtoks
   \synchronizematerialcounters
\to \everysetupmaterial

\definematerial [material]
\definematerial [number]
\definematerial [indicator]
\definematerial [indicator_helper]

\setupmaterial [\c!align=center,
                %\c!color=,
                %\c!style=,
                \c!spacebefore=1em,
                \c!spaceafter=1em,
                %\c!title=,
                %\c!author=,
                %\c!source=,
                \c!indicator=continue,
                indent={first,always,2em},]
\setupmaterial [\c!number] [\c!before={(},\c!after={)},
                            \c!prefix=no,\c!start=0,
                            \c!style=\namedmaterialparameter\c!title\c!style,
                            \c!color=\namedmaterialparameter\c!title\c!color,
                            \c!numberconversion=cn,\c!way=\v!by\v!chapter]
\setupmaterial [\c!title]  [\c!style=\ss\tfa,\c!color=,\c!align=center,
                            \c!before=,]
\setupmaterial [\c!author] [\c!style=\tf,\c!color=,\c!align=flushright]
\setupmaterial [\c!source] [\c!before=\par,\c!align=flushright]
\setupmaterial [indicator,indicator_helper]
               [style=\ss\bf,before={ (~},after={~) },prefix=no,
                numberconversion=cn,type=line,reset=false]

\def\material_counter_parameter#1%
  {\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\c!title\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \incrementcounter[#1]\convertedcounter[#1]%
    \namedmaterialparameter\currentmaterial\c!after
   \endgroup}

\def\material_parameter#1%creat new element in material
  {{\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\currentmaterial\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \rootmaterialparameter\currentmaterial
    \namedmaterialparameter\currentmaterial\c!after
    \par\endgroup}}

\tolerant\protected\def\startmaterial[#1]{\begingroup%
  \lettonothing\currentmaterial%%
  \edef\p_indicator{\rootmaterialparameter\c!indicator}
  \edef\p_reset{\namedmaterialparameter{indicator}\c!reset}
  \processaction[\p_indicator][
    reset=>\let\indicator_reset_helper\resetindicators,
  continue=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \processaction[\p_reset][
    true=>\let\indicator_reset_helper\resetindicators,
    false=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \env_materialtrue\set_envitem_counter%
  \iffirstargument\setupcurrentmaterial[#1]\fi
  \indicator_reset_helper
  \usematerialstyleandcolor\c!style\c!color%
  \blank[\rootmaterialparameter\c!spacebefore]
  \startalignment[\rootmaterialparameter\c!align]
      \material_counter_parameter\c!number
      \material_parameter\c!title
      \material_parameter\c!author
  \stopalignment
  \blank[\rootmaterialparameter\c!spaceafter]
  \setupindenting[\rootmaterialparameter{indent}]
  \removeunwantedspaces}
\def\stopmaterial{%
    \material_parameter\c!source
    \indicator_reset_helper
    \endgroup}

\tolerant\protected\def\indicator[#1]#:#2{\begingroup%
    \def\currentmaterial{indicator}
    \iffirstargument\setupmaterial[indicator][#1]\fi%
    \edef\indicator_type{\namedmaterialparameter\currentmaterial\c!type}%
    \edef\indicator_reset{\namedmaterialparameter\currentmaterial\c!reset}%
    \processaction[\indicator_type]%
              [line=>\let\indicator_type\underbar,%
               none=>\let\indicator_type\relax]%
    \usematerialstyleandcolor\c!style\c!color%
    \indicator_type{%
    \namedmaterialparameter\currentmaterial\c!before%
    \ifmode_check%
      \ifenv_material\color[red]{material}\else\color[red]{\currentitemgroup}\fi%
      \ifcontinue_counter\color[red]{continue}\fi%
    \fi%
    \ifenv_material%
      \ifmode_check\color[red]{::indicator}\fi%
      \incrementcounter[\currentmaterial]%
      \convertedcounter[\currentmaterial]%
    \else%
      \ifmode_check\color[red]{::helper}\fi%
      \incrementcounter[indicator_helper]%
      \convertedcounter[indicator_helper]%
    \fi%
    \namedmaterialparameter\currentmaterial\c!after%
    #2}
\endgroup}

\def\indicators{%%% TODO 增強該命令的用法
  \ifenv_material
    \ifmode_check\color[red]{::indicator}\fi
    \incrementcounter[indicator]%
    \convertedcounter[indicator]%
  \else
    \ifmode_check\color[red]{::helper}\fi
    \incrementcounter[indicator_helper]%
    \convertedcounter[indicator_helper]%
  \fi}
\def\resetindicators{\setcounter[indicator][0]%
                     \setcounter[indicator_helper] [0]}
%%%%%%%%%%%%%%%%
%D \section{设置 close 环境}

%D close 環境近乎是單獨設計的。還需要改進：直接使用 itemgroup 重置，該環境主要使用兩個命令：
%D \tex{startclose} 和 \tex{stopclose} 用來創建該環境，
%D \tex{closechoice} 用來標記環境內的選項，該命令隨行文放置即可。選項無須再次在文章後放置，
%D \tex{stopclose} 會自行放置。
%D 因為 \type{close} 環境的子項目 \tex{closechoice} 是通過 choice 環境設置的。
%D 因此，可以通過 \type{[*]} 來標記正確答案。

%D close 環境同樣繼承了 answer 的鍵值。
%D 此外設置了 reset 鍵來選擇是否每一篇重置選項的題號，
%D 其他的鍵值： barcolor barstyle 設置 下划線樣式
%D            before after style color 用於整體環境
%D            width frame stopper distance 用於選項前題號樣式

%D \startbuffer
%D \startclose
%D On Oct. 11, hundreds of runners competed in a cross-country race in Minnesota.
%D Melanie Bailey should have \closechoice[designed,followed,changed,finished] the
%D course earlier than she did. Her \closechoice[delay,chance,trouble,excuse] came
%D because she was carrying a \closechoice[judge,volunteer,classmate,competitor]
%D across the finish line.
%D
%D As reported by a local newspaper, Bailey was more than two-thirds of the way
%D through her \closechoice[race,school,town,training] when a runner in front of
%D her began crying in pain. She \closechoice[agreed,returned,stopped,promised]
%D to help her fellow runner, Danielle Lenoue. Bailey took her arm to see if she
%D could walk forward with \closechoice[courage,aid,patience,advice] . She couldn't.
%D Bailey then \closechoice[went away,stood up,stepped aside,bent down] to let Lenoue
%D climb onto her back and carried her all the way to the finish line, then another
%D 300 feet to where Lenoue could get \closechoice[medical,public,constant,equal] attention.
%D
%D Once there, Lenoue was \closechoice[interrupted,assessed,identified,appreciated]
%D and later taken to a hospital, where she learned that she had serious injuries in
%D one of her knees. She would have struggled with extreme \closechoice[hunger,pain,cold,tiredness]
%D to make it to that aid checkpoint without Bailey's help.
%D \stopclose
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupclose[%showanswer=false,
            reset=false,
            %barstyle=,
            %barcolor=,
            showpoint=false,
            answerstyle=\ss,
            answercolor=red,
            width=2em,% set order width
            frame=off,% set order frame
            stopper=.,% set order stopper
            distance=.5em,% set order distance
            after=\blank[halfline]]

\c_closetest=1\relax
\tolerant\protected\def\closebar#1{
  \startbar[underbar]%
    \scratchcounter\numexpr16/\plustwo\relax
    \interwordspacesbefore\scratchcounter
      \zwj\runninghbox{\resetbar{#1}}\zwj
    \interwordspacesafter\scratchcounter
  \stopbar}

\def\closechoice[#1]{% 這是用戶命令，用來記錄選項(定義選項列表)
  \expandafter\def\csname close:\romannumerals\c_closetest\endcsname{#1}%
  % c_closetest 用於標記選項列表，會隨著選項題目增加，無論是否啓用重置，該計數器都會記錄並自增
  % 在生成選項序列時，該計數器可以進行：(1) 是否設置了選項 (2) 遞增出選項序列
  % 該計數器屬於局域，每篇文章都會重置回 1。
  \ifclose_counter_reset
    \begingroup
      \setupbar[underbar]%
       [color=\closeparameter{barcolor},
        mp=\closeparameter{barstyle}]%
      \closebar{\number\c_closetest}%
    \endgroup
  \else
    \begingroup\let\par\relax% 將其封裝在局域，避免 par 命令失效
       \setupbar[underbar]%
       [color=\closeparameter{barcolor},
        mp=\closeparameter{barstyle}]%
      \startitemgroup[env_question][n,continue,text,nostopper]%
                                   [lefttext=\closebar,righttext=]%
      \item \save_question_order
      \stopitemgroup
    \endgroup
  \fi\advance\c_closetest by 1\relax}

\def\close_order{%選項前的序號樣式，序號通過 tempa 設定
  \unskip\noindent
  \inframed[width=\closeparameter\c!width,
            frame=\closeparameter\c!frame,
            foreground=color,
            foregroundcolor=\closeparameter\c!color,
            foregroundstyle=\closeparameter\c!style]{%
     \convertnumber{n}{\number\c_closetest_tempa}%
     \closeparameter\c!stopper}%
   \hskip\closeparameter\c!distance\relax
   \global\advance\c_closetest_tempa by 1\relax
  \unskip}

\def\docloseitem#1{\startcitem #1\stopcitem}
\def\placeclosechoice{%
  \scratchcounter\numexpr\c_closetest-1\relax
  \c_closetest=1\relax%
   \dorecurse{\number\scratchcounter}{% start recurse
    \hbox{% start first box
      \hsize=\textwidth
      \increaseQuestionID
      \set_count_envlevel  [close]%
      \installpointoranswer[close][point]%
      \installpointoranswer[close][answer]%
      \edef\currentitemnumber{\the\c_closetest_tempa}%
      \edef\currentuserorder{%
        \currentitemnumber%放置在這裡才能正確獲取題號
        \ifnum\rawcountervalue[Unicode_botlevel]=0\else% 抽出 order 定義，
          (\rawcountervalue[Unicode_botlevel])\fi}% 因為該環境沒有上級 question 環境
       \hbox{\close_order}% close question index  box
       \hbox{\vtop{%   close question choice box start
          \startchoice[point=\closeparameter\c!point]%
            \processcommacommand[\csname close:\romannumerals\c_closetest\endcsname]\docloseitem%
          \stopchoice
          }}%    close question choice box stop
     }% stop first hbox
   \advance\c_closetest by 1\relax}% stop reucrse
  \c_closetest=1\relax%
}

\tolerant\protected\def\startclose[#1]%
 {\begingroup\env_closetrue\set_envitem_counter
  \iffirstargument\setupclose[#1]\fi
  \edef\p_reset{\closeparameter\c!reset}%
  \ifx\p_reset\s!true
    \close_counter_resettrue
  \else
    \close_counter_resetfalse
  \fi\restore_question_order
  \ifclose_counter_reset% 如果重置， 則序號起自 1
    \c_closetest_tempa=1\relax% tempa 标记文章内的序号和选项前的序号
  \else % 否則， 恢復上一問題序號， 並遞增1.
    \c_closetest_tempa=\rawcountervalue[strc_close_counter]%
    \c_closetest_tempa=\numexpr\c_closetest_tempa+1\relax
  \fi
  \closeparameter\c!before
  \useclosestyleandcolor\c!style\c!color
  \removeunwantedspaces}

\def\stopclose{%
  \closeparameter\c!after
  \placeclosechoice
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{設置 optclose 環境}
%D 該環境是 close 環境的變體，但目前並未對該環境進行更多的設置。
%D 該環境的主要命令有兩個：
%D \tex{startoptclose} 和 \tex{stopoptclose} 用來創建該環境，
%D \tex{ocitem} 用來標記環境內的選項，該命令隨行文放置即可。
%D \tex{ocitem[answer=blabla]}\type{blablabla}

%D 此外，還有一個特殊的命令，\tex{specialocitem} 僅具有 answer 鍵值。可以通過
%D \tex{setupocitem} 來調整該命令的樣式。該命令標記答案，且無須任何環境包裹。

%D \startbuffer
%D \startoptclose
%D The latest \ocitem[answer=engineering]{engineer} techniques are applied to create
%D this protective \ocitem[answer=functional]{function} structure that is also
%D beautiful. The design features ten steel “sepals (萼片)” made of glass and
%D aluminium (铝). These sepals open on warm days \ocitem[answer=to give]{give} the
%D inside plants sunshine and fresh air. In cold weather, the structure stays
%D \ocitem[answer=closed]{close} to protect the plants.
%D
%D Further, the Silk Route Garden around the greenhouse \ocitem[answer=walks]{walk}
%D visitors through a journey influeVLed by the aVLient Silk Road, by which silk as
%D well as many plant species came to Britain for \ocitem[answer=the]{} first time.
%D These plants iVLluded modern Western \ocitem[answer=favorites]{favourite} such as
%D rosemary, lavender and fennel. The garden also contains a winding path that guides
%D visitors through the twelve regions of the Silk Road. The path offers over 300
%D plant species for visitors to see, too.
%D
%D The Glasshouse stands \ocitem[answer=as]{} a great achievement in contemporary
%D design, to house the plants of the southwestern part of China at the end of a path
%D retracing (追溯) the steps along the Silk Route \ocitem[answer=which that]{}
%D brought the plants from their native habitat in Asia to come to define much of the
%D \ocitem[answer=richness]{rich} of gardening in England.
%D \stopoptclose
%D \stopbuffer
%D \typebuffer
%D \getbuffer

\installnamespace          {ocitem}
\installcommandhandler \????ocitem    {ocitem}    \????ocitem

\setupocitem [%answer=,
              %color=,
              %point=,
              %showanswer=false,
              pointlabel={,\examtexts{point}},
              answerlabel={{\examtexts{answer}},},
              answercolor=red,
              answerstyle=\ss,]

\definequestion[optclose]
\definequestion[specialocitem]
\def\setupoptclose{\setupquestion[optclose]}
\def\setupspecialoptclose{\setupquestion[specialocitem]}

\setupquestion[optclose]
 [option={n,continue,text,nostopper},
  lefttext=\closebar,
  righttext=,
  reset=false,
  class=optclose,]

\setupquestion[specialocitem]
 [option={n,continue,text,nostopper},
  lefttext=\closebar,
  righttext=,
  reset=false,]

\tolerant\protected\def\ocitem[#1]#:#2%
   {\begingroup%
    \iffirstargument\setupocitem[#1]\fi%
    \useocitemstyleandcolor\c!style\c!color%
    \let\par\relax\increaseQuestionID%
    \item \parentitemnumber=\currentitemnumber\relax
          \set_count_itemlevel[ocitem]%%%% 必須命令，設定序號
          % 注意，此时 toplevel 并没有正确的关闭，因此最终的结果依然是 toplevel。
          % 但是该环境本身就被视为 toplevel                =>  5
          % 如果该环境被视为子项目时，则需要关闭 toplevel。==> 5(1)
          % 另外，关闭 toplevel 需要在 set_count_itemlevel 命令之前才会生效。
          \allowbreak\doifsomethingelse{#2}{(#2)}{}% 放置選項，類似 inlinechoice
          \edef\currentpoint{\ocitemparameter\c!point}%
          \edef\currentanswer{\ocitemparameter\c!answer}%
          \installpointoranswer[ocitem][point]%
          \installpointoranswer[ocitem][answer]%
          \installdatacollector%
          \installdatacollectorhelper%
          \initcollectanswer
          \save_question_order%
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{score}
%D 放置在 answer 環境內標記得分。

%D \starttyping
%D   score\score{3}\\
%D   score\score[type=dotfill]{30}\\
%D   \resetscore\\
%D   score\score[type=cdotfill]{30}\\
%D   \setupscore[score=calculation]
%D   score\score[type=space]{3}\\
%D   score\score[type=hfill]{3}\\
%D \stoptyping

\def\score_calc#1{% only show number
  \global\c_stepscore_temp=#1\relax%
  \ifnum\c_stepscore=0\global\c_stepscore=#1\relax\else%
  \global\c_stepscore=\numexpr\c_stepscore+\c_stepscore_temp\relax%
  \fi\number\c_stepscore%
}
\def\dotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil.\hfil}%
  \hfill\kern 0pt\relax}
\def\cdotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil$\cdot$\hfil}%
  \hfill\kern 0pt\relax}

\installnamespace                 {score}
\installcommandhandler \????score {score} \????score

\setupscore[style=\ssa,color=red,dotstyle=\ss,dotcolor=red,score=]

\tolerant\protected\def\score[#1]#:#2{\begingroup% format style
  \iffirstargument\setupscore[#1]\fi%
  \scoreparameter\c!before%
  \usescorestyleandcolor\c!style\c!color%
  \start\space\scoreparameter{dotstyle}%
  \switchtocolor[\scoreparameter{dotcolor}]%
  \doif{\scoreparameter\c!type}{}{\dotfill}%
  \doif{\scoreparameter\c!type}{space}{}%
  \doif{\scoreparameter\c!type}{hfill}{\unskip\hfill}%
  \doif{\scoreparameter\c!type}{dotfill}{\dotfill}%
  \doif{\scoreparameter\c!type}{cdotfill}{\cdotfill}%
  \space\stop\scoreparameter\c!left%
  \doif{\scoreparameter{score}}{}           {#2}%
  \doif{\scoreparameter{score}}{default}    {#2}%
  \doif{\scoreparameter{score}}{calculation}{\score_calc{#2}}%
  \doif{\scoreparameter{score}}{complex}    {#2 : \score_calc{#2}}%
  \scoreparameter\c!right\scoreparameter\c!after%
\par\endgroup}
\def\resetscore{%
  \c_stepscore_temp=0\relax%
       \c_stepscore=0\relax%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{作文格 / Writing Box}
%D
%D \startbuffer
%D \writingbox
%D  [column=12,
%D   row=15,
%D   evencolor=blue,
%D   oddcolor=darkgray,
%D   evenheight=1cm,
%D   oddheight=.5cm,
%D   align=flushleft,
%D   height=\textheight,
%D   width=\textwidth,]{}
%D \writinggrid
%D  [cellwidth=1cm,
%D   column=12,
%D   row=15,
%D   cellcolor=darkgray,
%D   align=flushleft,
%D   height=\textheight,
%D   width=\textwidth,]{}
%D \stopbuffer
%D \typebuffer
%D \getbuffer

\startuseMPgraphic{grid:writingbox}{column,row,evenheight,oddheight,}
  pageWidth   := OverlayWidth;
  evenRows    := \MPvar{row};
  evenHeight  := \MPvar{evenheight};
  oddHeight   := \MPvar{oddheight};
  evenColumns := \MPvar{column};
  oddColumns  := evenColumns + 1;

  %% 绘制偶数行
  for i = 1 upto evenColumns: % 可以根据需要调整行数
    y1 := i * (oddHeight + evenHeight) + oddHeight;
    y2 := y1 + evenHeight;
    for j = 0 upto evenRows - 1:
        x1 := j  * (pageWidth / evenRows);
        x2 := x1 + (pageWidth / evenRows);
        draw (x1, y1) -- (x2, y1) -- (x2, y2) -- (x1, y2) -- cycle
            withcolor \MPvar{evencolor};
    endfor;
  endfor;

  %% 绘制奇数行
  for i = 1 upto oddColumns: % 可以根据需要调整行数
    y1 := i * (oddHeight + evenHeight);
    y2 := y1 + oddHeight;
    draw (0, y1) -- (pageWidth, y1) -- (pageWidth, y2) -- (0, y2) -- cycle
        withcolor \MPvar{oddcolor};
  endfor;
\stopuseMPgraphic

\defineoverlay
[writingbox]
[{\uniqueMPgraphic{grid:writingbox}{
  evencolor=\framedparameter{evencolor},
   oddcolor=\framedparameter{oddcolor},
    column=\framedparameter{column},
        row=\framedparameter{row},
  evenheight=\framedparameter{evenheight},
  oddheight=\framedparameter{oddheight},
 }}]

\defineframed[writingbox]
 [offset=overlay,
  background=writingbox,
  frameoffset=.5pt,
  column=12,
  row=15,
  evencolor=blue,
  oddcolor=darkgray,
  evenheight=1cm,
  oddheight=.5cm,
  align=flushleft,
  height=\textheight,
  width=\textwidth,
  rulethickness=1pt]

% \writingbox[column=12,row=15,]{EEE\par EEEE\par EEEE}

\startuseMPgraphic{grid:writinggrid}{row,column,cellwidth,cellcolor}
  pageWidth   := OverlayWidth;
  m := \MPvar{row};       % 行数
  u := \MPvar{cellwidth}; % 单位长度
  n := \MPvar{column};    % 列数
  % 画竖线
  for i = 0 upto n:
      draw (i*u, 0) -- (i*u, m*u) withcolor \MPvar{cellcolor};
  endfor;

  % 画横线
  for j = 0 upto m:
      draw (0, j*u) -- (n*u, j*u) withcolor \MPvar{cellcolor};
  endfor;
\stopuseMPgraphic

\defineoverlay
[writinggrid]
[{\uniqueMPgraphic{grid:writinggrid}{
    column=\framedparameter{column},
       row=\framedparameter{row},
 cellwidth=\framedparameter{cellwidth},
 cellcolor=\framedparameter{cellcolor},
 }}]

\defineframed[writinggrid]
  [offset=overlay,
    background=writinggrid,
    frameoffset=.5pt,
    cellwidth=1cm,
    column=12,
    row=15,
    cellcolor=darkgray,
    align=flushleft,
    height=\textheight,
    width=\textwidth,
    rulethickness=1pt]

%  \writinggrid[column=12,row=15,]{EEE\par EEEE\par EEEE}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{模拟例子}

\dorecurse{2000}{% 提高这个数字，可以提升可生成例子的总数。所有例子共用一个总数
\expandafter\getrandomnumber \csname n_\romannumeral\recurselevel\endcsname  {1} {20}}

\dorecurse{2000}{% 一旦总例子数超过，则无法继续生成，并抛出错误。
\expandafter\getrandomnumber \csname nn_\romannumeral\recurselevel\endcsname {1} {20}}

\def\longtesttxt[#1]{%%1. \longtesttxt[\romannumeral 1]
  \ifcase\csname n_#1\endcsname%
    就像按 S 来响应错误一样。\or%0
    这个例子不太完整，因为页码没有存储在有用的地方。\or%1
    TeX 处理数学显示后，它将以下项目添加到当前垂直列表中： 惩罚、胶水、实际显示、胶水和惩罚。\or%2
    然而，它显示了一种增加或减少计数器的方法，并设置数字中的数字或相当于数字的罗马数字中的字母。\or%3
    基本问题是 “对 TeXbook 的页面引用应该如何出现在参考页面的描述区域中？” 这个例子显示了三种可能性。\or%4
    正如 TeX 不会随机连字符单词一样，它也不会在段落中的行之间随机打断数学表达式。\or%5
    TeX 仅考虑在关系（例如 = 或 < ）或二进制操作（例如 + 或 × ）之后进行中断。\or%6
    此命令提供对当前字体中所有字符的访问。号码应该在 0 -- 255 范围内。\or%7
    Junkjunk.tex文件不包含任何有用的东西，但这些行说明了一种读取辅助文件的方法。\or%8
    此命令将框寄存器中的列表副本添加到当前列表中。\or%9
    请注意，每个寄存器在创建后都会被初始化。\or%0
    此命令提供了一种直接指定分隔符的方法。\or%1
    数字应该是七个十六进制数字。\or%2
    它的前导数字必须在 0-7 范围内。该数字用作类号，其余六位数字用作 \type{\delcode} 值。\or%3
    Plain TeX 有二十多个定义，类似于：`\type{\def\rceil{\delimiter"5265307 }}'。\or%4
    这个定义意味着 \type{\rceil} 在家庭5（关闭），其小形式在家庭2位置"65，其大形式在家庭3位置"07"。\or%5
    \type{\Delimiter} 指定了一个数学符号，并以两种方式工作。\or%6
    当 TeX 寻找分隔符时（例如，在 \type{\left} 之后），它忽略了类数字，并使用剩余的六位数字作为 \type{\delcode}。\or%7
    但是，当分隔符在其他上下文中出现时，右三位数字被删除，其余四位数字成为符号的 \type{\mathcode}。\or%8
    对于 \type{\rceil}，这意味着 \type{\delcode} 是"265307，\type{\mathcode} 是"5265"。\or%9
    它首先计算子公式在轴上方和下延伸的距离。接下来，它使 y 等于刚刚计算的最大距离的两倍。\fi}

\def\shorttesttxt[#1]{%%1. \shorttesttxt[i]
  \ifcase\csname nn_#1\endcsname%
    悬挂压痕的数量\or%0
    段落中正线的宽度\or%1
    开始一个没有缩进的新段落\or%2
    告诉TeX尝试增加或减少段落中的行数\or%3
    扩展令牌，但在到达非空间令牌之前什么都不做\or%4
    只有当主垂直列表为空时，它才会结束当前工作\or%5
    该命令在内部垂直模式下是不允许的\or%6
    任意中断由三个字符序列组成\or%7
    另一个无效号码被传递了\or%8
    来自假部分的条件命令\or%9
    线路需要转移的金额\or%0
    用于指定显示样式\or%1
    关系后断线的惩罚\or%2
    此命令定义了宏\or%3
    家庭的脚本字体\or%4
    尺寸没有变化\or%5
    额外的空间\or%6
    左边的段落\or%7
    当前线宽\or%8
    文本样式\or%9
    序列\fi}

\tolerant\protected\def\choicenum[#1][#2][#3]{
  \ifnum\csname nn_#1\endcsname < 6
    \expandafter\startcitem[*]{\shorttesttxt[\romannumeral #2]} \stopcitem
  \else
    \expandafter\startcitem   {\shorttesttxt[\romannumeral #3]} \stopcitem
  \fi
}

\newcount\LNUM\LNUM=1\relax
\newcount\CNUM\CNUM=1\relax
\newcount\DNUM\DNUM=1\relax
\newcount\ENUM\ENUM=2\relax

\protected\def\example@choice#1{
    \setupquestion[point=2]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax\global\advance\DNUM by 2\relax\global\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \stopchoice
            % \startanswer
            % \input knuthmath
            % \stopanswer
    \stopquestion}
}
\def\example@fillin#1{
    \setuppitem   [point=3]
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem
          \longtesttxt[\romannumeral\CNUM]\fillin[]{\fillinanswer}
        \stoppitem
        % \startanswer
        %       \input knuthmath
        %     \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@pitem#1{
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem[answer={answer : \recurselevel},point={\number\CNUM}]
        \longtesttxt[\romannumeral\CNUM]\stoppitem
        % \startanswer
        %       \input knuthmath
        % \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@material#1{
    \startmaterial
    \input knuthmath
    \stopmaterial
    \setupquestion[point=6]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax%
            \global\advance\DNUM by 2\relax%
            \global\advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \stopchoice
            % \startanswer
            %   \input knuthmath
            % \stopanswer
    \stopquestion}
}
\def\example@close#1{
    \startclose
    \def\closechoicex{\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\closechoice[\closechoicex,{[*]\closechoicex},\closechoicex]
      \longtesttxt[\romannumeral\CNUM]}
    \stopclose
}

\def\example@optclose#1{
    \startoptclose
    \def\closechoicex{{\ss\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
          \global\advance\CNUM by 1\relax
        }\ocitem[point=4,answer={\shorttesttxt[\romannumeral\DNUM]}]%
                {\closechoicex,\closechoicex,\closechoicex}
      \longtesttxt[\romannumeral\CNUM]}
    \stopoptclose
}

\def\example@specialoptclose#1{
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\specialocitem[point=2,answer={\shorttesttxt[\romannumeral\DNUM]}]{}
        \global\advance\DNUM by 1\relax
      \longtesttxt[\romannumeral\CNUM]}
}

%\setupanswer[showanswer=true,showscript=true,
%              frame=on,framecolor=red,
%              rulethickness=2pt,
%              scriptcontent={\null\vbox to 4\baselineskip{}\relax}]
%\chapter{}
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%%
%\chapter{}
%
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%\page
%\dorecurse{30}{\typeanswerbychap{1}\par}
%\resetanswerid%
%\dorecurse{30}{\typeanswerbychap{2}\par}
%\resetanswerid
%\noindent\typeanswerlist[1][6]{30}
%\resetanswerid
%\noindent\typeanswerlist[2][6]{30}
%\type@answer@i[6*5,1,28]

%D \section{打印答案 / Print answer / 答えの輸出}

\newcount\c_qid_answer

\def\resetanswerid{\global\c_qid_answer=1\relax}

%D Example 1:
%D \starttyping
%D \dorecurse{5}{\typeanswerbychap{1}} % grab answer from chapter 1
%D \newcount\c_tempa\c_tempa=2\relax   % grab answer from 0-\the\c_tempa(chapter=0 qid=\the\c_tempa)
%D \dorecurse{5}{\typeanswerbychap[\c_tempa]{0}\advance\c_tempa by 1\relax}
%D \stoptyping
\tolerant\def\typeanswerbychap[#1]#:#2%
 {\begingroup% #1 = QID， #2 =chap number
  \ifparameter#1\or
    \doifsomethingelse{\scratchcounterone#1}{\scratchcounterone#1}{\scratchcounterone\zerocount}%
    \c_qid_answer=\numexpr\scratchcounterone -1\relax\fi
  \scratchcounter#2\relax
  \global\advance\c_qid_answer by 1\relax
  \datasetvariable{Answer_collector}{\the\scratchcounter-\the\c_qid_answer}{answer}%
  \endgroup}

%D Example 2:
%D \starttyping
%D \typeanswerdirect{0-5} % grab answer from chapter 0 qid 5
%D \stoptyping
\def\typeanswerdirect#1{% #1 = qid，需要自行輸入來獲取某個題目的答案
  \datasetvariable{Answer_collector}{#1}{answer}}

%D Example 3:
%D \starttyping
%D \typeanswerlist{30}       % type answer from chap 0 and get qid 1 - 30
%D \typeanswerlist[1]{30}    % type answer from chap 1 and get qid 1 - 30
%D \typeanswerlist[1][2]{30} % type answer from chap 1 and get qid 2 - 30
%D \stoptyping
\tolerant\protected\def\typeanswerlist[#chapno][#startno]#*#:#total{%#1 = chapter number
  \begingroup
  \ifparameter#chapno\or
    \doifsomethingelse{\scratchcounterone  #chapno }{\scratchcounterone  #chapno }{\scratchcounterone  \zerocount}\fi
  \ifparameter#startno\or
    \doifsomethingelse{\scratchcountertwo  #startno}{\scratchcountertwo  #startno}{\scratchcountertwo  \zerocount}\fi
  \ifparameter#total\or
    \doifsomethingelse{\scratchcounterthree#total  }{\scratchcounterthree#total  }{\scratchcounterthree\zerocount}\fi
  \c_qid_answer=\scratchcountertwo
  \dorecurse{\the\scratchcounterthree}{% answer amount
    \datasetvariable{Answer_collector}{\the\scratchcounterone-\the\c_qid_answer}{answer},%
  \advance\c_qid_answer by 1\relax}%
  \endgroup}

%D Example 4:
%D \starttyping
%D \typeanswertable[2,5]% #3 = 0 #4 = 1
%D \typeanswertable[2,5][0]% #4 = 1
%D \typeanswertable[2,5][0][6] % type answer in table
%D  ----------------------------------
%D |  ID  |  ID  |  ID  |  ID  |  ID  | #1 = 2
%D |  01  |  02  |  03  |  04  |  05  | #2 = 5
%D |  AS  |  AS  |  AS  |  AS  |  AS  | #3 = from chap 0
%D |  01  |  02  |  03  |  04  |  05  | #4 = type start QID 6
%D ------------------------------------
%D \stoptyping
\newcount\answer@seq@tempa
\newcount\answer@seq@tempb
\tolerant\def\typeanswertable[#rows,#columns]#*[#chapno]#*[#startno]%
 {\begingroup
  \ifarguments\or\or
  \scratchcounter    \zerocount\relax
  \scratchcounterone \plusone  \relax
  \or
  \doifsomethingelse{\scratchcounter    #chapno \relax}
                    {\scratchcounter    #chapno \relax}
                    {\scratchcounter    \zerocount\relax}
  \scratchcounterone \plusone  \relax
  \or
  \doifsomethingelse{\scratchcounter    #chapno \relax}
                    {\scratchcounter    #chapno \relax}
                    {\scratchcounter    \zerocount\relax}
  \doifsomethingelse{\scratchcounterone #startno\relax}
                    {\scratchcounterone #startno\relax}
                    {\scratchcounterone \zerocount\relax}
  \or\fi
  \answer@seq@tempa=\numexpr\scratchcounterone-1\relax
  \answer@seq@tempb=\numexpr\scratchcounterone-1\relax
  % \the\answer@seq@tempa == \the\answer@seq@tempb
  \bTABLE
    \dorecurse{#rows}{
      \bTR
      \dorecurse{#columns}{\advance\answer@seq@tempa by 1\relax
        \expanded{\bTD\tt\datasetvariable{Answer_collector}{\the\scratchcounter-\the\answer@seq@tempa}{userorder}\eTD}}%
      \eTR\bTR
      \dorecurse{#columns}{\advance\answer@seq@tempb by 1\relax
          \expanded{\bTD\ss\datasetvariable{Answer_collector}{\the\scratchcounter-\the\answer@seq@tempb}{answer}\eTD}}%
      \eTR}%
  \eTABLE
\par\endgroup}

%D Example 5:
%D \starttyping
%D \typeanswertablealt[4,2]% #3 = 0 #4 = 1
%D \typeanswertablealt[4,2][1]% #4 = 1
%D \typeanswertablealt[4,2][1][2] % type answer in table
%D  ----------------------------------
%D |  ID  |  01  |  AS  |  01  | #1 = 4
%D |  ID  |  02  |  AS  |  02  | #2 = 2
%D |  ID  |  03  |  AS  |  03  | #3 = from chap 0
%D |  ID  |  04  |  AS  |  04  | #4 = type start QID 2
%D ------------------------------------
%D \stoptyping
\tolerant\def\typeanswertablealt[#rows,#columns]#*[#chapno]#*[#startno]%
 {\begingroup\ifarguments 0\or
  \scratchcounter      \zerocount\relax
  \scratchcounterthree \plusone  \relax
  \or
  \scratchcounter      \zerocount\relax
  \scratchcounterthree \plusone  \relax
  \or
  \scratchcounterthree \plusone  \relax% for startno
  \doifsomethingelse{\scratchcounter      #chapno \relax}
                    {\scratchcounter      #chapno \relax}
                    {\scratchcounter      \zerocount\relax}
  \or
  \doifsomethingelse{\scratchcounter      #chapno \relax}
                    {\scratchcounter      #chapno \relax}
                    {\scratchcounter      \zerocount\relax}
  \doifsomethingelse{\scratchcounterthree #startno\relax}
                    {\scratchcounterthree #startno\relax}
                    {\scratchcounterthree \zerocount\relax}
  \or\fi
  \scratchcounterone #rows   \relax
  \scratchcountertwo #columns\relax
  \answer@seq@tempa=\numexpr\scratchcounterthree-1\relax
  \def\getdata##1{\datasetvariable
                 {Answer_collector}%
                 {\the\scratchcounter-\the\answer@seq@tempa}%
                 {##1}}%
  \bTABLE
    \dorecurse{\the\scratchcounterone}{\bTR
      \dorecurse{\the\scratchcountertwo}{\advance\answer@seq@tempa by 1\relax
        \expanded{\bTD\tt\getdata{userorder}\eTD}
        \expanded{\bTD\ss\getdata{answer}   \eTD}
       }
    \eTR}
  \eTABLE
\par\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{模式設置 / Mode Setting/ モードセット}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definemode[teacher][keep]
\definemode[student][keep]
\definemode[check]  [keep]
\startmode[teacher]
  \mode_showanswertrue
  \mode_showpointtrue
  % \setupquestion[showanswer=true,showpoint=true]
  % \setupchoice  [showanswer=true,showpoint=true]
  % \setupcitem   [showanswer=true,showpoint=true]
  % \setuppitem   [showanswer=true,showpoint=true]
  % \setupclose   [showanswer=true,showpoint=true]
  % \setupocitem  [showanswer=true,showpoint=true]
  % \setupanswer  [showanswer=true,showpoint=true,showscript=false]
\stopmode
\startmode[student]
  \mode_showanswerfalse
  \mode_showpointfalse
  % \setupquestion[showanswer=false,showpoint=true]
  % \setupchoice  [showanswer=false,showpoint=true]
  % \setupcitem   [showanswer=false,showpoint=true]
  % \setuppitem   [showanswer=false,showpoint=true]
  % \setupclose   [showanswer=false,showpoint=true]
  % \setupocitem  [showanswer=false,showpoint=true]
  % \setupanswer  [showanswer=false,showpoint=true,showscript=false]
\stopmode
\startmode[check]
  \mode_checktrue
\stopmode
\def\showanswer{\mode_showanswertrue\setupanswer[showscript=false]}
\def\hideanswer{\mode_showanswerfalse\setupanswer[showscript=true]}
\let\showpoint\mode_showpointtrue
\let\hidepoint\mode_showanswerfalse
\let\showchekinfo\mode_checktrue
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\protect
\stopmodule
\endinput