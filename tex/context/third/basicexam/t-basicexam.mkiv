% macros=mkvi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \module
%D   [     file=t-basicexam,
%D      version=2024-10-24,
%D        title=basicexam,
%D     subtitle=Memoir Ever,
%D       author=商无辛(Shueng Mosan),
%D         date=2024-6-1,
%D    copyright=商无辛(Shueng Mosan),
%D      license=,
%D          url=]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\startmodule[basicexam]
\unprotect
%D \placecontent
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{模塊參數 / Module Setups / モジュール　セットアップ}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \starttabulate[|r|lB|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC mode=   \NC student \NC will show point and hide answer                \NC\NR
%D \NC mode=   \NC teacher \NC will show point and answer                     \NC\NR
%D \NC mode=   \NC check   \NC will show some infos to console                \NC\NR
%D \HL
%D \NC layout= \NC twoup   \NC print two virtual pages on each physical page. \NC\NR
%D \NC layout= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \NC footer= \NC default \NC show subject and page at footer                \NC\NR
%D \NC footer= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \stoptabulate

\setupmodule[mode=student,layout=default,footer=none]
% \doifnotmode{mkiv}{\writestatus{error}{needs luatex}\wait\end}% check context version

%D 定义关键词
\immutable\def\m!basicexam{basicexam}

\definesystemconstant{close}
\definesystemconstant{choice}
\definesystemconstant{answer}
\definesystemconstant{problem}
\definesystemconstant{question}
\definesystemconstant{material}
\definesystemconstant{optclose}

\startinterface all
\setinterfaceconstant {class}          {class}
\setinterfaceconstant {answer}         {answer}
\setinterfaceconstant {point}          {point}
\setinterfaceconstant {example}        {example}
\setinterfaceconstant {showanswer}     {showanswer}
\setinterfaceconstant {showpoint}      {showpoint}
\setinterfaceconstant {showscript}     {showscript}
\setinterfaceconstant {answerstyle}    {answerstyle}
\setinterfaceconstant {answercolor}    {answercolor}
\setinterfaceconstant {answerlabel}    {answerlabel}
\setinterfaceconstant {pointstyle}     {pointstyle}
\setinterfaceconstant {pointcolor}     {pointcolor}
\setinterfaceconstant {pointlabel}     {pointlabel}
\setinterfaceconstant {autoright}      {autoright}
\setinterfaceconstant {inlineleft}     {inlineleft}
\setinterfaceconstant {inlineright}    {inlineright}
\setinterfaceconstant {inlinechoice}   {inlinechoice}
\setinterfaceconstant {recordanswer}   {recordanswer}
\stopinterface

% 1 for module
% 2 for question
% 3 for papertitle
% 9 for font

\startinterface english
  \setinterfacemessage\m!basicexam{1}  {There are unknown parameters in --, please check.}
  \setinterfacemessage\m!basicexam{2}  {Question   --: answer is --.}
  \setinterfacemessage\m!basicexam{200}{QuestionID --: order  is --.}
  \setinterfacemessage\m!basicexam{201}{The answer environment must be preceded by 
                                        a problem environment in order to get a score!}
  \setinterfacemessage\m!basicexam{3}  {You defined --, but you don't assign a value to it. Please check.}
  \setinterfacemessage\m!basicexam{9}  {-- is not installed, some -- will not display properly.}
\stopinterface

% \showmessage\m!basicexam{2}{}%

\newif\iflay_twoup   \lay_twoupfalse
\newif\ifhdr_default \hdr_defaultfalse

\processallactionsinset[\currentmoduleparameter{mode}][
     teacher=>{\enablemode[teacher]},
     student=>{\enablemode[student]},
       check=>{\enablemode[check]},
  \v!default=>{\enablemode[student]},
  \v!unknown=>\showmessage\m!basicexam{1}{mode},
]

\processallactionsinset[\currentmoduleparameter{layout}][
       twoup=>\lay_twouptrue,
        none=>\relax,
  \v!default=>\relax,
  \v!unknown=>\showmessage\m!basicexam{1}{layout},
]

\processallactionsinset[\currentmoduleparameter{footer}][
        none=>{\relax},
  \v!default=>\hdr_defaulttrue,
  \v!unknown=>\showmessage\m!basicexam{1}{footer},
]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 注意 ⚠️
%% 在定义命令时，参数后不可以直接断行，会导致参数查找失败。
%%（可能是因为 tex 认为参数后断行，则参数的结束分界符为断行，而非括号）
%% \def\foo#1{ .. some word ...}   \foo{..} 将正确运行
%% \def\foo#1
%%     { .. some word ...}         \foo{..} 将导致失败
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 注意 ⚠️
%% 在 lua 中使用 循环 等结构时，要注意 % 百分比符号的使用。不可以直接在关键字后
%% 使用。会导致运行出错：'do' expected near 'docontext' 等消息。
%% for i > 10 do % do 和 % 号之间有空格，  会正常运行
%% for i > 10 do%  do 和 % 号之间没有空格，会运行错误
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%\newcount\itindexn \itindexn=1
%%\def\itvariable
%%  {\ifcase\itindexn%
%%    \or a\or b\or c\or d\or e%
%%    \or f\or g\or h\or i\or j%
%%    \or k\or l\or m\or n\or o%
%%    \or p\or q\or r\or s\or t%
%%    \or u\or v\or w\or x\or y\or z
%%  \fi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\begingroup
%\catcode`\%=12\relax
%\gdef\percentchar{%}
%\endgroup
%\ctxlua{context(string.format("\percentchar8s",456))}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{尚未處理的組合　/ Command under handling / 未完成のコマンド}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D 設置頁面
%D 2UP Printing
%D \starttyping
%D \setuppapersize[user pagesize][real pagesize,real orientation]
%D \setuparranging[page arrange method]
%D more info : https://wiki.contextgarden.net/Command/setuparranging
%D             https://wiki.contextgarden.net/Imposition
%D \stoptyping
%D 例如：
%D \starttyping
%D \setuppapersize[A4][A3,landscape]
%D \setuparranging[2SIDE]%[2UP]
%D \setuppagenumbering[alternative=singlesided]%{doublesided}]
%D \stoptyping

\iflay_twoup
  \setuppapersize[A4][A3,landscape]
  \setuparranging[2SIDE]% 2SIDE start page at odd [2UP] start at even
  \setuppagenumbering[alternative={doublesided}]%singlesided]
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{定义其后环境所需命令}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newwrite\examanswer

\newif\ifonearguments
\newif\iftwoarguments
\newif\ifthreearguments
\newif\ifmode_debug          \newif\ifenv_question    \newif\ifenv_toplevel
\newif\ifmode_check          \newif\ifenv_problem     \newif\ifenv_botlevel
\newif\ifmode_showanswer     \newif\ifenv_choice      \newif\ifenv_answer
\newif\ifmode_showpoint      \newif\ifenv_material    \newif\ifitem_pitem
\newif\ifmode_showscript     \newif\ifenv_close       \newif\ifitem_fillin
\newif\ifmode_example        \newif\ifenv_writing     \newif\ifitem_inlinechoice
\newif\ifcontinue_counter    \newif\ifenv_subwriting  
\newif\ifclose_counter_reset 

\newdimen\d_width_cit
\newdimen\d_width_cit_max
\newdimen\d_compared_maxwidth
\newdimen\d_maxwidth_with_label

\newdimen\c_steppoint            
\newcount\c_stepscore
\newcount\c_closetest
\newdimen\c_steppoint_temp 
\newcount\c_stepscore_temp
\newcount\c_closetest_temp
\newcount\c_totalitemnumber
\newcount\c_currentitemnumber
\newcount\c_totalchoicenumber
\newcount\c_availablecolumns
\newcount\c_envnumber
\newcount\c_fillinnumber
\newcount\c_examplenumber
\newdimen\c_bottotalpoint
\newcount\c_strc_question_nesting
\newcount\parentitemnumber% \parentitemnumber 会等于父级列表环境的序号

\definecounter[Unicode][way=bychapter,start=1]
\definecounter[Unicode_toplevel]        % for level 1 : question or problem
\definecounter[Unicode_midlevel]        % for level 2 : problem or level 1
\definecounter[Unicode_botlevel]        % for level 3 : only for level 2
\definecounter[strc_close_counter]      % 为 close 环境可以继续 question 序号而设置

\def\inititemnumber     {\global        \c_currentitemnumber =  0\relax
                         \global        \c_totalitemnumber   =  0\relax}
\def\incrementitemnumber{\global\advance\c_currentitemnumber by 1\relax}
\def\recurseditemnumber%%遞歸出總序號
  {\ifnum       \c_totalitemnumber > \c_currentitemnumber
        \global \c_totalitemnumber = \c_totalitemnumber
  \else \global \c_totalitemnumber = \numexpr\c_currentitemnumber\relax\fi
  \ifenv_toplevel\ifnum
                \c_totalitemnumber = 0 \c_totalitemnumber\plusone\relax\fi
  \else \ifenv_botlevel
        \xdef\item_bottotalitemnumber_temp{\the\c_totalitemnumber}\else
        \global \c_totalitemnumber = \rawcountervalue[Unicode_midlevel]\fi\fi}
%% 這三個命令可以遞歸小題總數，
%% 他們分別封裝在 set_envcounter, set_itemcount,installdatacollectorhelper 中

\def\save_question_order{\setcounter[strc_close_counter][\currentitemnumber]\savecounter[strc_close_counter]}
\def\restore_question_order{\restorecounter[strc_close_counter]}

\def\EQuestionID{\jobname-E-\somenamedheadnumber{chapter}{current}-\number\c_examplenumber}
\def\increaseEQuestionID{\advance\c_examplenumber by  1\relax}
\def\decreaseEQuestionID{\advance\c_examplenumber by -1\relax}

\def\QuestionID{\jobname-\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}
\def\increaseQuestionID{\ifmode_example\increaseEQuestionID\else\incrementcounter[Unicode]\fi}
\def\decreaseQuestionID{\ifmode_example\decreaseEQuestionID\else\decrementcounter[Unicode]\fi}

\def\NextQuestionID{\jobname-\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\nextcountervalue[Unicode]\fi}
\def\PrevQuestionID{\jobname-\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\Prevcountervalue[Unicode]\fi}

\def\HelperID{\jobname-\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]\ifenv_botlevel -\rawcountervalue[Unicode_midlevel]\else\fi}
\def\topHelperID{\jobname-\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]}
\def\midHelperID{\jobname-\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]-\rawcountervalue[Unicode_midlevel]}

\definebar           [FillinText]
\definemarking       [title]
\definemarking       [subject]
\defineitemgroup     [env:question]
\defineitemgroup     [env:problem]
\defineitemgroup     [env:example]
\defineitemgroup     [env:choice]
\definedataset       [ExamDataset]
\definedataset       [ExamDatasetHelper]
\definetextbackground[env:answer]

\def\exam_write_answer{%
  \immediate\openout\examanswer=\jobname -answer.txt\relax
  \immediate\write\examanswer{
    \QuestionID           \space\string @
    \currentenvironment   \space\string @
    \currentuserorder     \space\string @
    \expand\currentanswer        \space\string @
    \currentorder         \space\string @
    \datasetvariable{ExamDataset}{\QuestionID}{totalnumber}%
                          \space\string @
    \currentpoint         \space\string @}% \closeout\examanswer
}

\ifmode_check
  \immediate\openout\examanswer=\jobname -answer.txt\relax
  \immediate\write\examanswer{
    \string questionid      \space\string @
    \string environment     \space\string @
    \string userorder       \space\string @
    \string answer          \space\string @
    \string currentorder    \space\string @
    \string totalitemnumber \space\string @
    \string currentpoint    \space\string @%
    }
\fi

\startuseMPgraphic{rules:under:wave}
    vardef lsin primary x =
        lua("mp.print(math.sin(" & decimal x & "))")
    enddef ;
    draw function(1, "x", "lsin(1.2*x)", 0, RuleWidth, .1pt)
         shifted (0,RuleFactor*RuleOffset+RuleDepth)
         withpen pencircle scaled RuleThickness
         withcolor RuleColor ;
    setbounds currentpicture to unitsquare xysized(RuleWidth,RuleHeight) ;
\stopuseMPgraphic

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% no need here
%\defineconversion [hiragana]      [あ,い,う,え,お,か,き,く,け,こ,さ,し,す,せ,そ,
%                                   た,ち,つ,て,と,な,に,ぬ,ね,の,は,ひ,ふ,へ,ほ,
%                                   ま,み,む,め,も,や,ゆ,よ,ら,り,る,れ,ろ,わ,ん]
%\defineconversion [katakana]      [ア,イ,ウ,エ,オ,カ,キ,ク,ケ,コ,サ,シ,ス,セ,ソ,
%                                   タ,チ,ツ,テ,ト,ナ,ニ,ヌ,ネ,ノ,ハ,ヒ,フ,ヘ,ホ,
%                                   マ,ミ,ム,メ,モ,ヤ,ユ,ヨ,ラ,リ,ル,レ,ロ,ワ,ン]
%\defineconversion [hiragana-iroha][い,ろ,は,に,ほ,へ,と,ち,り,ぬ,る,を,わ,か,よ,
%                                   た,れ,そ,つ,ね,な,ら,む,う,ゐ,の,お,く,や,ま,
%                                   け,ふ,こ,え,て,あ,さ,き,ゆ,め,み,し,ゑ,ひ,も,
%                                   せ,す,ん]
%\defineconversion [katakana-iroha][イ,ロ,ハ,ニ,ホ,ヘ,ト,チ,リ,ヌ,ル,ヲ,ワ,カ,ヨ,
%                                   タ,レ,ソ,ツ,ネ,ナ,ラ,ム,ウ,ヰ,ノ,オ,ク,ヤ,マ,
%                                   ケ,フ,コ,エ,テ,ア,サ,キ,ユ,メ,ミ,シ,ヱ,ヒ,モ,
%                                   セ,ス,ン]
%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ego=section isea=subsection
\definelabelclass [exam] [0]
\setuplabeltext   [cn]   [section={第,部分},subsection={第,节}]
\setupexamtext    [cn]   [point={分}, answer={答案:},  page={第,页},    totalpage={共,页},       writing={参见参考作文}]
\setupexamtext    [hans] [point={分}, answer={答案:},  page={第,页},    totalpage={共,页},       writing={参见参考作文}]% work with memos module
\setupexamtext    [hant] [point={分}, answer={答案:},  page={第,頁},    totalpage={共,頁},       writing={参见参考作文}]% work with memos module
\setupexamtext    [en]   [point={pts},answer={answer:},page={pages},    totalpage={total,pages}, writing={see example}]
\setupexamtext    [ja]   [point={点}, answer={答え:},  page={第,ページ},totalpage={共,ページ},   writing={see example}] 

\definehead [tu]   [chapter]
\definehead [ego]  [section]       % me  latin
\definehead [isea] [subsection]    % he or she latin
\definehead [heu]  [subsubsection] % och
\setuphead  [tu]   [placehead=empty]
\setuphead  [ego]  [sectionsegments=section,style=\ssa]
\setupheads [isea] [style=\hwa]
\setupheads [tu,ego,isea]
                   [indentnext=yes,align=flushleft,
                   before={\blank[quarterline]},
                   after={\blank[quarterline]},
                   sectionconversionset=examnum]
\definelist[tu]
\setuplist [tu][style={\feature[+][tabularnumbers]}]
\definestructureconversionset[examnum][chinesenumerals][chinesenumerals]

\ifhdr_default
  \definedelimitedtext    [paren]   [location=text]
  \setupdelimitedtext     [paren:1] [left={（\nobreak}, right={\nobreak）}]
  \setupdelimitedtext     [paren:2] [left={\,[~}, right={~]\,}]
  \setupdelimitedtext     [paren:3] [left={\,\{~}, right={~\}\,}]
  \setupmarking[subject][expansion=yes]
  \setupfooter [state=start]
  \startsetups hdr:infos
  \framed[height=max,align=lohi,frame=off]{%
    \getmarking[subject][page][current]
    \paren{\examtexts{page}{\pagenumber},\ %
           \examtexts{totalpage}{\lastpagenumber}}%
    }
  \stopsetups
  \setupfootertexts[\setups{hdr:infos}]
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\choice_answerstatus        {\datasetvariable{Choice_collector}{\QuestionID}{answerstatus}}
\def\point_totalpoint           {\datasetvariable{ExamDataset}{\currentQuestionID}{totalpoint}}
\def\point_bottotalpoint        {\datasetvariable{ExamDataset}{\currentQuestionID}{bottotalpoint}}
\def\item_totalitemnumber       {\datasetvariable{ExamDataset}{\currentQuestionID}{totalitemnumber}}
\def\item_bottotalitemnumber    {\datasetvariable{ExamDataset}{\currentQuestionID}{bottotalitemnumber}}
\def\point_point                {\datasetvariable{ExamDataset}{\currentQuestionID}{point}}
\def\answer_answer              {\datasetvariable{ExamDataset}{\currentQuestionID}{answer}}
\def\currentavailablecolumns    {}
\def\currentrealavailablecolumns{}
\def\currentitemmaxwidth        {}
\def\currentanswerstatus        {}
\def\example_mode{\ifmode_example NOTICE: MODE EXAMPLE IS ON !\fi}
\def\currentlevel{\ifenv_toplevel <env_toplevel>\else
                  \ifenv_botlevel <env_botlevel>\else
                                  <env_midlevel>\fi\fi}

\def\mode_status{\ifmode_check      <M:C>\fi
                 \ifmode_showanswer <M:A>\fi
                 \ifmode_showpoint  <M:P>\fi
                 \ifmode_example    <M:E>\fi}

\startluacode
  local report = logs.reporter("question info")

  local function center_text(text, total_width)
      local text_length   = #text
      local left_padding  = math.floor((total_width - text_length) / 2)
      local right_padding = total_width - left_padding - text_length
      return string.rep(' ', left_padding) .. text .. string.rep(' ', right_padding)
  end

  local function center_report(centerinfos)
      for _, row in ipairs(centerinfos) do
          local centered_line = center_text(row, 70)
          report(centered_line)
      end
  end

  local lines = {
      "NOTICE: MODE CHECK IS ON !",
    -- "Notice,Cinfos only show choice env information",
    -- "CU means 'current' , if CUuserorder ≠ CUorder,",
    -- "It maybe because START parameter is enabled.  ",
      "Notice: MODE EXAMPLE wont provide data infos   "
  }

  function formatted_report(data)
    -- 定义格式化字符串，加入竖线作为分隔符
    local format_str = "%15s  %-20s  %15s  %-20s"
    center_report(lines,70)
    -- 输出数据
    for _, row in ipairs(data) do
        report(format_str:format(row[1], row[2], row[3], row[4]))
    end
  end
\stopluacode

\def\check_info{
  {"","\example_mode","",""},
  {"Name         ", "Content                                                             ",
   "Name         ", "Content                                                             "},
  {"CUlevel      ", "\currentlevel                                                       ",
   "CUenvironment", "\currentenvironment                                                 "},
  {"CUitemgroup  ", "\datasetvariable{ExamDataset}{\QuestionID}{envid}              ",
   "CUparen      ", "\currentparentitemgroup                                             "},
  {"QuestionID   ", "\QuestionID                                                         ",
   "HelperID     ", "\HelperID                                                           "},
  {"order        ", "\currentorder                                                       ",
   "userorder    ", "\currentuserorder                                                   "},
  {"point        ", "\datasetvariable{ExamDataset}    {\QuestionID}{point}          ",
   "             ", "                                                                    "},
  {"totalnumber  ", "\datasetvariable{ExamDataset}    {\QuestionID}{totalnumber}    ",
   "Htotalnumber ", "\datasetvariable{ExamDatasetHelper}{\HelperID}{totalitemnumber}"},
  {"totalpoint   ", "\datasetvariable{ExamDataset}    {\QuestionID}{totalpoint}     ",
   "Htotalpoint  ", "\datasetvariable{ExamDatasetHelper}{\HelperID}{totalpoint}     "},
  {"CUCmaxwidth  ", "\datasetvariable{ExamDatasetHelper}{\HelperID}{itemmaxwidth}   ",
   "Cavailable   ", "\datasetvariable{ExamDatasetHelper}{\HelperID}{availablecolumns}&%
                     \datasetvariable{ExamDatasetHelper}{\HelperID}{realavailablecolumns}"},
  % {"answer       ", "\datasetvariable{ExamDataset}    {\QuestionID}{answer}         ",
  %  "             ", "                                                                    "},
  % {"Hanswer      ", "\datasetvariable{ExamDatasetHelper}{\HelperID}{answer}         ",
  %  "             ", "                                                                    "},
  {"mode.check   ", "\mode_status                                                        ",
   "Canswerstatus", "\choice_answerstatus                                                "},
}

\def\show_check_info#1%
 {\begingroup
  \ifmode_check%
    \ifdefined\currentorder%
      \let\old_currentorder\currentorder
      \let\old_currentorder\currentuserorder
    \else%
      \def\currentorder{    {\ttx currentorder didn't define}}%
      \def\currentuserorder{{\ttx currentorder didn't define}}%
    \fi%
    \writestatus{question info}{----------------------------------------------------------------}%
    \directlua{formatted_report({#1})}%
    \writestatus{question info}{\space\space\space\space\space\space\space\space answer
                    \space\space\datasetvariable{ExamDataset}    {\QuestionID}{answer}}%
    \writestatus{question info}{\space\space\space\space\space\space\space      Hanswer
                    \space\space\datasetvariable{ExamDatasetHelper}{\HelperID}{answer}}%
    \writestatus{question info}{\space answercontent
                    \space\space\datasetvariable{ExamDataset}    {\QuestionID}{answercontent}}%
    \writestatus{question info}{----------------------------------------------------------------}%
  \fi
  \endgroup}

\def\initcollectanswer{\directlua{MultiAnswerCollector = {}}}
\def\collectanswer#1{\directlua{table.insert(MultiAnswerCollector,[[#1]])}}
\def\collectedanswer{\directlua{tex.sprint(table.concat(MultiAnswerCollector,","))}}
\initcollectanswer

\def\set_envitem_counter{%
  \initcollectanswer% 初始化多项答案收集器
  \ifdefined\currentenvnumber
        \edef\prevenvnumber{\currentenvnumber}\fi
  \ifenv_answer    \advance\c_envnumber by 10\relax\else
                    \global\c_envnumber=0\relax%
  \ifenv_question   \global\c_envnumber=1\relax \edef\currentenvironment  {question}\fi
  \ifenv_problem    \global\c_envnumber=2\relax \edef\currentenvironment   {problem}\fi
  \ifenv_choice     \global\c_envnumber=3\relax \edef\currentenvironment    {choice}\fi
  \ifenv_material   \global\c_envnumber=4\relax \edef\currentenvironment  {material}\fi
  \ifenv_close      \global\c_envnumber=5\relax \edef\currentenvironment     {close}\fi
  \ifenv_writing    \global\c_envnumber=6\relax \edef\currentenvironment   {writing}\fi
  \ifenv_subwriting \global\c_envnumber=7\relax \edef\currentenvironment{subwriting}\fi
  \fi
  \doif{\csname \currentenvironment parameter\endcsname\c!example}{true}% 测试是否开启 example mode
       {\mode_exampletrue\global\c_envnumber=999\relax}%
  \edef\currentenvnumber{\the\c_envnumber}}

%% 注意，只要某个条件不关闭，他就会一直开启。例如：
% {\env_topleveltrue
%    1. \ifenv_toplevel top \else bot \fi  % top
%    \env_toplevelfalse\env_botleveltrue   % 关闭了 toplevel 才能正确输出
%    2. \ifenv_toplevel top \else bot \fi  % bot
%    3. \ifenv_botlevel bot \else top \fi} % bot
% 一定要关闭，因为默认并没有设置 top 和 bot 的二元关系。
% 所以即便是专门测试 bot 是否开启的 3 ，
% 也只会在关闭 top 的情况下获取正确的结果。

\def\current_user_order#1% get user order which can by changed by START
 {\number \csname #1order\endcsname% 獲得的結果類似於 2(4)
  \ifenv_toplevel\else
    (\ifnum \rawcountervalue[Unicode_midlevel]=0\else
            \rawcountervalue[Unicode_midlevel]\fi
      \ifnum\rawcountervalue[Unicode_botlevel]=0\else
      \ifnum\rawcountervalue[Unicode_midlevel]>0 -\fi
            \rawcountervalue[Unicode_botlevel]\fi
  )\fi}

\def\set_currentuserorder[#1]{% set order that user setted
  \ifcsname #1order\endcsname\else
    \expandafter\newcount\csname #1order\endcsname\fi
  \ifenv_toplevel\csname #1order\endcsname=\currentitemnumber
            \else\csname #1order\endcsname=\parentitemnumber \fi
  \edef\currentid{\QuestionID}%
  \edef\currentorder{% get unique order ( no chapter number )
    \somenamedheadnumber{chapter}{current}-%
    \rawcountervalue[Unicode_toplevel]-%
    \rawcountervalue[Unicode_midlevel]-%
    \rawcountervalue[Unicode_botlevel]}%
  \xdef\currentuserorder{\current_user_order{#1}}%获取 上面定义的 #1order
  \expandafter\show_check_info{\check_info}%
% % ==  \currentid ++ \currentorder @@ \currentorder
}%专为子级设计来获取父级序号，否则直接获取当前序号

\tolerant\def\set_count_envlevel[#1]{% #1 定義 #2order
  \env_topleveltrue
  \ifdefined\prevenvnumber
        \env_toplevelfalse
        \doifelse{\prevlevel}%
          {<env_midlevel>}%
          {\env_botleveltrue \incrementitemnumber               }%
          {\env_botlevelfalse\incrementitemnumber\inititemnumber}%
  \else \env_topleveltrue    \inititemnumber\fi
  \edef\prevlevel{\currentlevel}%
  \xdef\currentQuestionID{\jobname-\ifmode_example\EQuestionID\else
      \somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}%
  \ifenv_toplevel
      \setcounter[Unicode_midlevel][0]%
      \setcounter[Unicode_botlevel][0]%
      \incrementcounter[Unicode_toplevel]%
      \c_steppoint     \zeropoint
      \c_steppoint_temp\zeropoint% 重置分數計算
      \c_bottotalpoint \zeropoint
      \parentitemnumber\currentitemnumber
      \edef\item_bottotalitemnumber_temp{0}%
  \else\ifenv_botlevel
      \incrementcounter[Unicode_botlevel]%
  \else
      \edef\item_bottotalitemnumber_temp{0}%
      \setcounter[Unicode_botlevel][0]%
      \incrementcounter[Unicode_midlevel]\fi
  \fi%{\tt\red :: \currentlevel :: \currentorder}
  \set_currentuserorder[#1]}% 创建 #2order 以备使用

%%% id        由 章節號 + 題號 組成，題號在每一章節中重新從 1 計數
%%% envid     當前列表名稱和層數
%%% order     當前子題號，例如 第一題 ： 1 第六題第三小題 ： 6(3)
%%% userorder 當前列表序號(可獲取被start更改後的序號)

\protected\def\installdatacollector%
  {%\showmessage\m!basicexam{2}{\currentuserorder,\currentanswer}%顯示題號和答案到控制檯
   %\showmessage\m!basicexam{200}{\QuestionID,\currentorder}%
  \ifmode_check\exam_write_answer\fi
  \edef\currentanswercontent{\ifdefined\getanswercontent\getanswercontent\fi}%
  \setdataset [ExamDataset][\QuestionID]%收集答案並在未來展開
              [ id={\QuestionID},%
                envid={\currentitemgroup:\the\c_envnumber},%
                order={\number\currentorder},%
                userorder={\currentuserorder},%
                answer={\expand\currentanswer},%
                answercontent={\currentanswercontent},
                point={\currentpoint},%
                subitem={\the\c_subitem_state}
                totalnumber={\datasetvariable{ExamDatasetHelper}{\HelperID}{totalitemnumber}},
                bottotalitemnumber={\datasetvariable{ExamDatasetHelper}{\HelperID}{bottotalitemnumber}},
                totalpoint={\datasetvariable {ExamDatasetHelper}{\HelperID}{totalpoint}},
                bottotalpoint={\datasetvariable{ExamDatasetHelper}{\HelperID}{bottotalpoint}},]}

\protected\def\installdatacollectorhelper{%
  \increaseQuestionID% 具有獨立答案，增長 QID
  \recurseditemnumber
  \ifdefined\currenttotalbotpoint\else\edef\currenttotalbotpoint{\currenttotalpoint}\fi
  \setdataset[ExamDatasetHelper][\HelperID][%收集信息並在未來展開
              totalitemnumber={\the\c_totalitemnumber},
              bottotalitemnumber={\item_bottotalitemnumber_temp},
              availablecolumns={\currentavailablecolumns},
              realavailablecolumns={\currentrealavailablecolumns},
              itemmaxwidth={\currentitemmaxwidth},
              totalpoint={\currenttotalpoint},
              bottotalpoint={\currenttotalbotpoint},
              answer={\expand\currentanswer},
              answerstatus={\check_answerstatus},]%
  \initcollectanswer}

% 环境层级一览
% question 环境                 % close 环境                      % material 环境
%    choice 环境                %       closechoice 项目    ⭕    % question 环境
%       citem 项目        ⭕    % optclose 环境                   %    choice 环境
%    problem 环境               %       ocitem 项目         ⭕    %       citem 项目    ⭕
%       pitem 项目        ⭕    %       specialocitem 项目  ⭕
%         fillin 项目     ⭕
% ======================================================================================
% writing 环境            ⭕
%     subwriting 环境
%

% 获取当前环境的答案，并传递给最终的 answer dataset
\def\check_answerstatus{\ifempty\currentanswer there is no answer setted.\else setted answer.\fi}

\def\paren#1{(#1)}

\startluacode
  function FormatDim (dim)
    local converteddimen  = tex.toscaled(dim) / 65536
    local convertednumber = tonumber(string.format("%0.2f",converteddimen))
    return convertednumber
  end

  function FormatNum (num)
      if num <= 0 then
          return 0
      else
          local t1, t2 = math.modf(num)
          if t2 > 0 then
              return num
          else
              return t1
          end
      end
  end

  -- context(FormatDim(tex.dimen.c_steppoint))
  -- context.par()
  -- context(FormatNum(convertednumber))
  -- context.par()
  -- context(FormatNum(FormatDim(tex.dimen.c_steppoint)))
\stopluacode

\newcount\c_subitem_state\c_subitem_state=0

\def\install_point[#1][#2]{%
  \edef\currentpoint{\csname #1parameter\endcsname\c!point}%
  \edef\prevpoint{\currentprevpoint}%
  \ifempty\currentpoint
    \edef\currentpoint{\ifenv_toplevel 0\else\ifempty\prevpoint 0\else\prevpoint\fi\fi}%
  \else
    \edef\currentpoint{\csname #1parameter\endcsname\c!point}%
  \fi
  \ifenv_toplevel
    \ifempty\currentpoint
      \edef\currenttoppoint{0}\else
      \ifdefined\steptotalmidpoint
        \edef\currenttoppoint{\steptotalmidpoint}%
        \edef\currentpoint{\steptotalmidpoint}%
        \global\c_subitem_state2\relax\else
        \edef\currenttoppoint{\currentpoint}\fi\fi
      \ifempty\currentpoint% 抓取當前分數值
          \scratchdimen\zeropoint      \else
          \scratchdimen\currentpoint pt\relax
      \fi
      \global\c_steppoint_temp\scratchdimen\relax
      \global\c_steppoint=\dimexpr\c_steppoint+\c_steppoint_temp\relax
      \xdef\currenttotaltoppoint{\ctxlua{context(FormatNum(FormatDim(tex.dimen.c_steppoint)))}}%
      \ifnum\rawcountervalue[Unicode_midlevel]=0
        \xdef\currenttotalpoint{\csname #1parameter\endcsname\c!point}\else
        \xdef\currenttotalpoint{\currenttotaltoppoint}%
      \fi
      % {\ttx\red \currentlevel : \currenttotalpoint }
  \else
    \ifenv_botlevel
      \global\c_subitem_state3\relax
      \ifempty\currentpoint
        \edef\currentbotpoint{0}\else
        \edef\currentbotpoint{\currentpoint}\fi
        \ifempty\currentpoint% 抓取當前分數值
          \scratchdimen\zeropoint      \else
          \scratchdimen\currentpoint pt\relax
        \fi
        \global\c_steppoint_temp\scratchdimen\relax
        \global\c_steppoint    =\dimexpr\c_steppoint    +\c_steppoint_temp\relax
        \global\c_bottotalpoint=\dimexpr\c_bottotalpoint+\c_steppoint_temp\relax
        \xdef\steptotalbotpoint   {\ctxlua{context(FormatNum(FormatDim(tex.dimen.c_steppoint)))}}%
        \xdef\currenttotalbotpoint{\ctxlua{context(FormatNum(FormatDim(tex.dimen.c_bottotalpoint)))}}%
        \xdef\currenttotalpoint   {\steptotalbotpoint}%
        % {\ttx\red \currentlevel : \currenttotalpoint }
    \else
      \ifempty\currentpoint
        \edef\currentmidpoint{0}\else
        \ifdefined\currenttotalbotpoint
          \edef\currentmidpoint{\currenttotalbotpoint}%
          \ifnum\c_subitem_state=3\edef\currentpoint{0}\fi
          \global\c_subitem_state2\relax
          \else
          \edef\currentmidpoint{\currentpoint}\fi\fi
        \ifempty\currentpoint% 抓取當前分數值
          \scratchdimen\zeropoint      \else
          \scratchdimen\currentpoint pt\relax
        \fi
        \c_bottotalpoint\zeropoint% 重置 midlevel 分数
        \global\c_steppoint_temp\scratchdimen\relax
        \global\c_steppoint=\dimexpr\c_steppoint+\c_steppoint_temp\relax
        \global\c_bottotalpoint=\dimexpr\c_bottotalpoint+\c_steppoint_temp\relax
        \xdef\steptotalmidpoint   {\ctxlua{context(FormatNum(FormatDim(tex.dimen.c_steppoint)))}}%
        \xdef\currenttotalpoint   {\steptotalmidpoint}%
        \ifdefined\currenttotalbotpoint\xdef\currenttotalmidpoint{\currenttotalbotpoint}\fi
        % {\ttx\red \currentlevel : \currenttotalpoint }
    \fi
  \fi
}

\def\install_answer[#1][#2]{%
  \edef\prevanswer{\currentprevanswer}%
  \edef\p_answer{\csname #1parameter\endcsname\c!answer}%暫時定義
  \ifmode_debug{\ttx\blue{\ss INSTALL ANSWER} 1 : \currentanswer : \prevanswer}\fi
  \ifempty\p_answer
    \edef\currentanswer{\prevanswer}%empty : \currentanswer
    \ifmode_debug{\ttx\blue 2 : \currentanswer : \prevanswer}\fi
  \else%
    \ifempty\prevanswer
      \edef\currentanswer{\csname #1parameter\endcsname\c!answer}%not empty : \currentanswer
      \ifmode_debug{\ttx\blue 3 : \currentanswer : \prevanswer}\fi
    \else
      \edef\currentanswer{\prevanswer}%
      \ifmode_debug{\ttx\blue 4 : \currentanswer : \prevanswer}\fi
    \fi
    \ifempty\prevanswer\else
      \ifx\currentanswer\prevanswer\relax\else
        \writestatus{question info}{%
          \currentuserorder     : Two conflicting answers have been detected,
                                  check and delete unnecessary answers.}%
        \writestatus{question info}{%
          \string\prevanswer    : \prevanswer .
          \string\currentanswer : \currentanswer .}%
      \fi
    \fi
  \fi
}

\installnamespace {examinfo}
\installframedcommandhandler \????examinfo  {examinfo}  \????examinfo

\appendtoks
    \frozen\instance\protected\edefcsname\e!start\currentexaminfo\endcsname{\framed_examinfo_start[\currentexaminfo]}%
    \frozen\instance\protected\edefcsname\e!stop \currentexaminfo\endcsname{\framed_examinfo_stop                   }%
\to \everydefineexaminfo

\unexpanded\def\framed_examinfo_start[#1]%
 {\bgroup\edef\currentexaminfo{#1}%
  % \dontleavehmode\inheritedexaminfoframed
  \bgroup\examinfoparameter\c!left}

\unexpanded\def\framed_examinfo_stop%
 {\examinfoparameter\c!right\egroup\egroup}

\setupexaminfo[frame=off,location=low,left=(,right=),offset=0pt,align=flushleft]

\defineexaminfo[answerexaminfo]
\defineexaminfo[writingexaminfo]
\defineexaminfo[questionexaminfo]
\defineexaminfo[examitemexaminfo]
\defineexaminfo[closeexaminfo]    [width=2em]

\def\exam_showpointinfo{{\red \topHelperID :: \midHelperID :: \HelperID :: \currentQuestionID \\
  \hbox{:aETH: \datasetvariable{ExamDataset}      {\topHelperID}{totalpoint}         } 
  \hbox{:bEMH: \datasetvariable{ExamDataset}      {\midHelperID}{totalpoint}         }
  \hbox{:cE H: \datasetvariable{ExamDataset}      {\HelperID}   {totalpoint}         } \penalty0\blue
  \hbox{:dETH: \datasetvariable{ExamDataset}      {\topHelperID}{bottotalpoint}      }
  \hbox{:eEMH: \datasetvariable{ExamDataset}      {\midHelperID}{bottotalpoint}      }
  \hbox{:fE H: \datasetvariable{ExamDataset}      {\HelperID}   {bottotalpoint}      }\penalty0\red
  \hbox{:gHTH: \datasetvariable{ExamDatasetHelper}{\topHelperID}{totalpoint}         }
  \hbox{:hHMH: \datasetvariable{ExamDatasetHelper}{\midHelperID}{totalpoint}         }
  \hbox{:iH H: \datasetvariable{ExamDatasetHelper}{\HelperID}   {totalpoint}         }\penalty0\blue
  \hbox{:jHTH: \datasetvariable{ExamDatasetHelper}{\topHelperID}{bottotalpoint}      }
  \hbox{:kHMH: \datasetvariable{ExamDatasetHelper}{\midHelperID}{bottotalpoint}      }
  \hbox{:lH H: \datasetvariable{ExamDatasetHelper}{\HelperID}   {bottotalpoint}      }\penalty0\red
  \hbox{:mEQ:  \datasetvariable{ExamDataset}      {\currentQuestionID}{point}        } 
  \hbox{:nEQ:  \datasetvariable{ExamDataset}      {\currentQuestionID}{totalpoint}   }
  \hbox{:oEQ:  \datasetvariable{ExamDataset}      {\currentQuestionID}{bottotalpoint}}
}}

\def\exam_showanswerinfo{{\red
  % \hbox{:aETH: \datasetvariable{ExamDataset}      {\topHelperID}      {answer}} 
  % \hbox{:bEMH: \datasetvariable{ExamDataset}      {\midHelperID}      {answer}}
  % \hbox{:cE H: \datasetvariable{ExamDataset}      {\HelperID}         {answer}}\penalty0\blue
  \hbox{:dETH: \datasetvariable{ExamDatasetHelper}{\topHelperID}      {answer}}
  \hbox{:eEMH: \datasetvariable{ExamDatasetHelper}{\midHelperID}      {answer}}
  \hbox{:fE H: \datasetvariable{ExamDatasetHelper}{\HelperID}         {answer}}\penalty0\red
  \hbox{:gHTH: \datasetvariable{ExamDataset}      {\currentQuestionID}{answer}}
  \hbox{:hHMH: \datasetvariable{ExamDatasetHelper}{\currentQuestionID}{answer}}
}}

\tolerant\protected\def\showpointoranswer[#1]#*[#2]%
 {\edef\currentmode{#2}% check point or answer
  \edef\p_showanswer {\csname #1parameter\endcsname\c!showanswer}%
  \edef\p_showpoint  {\csname #1parameter\endcsname\c!showpoint }%
  \edef\p_showscript {\csname #1parameter\endcsname\c!showscript}%
  \edef\p_totalpoint {\csname #1parameter\endcsname {totalpoint}}%
  \edef\p_totalanswer{\csname #1parameter\endcsname{totalanswer}}%
  \ifempty\p_showanswer\else
    \ifx\p_showanswer\s!true
            \mode_showanswertrue
      \else \mode_showanswerfalse
  \fi\fi
  \ifempty\p_showpoint\else
    \ifx\p_showpoint\s!true
          \mode_showpointtrue
    \else \mode_showpointfalse
  \fi\fi
  \ifempty\p_showscript\else
    \ifx\p_showscript\s!true
          \mode_showscripttrue
    \else \mode_showscriptfalse
  \fi\fi
  \begingroup
    \p_assigned_currentlabel{#1}{#2}%
    \expandafter\expandafter
      \expandafter\p_pass_currentlabel
        \expandafter\expandafter
          \expandafter[\csname p_current#1#2label\endcsname]{#2}%
    \def\left_assignedlabel {\csname  left_assigned#2label\endcsname}%
    \def\right_assignedlabel{\csname right_assigned#2label\endcsname}%
    \ifx\currentmode\c!point \ifmode_debug {\ss PointINFO  : }\exam_showpointinfo \\\fi\fi
    \ifx\currentmode\c!answer\ifmode_debug {\ss AnswerINFO : }\exam_showanswerinfo\\\fi\fi
    \csname ifmode_show#2\endcsname
      \dousestyleparameter    {\csname #1parameter\endcsname{#2style}}%
      \dousecolorparameter    {\csname #1parameter\endcsname{#2color}}%
      \csname\e!start #1examinfo\endcsname
        \left_assignedlabel% like=>answer : blabla
          \ifx\currentmode\c!point% if #2 = point
            \ifempty\p_totalpoint
              \ifenv_answer
                \ifdefined\currentpointforanswer\currentpointforanswer
                \else\showmessage\m!basicexam{201}\fi%为了实现答案在环境内部或者外部都可以正确获取分数
              \else
                \ifmode_debug{\ttx\darkyellow \item_bottotalitemnumber :: \currentlevel :: 
                              \topHelperID :: \midHelperID :: \HelperID :: \currentQuestionID}\fi
                \ifenv_toplevel
                  \ifenv_answer\else\datasetvariable{ExamDatasetHelper}{\topHelperID}{totalpoint}\fi
                  \xdef\currentpointforanswer{\datasetvariable{ExamDatasetHelper}{\topHelperID}{totalpoint}}%
                \else
                  \ifenv_botlevel
                    \ifenv_answer\else\point_point\fi
                    \xdef\currentpointforanswer{\point_point}%
                  \else
                    \doifsomethingelse{\item_bottotalitemnumber}{\scratchcounter\item_bottotalitemnumber}{\scratchcounter\zerocount}\null
                    \ifnum\scratchcounter<2\relax
                      \ifenv_answer\else\point_point\fi
                      \xdef\currentpointforanswer{\point_point}%
                    \else
                      \ifenv_answer\else\datasetvariable{ExamDatasetHelper}{\midHelperID}{bottotalpoint}\fi
                      \xdef\currentpointforanswer{\datasetvariable{ExamDatasetHelper}{\midHelperID}{bottotalpoint}}%
                    \fi
                  \fi
                \fi
              \fi
            \else
              \p_totalpoint
            \fi
          \else% if #2 = answer。因为 currentXXXanswer 是有定义内容的，
            \ifmode_example You're in EXAMPLE MODE!\else
              \ifempty\p_totalanswer
                \answer_answer
              \else
                \p_totalanswer
              \fi
            \fi% 直接獲取當前 QID 答案
          \fi
        \right_assignedlabel
      \csname\e!stop #1examinfo\endcsname
    \fi
  \endgroup\allowbreak
  \ifdefined\currentprevpoint\else
    \edef\currentprevpoint{\csname #1parameter\endcsname\c!point}\fi
  \ifdefined\currentprevanswer
    \edef\currentprevanswer{\csname #1parameter\endcsname\c!answer}\else
    \edef\currentprevanswer{\csname #1parameter\endcsname\c!answer}%
  \fi%{\ttx\blue 0 :\currentprevanswer  0 :\currentprevpoint}
  \removeunwantedspaces\allowbreak}

\def\p_assigned_currentlabel#1#2{%
  \expandafter\edef%
    \csname p_current#1#2label%
      \expandafter\expandafter
        \expandafter\endcsname
          \expandafter\expandafter
            \expandafter{%
              \csname #1parameter\endcsname{#2label}}}

\def\p_pass_currentlabel[#1]{\p_assign_currentlabel[#1,,]}
\def\p_assign_currentlabel[#1,#2,#3]#4%
 {\expandafter\def\csname  left_assigned#4label\endcsname{#1}%
  \expandafter\def\csname right_assigned#4label\endcsname{#2}}

\tolerant\protected\def\installpointoranswer[#1]#*[#2]%#1 parameter %#2 modename
  {\edef\currentmode{#2}%
  \ifx\currentmode\c!point\install_point[#1][#2]\else\install_answer[#1][#2]\fi}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion[tnum][\addff{tabularnumbers}]
\protected\def\installitemgroupoption[#1][#2]{%
  \setupitemgroup[env:#1][each][
                \c!margin={\csname #2parameter\endcsname\c!margin},%
            \c!leftmargin={\csname #2parameter\endcsname\c!leftmargin},%
           \c!rightmargin={\csname #2parameter\endcsname\c!rightmargin},%
    \c!leftmargindistance={\csname #2parameter\endcsname\c!leftmargindistance},%
   \c!rightmargindistance={\csname #2parameter\endcsname\c!rightmargindistance},%
            \c!indentnext={\csname #2parameter\endcsname\c!indentnext},%
                 \c!width={\csname #2parameter\endcsname\c!width},%
                \c!factor={\csname #2parameter\endcsname\c!factor},%
              \c!distance={\csname #2parameter\endcsname\c!distance},%
                  \c!step={\csname #2parameter\endcsname\c!step},%
                 \c!align={\csname #2parameter\endcsname\c!align},%
              \c!symalign={\csname #2parameter\endcsname\c!symalign},%
                 \c!color={\csname #2parameter\endcsname\c!color},%
             \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                 \c!style={\csname #2parameter\endcsname\c!style},%
              \c!marstyle={\csname #2parameter\endcsname\c!marstyle},%
              \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
             \c!headstyle={\csname #2parameter\endcsname\c!headstyle},%
              \c!marcolor={\csname #2parameter\endcsname\c!marcolor},%
              \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
             \c!headcolor={\csname #2parameter\endcsname\c!headcolor},%
            \c!beforehead={\csname #2parameter\endcsname\c!beforehead},%
              \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
              \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
             \c!afterhead={\csname #2parameter\endcsname\c!afterhead},%
                \c!before={\csname #2parameter\endcsname\c!before},%
             \c!inbetween={\csname #2parameter\endcsname\c!inbetween},%
                 \c!after={\csname #2parameter\endcsname\c!after},%
               \c!stopper={\csname #2parameter\endcsname\c!stopper},%
          \c!placestopper={\csname #2parameter\endcsname\c!placestopper},%
               \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                 \c!inner={\csname #2parameter\endcsname\c!inner},%
                     \c!n={\csname #2parameter\endcsname\c!n},%
                 \c!items={\csname #2parameter\endcsname\c!items},%
                \c!levels={\csname #2parameter\endcsname\c!levels},%
              \c!lefttext={\csname #2parameter\endcsname\c!lefttext},%
             \c!righttext={\csname #2parameter\endcsname\c!righttext},%
                  \c!left={\csname #2parameter\endcsname\c!left},%
                 \c!right={\csname #2parameter\endcsname\c!right},%
         \c!packcriterium={\csname #2parameter\endcsname\c!packcriterium},%
             \c!criterium={\csname #2parameter\endcsname\c!criterium},%
          \c!textdistance={\csname #2parameter\endcsname\c!textdistance},%
     \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
     \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
               \c!command={\csname #2parameter\endcsname\c!command},%
             \c!indenting={\csname #2parameter\endcsname\c!indenting},%
           \c!alignsymbol={\csname #2parameter\endcsname\c!alignsymbol},%
                \c!symbol={\csname #2parameter\endcsname\c!symbol},%
                \c!option={\csname #2parameter\endcsname\c!option},%
              %  \c!start={\csname #2parameter\endcsname\c!start},%
                 \c!start={\csname #2parameter\endcsname\c!start},%
                 \c!state={\csname #2parameter\endcsname\c!state},% % beware, "" == start
                   \c!way={\csname #2parameter\endcsname\c!way},% % wont work if continue on
                \c!prefix={\csname #2parameter\endcsname\c!prefix},%
    \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
      \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
   \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
         \c!prefixstarter={\csname #2parameter\endcsname\c!prefixstarter},%
         \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
             \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
        \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
             \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
       \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
    \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
      \c!numberconversion={\csname #2parameter\endcsname\c!numberconversion},%
   \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
         \c!numberstarter={\csname #2parameter\endcsname\c!numberstarter},%
         \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
        \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
  %               \c!prefix={\csname #2parameter\endcsname\c!prefix},%
  %        \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
  %   \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
  %     \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
  %  \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
  %            \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
  %       \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
  %      \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
  %   \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
  %  \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
        %  \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
        % \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
  ]%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{繪製卷頭 / print title / タイトルの作成}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \macros {definepapertitle,setuppapertitle,makepapertitle}
%D
%D The following command simply shows how to define, set and draw a new test paper information.

%D \startitemize[nowhite,packed,joinedup]
%D \item 通過 \type{\definepapertitle[PaperTitleName]} 命令可以新建卷頭信息，
%D \item 通過  \type{\setuppapertitle[PaperTitleName]} 命令可以設定卷頭信息，
%D \item 通過   \type{\makepapertitle[PaperTitleName]} 命令可以繪製卷頭結果。
%D \stopitemize

%D \type{\definepapertitle} and \type{\setuppapertitle} accept one required and two optional parameters.
%D The first parameter is the name of the test paper.
%D The second parameter is the name of the parent test paper, which can be inherited by setting the parent.
%D The third parameter can directly set the relevant style and content.
%D The order can be set through ‘list’ parameters.
%D The default order is ‘secret, title, subject, information, notice’.

%D Once you've defined the {\bf list} parameter,
%D it will automatically expand the relevant parameters to define its style.
%D For example, if you define a {\bf title} parameter in the {\bf list},
%D it will automatically expand the following parameters:

%D \type{\setuppapertitle[list={title,and some other info}]}

%D \starttabulate[|r|l|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC title       \NC  titlealign   \NC \NC\NR
%D \NC titlestyle  \NC  beforetitle  \NC \NC\NR
%D \NC titlecolor  \NC  aftertitle   \NC \NC\NR
%D \HL
%D \stoptabulate

%D \startbuffer
%D  \definepapertitle[papertitles]
%D  \setuppapertitle [papertitles][
%D     list={secret,title,subject,information,notice},
%D     subjectsuffix=学科试卷,
%D     secretstyle=\ss,
%D     titlestyle=\ssa,
%D     subjectstyle=\ssb,
%D     informationstyle=\ttx,
%D     noticestyle=\rm\it,
%D     secretalign=flushleft,
%D     titlealign=center,
%D     subjectalign=center,
%D     informationalign=center,
%D     noticealign=flushleft,
%D     secret={绝密 ★ 启用前},
%D     title={2021 年普通高等学校招生全国统一考试},
%D     subject={日语},
%D     information={总分:150 分，考试时间:120 分钟},
%D     notice={注意事项：
%D       \startitemize[n,packed,joinedup]
%D         \item 答题前，务必将自己的姓名、准考证号填写在%
%D               答题卡规定的位置上。%
%D         \item 答选择题时，必须使用 2B 铅笔将答题卡上对%
%D               应题目的答案标号涂黑。如需改动，用橡皮擦%
%D               擦干净后，再选涂其它答案标号。答非选择题%
%D               时，必须使用 0.5 毫米黑色签字笔，将答案%
%D               书写在答题卡规定的位置上。所有題目必须在答%
%D               题卡上作答，在试题卷上答题无效。 %
%D         \item 考试结束后，将试题卷和答题卡一并交回。
%D         \stopitemize},
%D     ]
%D  \makepapertitle [papertitles]
%D  %If you want, you can also change the key value directly here.like
%D  % \makepapertitle [papertitles][title=new paper title]
%D \stopbuffer
%D \typebuffer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\installnamespace {papertitle}
\installnamespace {papertitlealternative}
\installnamespace {papertitlerenderings}

\installcommandhandler \????papertitle            {papertitle}            \????papertitle
\installcommandhandler \????papertitlealternative {papertitlealternative} \????papertitlealternative

\def\doifemptyelsex#1#2{\doifelse{#1}{}{#2}{#1}}
\def\definepapertitlevariable#1{\begingroup% #1=element name
    \parindent0pt\relax\par%
    \doifelse{\namedpapertitleparameter{\currentpapertitle}{#1align}}{}%
             {\setupalign[center]}%
             {\setupalign[\namedpapertitleparameter{\currentpapertitle}{#1align}]}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{before#1}}{}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1style}}{}%
    \expandafter\begincsname\namedpapertitleparameter{\currentpapertitle}{#1color}\endcsname
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1}}%
                   {\showmessage\m!basicexam{3}{#1}}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{after#1}}{}%
    \par\endgroup}

\tolerant\def\makepapertitle[#1][#2]%
  {\begingroup\cdef\currentpapertitle{#1}%
  \ifarguments\or\or\setuppapertitle[#1][#2]\fi
  \edef\currentpapertitlealternative{\papertitleparameter\c!alternative}%
  \ifcsname\currentpapertitlealternativehash\s!parent\endcsname \else
    \let\currentpapertitlealternative\s!default
  \fi
  \usesetupsparameter\papertitleparameter
  \edef\p_renderingsetup{\papertitlealternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \marking[subject]{\papertitleparameter{subject}%
                    \papertitleparameter{subjectsuffix}}%
  \marking[title]{\papertitleparameter\c!title}%
  \endgroup}

%D At the same time, you can define your own test paper title template through {\bf alternative}.
%D here is an example for default alternative.

\definepapertitlealternative
  [\s!default]
  [\c!renderingsetup=\????papertitlerenderings:\s!default]

\startsetups[\????papertitlerenderings:\s!default]
  \edef\currentlist{\papertitleparameter\c!list}
  \edef\currenttitle{\papertitleparameter\c!title}
  \expandafter\expandafter\expandafter\tu\expandafter{\currenttitle}
  \processcommacommand[\currentlist]\definepapertitlevariable
\stopsetups

\setuppapertitle [
  \c!alternative=\s!default,
  subjectsuffix=学科试卷,
  list={secret,title,subject,information,signinformation,notice},
  ]
\setuppapertitle [
    secretstyle=\ss,
    titlestyle=\ssa,
    subjectstyle=\ssb,
    informationstyle=\ttx,
    noticestyle=\rm\it,
    secretalign=flushleft,
    titlealign=center,
    subjectalign=center,
    informationalign=center,
    noticealign=flushleft,
    secret={绝密 ★ 启用前},
    title={\currentdate[year] 年普通高等学校招生全国统一考试},
    subject={英语},
    signinformation={{姓名:     }{\blackrule[width=4em,height=.2pt]}
                     {准考证号: }{\blackrule[width=4em,height=.2pt]}},
    information={全卷共12页，满分150分，考试时间120分钟。},
    notice={考生注意：
            \startitemize[n,packed,joinedup]
            \item 答题前，请务必将自己的姓名、准考证号用黑色字迹的签字笔
                  或钢笔分别填写在试题卷和答题纸规定的位置上。 %
            \item 答题时，请按照答题纸上“注意事项”的要求，在答题纸相应的
                  位置上规范作答，在本试题卷上的作答一律无效。 %
            \stopitemize},
]

\definepapertitle[newpaper]
%% #1 = newpapertitle #2 = setup elements of newpapertitle
%% \makepapertitle[newpaper][title=OOOOOOO]
%% quickly get elements at header and footer:
%% \getmarking[title][page][first] :: \getmarking[title][current]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设定一些可能用得到的符号 / Symbol Defination / シンボルの定義}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\doifelsefontpresent{NotoSansSymbols2-Regular}{}{
  \showmessage\m!basicexam{9}{NotoSansSymbols2 font,symbol}}
\definefontsynonym[NotoSansSymbols2][file:NotoSansSymbols2-Regular]
\def\notosymb#1{\getglyphstyled{NotoSansSymbols2}{\tochar{n:#1}}}

\definesymbol[marksquare]          [\notosymb{☐}]
\definesymbol[markcircle]          [\notosymb{○}]
\definesymbol[marknotcheck]        [\notosymb{⍻}]
\definesymbol[markcheck]           [\notosymb{🗸}]
\definesymbol[markheavycheck]      [\notosymb{✓}]
\definesymbol[marksquarecheck]     [\notosymb{\rlap{☐}\,\raise.2em\hbox{🗸}}]
\definesymbol[marksquareheavycheck][\notosymb{\rlap{☐}\,\raise.2em\hbox{✓}}]
\definesymbol[markcirclecheck]     [\notosymb{\rlap{○}\,\raise.2em\hbox{🗸}}]
\definesymbol[markcircleheavycheck][\notosymb{\rlap{○}\,\raise.2em\hbox{✓}}]
\definesymbol[markcross]           [\notosymb{✗}]
\definesymbol[markheavycross]      [\notosymb{✘}]
\definesymbol[marksquarecross]     [\notosymb{\rlap{☐}\,\raise.1em\hbox{✗}}]
\definesymbol[marksquareheavycross][\notosymb{\rlap{☐}\,\raise.1em\hbox{✘}}]
\definesymbol[markcirclecross]     [\notosymb{\rlap{○}\,\raise.1em\hbox{✗}}]
\definesymbol[markcircleheavycross][\notosymb{\rlap{○}\,\raise.1em\hbox{✘}}]

%D It is important to note that these symbols require
%D the font {\bf NotoSansSymbols2} to be pre-installed.
%D
%D \starttabulate[|l|r|l|r|]
%D \NC \type{\symbol{marksquare}}           \NC \symbol{marksquare}
%D \VL \type{\symbol{markcircle}}           \NC \symbol{markcircle}          \NC\NR\HL
%D \NC \type{\symbol{markcheck}}            \NC \symbol{markcheck}
%D \VL \type{\symbol{markcross}}            \NC \symbol{markcross}           \NC\NR
%D \NC \type{\symbol{markheavycheck}}       \NC \symbol{markheavycheck}
%D \VL \type{\symbol{markheavycross}}       \NC \symbol{markheavycross}      \NC\NR
%D \NC \type{\symbol{marksquarecheck}}      \NC \symbol{marksquarecheck}
%D \VL \type{\symbol{marksquarecross}}      \NC \symbol{marksquarecross}     \NC\NR
%D \NC \type{\symbol{marksquareheavycheck}} \NC \symbol{marksquareheavycheck}
%D \VL \type{\symbol{marksquareheavycross}} \NC \symbol{marksquareheavycross}\NC\NR
%D \NC \type{\symbol{markcirclecheck}}      \NC \symbol{markcirclecheck}
%D \VL \type{\symbol{markcirclecross}}      \NC \symbol{markcirclecross}     \NC\NR
%D \NC \type{\symbol{markcircleheavycheck}} \NC \symbol{markcircleheavycheck}
%D \VL \type{\symbol{markcircleheavycross}} \NC \symbol{markcircleheavycross}\NC\NR
%D \NC \type{\symbol{marknotcheck}}         \NC \symbol{marknotcheck}
%D \VL                                      \NC                              \NC\NR
%D \stoptabulate

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 question 环境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D With the merger of the code,
%D the question environment, the problem environment, and the optclose environment
%D have now been completely combined into one environment.
%D You can switch through the class key value.
%D \starttyping
%D   \definequestion[newquestioninstance]
%D   \setupquestion[newquestioninstance] [class=problem]
%D \stoptyping
%D
%D The \tex{question} environment command can be used to set the stem.
%D Simply wrap the stem between the \tex{startquestion} \tex{stopquestion} commands.
%D At the same time, we have defined a short command \tex{question},
%D which is used as a synonym for \tex{startquestion} \tex{stopquestion}
%D
%D \startbuffer
%D   \startquestion
%D     The environment is located in: \currentitemgroup 。
%D   \stopquestion
%D   \startquestion
%D     The environment is located in: \currentitemgroup 。
%D   \stopquestion
%D   \question {The environment is located in: \currentitemgroup 。}
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D The \tex{question} environment command inherits the option settings for
%D the \tex{itemgroup} environment. Therefore, you can modify the environment
%D using \tex{setupquestion} in the same way you modify \tex{itemgroup}.
%D
%D \bgroup
%D   \startbuffer
%D     \setupquestion[color=green,style=\ss,start=22,
%D                    option={n,packed,joinedup,nowhite,}]
%D     \startquestion
%D       The environment is located in: \currentitemgroup 。
%D     \stopquestion
%D   \stopbuffer
%D   \typebuffer
%D   \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D \egroup
%D
%D question 环境可以设置 {\bf 答案} 和 {\bf 分值}。该键值详细的设置如下：
%D \starttabulate[|l|l|l|l|]
%D \NC showanswer \NC answer \NC answerstyle    \NC answercolor \NC\NR
%D \NC            \NC        \NC answerlabel    \NC answerlabel \NC\NR\HL
%D \NC showpoint  \NC point  \NC pointstyle     \NC pointcolor  \NC\NR
%D \NC            \NC        \NC pointprelabel  \NC pointlabel  \NC\NR
%D \stoptabulate
%D
%D \startbuffer
%D   \setupquestion[start=1,option={n,packed,joinedup,nowhite,}]
%D   \startquestion[showpoint=true,point=5,pointlabel={points},
%D                  showanswer=true,answer={new answer},answerstyle={\tt},]
%D     The environment is located in: \currentitemgroup 。
%D   \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D 此外，question 设置了一个特殊的键值 example=true，可以是当前题目不被录入答案。
%D 在(v20241023)中，通过不太正常的方式设置了 example 后的题目可以自动重置回到序数 1。
%D 或许，可以设置一个新的键值，来设定 example 之后的题目是重置为 1 还是接续上一个序号。
%D 此外，由于 question 内置了一个 item， 因此可以使用 reference 来创建引用。
%D
%D {\bf About the settings of point and answer: }
%D point 的分值默認是一整個題目的總分數
%D （如果包括子題目，在該宏包無法正常獲取分值或分數時，可以使用 totalpoint 或者 totalanswer 來直接設定分數或答案）。
%D 如果當前字環境為 problem，只要為每個 pitem設計了 point 的分值，該模塊就會自動計算。answer 的獲取也是一樣。
%D 在設計時，pitem 默認是擁有多個同級項目的。也就是說，會在同一個 question 環境中，有多個子答案。
%D 我們無法獲知應該使用哪一個作為當前環境的答案。
%D 同樣的道理，每個 question 環境內只有一個choice 環境，只需要直接為 question 環境配置分值即可。

\installnamespace          {question}
\installcommandhandler \????question  {question}  \????question

\appendtoks
  \frozen\instance\protected\edefcsname        \currentquestion\endcsname{\directnamedquestion[\currentquestion]}%
  \frozen\instance\protected\edefcsname\e!start\currentquestion\endcsname{\startnamedquestion [\currentquestion]}%
  \frozen\instance\protected\edefcsname\e!stop \currentquestion\endcsname{\stopnamedquestion}%
\to \everydefinequestion

\let\strc_question_normal_setup\setupquestion

\permanent\overloaded\tolerant\protected\def\setupquestion[#S#category]#spacer[#S#levels]#spacer[#S#options]#spacer[#S#settings]% 
% category level|each options|settings settings|options
  {\ifarguments
     % nothing to set up
   \or
     \edef\strc_question_setup_what{#levels}%
     \strc_question_normal_setup[#category]% == settings
   \or
     \edef\strc_question_setup_what{#levels}%
     \strc_question_setup_each{#category}{#levels}%
   \or
     \edef\strc_question_setup_what{#levels}%
     \ifx\strc_question_setup_what\v!each
       \strc_question_setup_each{#category}{#options}%
     \else
       \strc_question_setup_list{#levels}{#category}{#options}%
     \fi
   \or
     \edef\strc_question_setup_what{#levels}%
     \ifx\strc_question_setup_what\v!each
       \strc_question_setup_each{#category}{#options}%
       \strc_question_setup_each{#category}{#settings}%
     \else
       \strc_question_setup_list{#levels}{#category}{#options}%
       \strc_question_setup_list{#levels}{#category}{#settings}%
     \fi
   \fi}

\def\strc_question_setup_each#category#whatever%
  {\ifhastok={#whatever}%
     \strc_question_normal_setup[#category][#whatever]%
   \else
     \strc_question_normal_setup[#category][\c!option={#whatever}]%
   \fi}

\def\strc_question_setup_list_level_a#category#whatever#level%
  {\strc_question_normal_setup[#category:#level][#whatever]}

\def\strc_question_setup_list_level_b#category#whatever#level%
  {\strc_question_normal_setup[#category:#level][\c!option={#whatever}]}

\def\strc_question_setup_list#subcategories#category#whatever%
  {\ifhastok={#whatever}%
     \processcommalist[#subcategories]{\strc_question_setup_list_level_a{#category}{#whatever}}%
   \else
     \processcommalist[#subcategories]{\strc_question_setup_list_level_b{#category}{#whatever}}%
   \fi}

\tolerant\protected\def\directnamedquestion[#1]#*[#S#2]#*[#S#3]#*%
 {\groupedcommand{\startnamedquestion[#1][#2][#3]}{\stopnamedquestion}}

\tolerant\protected\def\startnamedquestion[#S#1]#*[#S#2]#*[#S#3]#*%
 {\begingroup\nofarguments\lastarguments
  \cdef\currentquestion{#1}% no nested mixing of itemgroups
  \let\currentparentquestion\currentquestion
  \global\advanceby\c_strc_question_nesting\plusone
  \def\currentquestionlevel{\the\c_strc_question_nesting}%
  \normalexpanded{\chaintocurrentquestion{\currentparentquestion:\currentquestionlevel}}%
  \cdef\currentquestion{\currentparentquestion:\currentquestionlevel}%
  \ifcase\nofarguments
       \edef\p_option{}\setupcurrentquestion[]%
    \or\edef\p_option{}\setupcurrentquestion[]%
    \or
      \edef\p_class{\questionparameter\c!class}%
      \ifx\p_class\s!problem
            \setupitemgroup[env:problem] [#2]%
      \else \setupitemgroup[env:question][#2]\fi
      \ifhastok={#2}%
        \edef\p_option  {}\setupcurrentquestion[#2]\else
        \edef\p_option{#2}\setupcurrentquestion[#2]\fi
    \or
      \ifhastok={#2}\setupcurrentquestion[#2]\else
                    \setupcurrentquestion[#3]\fi
      \edef\p_class{\questionparameter\c!class}%
      \edef\p_option{#2}%
      \ifx\p_class\s!problem
        \setupitemgroup[env:problem][#3,option={#2}]%
      \else
        \setupitemgroup[env:question][#3,option={#2}]\fi
  \fi\let\p_option_bak\p_option
  \edef\p_class{\questionparameter\c!class}%
  \edef\p_start{\questionparameter\c!start}%
  \edef\p_reset{\questionparameter\c!reset}%
  \edef\p_option{\questionparameter\c!option,\p_option_bak}%
  \edef\p_defaultoption{n,packed,nowhite,joinedup,continue}%
  \ifx\p_class\s!question
    \env_questiontrue\set_envitem_counter
    \ifx\p_reset\s!true\resetcounter[itemgroup:env:question]\fi
    \ifmode_example
      \installitemgroupoption[example][question]%
      \startitemgroup[env:example][\p_option]\else
      \installitemgroupoption[question][question]%
      \startitemgroup[env:question][\p_option]%
    \fi
    \item[\questionparameter\c!reference]%
    \set_count_envlevel[question]%
  \fi
  \ifx\p_class\s!problem
    % ====================================================================
    % problem 環境現在已經基本不發揮作用，除了重置某些計數器和調整樣式之外，
    % 幾乎所有的功能都消失了。optclose 環境也基本一樣。
    % 除非有重大錯誤，否則，不應該繼續添加代碼，以防止計算點數和答案出錯。
    % ====================================================================
    \ifdefined\prevlevel\else\errmessage{problem cannot exist as a top-level environment, please place it in the question environment}\fi
    \env_problemtrue\set_envitem_counter
    \ifx\p_reset\s!true\resetcounter[itemgroup:env:problem]\fi
    \ifmode_example
      \installitemgroupoption[example][question]%
      \startitemgroup[env:example][\p_option]\else
      \installitemgroupoption[problem][question]%
      \startitemgroup[env:problem][\p_option]%
    \fi\inititemnumber
    \xdef\currentQuestionID{\jobname-\ifmode_example\EQuestionID\else
    \somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}%
    \edef\item_bottotalitemnumber_temp{0}%
  \fi
  \ifx\p_class\s!optclose
    \env_closetrue\set_envitem_counter
    \ifx\p_reset\s!true\resetcounter[itemgroup:env:question]\fi
    \ifmode_example
      \installitemgroupoption[example][question]%
      \startitemgroup[env:example][\p_option]\else
      \installitemgroupoption[question][question]%
      \startitemgroup[env:question][\p_option]%
    \fi
    \leftskip=0pt\relax
  \fi
  % 应对 problem 不开启 point 和 answer 导致后续环境无法继承状态的问题
  \ifmode_showanswer\edef\temp_showanswer{}\fi
  \ifmode_showpoint \edef\temp_showpoint{ }\fi
  \showpointoranswer[question][point]%
  \showpointoranswer[question][answer]%
  \ifdefined\temp_showanswer\mode_showanswertrue\fi
  \ifdefined\temp_showpoint \mode_showpointtrue \fi
  \usequestionstyleandcolor\c!textstyle\c!textcolor
  \save_question_order}

\protected\def\stopnamedquestion{%
  \ifx\p_class\s!question
    \ifenv_toplevel
      \ifnum\c_envnumber=1\relax% 当前环境为 question
        \ifnum\rawcountervalue[Unicode_midlevel]=0% 且只有一个子题目即题目本身
          \installpointoranswer[question][answer]%
          \installpointoranswer[question][point]%
          \installdatacollector\installdatacollectorhelper
       \fi
      \fi
    \else
      \installpointoranswer[question][answer]%
      \installpointoranswer[question][point]%
      \installdatacollector\installdatacollectorhelper
    \fi
  \fi
  \stopitemgroup
  \global\advanceby\c_strc_question_nesting\minusone
  \xdef\currentquestionlevel{\the\c_strc_question_nesting}%
  \endgroup}

\setupquestion
  [class=question,
  %example=,
  %showpoint=false,
  %point=,
  pointstyle=\ttx,
  %pointcolor=,
  %pointprelabel=,
  pointlabel={,\examtexts{point}},
  %showanswer=false,
  %answer=,
  answerlabel={\examtexts{answer},},
  answerstyle=ttx,
  %answerstyle=,
  indenting=no,
  way=bychapter,
  numberconversion=tnum,]

\setupquestion
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color,
   \c!symstyle=\itemgroupparameter\c!style,
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definequestion[question]
% \definequestion[problem]
% \definequestion[subquestion]
% \definequestion[optclose]
% \definequestion[specialocitem]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 problem 环境 / Problem Environment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D The environment \tex{problem} command can set up multiple aggregate issues,
%D and the environment has a specific subcommand \tex{pitem} to list each issue.
%D It can be used to set fill-in-the-blank, Q&A, and other questions.

%D \startbuffer
%D \startquestion
%D   The environment is located in: \currentitemgroup 。
%D \startproblem
%D \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The problem environment only inherits the key-value pairs from the itemgroup
%D environment and does not set any new key-values. In the current version (v20241023),
%D the settings for answers and scores have been removed. Because, under the
%D problem environment, there are usually many pitems, and each question may have
%D its own score and answer. Therefore, for design purposes, the answers and
%D scores of each question are directly set through \tex{pitem}.

%D \startbuffer
%D \startquestion
%D   The environment is located in: \currentitemgroup 。
%D \startproblem
%D \startpitem[showpoint=true,point=5]         The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem[showanswer=true,answer={newer}] The environment is located in: \currentitemgroup 。 \stoppitem
%D \startpitem[]                               The environment is located in: \currentitemgroup 。 \stoppitem
%D \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D Unlike the \tex{question} environment, where all ordinal numbers are sequential,
%D the \tex{problem} environment is recounted each time it starts.

%D If you want to add stems to the \tex{problem} environment,
%D you can place the \tex{problem} environment in the \tex{question} environment.

%D \startbuffer
%D \startquestion
%D   The environment is located in: \currentitemgroup 。
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup 。 \stoppitem
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D If you want to set a fill-in-the-blank question, you can use the \tex{fillin} command.
%D The use of \tex{fillin} and \tex{startanswer} will be mentioned later.
%D
%D \startbuffer
%D \setupanswer[showanswer=true]
%D \startquestion
%D   The environment is located in: \currentitemgroup 。
%D     \setuppitem[showanswer=true]
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \fillin{env_question:1}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[mp=rules:under:wave]{env_question:1}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem
%D     	The environment is located in: \fillin[empty=number]{env_question:2}。
%D     \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes]{env_question:3}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes,left={(},right={)}]{env_question:4}。 \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D In addition to this, you can define a new problem environment via \tex{defineproblem}\type{[XXX]},
%D which will generate two new commands \tex{startXXX} , \tex{\stopXXX}

\definequestion[problem]
\def\setupproblem{\setupquestion[problem]}

\setupproblem[showanswer=false,showpoint=false]

\definequestion[subquestion]
\def\setupsubquestion{\setupquestion[subquestion]}

\setupproblem
  [\c!class=\s!problem,
   \c!left=(,\c!lefttext=(,
   \c!right=),\c!righttext=),
   \c!stopper=,
   \c!option={n,packed,joinedup,nowhite},]

\setupsubquestion
  [\c!class=\s!problem,
   \c!left=(,\c!lefttext=(,
   \c!right=),\c!righttext=),
   \c!stopper=,
   \c!option={n,packed,joinedup,nowhite},]


%D userquestion 和 useritem 是为了应对本模块未曾考虑到的题型而设计的通用型 macro，
%D useritem 可以单独存在，此时它类似于 question 环境。答案和分数是分别计算的。
%D 也可以放置在 userquestion 环境下，此时它类似 fillin 可以不断记录答案，知道环境结束。
%D 但需要注意，这两个 macro 不可以与现存的其他命令同时使用，会导致一些未曾测试的错误。
%D
%D \startbuffer
%D \setupuserquestion[point=1,showanswer=true,showpoint=true]
%D \useritem{z1} \useritem{z2} \useritem{z3}
%D
%D \startuserquestion
%D \useritem{z1} \useritem{z2} \useritem{z3}
%D \stopuserquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {userquestion}
\installcommandhandler \????userquestion  {userquestion}  \????userquestion

\defineuserquestion[userquestion]
\defineuserquestion[useritem]

\setupuserquestion[
  showpoint=false,
  pointlabel={(,)},
  answerlabel={(,)},]

\tolerant\protected\def\useritem[#1]#:#2%
 {\begingroup
  \edef\currentuserquestion{useritem}%
  \setupcurrentuserquestion[#1]%
  \edef\currentanswer{#2}%
  \ifdefined\prevuserquestion
    \edef\currentanswer        {#2\collectanswer{#2}}%
    \edef\currentuseritemanswer{\collectedanswer}%
    \ifempty\currentuseritemanswer
        \edef\currentanswer{\currentprevanswer}%
    \else\edef\currentanswer{\collectedanswer}%
    \fi
    \aftergrouped{\xdef\currentprevanswer{\collectedanswer}}%
  \else
    \useuserquestionstyleandcolor\c!style\c!color
    \userquestionparameter\c!left
    \letuserquestionparameter\c!answer\currentanswer
    \set_count_envlevel[userquestion]%
    \showpointoranswer [userquestion][point]%
    \showpointoranswer [userquestion][answer]%
    \userquestionparameter\c!right
    \installpointoranswer[userquestion][answer]%
    \installpointoranswer[userquestion][point]%
    \installdatacollector
    \installdatacollectorhelper
  \fi
  \endgroup}

\tolerant\protected\def\startuserquestion#*[#1]#*%
 {\begingroup
  \edef\currentuserquestion{userquestion}%
  \edef\prevuserquestion{userquestion}%
  \setupcurrentuserquestion[#1]%
  \useuserquestionstyleandcolor\c!style\c!color
  \userquestionparameter\c!left
  \set_count_envlevel[userquestion]%
  \letuserquestionparameter\c!answer\currentanswer
  \showpointoranswer [userquestion][point]%
  \showpointoranswer [userquestion][answer]%
}

\def\stopuserquestion%
{\installpointoranswer[userquestion][answer]%
  \installpointoranswer[userquestion][point]%
  \installdatacollector
  \installdatacollectorhelper
  \userquestionparameter\c!right
  \endgroup}

  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 choice 环境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D 該環境命令只能置於 \tex{question} 環境之下。該環境有一個子項目：
%D \tex{startcitem}
%D \tex{stopcitem}。
%D \starttyping
%D  \startcitem {選項內容} \stopcitem
%D \stoptyping

%D 可以通過 \type{[*]} 來標記正確答案。如果想要設置多選題，只需要對每個正確答案添加 \type{[*]} 即可。
%D \startbuffer
%D \setupquestion[showanswer=true]
%D \startquestion
%D     The environment is located in: \currentitemgroup 。
%D     \startchoice
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup 。
%D     \startchoice
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup 。
%D     \startchoice
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D 同時為 \tex{startcitem}\tex{stopcitem} 定義了同義命令 \tex{citem} 和 \tex{fragilecitem}。
%D \tex{fragilecitem}命令可以不通過界定花括號來排版選項，但可能會引發未知問題，
%D 特別是選項中含有空格時。\tex{citem} 則需要將選項包裹在花括號中。
%D \starttyping
%D  \citem {選項內容}
%D  \fragilecitem 選項內容
%D \stoptyping

%D 该环境继承了一部分 itemgroup 的键值，就如同前两个命令一样。
%D 不同于 question 具有answer 和 point 两种键值，该环境只具有 answer 相关的键值，来特别地
%D 设置是否显示答案和配置答案樣式。
%D 因为 choice 环境的特殊性，point 键值通过 question 环境来显示。和 question 環境的區別是
%D question 环境的 answer 控制答案是否显示在题干以及设置相关样式。
%D choice   环境的 answer 控制答案是否显示在选项以及设置相关样式。

%D 另外，choice 環境有一個特別的值：
%D maxiwidth key is for calcaluted max width of choice and waited to be compare，
%D notice this key is maxiwidth ,and difference from maxwidth which
%D for setupitemgroup command

\installnamespace          {choice}
\installcommandhandler \????choice    {choice}    \????choice

\appendtoks
  \setuevalue        {\currentchoice}{\directnamedchoice[\currentchoice]}%
  \setuevalue{\e!start\currentchoice}{\startnamedchoice [\currentchoice]}%
  \setuevalue{\e!stop \currentchoice}{\stopnamedchoice}%
\to \everydefinechoice

\setupchoice [answerstyle=\ss,
              answercolor=red,
              inlinechoice=false,
              point=\questionparameter\c!point,
              maxiwidth=.9\hsize,
              numberconversion=A,]

\setvalue{\??itemgroupkeyword\v!vertical}{\setfalse\c_strc_itemgroups_horizontal
                                          \setfalse\c_strc_itemgroups_collecting
                                          \setfalse\c_strc_itemgroups_inline
                                          \setfalse\c_strc_itemgroups_joined
                                          \strc_itemgroups_process_set_option_unpack}

\tolerant\protected\def\directnamedchoice[#S#1]#*[#S#2]#*[#S#3]#:#4%
{\begingroup
  \startnamedchoice[#1][#2][#3]%
    \def\citem_temp##1{\startcitem##1\stopcitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \processcommacommand[#4]\citem_temp
  \stopnamedchoice\endgroup}

\tolerant\protected\def\startnamedchoice[#S#1]#*[#S#2]#*[#S#3]#*%
 {\begingroup\def\currentchoice{#1}%
  \ifarguments
    \or\oneargumentstrue
    \or\twoargumentstrue  \setupcurrentchoice[#2]%
    \or\threeargumentstrue
      \ifhastok={#2}\setupcurrentchoice[#2]\fi
      \setupcurrentchoice[#3]%
  \fi
  \ifnum\c_envnumber = 2\relax
    \errmessage{you cannot put choice in problem environment.
                choice env can only be putted in question environment.}\fi
  \env_choicetrue\set_envitem_counter
  \ifdefined\currentuserorder
    \expandafter\show_check_info{\check_info}%
  \else
    \ifnum\c_envnumber = 3\relax
    \else \set_count_envlevel[choice]\fi
  \fi
  \doifelsesomething{\datasetvariable{ExamDatasetHelper}{\HelperID}{totalitemnumber}}% arg_1
     {\scratchcounter\datasetvariable{ExamDatasetHelper}{\HelperID}{totalitemnumber}}% arg_2
     {\scratchcounter\zerocount}% arg_3
  \c_totalchoicenumber=\number\scratchcounter\relax
  \doifelsesomething{\datasetvariable{ExamDatasetHelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\datasetvariable{ExamDatasetHelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\zerocount}%
  \c_availablecolumns=\number\scratchcounter\relax
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%    % if calc_horizontal_num >= tbl_cit_count
%%    %                                      set horizontal = tbl_cit_count
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count ~= 1
%%    %                                  set horizontal = two % calc_horizontal_num
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count == 1
%%    %                                      set horizontal = 1
%%    % 特别的， 3 选项 且 可排版最大列数为 2 时，排版 1 行
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \startluacode
  tbl_num_temp = {"one","two","three","four",
                  "five","six","seven","eight","nine"}
  local   tbl_cit_count         = tex.count['c_totalchoicenumber']
  local   available_columns     = tex.count['c_availablecolumns']
          available_columns_arg = ""
  if     (tbl_cit_count == 3) and (available_columns   <  tbl_cit_count)
  then    available_columns_arg = "one"
  elseif (tbl_cit_count >  1) and (available_columns   >= tbl_cit_count)
  then    available_columns_arg = "horizontal," .. tbl_num_temp[tbl_cit_count]
  elseif (tbl_cit_count >= 1) and (available_columns   <=            1 )
  then    available_columns_arg = "one"
  else    available_columns_arg = "horizontal,two"
  end
  \stopluacode
  \edef\currentrealavailablecolumns{\ctxlua{context(available_columns_arg,"")}}%
  \edef\p_option            {\choiceparameter\c!option      }%
  \edef\p_showanswer        {\choiceparameter\c!showanswer  }%
  \edef\p_choicetype        {\choiceparameter\c!inlinechoice}%
  \edef\p_correctsymbol     {\choiceparameter{correctsymbol}}%
  \edef\p_defaultoption     {A,packed,nowhite,joinedup      }%
  \edef\currentchoiceanswer {\choiceparameter\c!answer      }%
  \installitemgroupoption[choice][choice]%
  \ifx\p_choicetype\s!true
    \ifthreearguments      \startitemgroup[env:choice][text,#2][#3]%
      \else\iftwoarguments \startitemgroup[env:choice][text,#2][#2]%
      \else\ifonearguments \startitemgroup[env:choice][text,\p_option]%
        \fi
      \fi
    \fi
  \else
    \ifthreearguments
        \startitemgroup[env:choice][\ctxlua{context(available_columns_arg,"")},#2][#3]%
      \else\iftwoarguments
        \startitemgroup[env:choice][\ctxlua{context(available_columns_arg,"")},#2][#2]%
      \else\ifonearguments
        \startitemgroup[env:choice][\ctxlua{context(available_columns_arg,"")},\p_option]%
      \else
        \errmessage{You should define at least one instance for the current environment.}%
        \fi
      \fi
    \fi
  \fi
  \choiceparameter\c!inlineleft
  \ifmode_showanswer\else
    \ifx\p_showanswer\s!true
         \mode_showanswertrue
    \else\mode_showanswerfalse\fi
  \fi\usechoicestyleandcolor\c!textstyle\c!textcolor}

\protected\def\stopnamedchoice{%
  \removemarkedcontent[inlinechoice_punctuation]%
  \d_maxwidth_with_label = \dimexpr\d_width_cit_max +
                           \d_strc_itemgroups_list_width\relax
  \d_compared_maxwidth   = \choiceparameter{maxiwidth}  \relax
  \startluacode
    local a = tex.dimen['d_compared_maxwidth']
    local b = tex.dimen['d_maxwidth_with_label']
          c = math.floor(a/b)
  \stopluacode
%%   \d_compared_maxwidth 是可排版的最長寬度。
%%   a 和 b 將寬度數字化， 以備比較出可排版的欄數。
%%   因為取消了 choice 作為上級環境時的 \set_count_envlevel 因此，重定義 order。
%%   取消原因是 讓 choice 直接獲取 question 環境的 order。
  \edef\currentchoiceanswer{\collectedanswer}%
  \ifempty\currentchoiceanswer% 未從 選項 中收集到答案
    \edef\currentanswer{\choiceparameter\c!answer}
    \ifempty\currentanswer    % 未從 當前 choice 收集到答案
      \edef\currentanswer{\currentprevanswer}\fi% 讓 choice 繼承 前一個答案
  \else
    \edef\currentanswer{\collectedanswer}%
  \fi
  \def\currentavailablecolumns{\ctxlua{context(c,"")}}%
  \def\currentitemmaxwidth    {\the\d_width_cit_max}%
  \doifelsesomething{\choiceparameter\c!point}%
    {\scratchcountertwo\choiceparameter\c!point}%
    {\scratchcountertwo\zerocount}%
  \edef\currentpoint     {\the\scratchcountertwo}%
  \edef\currenttotalpoint{\the\scratchcountertwo}%
  \installdatacollector\installdatacollectorhelper
  \choiceparameter\c!inlineright
  \stopitemgroup
  \endgroup}

\setupchoice
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=.2\emwidth,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color,
   \c!symstyle=\itemgroupparameter\c!style,
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={A,packed,joinedup,nowhite,},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definechoice[choice]
\definechoice[inlinechoice]
\tolerant\def\setupinlinechoice[#1]{\setupchoice[inlinechoice][#1]}

\setupinlinechoice[option={text,8,packed,joinedup,nowhite,},
                   inlinechoice=\s!true,
                   correctsymbol={\symbol{marksquarecheck}},
                   inlineleft={ (\nobreak},
                   inlineright={\nobreak ) },
                   %lefttext={},
                   %righttext={},
                   answerstyle=ttx,
                   %stopper=,
                   %showanswer=,% shoule be empty before used
                   separator={\removeunwantedspaces,\space},
                   ]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 writing 环境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D 目前该环境只是初步的设计。
%D 如果只有同级的多个作文题目，只需要使用 writing 环境即可。
%D 但是，当一个作文体下面有多个子题目时，需要将子题目放到 subwriting 环境当中。

%D \startbuffer
%D \setupwriting[showanswer=true,showpoint=true]
%D \startwriting[point=45]
%D   作文题目说明
%D   \startanswer
%D     参考作文 1
%D   \stopanswer
%D \stopwriting
%D
%D \startwriting
%D 作文题目说明
%D   \startsubwriting[point=450]
%D     sub 作文题目说明
%D     \startanswer
%D       参考作文 2
%D     \stopanswer
%D   \stopsubwriting
%D   \startsubwriting[point=4588]
%D     sub 作文题目说明
%D     \startanswer
%D     参考作文 3
%D     \stopanswer
%D   \stopsubwriting
%D \stopwriting
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {writing}
\installcommandhandler \????writing   {writing}   \????writing

\appendtoks
  \setuevalue{\e!start\currentwriting}{\startnamedwriting[\currentwriting]}%
  \setuevalue{\e!stop \currentwriting}{\stopnamedwriting}%
\to \everydefinewriting

\tolerant\protected\def\startnamedwriting[#S#1]#*[#S#2]#*%
  {\begingroup\env_subwritingfalse
  \env_writingtrue\set_envitem_counter
  \edef\currentwriting{#1}%
  \setupcurrentwriting[#2]%注意，writing 没有单独的 itemgroup 环境
  \edef\p_writingtype{\writingparameter{subwriting}}%
  \installitemgroupoption[question][writing]%
  \startitemgroup[env:question]%
  \item[\writingparameter\c!reference]%
  \ifx\p_writingtype\s!true
    \env_subwritingtrue\set_envitem_counter
  \fi
  \set_count_envlevel[writing]%
  \showpointoranswer[writing][point]%
  \showpointoranswer[writing][answer]%
  \save_question_order}

\protected\def\stopnamedwriting{%
  \installpointoranswer[writing][point]%
  \installpointoranswer[writing][answer]%
  \ifenv_subwriting
    \installdatacollector\installdatacollectorhelper
  \else
    \ifnum\c_totalitemnumber>1\else
    %即便作文環境，內部也存在可能多個子題目，必須只有一個題目時才能執行
    \c_totalitemnumber=1\relax
    \installdatacollector\installdatacollectorhelper\fi
  \fi
  \stopitemgroup\endgroup}

\setupwriting
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color,
   \c!symstyle=\itemgroupparameter\c!style,
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\setupwriting
  [\c!answer={参见参考作文。},
   \c!answerstyle=\ttx,
   \c!answercolor=,
   \c!answerlabel={\examtexts{answer},},
   \c!pointstyle=\ttx,
  %\c!pointcolor=,
   \c!pointlabel={,\examtexts{point}},
   totalanswer={\examtexts{writing}},
  ]

\definewriting[writing]
\definewriting[subwriting]
\def\setupsubwriting{\setupwriting[subwriting]}
\setupsubwriting
  [answer={参见参考作文。},
   subwriting=true,
   pointlabel={,\examtexts{point}},
   totalanswer=\writingparameter\c!answer,]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 answer 环境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D 在(v20241023)中，删除了 answer 环境的标签通过 description 来进行设置。
%D 整体环境通过 textbackground 环境进行设置。
%D 该环境提供了一個特殊的鍵值 sctipt，該鍵值主要用於創建答題區域。
%D 該鍵值和 showanswer 鍵值是互斥的，不應該同時啟用。

%D \tex{answer} 是爲師生兩版設置的命令。但目前該命令和相關設置還具有諸多不足之處。
%D 只需要將該環境置於題目下方，即可獲取當前題目設定的答案，並可以爲其編寫答案解析。
%D
%D \startbuffer
%D \startquestion[showanswer=true,answer={answer for \currentitemgroup },point=12]
%D     The environment is located in: \currentitemgroup 。
%D     注意：\tex{answer} 可以獲取父環境或同級環境的答案而不必再次設置。
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \startquestion[showanswer=true,point=1]]
%D     The environment is located in: \currentitemgroup 。
%D     注意：\tex{answer} 可以獲取父環境或同級環境的答案而不必再次設置。
%D     \startchoice
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D \startbuffer
%D \startquestion[showanswer=true]
%D   The environment is located in: \currentitemgroup 。
%D     \startproblem[showanswer=true,left={(},right={)},distance=1em,stopper={}]
%D     \startpitem[showanswer=true,answer={Pitem 1},point=10]
%D        The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 2},point=20]
%D        The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 3},point=30]
%D        The environment is located in: \currentitemgroup 。 \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%%%%%%%

\installnamespace {answer}
\installnamespace {answeralternative}
\installnamespace {answerrenderings}

\installcommandhandler \????answer            {answer}            \????answer
\installcommandhandler \????answeralternative {answeralternative} \????answeralternative

\appendtoks
    \frozen\instance\protected\edefcsname        \currentanswer\endcsname{\answer_direct_instance}%
    \frozen\protected\instance\edefcsname\e!start\currentanswer\endcsname{\answer_start_instance [\currentanswer]}%
    \frozen\protected\instance\letcsname \e!stop \currentanswer\endcsname \answer_stop_instance
\to \everydefineanswer

\newtoks\everyanswer

\tolerant\protected\def\answer_direct_instance[#S#1]#:#2%
  {\begingroup
  \env_answertrue
  \env_questionfalse   \env_problemfalse \env_choicefalse
  \env_materialfalse   \env_closefalse   \env_writingfalse
  \env_subwritingfalse \item_pitemfalse  \item_fillinfalse
  \item_inlinechoicefalse             \set_envitem_counter
  \edef\currentanswer_bak{\currentanswer}%
  \cdef\currentanswer{#1}%
  \edef\getanswerbuffer{#2}%
  \edef\p_showanswer{\answerparameter\c!showanswer}%
  \edef\p_showscript{\answerparameter\c!showscript}%
  \edef\p_showpoint {\answerparameter\c!showpoint }%
  \ifx\p_showanswer\s!true
      \mode_showanswertrue
      \mode_showscriptfalse\fi
  \ifx\p_showscript\s!true
      \mode_showscripttrue
      \mode_showanswerfalse\fi
  \ifx\p_showpoint \s!true
      \mode_showpointtrue\fi
  \expand\everyanswer
  \ifmode_showscript\donetrue\fi
  \ifmode_showanswer\donetrue\fi
  \ifmode_showpoint \donetrue\fi
  \ifdone
    \answerparameter\c!before
    \dostarttagged\t!answer\currentanswer
    \begingroup
    \useanswerstyleandcolor\c!style\c!color
    \usealignparameter\answerparameter
    \edef\currentansweralternative{\answerparameter\c!alternative}%
    \ifcsname\currentansweralternativehash\s!parent\endcsname \else
      \let\currentansweralternative\s!default
    \fi
    \usesetupsparameter\answerparameter
    \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
    \directsetup\p_renderingsetup
    \endgroup\dostoptagged
    \answerparameter\c!after
  \fi\xdef\getanswercontent{\getanswerbuffer}\endgroup}

\permanent\protected\def\startanswer%
  {\begingroup
   \edef\currentanswer_bak{\currentanswer}%
   \lettonothing\currentanswer
   \doifelsenextoptionalcs\answer_start_delayed\answer_start_indeed}

\def\answer_start_delayed[#S#1]%
  {\doifelseassignmentcs{#1}%
     \answer_start_delayed_parameters
     \answer_start_delayed_name
   [#1]}

\def\answer_start_delayed_parameters[#S#1]%
  {\setupcurrentanswer[#1]%
   \answer_start_indeed}

\def\answer_start_delayed_name[#1]%
  {\cdef\currentanswer{#1}%
   \checkanswerparent
   \doifelsenextoptionalcs\answer_start_delayed_parameters\answer_start_indeed}

\protected\tolerant\def\answer_start_instance[#S#1]#*[#S#2]#*%
  {\begingroup
  \env_answertrue
  \env_questionfalse   \env_problemfalse \env_choicefalse
  \env_materialfalse   \env_closefalse   \env_writingfalse
  \env_subwritingfalse \item_pitemfalse  \item_fillinfalse
  \item_inlinechoicefalse                
  \set_envitem_counter
  \edef\currentanswer_bak{\currentanswer}% 備份之前的答案
 %  \lettonothing\currentanswer%釋放currentanswer
 % currentanswer 命令已經被其他環境定義為答案獲取命令，
 % 此處的 currentanswer 是定義環境命令，需要重新釋放。
  \cdef\currentanswer{#1}%
  \setupcurrentanswer[#2]%
  \grabbufferdatadirect
   % {\s!answer:\currentanswer}%
    {\s!answer}% unnested, as before
    {\e!start\currentanswer}%
    {\e!stop \currentanswer}}

\def\answer_start_indeed
  {\grabbufferdatadirect
   % {\s!answer:\currentanswer}%
    {\s!answer}% unnested, as before
    {\csstring\startanswer}%
    {\csstring\stopanswer}}

\permanent\protected\def\stopanswer{%
  \edef\p_showanswer{\answerparameter\c!showanswer}%
  \edef\p_showscript{\answerparameter\c!showscript}%
  \edef\p_showpoint {\answerparameter\c!showpoint }%
  \ifx\p_showanswer\s!true
      \mode_showanswertrue
      \mode_showscriptfalse\fi
  \ifx\p_showscript\s!true
      \mode_showscripttrue
      \mode_showanswerfalse\fi
  \ifx\p_showpoint \s!true
      \mode_showpointtrue\fi 
  \ifmode_showscript\donetrue\fi
  \ifmode_showanswer\donetrue\fi
  \ifmode_showpoint \donetrue\fi
  \ifdone
    \leftskip0pt\relax\rightskip\leftskip\relax
    \answerparameter\c!before
    \dostarttagged\t!answer\currentanswer
    \begingroup
    \useanswerstyleandcolor\c!style\c!color
    \usealignparameter\answerparameter
    \edef\currentansweralternative{\answerparameter\c!alternative}%
    \ifcsname\currentansweralternativehash\s!parent\endcsname \else
      \let\currentansweralternative\s!default
    \fi
    \usesetupsparameter\answerparameter
    \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
    \directsetup\p_renderingsetup
    \endgroup\dostoptagged
    \answerparameter\c!after
  \fi \xdef\getanswercontent{\getanswerbuffer}\endgroup}

\aliased\let\answer_stop_instance\stopanswer

% kind of nested, when we need it:
%
% \permanent\tolerant\protected\def\getanswer      [#1]{\normalexpanded{\getbufferdata[\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}
% \permanent\tolerant\protected\def\getinlineanswer[#1]{\normalexpanded{\inlinebuffer [\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}

% unnested, as before:

\permanent\tolerant\protected\def\getanswerbuffer      [#1]{\getbufferdata[\s!answer]}
\permanent\tolerant\protected\def\getinlineanswerbuffer[#1]{\inlinebuffer [\s!answer]}

\defineansweralternative
  [\s!default]
  [\c!renderingsetup=\????answerrenderings:\s!default]

\defineansweralternative
  [\s!none]
  [\c!renderingsetup=\????answerrenderings:\s!none]

% \startsetups[\????answerrenderings:\s!default]
%     \answerparameter\c!before
%     \usesetupsparameter\answerparameter
%     \getbufferdata[\s!answer]
%     \answerparameter\c!after
% \stopsetups

\startsetups[\????answerrenderings:\s!none]
\stopsetups

\startsetups[\????answerrenderings:\s!default]
  \setuptextbackground[env:answer]%
    [location=paragraph,width=local,
    leftoffset=1ex,rightoffset=1ex,
    before=,after=,
    %topoffset=.5ex,bottomoffset=.5ex,
    background=\answerparameter\c!background,
    backgroundcolor=\answerparameter\c!backgroundcolor,
    corner=\answerparameter\c!corner,
    frame=\answerparameter\c!frame,
    framecolor=\answerparameter\c!framecolor,
    rulethickness=\answerparameter\c!rulethickness,
    ]%
  \starttextbackground[env:answer]
  \useanswerstyleandcolor\c!style\c!color
  \ifenv_material% 可以用来做文章翻译或内容解释，
    \getanswerbuffer% 也可以直接放置在文章之后，或这每一个段落之后
  \else
    \ifmode_showscript
        \answerparameter{scriptcontent}%
    \else
      \noindent
      \showpointoranswer[answer][answer]%
      \showpointoranswer[answer][point]%
      \ifmode_showanswer
          \answerparameter\c!inbetween
          \getanswerbuffer
      \fi
    \fi
  \fi
  \stoptextbackground
\stopsetups

\tolerant\protected\def\startoldanswer[#1]#:#2\stopoldanswer%
{\begingroup
  \env_answertrue\set_envitem_counter
  \lettonothing\currentanswer%釋放currentanswer
  \lettonothing\getanswerbuffer\lettonothing\getinlineanswerbuffer
  % currentanswer 命令已經被其他環境定義為答案獲取命令，
  % 此處的 currentanswer 是定義環境命令，需要重新釋放。
  \cdef\currentanswer{#1}%
  \setupcurrentanswer[#2]%
  \edef\getanswerbuffer{#2}%
  \usesetupsparameter\answerparameter
  \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
    {#2}%%
% 需要注意，该命令会传递给 dataset，不同于 writing 环境的 currentanswer
% currentanswer 的目的是设置较短的作文答案。
% getanswercontent 则是设置完整的作文答案。
% 如果需要為其他環境獲取解析內容， 應該需要重定義命令（answer + currentQID）
\endgroup}

\startuseMPgraphic{normalframeMP}
  draw unitsquare xyscaled (\overlaywidth, \overlayheight);
\stopuseMPgraphic
\defineoverlay       [normalframeOL][\useMPgraphic{normalframeMP}]

%%%%% NOTICE : 目前，當用戶主動輸入值和選項值發生衝突時，並未設置警告信息!!!!
\def\getanswerforanswer{\datasetvariable{ExamDataset}{\QuestionID}{answer}}

\def\getpointforanswer{% used for answer env to auto get point
  \datasetvariable{ExamDataset}{\QuestionID}{point}}

\setupanswer
  [answerlabel={{\examtexts{answer}}},
  pointlabel={,\examtexts{point}},
  pointstyle=\answerparameter\c!style,
  pointcolor=\answerparameter\c!color,
  answerstyle=\answerparameter\c!style,
  answercolor=\answerparameter\c!color,
  style=\ss\it,
  before=\blank[halfline]\startnarrower,
  after=\blank[halfline]\stopnarrower,
  inbetween={\par},
  % showscript=true,
  scriptcontent={\noindent\ssx\gray Write Answer Here},
  \c!alternative=\s!default,
  background=normalframeOL,%% for env_answer textbackground
  %backgroundcolor=,
  %corner=,
  frame=on,
  %framecolor=,
  %rulethickness=,
  ]
\defineanswer[answer]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 pitem,citem 命令}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\installnamespace          {examitem}
\installcommandhandler \????examitem     {examitem}     \????examitem

\defineexamitem[pitem]
\def\setuppitem{\setupexamitem[pitem]}

\setuppitem    [%showpoint=,
                %point=,
                pointstyle=\ttx,
                %pointcolor=,
                pointlabel={,\examtexts{point}},
                answerlabel={\examtexts{answer},},
                %showanswer=,
                %answer=,
                answerstyle=ttx,
                %answerstyle=,
                %reference=,
                ]

\tolerant\protected\def\startpitem[#1]#*%
 {\begingroup
  \edef\currentexamitem{pitem}%
  \item_pitemtrue\set_envitem_counter
  \iffirstargument\setuppitem[#1]\fi%
  \startitem[\examitemparameter{pitem}{reference}]%
    \set_count_envlevel [pitem]%
    \showpointoranswer  [examitem][point]%
    \showpointoranswer  [examitem][answer]%
    \useexamitemstyleandcolor\c!textstyle\c!textcolor
}

\def\stoppitem{%
  \installpointoranswer[examitem][answer]%
  \installpointoranswer[examitem][point]%
  \installdatacollector\installdatacollectorhelper
  \stopitem\endgroup}

%D [*](用于标记正确答案)

\defineexamitem[citem]
\def\setupcitem{\setupexamitem[citem]}

\setupcitem[
  %style=,
  %color=,
]

\def\tempexamchoicecounter{%
\begingroup% copy from \strc_itemgroups_insert_item_counter_indeed
  \setupcounter
    [\v_strc_itemgroups_counter]%
    [\c!prefix=\itemgroupparameter\c!prefix,
      \c!prefixstopper=\itemgroupparameter\c!prefixstopper,
      \c!prefixseparatorset=\itemgroupparameter\c!prefixseparatorset,
      \c!prefixconversion=\itemgroupparameter\c!prefixconversion,
      \c!prefixconversionset=\itemgroupparameter\c!prefixseparatorset,
      \c!prefixset=\itemgroupparameter\c!prefixset,
      \c!prefixsegments=\itemgroupparameter\c!prefixsegments,
      \c!prefixconnector=\itemgroupparameter\c!prefixconnector,
      \c!criterium=\itemgroupparameter\c!criterium,
      \c!numberorder=\ifconditional\c_strc_itemgroups_reverse\v!reverse\else\v!normal\fi,
      \c!numberconversionset=\v_strc_itemgroups_counter,
      \c!numbersegments=\currentitemgroupsegments]%
  \normalexpanded{\defineconversionset[\v_strc_itemgroups_counter][\currentitemgroupconversionset][\currentitemgroupsymbol]}%
  \convertedcounter[\v_strc_itemgroups_counter]%
\endgroup
}

\edef\applychoicestyleandcolor{%
  \ifempty\p_answerstyle
        \dousestyleparameter{\questionparameter\c!answerstyle}%
  \else \dousestyleparameter{\choiceparameter  \c!answerstyle}\fi
  \ifempty\p_answercolor
        \dousecolorparameter{\questionparameter\c!answercolor}%
  \else \dousecolorparameter{\choiceparameter  \c!answercolor}\fi
}

\protected\def\check_correct_choice#1#2{%
  \useexamitemstyleandcolor\c!textstyle\c!textcolor
  \edef\p_correctmark_m{*}\edef\p_correctmark_p{#1}%
  \edef\p_answerstyle{\choiceparameter\c!answerstyle}%
  \edef\p_answercolor{\choiceparameter\c!answercolor}%
  \ifx\p_choicetype\s!true% if inlinechoice
    \ifx\p_correctmark_p\p_correctmark_m
      \ifx\p_correctsymbol\c!default
        \startitem[\namedexamitemparameter{citem}\c!reference]%
          \bgroup
          \ifmode_showanswer\applychoicestyleandcolor\fi
          #2\collectanswer{#2}%
          \egroup
        \stopitem
      \else
        \bgroup
        \ifmode_showanswer\applychoicestyleandcolor
          \sym{\ifempty\p_correctsymbol\symbol{marksquarecheck}\else
                      \p_correctsymbol\fi}% correct inline choice
        \fi
        #2\collectanswer{#2}%
        \egroup
      \fi
    \else
    \startitem[\namedexamitemparameter{citem}\c!reference]#2\stopitem
    \fi
  \else% 如果不是 inlinechoice
    \ifx\p_correctmark_p\p_correctmark_m% 如果标记正确答案
      \startitem[\namedexamitemparameter{citem}\c!reference]%
        \bgroup
          \ifmode_showanswer\applychoicestyleandcolor\fi
          #2
        \egroup
      \stopitem
      \edef\currentanswerindex{\the\c_currentitemnumber}%
      \edef\correct_choice_index{\convertnumber{\choiceparameter{numberconversion}}{\currentanswerindex}}%
      \collectanswer{\correct_choice_index}% collect current normal answer
    \else% 必须分离已标记和未标记的答案，来进行正确的样式设置
      \startitem[\namedexamitemparameter{citem}\c!reference]#2\stopitem
    \fi%
  \fi
  \ifx\p_choicetype\s!true
    \markcontent[inlinechoice_punctuation]{\choiceparameter\c!separator}%
  \fi}

\protected\def\get_citem_text[#1]{\setbox0=\hbox{#1}%
    \d_width_cit = \the\wd0\relax%relax is neccessary
    \ifdim \d_width_cit_max > \d_width_cit%
           \d_width_cit_max = \d_width_cit_max%
    \else  \d_width_cit_max = \d_width_cit%
    \fi}%%%% 遞歸計算出最大寬度

\tolerant\protected\def\startcitem[#1]#*[#2]#:#3\stopcitem{% #1 correct answer
  \edef\currentexaminfo{citem}%
  \ifsecondargument\setupcitem[#2]\fi%                     #2 option
  \get_citem_text[#3]%                                     #3 choice content
  \edef\p_correctmark_p{#1}\edef\p_correctmark_m{*}%
  \incrementitemnumber
  \check_correct_choice{#1}{#3}%
  \removeunwantedspaces
  \lettonothing\currentexaminfo}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{定义同义命令}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D \startquestion[showanswer=true]
%D \fastchoice{a,\correct{F},{[*]E},}
%D \stopquestion

%D \startquestion[showanswer=true]
%D \fastchoicealt{a,\correct{F},{[*]sF}}
%D \stopquestion

\def\pitem{\dosingleempty\pitem_indeed}
\def\pitem_indeed[#1]#2{
  \startpitem[#1]{#2}\stoppitem}

\def\citem{\dosingleempty\citem_indeed}
\def\citem_indeed[#1]#2{%
  \startcitem[#1]{#2}\stopcitem}

\tolerant\protected\def\fastchoice[#1]#:#2{
  \startchoice[#1]%
    \def\citem_temp##1{\startcitem##1\stopcitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \processcommacommand[#2]\citem_temp
  \stopchoice}

\tolerant\protected\def\fastchoicealt[#1]#:#2{
  \startinlinechoice[#1]%
    \def\citem_temp##1{\startcitem##1\stopcitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \processcommacommand[#2]\citem_temp
  \stopinlinechoice}

%D 谨慎使用下面的 fragilecitem，他并不安全。很有可能导致错误

\bgroup
\obeylines
\gdef\xcitem{\bgroup\obeylines\dosingleempty\doxcitem}%
\gdef\doxcitem[#1]#2
  {\egroup%
  \doifsomethingelse{#1}%
  {\startcitem[*]#2\stopcitem}%
  {\startcitem #2\stopcitem}%
  }%
\egroup

\let\fragilecitem\xcitem

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{設置 fillin 命令}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D The command is recommended to be used within the pitem environment.
%D Of course, since pitem itself also has an answer key, it can be set through this key.
%D
%D The fillin command mainly relies on the bar command.
%D Basically, modifying the bar command can modify the fillin command.
%D The fillin command has two parameters that refer to textnote: empty and n.
%D empty=yes hides the answer; empty=number shows the number and hides the answer; empty=none shows the answer.
%D n=* hides the answer, with a length equal to the answer length; n=NUMBER controls the length of the bar.

%D bar 主要有四種樣式，可以通過 mp 參數進行設置：
%D rules:under:dots    %rules:under:random
%D rules:under:dash    %rules:under:wave

%D 新增一个 align=autoright 来让 fillin 对齐右方。

\installnamespace {fillin}
\installnamespace {fillinalternative}
\installnamespace {fillinrenderings}

\installframedcommandhandler\????fillin            {fillin}            \????fillin   
\installcommandhandler      \????fillinalternative {fillinalternative} \????fillinalternative

\setupfillin[%foregroundcolor=,
             %before=,after=,
             %left=,right=,
             %repeat=,mp=
              rule=FillinText,% 引用 bar 命令
              empty=yes,
              continue=yes,
              unit=em,
              order=foreground,
              method=0,
              %color=gray,
              width=4em,
              n=4,
              dy=-0.4,
              max=3,
              offset=-.1,
              rulethickness=.05,
              style=\ss,]

% \setupfillin[width=fit,offset=0pt,location=low] %if alternative=framed

\tolerant\protected\def\fillin[#1]#:#2{%
  \begingroup
    \item_fillintrue\null
    \global\advance\c_fillinnumber by 1\relax
    \iffirstargument\setupfillin[#1]\fi
    \edef\currentfillinanswer{#2}%
    \edef\p_number{\number\c_fillinnumber}%
    \edef\p_align{\fillinparameter\c!align}%
    \edef\currentfillinalternative{\fillinparameter\c!alternative}%
    \ifcsname\currentfillinalternativehash\s!parent\endcsname\else
      \let\currentfillinalternative\s!default
    \fi
    \usesetupsparameter\fillinparameter
    \edef\p_renderingsetup{\fillinalternativeparameter\c!renderingsetup}%
    \ifx\p_align\c!autoright
      \unskip\nobreak\hfill
      \penalty50\hskip2em\hbox{}\nobreak\hfill
    \fi
    \usefillinstyleandcolor\c!style\c!color
    \fillinparameter\c!before
    \fillinparameter\c!left
    \directsetup\p_renderingsetup
    \fillinparameter\c!right
    \fillinparameter\c!after
    \ifx\p_align\c!autoright
      \parfillskip=0pt \finalhyphendemerits=0 \par\fi
    \edef\currentanswer      {#2\collectanswer{#2}}%
    \edef\currentfillinanswer{\collectedanswer}%
    \ifempty\currentfillinanswer
         \edef\currentanswer{\currentprevanswer}% 讓 fillin 繼承 前一個答案
    \else\edef\currentanswer{\collectedanswer}%
    \fi\aftergrouped{\xdef\currentprevanswer{\collectedanswer}}%
    \endgroup}

\definefillinalternative
  [\s!default]
  [\c!renderingsetup=\????fillinrenderings:\s!default]

\definefillinalternative
  [framed]
  [\c!renderingsetup=\????fillinrenderings:framed]

\startsetups[\????fillinrenderings:\s!default]
  \edef\currentbar{\fillinparameter\c!rule}%
  \setupbar[\currentbar][%
           rulethickness=\fillinparameter{rulethickness},
         foregroundcolor=\fillinparameter{foregroundcolor},
         foregroundstyle=\fillinparameter{style},
                continue=\fillinparameter{continue},
                    unit=\fillinparameter{unit},
                   order=\fillinparameter{order},
                  method=\fillinparameter{method},
                      dy=\fillinparameter{dy},
                     max=\fillinparameter{max},
                    left=\fillinparameter{left},
                   right=\fillinparameter{right},
                  repeat=\fillinparameter{repeat},
                   color=\fillinparameter{color},
                  offset=\fillinparameter{offset},
                   empty=\fillinparameter{empty},
                      mp=\fillinparameter{mp}]%
  \edef\p_n{\fillinparameter\c!n}%
  \edef\p_empty{\fillinparameter\c!empty}%
  \ifx\p_n\wildcardsymbol
      \ifmode_showanswer\setupfillin[empty=none]\fi
      \edef\p_empty{\fillinparameter\c!empty}%
      \ifx\p_empty\v!number
        \inlinebar[\currentbar]\bgroup
        \interwordspacesbefore2
        \zwnj\runninghbox{\resetbar\p_number}\zwnj
        \interwordspacesafter2
        \egroup
      \else
        \inlinebar[\currentbar]\bgroup
          \wordboundary\zwnj\currentfillinanswer\zwnj
          \egroup
      \fi
    \else
      \ifmode_showanswer\setupfillin[empty=none]\fi
      \edef\p_empty{\fillinparameter\c!empty}%
      \inlinebar[\currentbar]\bgroup
        \wordboundary\scratchcounter\numexpr\p_n\relax
        \ifx\p_empty\v!yes
          \interwordspacesbefore\scratchcounter
          \interwordspacesafter\scratchcounter
        \else\ifx\p_empty\v!number
          \interwordspacesbefore\scratchcounter
          \zwnj\runninghbox{\resetbar\p_number}\zwnj
          \interwordspacesafter\scratchcounter
        \else\ifx\p_empty\v!none
          \scratchcounter\numexpr\p_n/\plustwo\relax
          \interwordspacesbefore\scratchcounter
          \zwnj{{\currentfillinanswer}}\zwnj
          \interwordspacesafter\scratchcounter
        \else\currentfillinanswer\fi\fi
        \fi
      \egroup
    \fi
\stopsetups

\startsetups[\????fillinrenderings:framed]
  \edef\p_n{\fillinparameter\c!n}%
  \edef\p_empty{\fillinparameter\c!empty}%
  \ifx\p_n\wildcardsymbol
      \ifmode_showanswer\setupfillin[empty=none]\fi
      \edef\p_empty{\fillinparameter\c!empty}%
      \ifx\p_empty\v!number
        \inheritedfillinframed\bgroup
        \interwordspacesbefore2
        \zwnj\p_number\zwnj
        \interwordspacesafter2
        \egroup
      \else
        \inheritedfillinframed\bgroup
        \wordboundary\zwnj\currentfillinanswer\zwnj
        \egroup
      \fi
    \else
      \ifmode_showanswer\setupfillin[empty=none]\fi
      \edef\p_empty{\fillinparameter\c!empty}%
        \wordboundary\scratchcounter\numexpr\p_n\relax
        \ifx\p_empty\v!yes
          \inheritedfillinframed\bgroup
          \interwordspacesbefore\scratchcounter
          \interwordspacesafter\scratchcounter
          \egroup
        \else\ifx\p_empty\v!number
          \inheritedfillinframed\bgroup
          \interwordspacesbefore\scratchcounter
          \zwnj\p_number\zwnj
          \interwordspacesafter\scratchcounter
          \egroup
        \else\ifx\p_empty\v!none
          \inheritedfillinframed\bgroup
          \scratchcounter\numexpr\p_n/\plustwo\relax
          \interwordspacesbefore\scratchcounter
          \zwnj{{\currentfillinanswer}}\zwnj
          \interwordspacesafter\scratchcounter
          \egroup
        \else\currentfillinanswer\fi\fi
        \fi
    \fi
\stopsetups

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{設置 material 環境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D 顧名思義，\tex{material} 環境用來放置大段文本材料。
%D 該環境比較特殊，它設置了多個子實例來進行更完善的設置。
%D 除了 \tex{setupmaterial[number]} 這個實例繼承了 \tex{setupcounter} 的全部鍵值之外，
%D 其他實例都是新定義的鍵值。

%D 這些實例分別是：
%D \startitemize[nowhite,joinedup,packed]
%D \item \tex{setupmaterial[number]}    設置 該環境標題的 {\bf 序號};
%D \item \tex{setupmaterial[title]}     設置 該環境的 {\bf 標題} 相關的樣式;
%D \item \tex{setupmaterial[author]}    設置 該環境文章的 {\bf 作者} 相關的樣式;
%D \item \tex{setupmaterial[source]}    設置 該環境文章的 {\bf 具體來源} 的相關樣式。
%D \item \tex{setupmaterial[indicator]} 設置 該環境文章的 {\bf 畫線序號文字} 的相關樣式。
%D \stopitemize

%D 此外，\type{title},\type{author},\type{source} 的名稱是通過 \tex{setupmaterial}
%D 來直接設置。此外， 該環境具有一個特殊的子命令 \tex{indicator} 來標記文章中的提問的部分並
%D 進行添加數字標識 --- （一）畫線文字。因此，\tex{setupmaterial} 還具有一個鍵值 indicator
%D 通過 \type{indicator=reset} 對 indicator 進行重置，每當開啓一個新的 material 環境。
%D 通過 \type{indicator=continue} 對 indicator 取消重置，它將持續計數。
%D 當然，也可以直接通過 \tex{setupmaterial[indicator][reset=true]} 來啓用重新計數

%D 以上所有實例都具有以下鍵值：
%D before after align style color
%D 此外，\tex{setupmaterial} 可以通过 spacebefore 和spaceafter 来控制环境前后的垂直距离

%D notice , if you want change [start = number] after a chapter ,
%D you should use \tex{resetcount[COUNTER_NAME]} to reset current counter
%D to the number of start you've setted.
%D otherwise, you need put [start = number] before the chapter you want
%D to reset the counter.

%D \startbuffer
%D \setupmaterial[title][color=green]
%D \startmaterial[title={Knuth},author={Mos},source={Yelu}]
%D \input knuth
%D \stopmaterial
%D \startmaterial[indent=no]
%D   \startcolumns[n=2,separator=rule]
%D     \input knuth
%D     \indicator{mark 1}
%D     \indicator{mark 1}
%D     \indicator{mark 1}
%D   \column
%D     \startanswer
%D       \bold{\ssa Here is answer.}
%D       \input knuth
%D     \stopanswer
%D   \stopcolumns
%D \stopmaterial
%D
%D \startquestion
%D   \indicator{mark 1}
%D \stopquestion
%D \startquestion
%D   \indicator{mark 1}
%D \stopquestion
%D \startquestion
%D   \indicator{mark 1}
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {material}
\installcommandhandler \????material  {material}  \????material
\installcounterassociation {material}

\appendtoks
   \registermaterialcounter\currentmaterial
   \definecounter[\currentmaterial]%
\to \everydefinematerial

\appendtoks
   \synchronizematerialcounters
\to \everysetupmaterial

\definematerial [material]
\definematerial [number]
\definematerial [indicator]
\definematerial [indicator_helper][indicator]

\setupmaterial [\c!align=center,
                %\c!color=,
                %\c!style=,
                \c!spacebefore=1em,
                \c!spaceafter=1em,
                %\c!title=,
                %\c!author=,
                %\c!source=,
                \c!indicator=continue,
                indent={first,always,2em},]
\setupmaterial [\c!number] [\c!before={(},\c!after={)},
                            \c!prefix=no,\c!start=0,
                            \c!style=\namedmaterialparameter\c!title\c!style,
                            \c!color=\namedmaterialparameter\c!title\c!color,
                            \c!numberconversion=cn,\c!way=\v!by\v!chapter]
\setupmaterial [\c!title]  [\c!style=\ss\tfa,\c!color=,\c!align=center,
                            \c!before=,]
\setupmaterial [\c!author] [\c!style=\tf,\c!color=,\c!align=flushright]
\setupmaterial [\c!source] [\c!before=\par,\c!align=flushright]
\setupmaterial [indicator]
               [\c!style=\ssbf,
                \c!color=,
                \c!before={\;(\nobreak\,\nobreak},
                \c!after={\nobreak\,\nobreak)\;},
                \c!prefix=no,
                \c!numberconversion=cn,
                \c!type=line,
                \c!reset=false,
                \c!method=0,
                \c!continue=\v!yes,
                \c!empty=,
                \c!offset=-0.3,
                \c!dy=-0.4,
                \c!max=3,
                \c!rulethickness=.1,
                \c!order=\v!foreground,
                \c!unit=ex,]

\def\material_counter_parameter#1%
  {\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\c!title\c!align]%
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \incrementcounter[#1]\convertedcounter[#1]%
    \namedmaterialparameter\currentmaterial\c!after
   \endgroup}

\def\material_parameter#1%creat new element in material
  {{\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\currentmaterial\c!align]%
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \rootmaterialparameter\currentmaterial
    \namedmaterialparameter\currentmaterial\c!after
    \par\endgroup}}

\tolerant\protected\def\startmaterial[#1]#*{\begingroup%
  \lettonothing\currentmaterial%%
  \edef\p_indicator{\rootmaterialparameter\c!indicator}%
  \edef\p_reset{\namedmaterialparameter{indicator}\c!reset}%
  \processaction[\p_indicator][
    reset=>\let\indicator_reset_helper\resetindicators,
  continue=>\continue_countertrue\let\indicator_reset_helper\relax,]%
  \processaction[\p_reset][
    true=>\let\indicator_reset_helper\resetindicators,
    false=>\continue_countertrue\let\indicator_reset_helper\relax,]%
  \env_materialtrue\set_envitem_counter%
  \iffirstargument\setupcurrentmaterial[#1]\fi
  \indicator_reset_helper
  \usematerialstyleandcolor\c!style\c!color%
  \blank[\rootmaterialparameter\c!spacebefore]%
  \startalignment[\rootmaterialparameter\c!align]%
      \material_counter_parameter\c!number
      \material_parameter\c!title
      \material_parameter\c!author
  \stopalignment
  \blank[\rootmaterialparameter\c!spaceafter]%
  \setupindenting[\rootmaterialparameter{indent}]}

\def\stopmaterial{%
    \material_parameter\c!source
    \indicator_reset_helper
    \endgroup}

\tolerant\protected\def\indicator[#1]#:#2%
  {\begingroup\def\currentmaterial{indicator}%
  \setupmaterial[\currentmaterial][#1]%
  \edef\indicator_type{\namedmaterialparameter\currentmaterial\c!type}%
  \edef\indicator_reset{\namedmaterialparameter\currentmaterial\c!reset}%
  \namedmaterialparameter\currentmaterial\c!style
  \setupbars
    [\c!method=\namedmaterialparameter\currentmaterial\c!method,% new: 0=center nested, 1=stack nested
    \c!continue=\namedmaterialparameter\currentmaterial\c!continue,
    \c!empty=\namedmaterialparameter\currentmaterial\c!empty,   % new: yes = hide text
    \c!offset=\namedmaterialparameter\currentmaterial\c!offset, % upwards, replaces: topoffset bottomoffset
    \c!dy=\namedmaterialparameter\currentmaterial\c!dy,
    \c!max=\namedmaterialparameter\currentmaterial\c!max,
    \c!style=\namedmaterialparameter\currentmaterial\c!style,
    \c!rulethickness=\namedmaterialparameter\currentmaterial\c!rulethickness,
    \c!order=\namedmaterialparameter\currentmaterial\c!order,
    \c!unit=\namedmaterialparameter\currentmaterial\c!unit,  % so now we are relative
    \c!color=\namedmaterialparameter\currentmaterial\c!color]% replaces: rulecolor
  \processaction[\indicator_type]%
            [line=>\let\indicator_type\underbar,%
             none=>\let\indicator_type\relax]%
  \usematerialstyleandcolor\c!style\c!color%
  \indicator_type\bgroup
  \namedmaterialparameter\currentmaterial\c!before%
  \ifmode_debug
    \ifenv_material\color[red]{material}\else\color[red]{\currentitemgroup}\fi
    \ifcontinue_counter\color[red]{continue}\fi
  \fi
  \ifenv_material
    \incrementcounter[\currentmaterial]%
    \convertedcounter[\currentmaterial]%
  \else
    \incrementcounter[indicator_helper]%
    \convertedcounter[indicator_helper]%
  \fi
  \namedmaterialparameter\currentmaterial\c!after
  \penalty0\relax
    #2\egroup
  \endgroup}

\def\indicators{%%% TODO 增強該命令的用法
  \ifenv_material
    \incrementcounter[indicator]%
    \convertedcounter[indicator]%
  \else
    \incrementcounter[indicator_helper]%
    \convertedcounter[indicator_helper]%
  \fi}
\def\resetindicators{\setcounter[indicator][0]%
                     \setcounter[indicator_helper] [0]}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Chinese Verse}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\installnamespace          {verse}
\installcommandhandler \????verse            {verse}            \????verse
\def\c!verse{verse}
\def\c!skip{skip}

\defineverse[\c!title]
\defineverse[\c!author]
\setupverse            [%title=,author=,source={KKK},skip=both,
                        \c!sample={一二三四五六七}, \c!skip=\v!left]
\setupverse [\c!title] [\c!align=center,    \c!style=bf,\c!skip=\v!both,\c!before=,\c!after=]
\setupverse [\c!author][\c!align=flushright,\c!style=it,\c!skip=\v!both,\c!before=,\c!after=]
\setupverse [\c!source][\c!align=flushright,\c!style=it,\c!skip=\v!both,\c!before=,\c!after=]

\newdimen\d_temp_leftskip
\newdimen\d_temp_maxwidth
\def\c_verse_skip{%
 \ifx\verse_skip\v!left\leftskip\d_temp_leftskip\relax\fi
 \ifx\verse_skip\v!right\rightskip\d_temp_leftskip\relax\fi
 \ifx\verse_skip\v!both
   \leftskip\d_temp_leftskip\relax
   \rightskip\leftskip\relax
 \fi}

\def\verse_element#1%
  {\begingroup%
  \edef\currentverse{#1}%
  \edef\verse_skip{\namedverseparameter\currentverse\c!skip}%
  \c_verse_skip
  \namedverseparameter\currentverse\c!before
  \startalignment[\namedverseparameter\currentverse\c!align]
  \useversestyleandcolor\c!style\c!color
  \rootverseparameter\currentverse
  \stopalignment
  \namedverseparameter\currentverse\c!after
  \endgroup}

\tolerant\protected\def\startverse[#1]#*%
  {\begingroup\parindent0pt\relax\let\\\par
  \iffirstargument\setupverse[#1]\fi
  \edef\verse_skip{\verseparameter\c!skip}%
  \setwidthof{\verseparameter\c!sample}\to\d_temp_maxwidth
  \d_temp_leftskip=\dimexpr.5\textwidth-.5\d_temp_maxwidth\relax
  \ifx\verse_skip\v!none\relax\else
    \c_verse_skip
  \fi
  \verseparameter\c!before
  \verse_element \c!title
  \verse_element \c!author
  \useversestyleandcolor\c!style\c!color
  \ifx\verse_skip\v!none
  \startalignment[\verseparameter\c!align]\fi}

\def\stopverse{\par\ifx\verse_skip\v!none\stopalignment\fi
  \leftskip0pt\rightskip\leftskip\relax
  \verse_element\c!source\verseparameter\c!after\endgroup}

% \setupverse [\c!sample={滾滾長江東逝水浪花淘盡英雄},\c!skip=\v!left,before=\blank,after=\blank]
% \setupverse [\c!title] [\c!align=center,\c!style=bf,\c!skip=\v!both]
% \setupverse [\c!author][\c!align=flushright,\c!style=it,\c!skip=\v!both]
% \setupverse [\c!source][\c!align=flushright,\c!style=it,\c!skip=\v!both]

% \startbuffer
% \startverse[title=临江仙 $\cdot$ 滚滚长江东逝水,author=明 $\cdot$ 杨慎]
% 滾滾長江東逝水浪花淘盡英雄\\
% 是非成敗轉頭空\\
% 青山依舊在 幾度夕陽紅\\
% 白髮漁樵江渚上 慣看秋月春風\\
% 一壺濁酒喜相逢\\
% 古今多少事 都付笑談中
% \stopverse
% \stopbuffer

% \getbuffer

% \setupverse[skip=none,align=center]
% \getbuffer

% \setupverse [\c!sample={\rma\bf滾滾長江東逝水浪花淘盡英雄},\c!skip=\v!left,style=\rma\bf]
% \setupverse [\c!title] [style=ssa]
% \getbuffer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Multilingual support}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \installlanguage [hans] [patterns={zh,en}]% install simplified  chinese
% \installlanguage [hant] [patterns={zh,en}]% install traditional chinese

% \setuplanguage[en]
%   [script=,
%    patterns=,
%    font=pagella,
%    align={bottom,width},
%    interlinespace=2.8ex,
%    indenting=none,
%   ]

% \setuplanguage[cn]
%   [script=nihongo,
%    patterns={zh,en},
%    font=pagella,% 需要修改為對應的中文字體
%    align={height,hanging,justified},
%    interlinespace=1.5em,
%    indenting={first,always,2em},
%   ]

% \setuplanguage[hans]
%   [script=nihongo,
%    patterns={zh,en},
%    font=pagella,% 需要修改為對應的中文字體
%    align={height,hanging,justified},
%    interlinespace=1.5em,
%    indenting={first,always,2em},
%   ]

% \setuplanguage[hant]
%   [script=nihongo,
%    patterns={zh,en},
%    font=pagella,% 需要修改為對應的中文字體
%    align={height,hanging,justified},
%    interlinespace=1.5em,
%    indenting={first,always,2em},
%   ]

% \setuplanguage[ja]
%   [script=nihongo,
%    patterns=en,
%    font=pagella,% 需要修改為對應的日文字體
%    align={height,hanging,justified},
%    interlinespace=1.5em,
%    indenting={first,always,1em},
%   ]

% \appendtoks
%   \setupalign[\languageparameter\c!align]
%   \setscript[\languageparameter{script}]
%   \switchtobodyfont[\languageparameter\c!font]
%   \setupindenting[\languageparameter\c!indenting]
%   \setupinterlinespace[line=\languageparameter{interlinespace}]
% \to \everylanguage

%D \startlanguage[en]
%D lipsum
%D \stoplanguage
%D
%D \startlanguage[cn]
%D 亂數假文
%D \stoplanguage
%D
%D \startlanguage[hans]
%D 亂數假文
%D \stoplanguage
%D
%D \startlanguage[ja]
%D ダミーテキスト
%D \stoplanguage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{设置 close 环境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D close 環境近乎是單獨設計的。還需要改進：直接使用 itemgroup 重置，該環境主要使用兩個命令：
%D \tex{startclose} 和 \tex{stopclose} 用來創建該環境，
%D \tex{closechoice} 用來標記環境內的選項，該命令隨行文放置即可。選項無須再次在文章後放置，
%D \tex{stopclose} 會自行放置。
%D 因為 \type{close} 環境的子項目 \tex{closechoice} 是通過 choice 環境設置的。
%D 因此，可以通過 \type{[*]} 來標記正確答案。

%D close 環境同樣繼承了 answer 的鍵值。
%D 此外設置了 reset 鍵來選擇是否每一篇重置選項的題號，
%D 其他的鍵值： barcolor barstyle 設置 下划線樣式
%D            before after style color 用於整體環境
%D            width frame stopper distance 用於選項前題號樣式

%D \startbuffer
%D \startclose
%D On Oct. 11, hundreds of runners competed in a cross-country race in Minnesota.
%D Melanie Bailey should have \closechoice[designed,followed,changed,finished] the
%D course earlier than she did. Her \closechoice[delay,chance,trouble,excuse] came
%D because she was carrying a \closechoice[judge,volunteer,classmate,competitor]
%D across the finish line.
%D
%D As reported by a local newspaper, Bailey was more than two-thirds of the way
%D through her \closechoice[race,school,town,training] when a runner in front of
%D her began crying in pain. She \closechoice[agreed,returned,stopped,promised]
%D to help her fellow runner, Danielle Lenoue. Bailey took her arm to see if she
%D could walk forward with \closechoice[courage,aid,patience,advice] . She couldn't.
%D Bailey then \closechoice[went away,stood up,stepped aside,bent down] to let Lenoue
%D climb onto her back and carried her all the way to the finish line, then another
%D 300 feet to where Lenoue could get \closechoice[medical,public,constant,equal] attention.
%D
%D Once there, Lenoue was \closechoice[interrupted,assessed,identified,appreciated]
%D and later taken to a hospital, where she learned that she had serious injuries in
%D one of her knees. She would have struggled with extreme \closechoice[hunger,pain,cold,tiredness]
%D to make it to that aid checkpoint without Bailey's help.
%D \stopclose
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {close}
\installcommandhandler \????close     {close}     \????close

\setupclose[reset=false,
            %barstyle=,
            %barcolor=,
            answerstyle=ttx,
            pointstyle=ttx,
            %answerstyle=,
            width=1.5em,% set order width
            answerwidth=4em,
            frame=off,% set order frame
            stopper=.,% set order stopper
            distance=.5em,% set order distance
            after=\blank[halfline]]

\c_closetest=1\relax
\tolerant\protected\def\closebar#1{
  \startbar[underbar]%
    \scratchcounter\numexpr16/\plustwo\relax
    \interwordspacesbefore\scratchcounter
      \zwj\runninghbox{\resetbar{#1}}\zwj
    \interwordspacesafter\scratchcounter
  \stopbar}

\def\closechoice[#1]{% 這是用戶命令，用來記錄選項(定義選項列表)
  \expandafter\def\csname close:\romannumerals\c_closetest\endcsname{#1}%
  % c_closetest 用於標記選項列表，會隨著選項題目增加，無論是否啓用重置，該計數器都會記錄並自增
  % 在生成選項序列時，該計數器可以進行：(1) 是否設置了選項 (2) 遞增出選項序列
  % 該計數器屬於局域，每篇文章都會重置回 1。
  \ifclose_counter_reset
    \begingroup
      \setupbar[underbar]%
       [color=\closeparameter{barcolor},
        mp=\closeparameter{barstyle}]%
      \closebar{\number\c_closetest}%
    \endgroup
  \else
    \begingroup\let\par\relax% 將其封裝在局域，避免 par 命令失效
       \setupbar[underbar]%
       [color=\closeparameter{barcolor},
        mp=\closeparameter{barstyle}]%
      \startitemgroup[env:question][n,continue,text,nostopper]%
                                   [lefttext=\closebar,righttext=]%
      \item \save_question_order
      \stopitemgroup
    \endgroup
  \fi\advance\c_closetest by 1\relax}

\def\close_order{%選項前的序號樣式，序號通過 tempa 設定
  \unskip\noindent
  \inframed[width=\closeparameter\c!width,
            frame=\closeparameter\c!frame,
            align=flushleft,
            foreground=color,
            foregroundcolor=\closeparameter\c!color,
            foregroundstyle=\closeparameter\c!style]{%
     \convertnumber{n}{\number\c_closetest_temp}%
     \closeparameter\c!stopper}%
   \hskip\closeparameter\c!distance\relax
   \global\advance\c_closetest_temp by 1\relax
  \unskip}

\def\docloseitem#1{\startcitem #1\stopcitem}
\def\placeclosechoice{%
  \scratchcounter\numexpr\c_closetest-1\relax
  \edef\p_showanswer{\closeparameter\c!showanswer}%
  \edef\p_showpoint {\closeparameter\c!showpoint }%
  \ifx\p_showanswer\s!true
      \mode_showanswertrue
      \mode_showscriptfalse\fi
  \ifx\p_showpoint \s!true
      \mode_showpointtrue\fi
  \c_closetest=1\relax%
   \dorecurse{\number\scratchcounter}{% start recurse
    \hbox{\hsize\textwidth
      \ifmode_showanswer\else\scratchdimen\zeropoint
      \ifmode_showpoint \else\scratchdimen\zeropoint\fi\fi
      \ifmode_showanswer
      \scratchdimen=\closeparameter{answerwidth}\relax\fi
      \ifmode_showpoint
      \scratchdimen=\closeparameter{answerwidth}\relax\fi
      \scratchdimenone=\closeparameter\c!width\relax
      \set_count_envlevel[close]%
      \vtop{\hsize\scratchdimen        
        \ifmode_showanswer\edef\temp_showanswer{}\fi
        \ifmode_showpoint \edef\temp_showpoint{ }\fi
        \showpointoranswer[close][point]%
        \showpointoranswer[close][answer]%
        \ifdefined\temp_showanswer\mode_showanswertrue\fi
        \ifdefined\temp_showpoint \mode_showpointtrue \fi}
      \ifdefined\currentprevpoint\else
        \edef\currentprevpoint {\closeparameter\c!point}\fi
      \ifdefined\currentprevanswer
        \edef\currentprevanswer{\closeparameter\c!answer}\else
        \edef\currentprevanswer{\closeparameter\c!answer}\fi
      \edef\currentitemnumber{\the\c_closetest_temp}%
      \edef\currentuserorder{%
        \currentitemnumber%放置在這裡才能正確獲取題號
        \ifnum\rawcountervalue[Unicode_botlevel]=0\else% 抽出 order 定義，
          (\rawcountervalue[Unicode_botlevel])\fi}% 因為該環境沒有上級 question 環境
      \vtop{\hsize\scratchdimenone\close_order}
      \vtop{\hsize=\dimexpr\textwidth-\scratchdimen-\scratchdimenone\relax 
        \startchoice
          \processcommacommand[\csname close:\romannumerals\c_closetest\endcsname]\docloseitem%
        \stopchoice
        }%
    }%
   \advance\c_closetest by 1\relax}% stop reucrse
  \c_closetest=1\relax%
}

\tolerant\protected\def\startclose[#1]#*%
 {\begingroup
  \env_closetrue\set_envitem_counter
  \iffirstargument\setupclose[#1]\fi
  \edef\p_reset{\closeparameter\c!reset}%
  \ifx\p_reset\s!true\close_counter_resettrue
  \else\close_counter_resetfalse\fi
  \restore_question_order
  \ifclose_counter_reset% 如果重置， 則序號起自 1
    \c_closetest_temp=1\relax% tempa 标记文章内的序号和选项前的序号
  \else% 否則， 恢復上一問題序號， 並遞增1.
    \c_closetest_temp=\rawcountervalue[strc_close_counter]%
    \c_closetest_temp=\numexpr\c_closetest_temp+1\relax
  \fi
  \closeparameter\c!before
  \useclosestyleandcolor\c!style\c!color}

\def\stopclose{%
  \closeparameter\c!after
  \placeclosechoice
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{設置 optclose 環境}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D 該環境是 close 環境的變體，但目前並未對該環境進行更多的設置。
%D 該環境的主要命令有兩個：
%D \tex{startoptclose} 和 \tex{stopoptclose} 用來創建該環境，
%D \tex{ocitem} 用來標記環境內的選項，該命令隨行文放置即可。
%D \tex{ocitem[answer=blabla]}\type{blablabla}

%D 此外，還有一個特殊的命令，\tex{specialocitem} 僅具有 answer 鍵值。可以通過
%D \tex{setupocitem} 來調整該命令的樣式。該命令標記答案，且無須任何環境包裹。

%D \startbuffer
%D \startoptclose
%D The latest \ocitem[answer=engineering]{engineer} techniques are applied to create
%D this protective \ocitem[answer=functional]{function} structure that is also
%D beautiful. The design features ten steel “sepals (萼片)” made of glass and
%D aluminium (铝). These sepals open on warm days \ocitem[answer=to give]{give} the
%D inside plants sunshine and fresh air. In cold weather, the structure stays
%D \ocitem[answer=closed]{close} to protect the plants.
%D
%D Further, the Silk Route Garden around the greenhouse \ocitem[answer=walks]{walk}
%D visitors through a journey influeVLed by the aVLient Silk Road, by which silk as
%D well as many plant species came to Britain for \ocitem[answer=the]{} first time.
%D These plants iVLluded modern Western \ocitem[answer=favorites]{favourite} such as
%D rosemary, lavender and fennel. The garden also contains a winding path that guides
%D visitors through the twelve regions of the Silk Road. The path offers over 300
%D plant species for visitors to see, too.
%D
%D The Glasshouse stands \ocitem[answer=as]{} a great achievement in contemporary
%D design, to house the plants of the southwestern part of China at the end of a path
%D retracing (追溯) the steps along the Silk Route \ocitem[answer=which that]{}
%D brought the plants from their native habitat in Asia to come to define much of the
%D \ocitem[answer=richness]{rich} of gardening in England.
%D \stopoptclose
%D \stopbuffer
%D \typebuffer
%D \getbuffer

\definequestion[optclose]
\definequestion[specialocitem]
\def\setupoptclose{\setupquestion[optclose]}
\def\setupspecialoptclose{\setupquestion[specialocitem]}

\setupquestion[optclose]
 [option={n,continue,text,nostopper},
  lefttext=\closebar,
  righttext=,
  reset=false,
  showanswer=false,
  showpoint=false,
  class=optclose,]

\setupquestion[specialocitem]
 [option={n,continue,text,nostopper},
  lefttext=\closebar,
  righttext=,
  reset=false,]

\defineexamitem[ocitem]
\def\setupocitem{\setupexamitem[ocitem]}

\setupocitem [%answer=,
              %color=,
              point=\currentprevpoint,
              %showanswer=false,
              pointlabel={,\examtexts{point}},
              answerlabel={{\examtexts{answer}},},
              %answerstyle=,
              pointstyle=ttx,
              answerstyle=ttx,]

\tolerant\protected\def\ocitem[#1]#:#2%
   {\begingroup
    \edef\currentexamitem{ocitem}%
    \iffirstargument\setupocitem[#1]\fi
    \useexamitemstyleandcolor\c!textstyle\c!textcolor
    \let\par\relax
    \item \parentitemnumber=\currentitemnumber\relax
          \set_count_envlevel[ocitem]%
          \namedexamitemparameter{ocitem}\c!left
          \allowbreak\doifsomethingelse{#2}{(#2)}{}% 放置選項，類似 inlinechoice
          \showpointoranswer   [examitem][point]%
          \showpointoranswer   [examitem][answer]%
          \installpointoranswer[examitem][answer]%
          \installpointoranswer[examitem][point]%
          \namedexamitemparameter{ocitem}\c!right
          \installdatacollector\installdatacollectorhelper
          \save_question_order
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{score}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D 放置在 answer 環境內標記得分。

%D \starttyping
%D   score\score{3}\\
%D   score\score[type=dotfill]{30}\\
%D   \resetscore\\
%D   score\score[type=cdotfill]{30}\\
%D   \setupscore[score=calculation]
%D   score\score[type=space]{3}\\
%D   score\score[type=hfill]{3}\\
%D \stoptyping

\def\score_calc#1{% only show number
  \global\c_stepscore_temp=#1\relax%
  \ifnum\c_stepscore=0\global\c_stepscore=#1\relax\else%
  \global\c_stepscore=\numexpr\c_stepscore+\c_stepscore_temp\relax%
  \fi\number\c_stepscore%
}
\def\dotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil.\hfil}%
  \hfill\kern 0pt\relax}
\def\cdotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil$\cdot$\hfil}%
  \hfill\kern 0pt\relax}

\installnamespace                 {score}
\installcommandhandler \????score {score} \????score

\setupscore[style=\ssa,color=red,dotstyle=\ss,dotcolor=red,score=]

\tolerant\protected\def\score[#1]#:#2{\begingroup% format style
  \iffirstargument\setupscore[#1]\fi%
  \scoreparameter\c!before%
  \usescorestyleandcolor\c!style\c!color%
  \start\space\scoreparameter{dotstyle}%
  \switchtocolor[\scoreparameter{dotcolor}]%
  \doif{\scoreparameter\c!type}{}{\dotfill}%
  \doif{\scoreparameter\c!type}{space}{}%
  \doif{\scoreparameter\c!type}{hfill}{\unskip\hfill}%
  \doif{\scoreparameter\c!type}{dotfill}{\dotfill}%
  \doif{\scoreparameter\c!type}{cdotfill}{\cdotfill}%
  \space\stop\scoreparameter\c!left%
  \doif{\scoreparameter{score}}{}           {#2}%
  \doif{\scoreparameter{score}}{default}    {#2}%
  \doif{\scoreparameter{score}}{calculation}{\score_calc{#2}}%
  \doif{\scoreparameter{score}}{complex}    {#2 : \score_calc{#2}}%
  \scoreparameter\c!right\scoreparameter\c!after%
\par\endgroup}
\def\resetscore{%
  \c_stepscore_temp=0\relax%
       \c_stepscore=0\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{作文格 / Writing Box}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%D \startbuffer
%D \writingbox
%D  [column=12,
%D   row=15,
%D   evencolor=blue,
%D   oddcolor=darkgray,
%D   evenheight=1cm,
%D   oddheight=.5cm,
%D   align=flushleft,
%D   height=\textheight,
%D   width=\textwidth,]{}
%D \writinggrid
%D  [cellwidth=1cm,
%D   column=12,
%D   row=15,
%D   cellcolor=darkgray,
%D   align=flushleft,
%D   height=\textheight,
%D   width=\textwidth,]{}
%D \stopbuffer
%D \typebuffer
%D \getbuffer

\startuseMPgraphic{grid:writingbox}{column,row,evenheight,oddheight,}
  pageWidth   := OverlayWidth;
  evenRows    := \MPvar{row};
  evenHeight  := \MPvar{evenheight};
  oddHeight   := \MPvar{oddheight};
  evenColumns := \MPvar{column};
  oddColumns  := evenColumns + 1;

  %% 绘制偶数行
  for i = 1 upto evenColumns: % 可以根据需要调整行数
    y1 := i * (oddHeight + evenHeight) + oddHeight;
    y2 := y1 + evenHeight;
    for j = 0 upto evenRows - 1:
        x1 := j  * (pageWidth / evenRows);
        x2 := x1 + (pageWidth / evenRows);
        draw (x1, y1) -- (x2, y1) -- (x2, y2) -- (x1, y2) -- cycle
            withcolor \MPvar{evencolor};
    endfor;
  endfor;

  %% 绘制奇数行
  for i = 1 upto oddColumns: % 可以根据需要调整行数
    y1 := i * (oddHeight + evenHeight);
    y2 := y1 + oddHeight;
    draw (0, y1) -- (pageWidth, y1) -- (pageWidth, y2) -- (0, y2) -- cycle
        withcolor \MPvar{oddcolor};
  endfor;
\stopuseMPgraphic

\defineoverlay
[writingbox]
[{\uniqueMPgraphic{grid:writingbox}{
  evencolor=\framedparameter{evencolor},
   oddcolor=\framedparameter{oddcolor},
    column=\framedparameter{column},
        row=\framedparameter{row},
  evenheight=\framedparameter{evenheight},
  oddheight=\framedparameter{oddheight},
 }}]

\defineframed[writingbox]
 [offset=overlay,
  background=writingbox,
  frameoffset=.5pt,
  column=12,
  row=15,
  evencolor=blue,
  oddcolor=darkgray,
  evenheight=1cm,
  oddheight=.5cm,
  align=flushleft,
  height=\textheight,
  width=\textwidth,
  rulethickness=1pt]

% \writingbox[column=12,row=15,]{EEE\par EEEE\par EEEE}

\startuseMPgraphic{grid:writinggrid}{row,column,cellwidth,cellcolor}
  pageWidth   := OverlayWidth;
  m := \MPvar{row};       % 行数
  u := \MPvar{cellwidth}; % 单位长度
  n := \MPvar{column};    % 列数
  % 画竖线
  for i = 0 upto n:
      draw (i*u, 0) -- (i*u, m*u) withcolor \MPvar{cellcolor};
  endfor;

  % 画横线
  for j = 0 upto m:
      draw (0, j*u) -- (n*u, j*u) withcolor \MPvar{cellcolor};
  endfor;
\stopuseMPgraphic

\defineoverlay
[writinggrid]
[{\uniqueMPgraphic{grid:writinggrid}{
    column=\framedparameter{column},
       row=\framedparameter{row},
 cellwidth=\framedparameter{cellwidth},
 cellcolor=\framedparameter{cellcolor},
 }}]

\defineframed[writinggrid]
  [offset=overlay,
    background=writinggrid,
    frameoffset=.5pt,
    cellwidth=1cm,
    column=12,
    row=15,
    cellcolor=darkgray,
    align=flushleft,
    height=\textheight,
    width=\textwidth,
    rulethickness=1pt]

%  \writinggrid[column=12,row=15,]{EEE\par EEEE\par EEEE}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \defineoverlay[WatermarkOverlay]
%D           [{\framed[frame=off,foregroundcolor=lightgray]
%D            {\scale[sx=3,sy=3]
%D            {\rotate[rotation=20.0]{\framed[align=middle,frame=off]{This is a \\ long watermark}}}}}]
%D
%D \setupbackgrounds[page][background=WatermarkOverlay]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{打印答案 / Print answer / 答えの輸出}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcount\c_qid_answer

\def\resetanswerid{\global\c_qid_answer=0\relax}

%D Example 1:
%D \starttyping
%D \dorecurse{5}{\typeanswerbychap{1}} % grab answer from chapter 1
%D \newcount\c_tempa\c_tempa=2\relax   % grab answer from 0-\the\c_tempa(chapter=0 qid=\the\c_tempa)
%D \dorecurse{5}{\typeanswerbychap[\c_tempa]{0}\advance\c_tempa by 1\relax}
%D \stoptyping
\tolerant\def\typeanswerbychap[#1]#:#2%
 {\begingroup% #1 = QID， #2 =chap number
  \ifparameter#1\or
    \doifsomethingelse{\scratchcounterone#1}{\scratchcounterone#1}{\scratchcounterone\zerocount}%
    \c_qid_answer=\numexpr\scratchcounterone -1\relax\fi
  \scratchcounter#2\relax
  \global\advance\c_qid_answer by 1\relax
  \datasetvariable{ExamDataset}{\jobname-\the\scratchcounter-\the\c_qid_answer}{answer}%
  \endgroup}

%D Example 2:
%D \starttyping
%D \typeanswerdirect{0-5} % grab answer from chapter 0 qid 5
%D \stoptyping
\def\typeanswerdirect#1{% #1 = qid，需要自行輸入來獲取某個題目的答案
  \datasetvariable{ExamDataset}{#1}{answer}}

%D Example 3:
%D \starttyping
%D \typeanswerlist{30}       % type answer from chap 0 and get qid 1 - 30
%D \typeanswerlist[1]{30}    % type answer from chap 1 and get qid 1 - 30
%D \typeanswerlist[1][2]{30} % type answer from chap 1 and get qid 2 - 30
%D \stoptyping
\tolerant\protected\def\typeanswerlist[#chapno][#startno]#*#:#total{%#1 = chapter number
  \begingroup
  \ifparameter#chapno\or
    \doifsomethingelse{\scratchcounterone  #chapno }{\scratchcounterone  #chapno }{\scratchcounterone  \zerocount}\fi
  \ifparameter#startno\or
    \doifsomethingelse{\scratchcountertwo  #startno}{\scratchcountertwo  #startno}{\scratchcountertwo  \zerocount}
    \else\scratchcountertwo\zerocount\fi
  \ifparameter#total\or
    \doifsomethingelse{\scratchcounterthree#total  }{\scratchcounterthree#total  }{\scratchcounterthree\zerocount}\fi
  \c_qid_answer=\scratchcountertwo
  \dorecurse{\the\scratchcounterthree}{% answer amount
    \datasetvariable{ExamDataset}{\jobname-\the\scratchcounterone-\the\c_qid_answer}{answer},%
  \advance\c_qid_answer by 1\relax}%
  \endgroup}

%D Example 4:
%D \starttyping
%D \typeanswertable[2,5]% #3 = 0 #4 = 1
%D \typeanswertable[2,5][0]% #4 = 1
%D \typeanswertable[2,5][0][6] % type answer in table
%D  ----------------------------------
%D |  ID  |  ID  |  ID  |  ID  |  ID  | #1 = 2
%D |  01  |  02  |  03  |  04  |  05  | #2 = 5
%D |  AS  |  AS  |  AS  |  AS  |  AS  | #3 = from chap 0
%D |  01  |  02  |  03  |  04  |  05  | #4 = type start QID 6
%D ------------------------------------
%D \stoptyping
\newcount\answer@seq@tempa
\newcount\answer@seq@tempb
\tolerant\def\typeanswertable[#rows,#columns]#*[#chapno]#*[#startno]%
 {\begingroup
  \ifarguments\or\or
  \scratchcounter    \zerocount\relax
  \scratchcounterone \zerocount\relax
  \or
  \doifsomethingelse{\scratchcounter    #chapno \relax}%
                    {\scratchcounter    #chapno \relax}%
                    {\scratchcounter    \zerocount\relax}%
                     \scratchcounterone \zerocount\relax
  \or
  \doifsomethingelse{\scratchcounter    #chapno \relax}%
                    {\scratchcounter    #chapno \relax}%
                    {\scratchcounter    \zerocount\relax}%
  \doifsomethingelse{\scratchcounterone #startno\relax}%
                    {\scratchcounterone #startno\relax}%
                    {\scratchcounterone \zerocount\relax}%
  \or\fi
  \answer@seq@tempa=\numexpr\scratchcounterone-1\relax
  \answer@seq@tempb=\numexpr\scratchcounterone-1\relax
  \bTABLE
    \dorecurse{#rows}{
      \bTR
      \dorecurse{#columns}{\advance\answer@seq@tempa by 1\relax
        \expanded{\bTD\tt\datasetvariable{ExamDataset}{\jobname-\the\scratchcounter-\the\answer@seq@tempa}{userorder}\eTD}}%
      \eTR\bTR
      \dorecurse{#columns}{\advance\answer@seq@tempb by 1\relax
          \expanded{\bTD\ss\datasetvariable{ExamDataset}{\jobname-\the\scratchcounter-\the\answer@seq@tempb}{answer}\eTD}}%
      \eTR}%
  \eTABLE
\par\endgroup}

%D Example 5:
%D \starttyping
%D \typeanswertablealt[4,2]% #3 = 0 #4 = 1
%D \typeanswertablealt[4,2][1]% #4 = 1
%D \typeanswertablealt[4,2][1][2] % type answer in table
%D  ----------------------------------
%D |  ID  |  01  |  AS  |  01  | #1 = 4
%D |  ID  |  02  |  AS  |  02  | #2 = 2
%D |  ID  |  03  |  AS  |  03  | #3 = from chap 0
%D |  ID  |  04  |  AS  |  04  | #4 = type start QID 2
%D ------------------------------------
%D \stoptyping
\tolerant\def\typeanswertablealt[#rows,#columns]#*[#chapno]#*[#startno]%
 {\begingroup\ifarguments 0\or
  \scratchcounter      \zerocount\relax
  \scratchcounterthree \zerocount\relax
  \or
  \scratchcounter      \zerocount\relax
  \scratchcounterthree \zerocount\relax
  \or
  \scratchcounterthree \zerocount\relax% for startno
  \doifsomethingelse{\scratchcounter      #chapno \relax}%
                    {\scratchcounter      #chapno \relax}%
                    {\scratchcounter      \zerocount\relax}%
  \or
  \doifsomethingelse{\scratchcounter      #chapno \relax}%
                    {\scratchcounter      #chapno \relax}%
                    {\scratchcounter      \zerocount\relax}%
  \doifsomethingelse{\scratchcounterthree #startno\relax}%
                    {\scratchcounterthree #startno\relax}%
                    {\scratchcounterthree \zerocount\relax}%
  \or\fi
  \scratchcounterone #rows   \relax
  \scratchcountertwo #columns\relax
  \answer@seq@tempa=\numexpr\scratchcounterthree-1\relax
  \def\getdata##1{\datasetvariable
                 {ExamDataset}%
                 {\jobname-\the\scratchcounter-\the\answer@seq@tempa}%
                 {##1}}%
  \bTABLE
    \dorecurse{\the\scratchcounterone}{\bTR
      \dorecurse{\the\scratchcountertwo}{\advance\answer@seq@tempa by 1\relax
        \expanded{\bTD\tt\getdata{userorder}\eTD}%
        \expanded{\bTD\ss\getdata{answer}   \eTD}%
       }%
    \eTR}%
  \eTABLE
\par\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{模式設置 / Mode Setting/ モードセット}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definemode[teacher][keep]
\definemode[student][keep]
\definemode[check]  [keep]
\startmode[teacher]
  \mode_showanswertrue
  \mode_showpointtrue
\stopmode
\startmode[student]
  \mode_showanswerfalse
  \mode_showpointfalse
\stopmode
\startmode[check]
  \mode_checktrue
\stopmode
\def\showanswer{\mode_showanswertrue\setupanswer[showscript=false]}
\def\hideanswer{\mode_showanswerfalse\setupanswer[showscript=true]}
\let\showpoint\mode_showpointtrue
\let\hidepoint\mode_showanswerfalse
\let\showchekinfo\mode_checktrue
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\protect
\stopmodule
\endinput