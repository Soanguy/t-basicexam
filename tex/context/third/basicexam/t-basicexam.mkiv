% macros=mkvi
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \module
%D   [     file=t-basicexam,
%D      version=2024-10-24,
%D        title=basicexam,
%D     subtitle=Memoir Ever,
%D       author=å•†æ— è¾›(Shueng Mosan),
%D         date=2024-6-1,
%D    copyright=å•†æ— è¾›(Shueng Mosan),
%D      license=,
%D          url=]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\startmodule[basicexam]
\unprotect
%D \placecontent
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{æ¨¡å¡Šåƒæ•¸ / Module Setups / ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—}

%D \starttabulate[|r|lB|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC mode=   \NC student \NC will show point and hide answer                \NC\NR
%D \NC mode=   \NC teacher \NC will show point and answer                     \NC\NR
%D \NC mode=   \NC check   \NC will show some infos to console                \NC\NR
%D \HL
%D \NC layout= \NC twoup   \NC print two virtual pages on each physical page. \NC\NR
%D \NC layout= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \NC footer= \NC default \NC show subject and page at footer                \NC\NR
%D \NC footer= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \stoptabulate

\setupmodule[mode=student,layout=default,footer=none]
% \doifnotmode{mkiv}{\writestatus{error}{needs luatex}\wait\end}% check context version

% 1 for module
% 2 for question
% 3 for papertitle
% 9 for font

\startinterface english
  \setinterfacemessage{basicexam}{1}{There are unknown parameters in --, please check.}
  \setinterfacemessage{basicexam}{2}{Question (--): answer is (--).}
  \setinterfacemessage{basicexam}{3}{You defined --, but you don't assign a value to it. Please check.}
  \setinterfacemessage{basicexam}{9}{-- is not installed, some -- will not display properly.}
\stopinterface

% \showmessage{basicexam}{2}{}%

\newif\iflay_twoup   \lay_twoupfalse
\newif\ifhdr_default \hdr_defaultfalse

\processallactionsinset[\currentmoduleparameter{mode}][
     teacher=>{\enablemode[teacher]},
     student=>{\enablemode[student]},
       check=>{\enablemode[check]},
  \v!default=>{\enablemode[student]},
  \v!unknown=>\showmessage{basicexam}{1}{mode},
]

\processallactionsinset[\currentmoduleparameter{layout}][
       twoup=>\lay_twouptrue,
        none=>\relax,
  \v!default=>\relax,
  \v!unknown=>\showmessage{basicexam}{1}{layout},
]

\processallactionsinset[\currentmoduleparameter{footer}][
        none=>{\relax},
  \v!default=>\hdr_defaulttrue,
  \v!unknown=>\showmessage{basicexam}{1}{footer},
]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% æ³¨æ„ âš ï¸
%% åœ¨å®šä¹‰å‘½ä»¤æ—¶ï¼Œå‚æ•°åä¸å¯ä»¥ç›´æ¥æ–­è¡Œï¼Œä¼šå¯¼è‡´å‚æ•°æŸ¥æ‰¾å¤±è´¥ã€‚
%%ï¼ˆå¯èƒ½æ˜¯å› ä¸º tex è®¤ä¸ºå‚æ•°åæ–­è¡Œï¼Œåˆ™å‚æ•°çš„ç»“æŸåˆ†ç•Œç¬¦ä¸ºæ–­è¡Œï¼Œè€Œéæ‹¬å·ï¼‰
%% \def\foo#1{ .. some word ...}   \foo{..} å°†æ­£ç¡®è¿è¡Œ
%% \def\foo#1
%%     { .. some word ...}         \foo{..} å°†å¯¼è‡´å¤±è´¥
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% æ³¨æ„ âš ï¸
%% åœ¨ lua ä¸­ä½¿ç”¨ å¾ªç¯ ç­‰ç»“æ„æ—¶ï¼Œè¦æ³¨æ„ % ç™¾åˆ†æ¯”ç¬¦å·çš„ä½¿ç”¨ã€‚ä¸å¯ä»¥ç›´æ¥åœ¨å…³é”®å­—å
%% ä½¿ç”¨ã€‚ä¼šå¯¼è‡´è¿è¡Œå‡ºé”™ï¼š'do' expected near 'docontext' ç­‰æ¶ˆæ¯ã€‚
%% for i > 10 do % do å’Œ % å·ä¹‹é—´æœ‰ç©ºæ ¼ï¼Œ  ä¼šæ­£å¸¸è¿è¡Œ
%% for i > 10 do%  do å’Œ % å·ä¹‹é—´æ²¡æœ‰ç©ºæ ¼ï¼Œä¼šè¿è¡Œé”™è¯¯
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%\newcount\itindexn \itindexn=1
%%\def\itvariable{\ifcase\itindexn%
%%                       \or a\or b\or c\or d\or e%
%%                       \or f\or g\or h\or i\or j%
%%                       \or k\or l\or m\or n\or o%
%%                       \or p\or q\or r\or s\or t%
%%                       \or u\or v\or w\or x\or y\or z
%%                \fi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\begingroup
%\catcode`\%=12\relax
%\gdef\percentchar{%}
%\endgroup
%\ctxlua{context(string.format("\percentchar8s",456))}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{å°šæœªè™•ç†çš„çµ„åˆã€€/ Command under handling / æœªå®Œæˆã®ã‚³ãƒãƒ³ãƒ‰}

%D è¨­ç½®é é¢
%D 2UP Printing
%D \starttyping
%D \setuppapersize[user pagesize][real pagesize,real orientation]
%D \setuparranging[page arrange method]
%D more info : https://wiki.contextgarden.net/Command/setuparranging
%D             https://wiki.contextgarden.net/Imposition
%D \stoptyping
%D ä¾‹å¦‚ï¼š
%D \starttyping
%D \setuppapersize[A4][A3,landscape]
%D \setuparranging[2SIDE]%[2UP]
%D \setuppagenumbering[alternative=singlesided]%{doublesided}]
%D \stoptyping

\iflay_twoup
  \setuppapersize[A4][A3,landscape]
  \setuparranging[2SIDE]% 2SIDE start page at odd [2UP] start at even
  \setuppagenumbering[alternative={doublesided}]%singlesided]
\fi

%D \section{å®šä¹‰å…¶åç¯å¢ƒæ‰€éœ€å‘½ä»¤}

%D å®šä¹‰å…³é”®è¯
\definesystemconstant{close}
\definesystemconstant{choice}
\definesystemconstant{answer}
\definesystemconstant{problem}
\definesystemconstant{question}
\definesystemconstant{material}
\definesystemconstant{optclose}

\startinterface all
\setinterfaceconstant {class}          {class}
\setinterfaceconstant {answer}         {answer}
\setinterfaceconstant {point}          {point}
\setinterfaceconstant {example}        {example}
\setinterfaceconstant {showanswer}     {showanswer}
\setinterfaceconstant {showpoint}      {showpoint}
\setinterfaceconstant {answerstyle}    {answerstyle}
\setinterfaceconstant {answercolor}    {answercolor}
\setinterfaceconstant {answerlabel}    {answerlabel}
\setinterfaceconstant {pointstyle}     {pointstyle}
\setinterfaceconstant {pointcolor}     {pointcolor}
\setinterfaceconstant {pointlabel}     {pointlabel}
\setinterfaceconstant {autoright}      {autoright}
\setinterfaceconstant {inlineleft}     {inlineleft}
\setinterfaceconstant {inlineright}    {inlineright}
\setinterfaceconstant {inlinechoice}   {inlinechoice}
\stopinterface
%D å®‰è£…å®šä¹‰å‘½åç©ºé—´å’Œç¯å¢ƒåŠ©æ‰‹
\installnamespace          {close}
\installcommandhandler \????close     {close}     \????close
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifmode_quickcheck     \mode_quickcheckfalse
\newif\ifmode_check          \mode_checkfalse
\newif\ifmode_showanswer     \mode_showanswerfalse
\newif\ifmode_showpoint      \mode_showpointfalse
\newif\ifmode_showscript     \mode_showscriptfalse
\newif\ifmode_example        \mode_examplefalse
\newif\ifenv_question        \env_questionfalse
\newif\ifenv_problem         \env_problemfalse
\newif\ifenv_choice          \env_choicefalse
\newif\ifenv_material        \env_materialfalse
\newif\ifenv_close           \env_closefalse
\newif\ifenv_writing         \env_writingfalse
\newif\ifenv_subwriting      \env_subwritingfalse
\newif\ifenv_answer          \env_answerfalse
\newif\ifenv_toplevel        \env_topleveltrue
\newif\ifenv_botlevel        \env_botlevelfalse
\newif\ifitem_pitem          \item_pitemfalse
\newif\ifitem_fillin         \item_fillinfalse
\newif\ifitem_inlinechoice   \item_inlinechoicefalse
\newif\ifchoice_check        \choice_checkfalse
\newif\ifcontinue_counter    \continue_counterfalse
\newif\ifclose_counter_reset \close_counter_resetfalse

\newdimen\d_width_cit
\newdimen\d_width_cit_max
\newdimen\d_compared_maxwidth
\newdimen\d_maxwidth_with_label
\newcount\c_currentitemnumber% å°è£åœ¨ inititemnumber å’Œ incrementitemnumber ä¸­
\newcount\c_totalitemnumber% å°è£åœ¨ recurseditemnumber ä¸­
\newcount\c_steppoint% å°è£åœ¨ install_point å‘½ä»¤ä¸­
\newcount\c_steppoint_temp
\newcount\c_stepscore
\newcount\c_stepscore_temp
\newcount\c_closetest
\newcount\c_closetest_tempa
\newcount\c_example_question
\newcount\c_envcounter_toggle
\newcount\c_fillin_number
\newcount\current_total_choice_number% ç•¶å‰é¸é … ABCD ç¸½è¨ˆæ•¸, è·å–å·²ç»è®¡ç®—åçš„ totalitemnumber
\newcount\current_available_columns%å¯æ’ç‰ˆçš„æœ€å¤šåˆ—æ•¸
\newcount\parentitemnumber% \parentitemnumber ä¼šç­‰äºçˆ¶çº§åˆ—è¡¨ç¯å¢ƒçš„åºå·

\definecounter[Unicode][way=bychapter]
\definecounter[Unicode_toplevel]        % for level 1 : question or problem
\definecounter[Unicode_midlevel]        % for level 2 : problem or level 1
\definecounter[Unicode_botlevel]        % for level 3 : only for level 2
\definecounter[strc_close_counter]      % ä¸º close ç¯å¢ƒå¯ä»¥ç»§ç»­ question åºå·è€Œè®¾ç½®

\def\inititemnumber{\c_currentitemnumber=0\relax\c_totalitemnumber=0\relax}
\def\incrementitemnumber{\global\advance\c_currentitemnumber by 1\relax}
\def\recurseditemnumber%%éæ­¸å‡ºç¸½åºè™Ÿ
  {\ifnum       \c_totalitemnumber > \c_currentitemnumber%
         \global\c_totalitemnumber = \c_totalitemnumber%
   \else \global\c_totalitemnumber = \numexpr\c_currentitemnumber\relax\fi}
%% é€™ä¸‰å€‹å‘½ä»¤å¯ä»¥éæ­¸å°é¡Œç¸½æ•¸ï¼Œ
%% ä»–å€‘åˆ†åˆ¥å°è£åœ¨ set_envcounter, set_itemcount,installdatacollectorhelper ä¸­
\def\save_question_order{\setcounter[strc_close_counter][\currentitemnumber]\savecounter[strc_close_counter]}
\def\restore_question_order{\restorecounter[strc_close_counter]}
\def\EQuestionID{E-\somenamedheadnumber{chapter}{current}-\number\c_example_question}
\def\QuestionID{\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}
\def\HelperID{\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]}
\def\increaseEQuestionID{\advance\c_example_question by  1\relax}
\def\decreaseEQuestionID{\advance\c_example_question by -1\relax}
\def\increaseQuestionID{\ifmode_example\increaseEQuestionID\else\incrementcounter[Unicode]\fi}
\def\decreaseQuestionID{\ifmode_example\decreaseEQuestionID\else\decrementcounter[Unicode]\fi}

\definetextbackground[env_answer]
\defineitemgroup     [env_question]
\defineitemgroup     [env_problem]
\defineitemgroup     [env_example]
\defineitemgroup     [env_choice]
\definebar           [fillin_text]
\definemarking       [title]
\definemarking       [subject]
\definedataset[Answer_collector]
\definedataset[Answer_collectorhelper]
\definedataset[Subwriting_collector]
\newwrite\examanswer

\def\exam_write_answer{%
  \immediate\openout\examanswer=\jobname -answer.txt\relax
  \immediate\write\examanswer{
    \QuestionID                \space\string @
    \currentenvironment        \space\string @
    \currentuserorder          \space\string @
    \pass_parameter_answer}%
 % \closeout\examanswer
}

\ifmode_check
  \immediate\openout\examanswer=\jobname -answer.txt\relax
  \immediate\write\examanswer{
    \string questionid  \space\string @
    \string environment \space\string @
    \string userorder   \space\string @
    \string answer}
\fi

\startuseMPgraphic{rules:under:wave}
    vardef lsin primary x =
        lua("mp.print(math.sin(" & decimal x & "))")
    enddef ;
    draw function(1, "x", "lsin(1.2*x)", 0, RuleWidth, .1pt)
         shifted (0,RuleFactor*RuleOffset+RuleDepth)
         withpen pencircle scaled RuleThickness
         withcolor RuleColor ;
    setbounds currentpicture to unitsquare xysized(RuleWidth,RuleHeight) ;
\stopuseMPgraphic

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% no need here
%\defineconversion [hiragana]      [ã‚,ã„,ã†,ãˆ,ãŠ,ã‹,ã,ã,ã‘,ã“,ã•,ã—,ã™,ã›,ã,
%                                   ãŸ,ã¡,ã¤,ã¦,ã¨,ãª,ã«,ã¬,ã­,ã®,ã¯,ã²,ãµ,ã¸,ã»,
%                                   ã¾,ã¿,ã‚€,ã‚,ã‚‚,ã‚„,ã‚†,ã‚ˆ,ã‚‰,ã‚Š,ã‚‹,ã‚Œ,ã‚,ã‚,ã‚“]
%\defineconversion [katakana]      [ã‚¢,ã‚¤,ã‚¦,ã‚¨,ã‚ª,ã‚«,ã‚­,ã‚¯,ã‚±,ã‚³,ã‚µ,ã‚·,ã‚¹,ã‚»,ã‚½,
%                                   ã‚¿,ãƒ,ãƒ„,ãƒ†,ãƒˆ,ãƒŠ,ãƒ‹,ãƒŒ,ãƒ,ãƒ,ãƒ,ãƒ’,ãƒ•,ãƒ˜,ãƒ›,
%                                   ãƒ,ãƒŸ,ãƒ ,ãƒ¡,ãƒ¢,ãƒ¤,ãƒ¦,ãƒ¨,ãƒ©,ãƒª,ãƒ«,ãƒ¬,ãƒ­,ãƒ¯,ãƒ³]
%\defineconversion [hiragana-iroha][ã„,ã‚,ã¯,ã«,ã»,ã¸,ã¨,ã¡,ã‚Š,ã¬,ã‚‹,ã‚’,ã‚,ã‹,ã‚ˆ,
%                                   ãŸ,ã‚Œ,ã,ã¤,ã­,ãª,ã‚‰,ã‚€,ã†,ã‚,ã®,ãŠ,ã,ã‚„,ã¾,
%                                   ã‘,ãµ,ã“,ãˆ,ã¦,ã‚,ã•,ã,ã‚†,ã‚,ã¿,ã—,ã‚‘,ã²,ã‚‚,
%                                   ã›,ã™,ã‚“]
%\defineconversion [katakana-iroha][ã‚¤,ãƒ­,ãƒ,ãƒ‹,ãƒ›,ãƒ˜,ãƒˆ,ãƒ,ãƒª,ãƒŒ,ãƒ«,ãƒ²,ãƒ¯,ã‚«,ãƒ¨,
%                                   ã‚¿,ãƒ¬,ã‚½,ãƒ„,ãƒ,ãƒŠ,ãƒ©,ãƒ ,ã‚¦,ãƒ°,ãƒ,ã‚ª,ã‚¯,ãƒ¤,ãƒ,
%                                   ã‚±,ãƒ•,ã‚³,ã‚¨,ãƒ†,ã‚¢,ã‚µ,ã‚­,ãƒ¦,ãƒ¡,ãƒŸ,ã‚·,ãƒ±,ãƒ’,ãƒ¢,
%                                   ã‚»,ã‚¹,ãƒ³]
%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ego=section isea=subsection
\definelabelclass [exam] [0]
\setuplabeltext   [cn]   [section={ç¬¬,éƒ¨åˆ†},subsection={ç¬¬,èŠ‚}]
\setupexamtext    [cn]   [point={åˆ†}, answer={ç­”æ¡ˆ:},  page={ç¬¬,é¡µ},    totalpage={å…±,é¡µ}]
\setupexamtext    [hans] [point={åˆ†}, answer={ç­”æ¡ˆ:},  page={ç¬¬,é¡µ},    totalpage={å…±,é¡µ}]% work with memos module
\setupexamtext    [hant] [point={åˆ†}, answer={ç­”æ¡ˆ:},  page={ç¬¬,é },    totalpage={å…±,é }]% work with memos module
\setupexamtext    [en]   [point={pts},answer={answer:},page={pages},    totalpage={total,pages}]
\setupexamtext    [ja]   [point={ç‚¹}, answer={ç­”ãˆ:},  page={ç¬¬,ãƒšãƒ¼ã‚¸},totalpage={å…±,ãƒšãƒ¼ã‚¸}]

\definehead [tu]   [chapter]
\definehead [ego]  [section]       % me  latin
\definehead [isea] [subsection]    % he or she latin
\definehead [heu]  [subsubsection] % och
\setuphead  [tu]   [placehead=empty]
\setuphead  [ego]  [sectionsegments=section,style=\ssa]
\setupheads [isea] [style=\hwa]
\setupheads [tu,ego,isea]
                   [indentnext=yes,align=flushleft,
                   before={\blank[quarterline]},
                   after={\blank[quarterline]},
                   sectionconversionset=examnum]
\definelist[tu]
\setuplist [tu][style={\feature[+][tabularnumbers]}]
\definestructureconversionset[examnum][chinesenumerals][chinesenumerals]

\ifhdr_default
  \definedelimitedtext    [paren]   [location=text]
  \setupdelimitedtext     [paren:1] [left={ï¼ˆ\nobreak}, right={\nobreakï¼‰}]
  \setupdelimitedtext     [paren:2] [left={\,[~}, right={~]\,}]
  \setupdelimitedtext     [paren:3] [left={\,\{~}, right={~\}\,}]
  \setupmarking[subject][expansion=yes]
  \setupfooter [state=start]
  \startsetups hdr:infos
  \framed[height=max,align=lohi,frame=off]{%
    \getmarking[subject][page][current]
    \paren{\examtexts{page}{\pagenumber},\ %
           \examtexts{totalpage}{\lastpagenumber}}%
    }
  \stopsetups
  \setupfootertexts[\setups{hdr:infos}]
\fi

%%%%% setupinfos è®¾ç½®è¯•å·æŠ¬å¤´ä¿¡æ¯å’Œæ ¼å¼
%D \section{ç¹ªè£½å·é ­ / print title / ã‚¿ã‚¤ãƒˆãƒ«ã®ä½œæˆ}
%D
%D The following command simply shows how to define, set and draw a new test paper information.

%D \startitemize[nowhite,packed,joinedup]
%D \item é€šé \type{\definepapertitle[PaperTitleName]} å‘½ä»¤å¯ä»¥æ–°å»ºå·é ­ä¿¡æ¯ï¼Œ
%D \item é€šé  \type{\setuppapertitle[PaperTitleName]} å‘½ä»¤å¯ä»¥è¨­å®šå·é ­ä¿¡æ¯ï¼Œ
%D \item é€šé   \type{\makepapertitle[PaperTitleName]} å‘½ä»¤å¯ä»¥ç¹ªè£½å·é ­çµæœã€‚
%D \stopitemize

%D \type{\definepapertitle} and \type{\setuppapertitle} accept one required and two optional parameters.
%D The first parameter is the name of the test paper.
%D The second parameter is the name of the parent test paper, which can be inherited by setting the parent.
%D The third parameter can directly set the relevant style and content.
%D The order can be set through â€˜listâ€™ parameters.
%D The default order is â€˜secret, title, subject, information, noticeâ€™.

%D Once you've defined the {\bf list} parameter,
%D it will automatically expand the relevant parameters to define its style.
%D For example, if you define a {\bf title} parameter in the {\bf list},
%D it will automatically expand the following parameters:

%D \type{\setuppapertitle[list={title,and some other info}]}

%D \starttabulate[|r|l|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC title       \NC  titlealign   \NC \NC\NR
%D \NC titlestyle  \NC  beforetitle  \NC \NC\NR
%D \NC titlecolor  \NC  aftertitle   \NC \NC\NR
%D \HL
%D \stoptabulate

%D \startbuffer
%D  \definepapertitle[papertitles]
%D  \setuppapertitle [papertitles][
%D     list={secret,title,subject,information,notice},
%D     subjectsuffix=å­¦ç§‘è¯•å·,
%D     secretstyle=\ss,
%D     titlestyle=\ssa,
%D     subjectstyle=\ssb,
%D     informationstyle=\ttx,
%D     noticestyle=\rm\it,
%D     secretalign=flushleft,
%D     titlealign=center,
%D     subjectalign=center,
%D     informationalign=center,
%D     noticealign=flushleft,
%D     secret={ç»å¯† â˜… å¯ç”¨å‰},
%D     title={2021 å¹´æ™®é€šé«˜ç­‰å­¦æ ¡æ‹›ç”Ÿå…¨å›½ç»Ÿä¸€è€ƒè¯•},
%D     subject={æ—¥è¯­},
%D     information={æ€»åˆ†:150 åˆ†ï¼Œè€ƒè¯•æ—¶é—´:120 åˆ†é’Ÿ},
%D     notice={æ³¨æ„äº‹é¡¹ï¼š
%D       \startitemize[n,packed,joinedup]
%D         \item ç­”é¢˜å‰ï¼ŒåŠ¡å¿…å°†è‡ªå·±çš„å§“åã€å‡†è€ƒè¯å·å¡«å†™åœ¨%
%D               ç­”é¢˜å¡è§„å®šçš„ä½ç½®ä¸Šã€‚%
%D         \item ç­”é€‰æ‹©é¢˜æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ 2B é“…ç¬”å°†ç­”é¢˜å¡ä¸Šå¯¹%
%D               åº”é¢˜ç›®çš„ç­”æ¡ˆæ ‡å·æ¶‚é»‘ã€‚å¦‚éœ€æ”¹åŠ¨ï¼Œç”¨æ©¡çš®æ“¦%
%D               æ“¦å¹²å‡€åï¼Œå†é€‰æ¶‚å…¶å®ƒç­”æ¡ˆæ ‡å·ã€‚ç­”éé€‰æ‹©é¢˜%
%D               æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ 0.5 æ¯«ç±³é»‘è‰²ç­¾å­—ç¬”ï¼Œå°†ç­”æ¡ˆ%
%D               ä¹¦å†™åœ¨ç­”é¢˜å¡è§„å®šçš„ä½ç½®ä¸Šã€‚æ‰€æœ‰é¡Œç›®å¿…é¡»åœ¨ç­”%
%D               é¢˜å¡ä¸Šä½œç­”ï¼Œåœ¨è¯•é¢˜å·ä¸Šç­”é¢˜æ— æ•ˆã€‚ %
%D         \item è€ƒè¯•ç»“æŸåï¼Œå°†è¯•é¢˜å·å’Œç­”é¢˜å¡ä¸€å¹¶äº¤å›ã€‚
%D         \stopitemize},
%D     ]
%D  \makepapertitle [papertitles]
%D  %If you want, you can also change the key value directly here.like
%D  % \makepapertitle [papertitles][title=new paper title]
%D \stopbuffer
%D \typebuffer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\installnamespace {papertitle}
\installnamespace {papertitlealternative}
\installnamespace {papertitlerenderings}

\installcommandhandler \????papertitle            {papertitle}            \????papertitle
\installcommandhandler \????papertitlealternative {papertitlealternative} \????papertitlealternative

\def\doifemptyelsex#1#2{\doifelse{#1}{}{#2}{#1}}
\def\definepapertitlevariable#1{\begingroup% #1=element name
    \parindent0pt\relax\par%
    \doifelse{\namedpapertitleparameter{\currentpapertitle}{#1align}}{}%
             {\setupalign[center]}%
             {\setupalign[\namedpapertitleparameter{\currentpapertitle}{#1align}]}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{before#1}}{}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1style}}{}%
    \expandafter\begincsname\namedpapertitleparameter{\currentpapertitle}{#1color}\endcsname
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1}}%
                   {\showmessage{basicexam}{3}{#1}}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{after#1}}{}%
    \par\endgroup}

\tolerant\def\makepapertitle[#1][#2]%
  {\begingroup\cdef\currentpapertitle{#1}%
  \ifarguments\or\or\setuppapertitle[#1][#2]\fi
  \edef\currentpapertitlealternative{\papertitleparameter\c!alternative}%
  \ifcsname\currentpapertitlealternativehash\s!parent\endcsname \else
    \let\currentpapertitlealternative\s!default
  \fi
  \usesetupsparameter\papertitleparameter
  \edef\p_renderingsetup{\papertitlealternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \marking[subject]{\papertitleparameter{subject}
                    \papertitleparameter{subjectsuffix}}
  \marking[title]{\papertitleparameter\c!title}
  \endgroup}

%D At the same time, you can define your own test paper title template through {\bf alternative}.
%D here is an example for default alternative.

\definepapertitlealternative
  [\s!default]
  [\c!renderingsetup=\????papertitlerenderings:\s!default]

\startsetups[\????papertitlerenderings:\s!default]
  \edef\currentlist{\papertitleparameter\c!list}
  \edef\currenttitle{\papertitleparameter\c!title}
  \expandafter\expandafter\expandafter\tu\expandafter{\currenttitle}
  \processcommacommand[\currentlist]\definepapertitlevariable
\stopsetups

\setuppapertitle [
  \c!alternative=\s!default,
  subjectsuffix=å­¦ç§‘è¯•å·,
  list={secret,title,subject,information,signinformation,notice},
  ]
\setuppapertitle [
    secretstyle=\ss,
    titlestyle=\ssa,
    subjectstyle=\ssb,
    informationstyle=\ttx,
    noticestyle=\rm\it,
    secretalign=flushleft,
    titlealign=center,
    subjectalign=center,
    informationalign=center,
    noticealign=flushleft,
    secret={ç»å¯† â˜… å¯ç”¨å‰},
    title={\currentdate[year] å¹´æ™®é€šé«˜ç­‰å­¦æ ¡æ‹›ç”Ÿå…¨å›½ç»Ÿä¸€è€ƒè¯•},
    subject={è‹±è¯­},
    signinformation={{å§“å:     }{\blackrule[width=4em,height=.2pt]}
                     {å‡†è€ƒè¯å·: }{\blackrule[width=4em,height=.2pt]}},
    information={å…¨å·å…±12é¡µï¼Œæ»¡åˆ†150åˆ†ï¼Œè€ƒè¯•æ—¶é—´120åˆ†é’Ÿã€‚},
    notice={è€ƒç”Ÿæ³¨æ„ï¼š
            \startitemize[n,packed,joinedup]
            \item ç­”é¢˜å‰ï¼Œè¯·åŠ¡å¿…å°†è‡ªå·±çš„å§“åã€å‡†è€ƒè¯å·ç”¨é»‘è‰²å­—è¿¹çš„ç­¾å­—ç¬”
                  æˆ–é’¢ç¬”åˆ†åˆ«å¡«å†™åœ¨è¯•é¢˜å·å’Œç­”é¢˜çº¸è§„å®šçš„ä½ç½®ä¸Šã€‚ %
            \item ç­”é¢˜æ—¶ï¼Œè¯·æŒ‰ç…§ç­”é¢˜çº¸ä¸Šâ€œæ³¨æ„äº‹é¡¹â€çš„è¦æ±‚ï¼Œåœ¨ç­”é¢˜çº¸ç›¸åº”çš„
                  ä½ç½®ä¸Šè§„èŒƒä½œç­”ï¼Œåœ¨æœ¬è¯•é¢˜å·ä¸Šçš„ä½œç­”ä¸€å¾‹æ— æ•ˆã€‚ %
            \stopitemize},
]

\definepapertitle[newpaper]
%% #1 = newpapertitle #2 = setup elements of newpapertitle
%% \makepapertitle[newpaper][title=OOOOOOO]
%% quickly get elements at header and footer:
%% \getmarking[title][page][first] :: \getmarking[title][current]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{è®¾å®šä¸€äº›å¯èƒ½ç”¨å¾—åˆ°çš„ç¬¦å· / Symbol Defination / ã‚·ãƒ³ãƒœãƒ«ã®å®šç¾©}

\doifelsefontpresent{NotoSansSymbols2-Regular}{}{
  \showmessage{basicexam}{9}{NotoSansSymbols2 font,symbol}}
\definefontsynonym[NotoSansSymbols2][file:NotoSansSymbols2-Regular]
\def\notosymb#1{\getglyphstyled{NotoSansSymbols2}{\tochar{n:#1}}}

\definesymbol[marksquare]          [\notosymb{â˜}]
\definesymbol[markcircle]          [\notosymb{â—‹}]
\definesymbol[marknotcheck]        [\notosymb{â»}]
\definesymbol[markcheck]           [\notosymb{ğŸ—¸}]
\definesymbol[markheavycheck]      [\notosymb{âœ“}]
\definesymbol[marksquarecheck]     [\notosymb{\rlap{â˜}\,\raise.2em\hbox{ğŸ—¸}}]
\definesymbol[marksquareheavycheck][\notosymb{\rlap{â˜}\,\raise.2em\hbox{âœ“}}]
\definesymbol[markcirclecheck]     [\notosymb{\rlap{â—‹}\,\raise.2em\hbox{ğŸ—¸}}]
\definesymbol[markcircleheavycheck][\notosymb{\rlap{â—‹}\,\raise.2em\hbox{âœ“}}]
\definesymbol[markcross]           [\notosymb{âœ—}]
\definesymbol[markheavycross]      [\notosymb{âœ˜}]
\definesymbol[marksquarecross]     [\notosymb{\rlap{â˜}\,\raise.1em\hbox{âœ—}}]
\definesymbol[marksquareheavycross][\notosymb{\rlap{â˜}\,\raise.1em\hbox{âœ˜}}]
\definesymbol[markcirclecross]     [\notosymb{\rlap{â—‹}\,\raise.1em\hbox{âœ—}}]
\definesymbol[markcircleheavycross][\notosymb{\rlap{â—‹}\,\raise.1em\hbox{âœ˜}}]

%D It is important to note that these symbols require
%D the font {\bf NotoSansSymbols2} to be pre-installed.
%D
%D \starttabulate[|l|r|l|r|]
%D \NC \type{\symbol{marksquare}}           \NC \symbol{marksquare}
%D \VL \type{\symbol{markcircle}}           \NC \symbol{markcircle}          \NC\NR\HL
%D \NC \type{\symbol{markcheck}}            \NC \symbol{markcheck}
%D \VL \type{\symbol{markcross}}            \NC \symbol{markcross}           \NC\NR
%D \NC \type{\symbol{markheavycheck}}       \NC \symbol{markheavycheck}
%D \VL \type{\symbol{markheavycross}}       \NC \symbol{markheavycross}      \NC\NR
%D \NC \type{\symbol{marksquarecheck}}      \NC \symbol{marksquarecheck}
%D \VL \type{\symbol{marksquarecross}}      \NC \symbol{marksquarecross}     \NC\NR
%D \NC \type{\symbol{marksquareheavycheck}} \NC \symbol{marksquareheavycheck}
%D \VL \type{\symbol{marksquareheavycross}} \NC \symbol{marksquareheavycross}\NC\NR
%D \NC \type{\symbol{markcirclecheck}}      \NC \symbol{markcirclecheck}
%D \VL \type{\symbol{markcirclecross}}      \NC \symbol{markcirclecross}     \NC\NR
%D \NC \type{\symbol{markcircleheavycheck}} \NC \symbol{markcircleheavycheck}
%D \VL \type{\symbol{markcircleheavycross}} \NC \symbol{markcircleheavycross}\NC\NR
%D \NC \type{\symbol{marknotcheck}}         \NC \symbol{marknotcheck}
%D \VL                                      \NC                              \NC\NR
%D \stoptabulate

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\choice_answerstatus        {\datasetvariable{Choice_collector}{\QuestionID}{answerstatus}}
\def\point_totalpoint           {\datasetvariable{Answer_collector}{\QuestionID}{totalpoint}}
\def\point_point                {\datasetvariable{Answer_collector}{\QuestionID}{point}}
\def\currentavailablecolumns    {}
\def\currentrealavailablecolumns{}
\def\currentitemmaxwidth        {}
\def\currentanswerstatus        {}
\def\example_mode{\ifmode_example NOTICE: MODE EXAMPLE IS ON !\fi}
\def\level_status{\ifenv_toplevel <env_toplevel>\else%
                  \ifenv_botlevel <env_botlevel>\else%
                                  <env_midlevel>\fi\fi}

\def\mode_status{\ifmode_check      <M:C>\fi%check
                 \ifmode_showanswer <M:A>\fi%answer
                 \ifmode_showpoint  <M:P>\fi%point
                 \ifmode_example    <M:E>\fi}

\startluacode
  local report = logs.reporter("question info")

  local function center_text(text, total_width)
      local text_length = #text
      local left_padding = math.floor((total_width - text_length) / 2)
      local right_padding = total_width - left_padding - text_length
      return string.rep(' ', left_padding) .. text .. string.rep(' ', right_padding)
  end

  local function center_report(centerinfos)
      for _, row in ipairs(centerinfos) do
          local centered_line = center_text(row, 60)
          report(centered_line)
      end
  end

  local lines = {
      "NOTICE: MODE CHECK   IS ON !",
      "Notice,Cinfos only show choice env information",
      "CU means 'current' , if CUuserorder â‰  CUorder,",
      "It maybe because START parameter is enabled.  ",
      "Notice,MODE EXAMPLE wont provide data infos   "
  }

  function formatted_report(data)
    -- å®šä¹‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ŒåŠ å…¥ç«–çº¿ä½œä¸ºåˆ†éš”ç¬¦
    local format_str = "%15s  %-20s  %15s  %-20s"

    report("----------------------------------------------------------------")
    center_report(lines,60)

    -- è¾“å‡ºæ•°æ®
    for _, row in ipairs(data) do
        report(format_str:format(row[1], row[2], row[3], row[4]))
    end
    report("----------------------------------------------------------------")
  end
\stopluacode

\def\check_info{
      {"","\example_mode","",""},
      {"Name         ", "Content                                                             ",
       "Cinfos       ", "Content                                                             "},
      {"CUitemgroup  ", "\datasetvariable{Answer_collector}{\QuestionID}{envid}              ",
       "CUparen      ", "\currentparentitemgroup                                             "},
      {"QuestionID   ", "\QuestionID                                                         ",
       "HelperID     ", "\HelperID                                                           "},
      {"order        ", "\currentorder                                                       ",
       "userorder    ", "\currentuserorder                                                   "},
      {"point        ", "\datasetvariable{Answer_collector}    {\QuestionID}{point}          ",
       "             ", "                                                                    "},
      {"totalnumber  ", "\datasetvariable{Answer_collector}    {\QuestionID}{totalnumber}    ",
       "Htotalnumber ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}"},
      {"totalpoint   ", "\datasetvariable{Answer_collector}    {\QuestionID}{totalpoint}     ",
       "Htotalpoint  ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{totalpoint}     "},
      {"CUCmaxwidth  ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{itemmaxwidth}   ",
       "Cavailable   ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns} &
                         \datasetvariable{Answer_collectorhelper}{\HelperID}{realavailablecolumns}"},
      {"answer       ", "\datasetvariable{Answer_collector}    {\QuestionID}{answer}         ",
       "             ", "                                                                    "},
      {"Hanswer      ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{answer}         ",
       "             ", "                                                                    "},
      {"mode.status  ", "\mode_status                                                        ",
       "level.check  ", "\level_status                                                       "},
      {"Canswerstatus", "\choice_answerstatus                                                ",
       "             ", "                                                                    "},
}

\def\show_check_info#1%
 {\begingroup
  \ifmode_check%
    \ifdefined\currentorder%
      \let\old_currentorder\currentorder
      \let\old_currentorder\currentuserorder
    \else%
      \def\currentorder{    {\ttx currentorder didn't define}}
      \def\currentuserorder{{\ttx currentorder didn't define}}
    \fi%
    \directlua{formatted_report({#1})}
  \fi
  \endgroup}

\def\dimtonum #1{\number\numexpr \dimexpr #1\relax*635/65536\relax }
\newcount\cnt_floor
\def\floor#1{\floorhelper#1.\relax}
\def\floorhelper#1.#2\relax{\ifx\relax#2\relax#1%
    \else\if.#2#1\else\floorhelphelper{#1}#2\fi\fi}
\def\floorhelphelper#1#2.{\ifnum#2>0%
    \floorhelphelphelper#1\relax\relax\relax\else#1\fi}
\def\floorhelphelphelper#1#2\relax{%
  \if-#1\relax-\cnt_floor=0#2\relax%
  \advance\cnt_floor by 1\relax%
  \number\cnt_floor\relax%
  \else\cnt_floor=0#1#2\relax%
  \number\cnt_floor\relax\fi%
}

\def\initcollectanswer{\directlua{MultiAnswerCollector = {}}}
\def\collectanswer#1{\directlua{table.insert(MultiAnswerCollector, [[#1]])}}
\def\collectedanswer{\directlua{tex.sprint(table.concat(MultiAnswerCollector,","))}}

\def\set_envitem_counter{%
  \ifdefined\currentenvnumber
    \edef\prevenvnumber{\currentenvnumber}%
  \fi\initcollectanswer% åˆå§‹åŒ–å¤šé¡¹ç­”æ¡ˆæ”¶é›†å™¨
  \ifenv_answer    \advance\c_envcounter_toggle by 10\relax\else
                    \global\c_envcounter_toggle=0\relax%
  \ifenv_question   \global\c_envcounter_toggle=1\relax \edef\currentenvironment  {question}\fi
  \ifenv_problem    \global\c_envcounter_toggle=2\relax \edef\currentenvironment   {problem}\fi
  \ifenv_choice     \global\c_envcounter_toggle=3\relax \edef\currentenvironment    {choice}\fi
  \ifenv_material   \global\c_envcounter_toggle=4\relax \edef\currentenvironment  {material}\fi
  \ifenv_close      \global\c_envcounter_toggle=5\relax \edef\currentenvironment     {close}\fi
  \ifenv_writing    \global\c_envcounter_toggle=6\relax \edef\currentenvironment   {writing}\fi
  \ifenv_subwriting \global\c_envcounter_toggle=7\relax \edef\currentenvironment{subwriting}\fi
  \fi
  \doif{\csname \currentenvironment parameter\endcsname\c!example}{true}% ä¸“ç”¨äºæµ‹è¯•æ˜¯å¦å¼€å¯äº† example mode
       {\mode_exampletrue\global\c_envcounter_toggle=999\relax}
  \edef\currentenvnumber{\the\c_envcounter_toggle}}

%% æ³¨æ„ï¼Œåªè¦æŸä¸ªæ¡ä»¶ä¸å…³é—­ï¼Œä»–å°±ä¼šä¸€ç›´å¼€å¯ã€‚ä¾‹å¦‚ï¼š
% {\env_topleveltrue
%    1. \ifenv_toplevel top \else bot \fi  % top
%    \env_toplevelfalse\env_botleveltrue   % å…³é—­äº† toplevel æ‰èƒ½æ­£ç¡®è¾“å‡º
%    2. \ifenv_toplevel top \else bot \fi  % bot
%    3. \ifenv_botlevel bot \else top \fi} % bot
% ä¸€å®šè¦å…³é—­ï¼Œå› ä¸ºé»˜è®¤å¹¶æ²¡æœ‰è®¾ç½® top å’Œ bot çš„äºŒå…ƒå…³ç³»ã€‚
% æ‰€ä»¥å³ä¾¿æ˜¯ä¸“é—¨æµ‹è¯• bot æ˜¯å¦å¼€å¯çš„ 3 ï¼Œ
% ä¹Ÿåªä¼šåœ¨å…³é—­ top çš„æƒ…å†µä¸‹è·å–æ­£ç¡®çš„ç»“æœã€‚

\def\current_user_order#1{% get user order which can by changed by START
    \number\csname #1order\endcsname% ç²å¾—çš„çµæœé¡ä¼¼æ–¼ 2(4)
    \ifnum\rawcountervalue[Unicode_botlevel]=0\else%
    (\rawcountervalue[Unicode_botlevel])\fi}

\def\set_currentuserorder[#1]{% set order that user setted
  \ifcsname #1order\endcsname\else
    \expandafter\newcount\csname #1order\endcsname\fi
  \ifenv_toplevel\csname #1order\endcsname=\currentitemnumber
            \else\csname #1order\endcsname=\parentitemnumber \fi
  \edef\currentid{\QuestionID}%
  \edef\currentorder{% get unique order ( no chapter number )
    \somenamedheadnumber{chapter}{current}-%
    \rawcountervalue[Unicode_toplevel]-%
    \rawcountervalue[Unicode_midlevel]-%
    \rawcountervalue[Unicode_botlevel]}%
  \edef\currentuserorder{\current_user_order{#1}}%è·å– ä¸Šé¢å®šä¹‰çš„ #1order
  \expandafter\show_check_info{\check_info}%
% % ==  \currentid ++ \currentorder @@ \currentorder
}%ä¸“ä¸ºå­çº§è®¾è®¡æ¥è·å–çˆ¶çº§åºå·ï¼Œå¦åˆ™ç›´æ¥è·å–å½“å‰åºå·

\tolerant\def\set_count_envlevel[#1]{% #1 å®šç¾© #2order
% å¦‚æœ cur = prevï¼Œ èªªæ˜å·²ç¶“æœ‰äº†ä¸Šå±¤ç’°å¢ƒï¼Œ åˆ¤å®šç‚º ä¸­å±¤ç’°å¢ƒï¼Œ
% å¦‚æœ prev æœªè¢«å®šç¾©ï¼Œ èªªæ˜æ²’æœ‰ä¸Šå±¤ç’°å¢ƒï¼Œ åˆ¤å®šç‚º  ä¸Šå±¤ç’°å¢ƒ
  \setcounter[Unicode_midlevel][0]%
  \setcounter[Unicode_botlevel][0]%
  \ifdefined\prevenvnumber
    \ifx\currentenvnumber\prevenvnumber
        \env_topleveltrue \incrementcounter[Unicode_toplevel]%
   \else\env_toplevelfalse\incrementcounter[Unicode_midlevel]\fi
   \else\env_topleveltrue \incrementcounter[Unicode_toplevel]\fi
  \parentitemnumber=\currentitemnumber\relax
  \set_currentuserorder[#1]% åˆ›å»º #2order ä»¥å¤‡ä½¿ç”¨
  \inititemnumber%åˆå§‹åŒ–å­é¡Œç›®è¨ˆæ•¸å™¨
}

\tolerant\def\set_count_itemlevel[#1]{%
  \env_toplevelfalse
  \ifdefined\prevenvnumber
    \ifx\currentenvnumber\prevenvnumber
        \env_botlevelfalse\incrementcounter[Unicode_midlevel]\else
        \env_botleveltrue \incrementcounter[Unicode_botlevel]\fi
   \else\env_botlevelfalse\incrementcounter[Unicode_midlevel]%
  \fi\ifenv_subwriting\env_botleveltrue\fi
  \set_currentuserorder[#1]%
  \incrementitemnumber%å¢é•·å­é¡Œç›®è¨ˆæ•¸å™¨
}

%%% id        ç”± ç« ç¯€è™Ÿ + é¡Œè™Ÿ çµ„æˆï¼Œé¡Œè™Ÿåœ¨æ¯ä¸€ç« ç¯€ä¸­é‡æ–°å¾ 1 è¨ˆæ•¸
%%% envid     ç•¶å‰åˆ—è¡¨åç¨±å’Œå±¤æ•¸
%%% order     ç•¶å‰å­é¡Œè™Ÿï¼Œä¾‹å¦‚ ç¬¬ä¸€é¡Œ ï¼š 1 ç¬¬å…­é¡Œç¬¬ä¸‰å°é¡Œ ï¼š 6(3)
%%% userorder ç•¶å‰åˆ—è¡¨åºè™Ÿ(å¯ç²å–è¢«startæ›´æ”¹å¾Œçš„åºè™Ÿ)

\def\installdatacollector%
  {\writestatus{basicexam}{Question (\currentuserorder): answer is (\currentanswer).}%é¡¯ç¤ºé¡Œè™Ÿå’Œç­”æ¡ˆåˆ°æ§åˆ¶æª¯
  \ifmode_check\exam_write_answer\fi
  \setdataset [Answer_collector][\QuestionID]%æ”¶é›†ç­”æ¡ˆä¸¦åœ¨æœªä¾†å±•é–‹
              [id={\QuestionID},%
                envid={\currentenvironment : \the\c_envcounter_toggle : \currentitemgroup},%
                order={\number\currentorder},%
                userorder={\currentuserorder},%
                answer={\pass_parameter_answer},%
                point={\currentpoint},%
                totalnumber={\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}},%
                totalpoint={\datasetvariable {Answer_collectorhelper}{\HelperID}{totalpoint}},]}

\protected\def\installdatacollectorhelper{%
  \recurseditemnumber%
  \setdataset [Answer_collectorhelper][\HelperID]%æ”¶é›†ä¿¡æ¯ä¸¦åœ¨æœªä¾†å±•é–‹
              [totalitemnumber={\the\c_totalitemnumber},
               totalpoint={\currenttotalpoint},
               availablecolumns={\currentavailablecolumns},
               realavailablecolumns={\currentrealavailablecolumns},
               itemmaxwidth={\currentitemmaxwidth},
               answer={\currentanswer},
               answerstatus={\check_choice_answerstatus},
              ]%
}

% ç¯å¢ƒå±‚çº§ä¸€è§ˆ
% question ç¯å¢ƒ                 % close ç¯å¢ƒ                      % material ç¯å¢ƒ
%    choice ç¯å¢ƒ                %       closechoice é¡¹ç›®    â­•    % question ç¯å¢ƒ
%       citem é¡¹ç›®        â­•    % optclose ç¯å¢ƒ                   %    choice ç¯å¢ƒ
%    problem ç¯å¢ƒ               %       ocitem é¡¹ç›®         â­•    %       citem é¡¹ç›®    â­•
%       pitem é¡¹ç›®        â­•    %       specialocitem é¡¹ç›®  â­•
%         fillin é¡¹ç›®     â­•
% ======================================================================================
% writing ç¯å¢ƒ            â­•
%     subwriting ç¯å¢ƒ
%

% è·å–å½“å‰ç¯å¢ƒçš„ç­”æ¡ˆï¼Œå¹¶ä¼ é€’ç»™æœ€ç»ˆçš„ answer dataset
\def\pass_parameter_answer{%
  \ifenv_writing\short_writing_answer\else
    \ifempty\currentanswer there is no answer setted.\else
  \currentanswer\fi\fi}

\def\check_choice_answerstatus{\ifchoice_check checked!\else%
    unchecked!please set the answer manually by add [*] parameter to citem command.\fi}

\def\paren#1{(#1)}

\protected\def\install_point[#1]{%
  \edef\p_showpoint{\csname #1parameter\endcsname{showpoint}}%
  \ifempty\p_showpoint\else
    \ifx\p_showpoint\s!true\mode_showpointtrue
    \else\mode_showpointfalse
  \fi\fi
  \ifx\currentmode\c!point
    \ifdefined\currentpoint\edef\prevpoint{\currentpoint}\fi
    \edef\p_point{\csname #1parameter\endcsname\c!point}%æš«æ™‚å®šç¾©
    \ifempty\p_point
      \ifenv_toplevel% ç•¶è™•æ–¼é ‚å±¤æ™‚ï¼Œ ç”±æ–¼ prev ä¹Ÿæœªå®šç¾©ï¼Œ æœƒæ‹‹å‡ºéŒ¯èª¤
      \edef\currentpoint{0}\else% å› æ­¤ï¼Œ ç›´æ¥è³¦å€¼æœª 0
      \edef\currentpoint{\prevpoint}\fi
    \else%
      \ifenv_subwriting
        \edef\currentpoint{\namedwritingparameter{subwriting}\c!point}%
      \else
        \edef\currentpoint{\csname #1parameter\endcsname\c!point}%
      \fi
    \fi
    \ifempty\currentpoint% æŠ“å–ç•¶å‰åˆ†æ•¸å€¼
      \scratchcounter\zerocount
    \else
      \scratchcounter\currentpoint
    \fi
    \ifenv_toplevel% é‡ç½®åˆ†æ•¸è¨ˆç®—
      \c_steppoint\zerocount
      \c_steppoint_temp\zerocount
    \fi
    \global\c_steppoint_temp\scratchcounter
    \ifnum\c_steppoint=0
      \global\c_steppoint=\c_steppoint_temp
    \else%
      \global\c_steppoint=\numexpr\c_steppoint+\c_steppoint_temp\relax
    \fi% éæ­¸å‡ºç¸½åˆ†æ•¸
    \ifenv_toplevel% å¦‚æœæœ‰å­é¡Œç›®ï¼Œ ä¸æ‡‰ç•¶ è¨ˆç®— question æœ¬èº«çš„åˆ†å€¼, ä½†é€™ä¼¼ä¹å¢åŠ äº†ç·¨è­¯æ¬¡æ•¸
      \edef\p_totalitemnumber{\datasetvariable{Answer_collector}{\QuestionID}{totalnumber}}%
      \doifelsesomething{\p_totalitemnumber}{\scratchcounter\p_totalitemnumber}{\scratchcounter\zerocount}%
      \writestatus{question info}{currentsteppoint is \the\c_steppoint ::\the\c_steppoint_temp}%
      % ä¸çŸ¥é“ç‚ºä»€éº¼ï¼Œ ä½†å¢åŠ è¼¸å‡º steppoint å¯ä»¥ç²å–æ­£ç¢ºçš„æœ€çµ‚è¨ˆæ•¸ã€‚
      \ifnum\scratchcounter>1\global\c_steppoint=\numexpr\c_steppoint-\c_steppoint_temp\relax\fi
      \xdef\currenttotalpoint{\number\currentpoint}%
    \else%
      \xdef\currenttotalpoint{\number\c_steppoint}%
    \fi%
  \fi
}

\def\install_answer[#1]{%
  \edef\p_showanswer{\csname  #1parameter\endcsname\c!showanswer}%
  \ifempty\p_showanswer\else
    \ifx\p_showanswer\s!true
           \mode_showanswertrue
      \else\mode_showanswerfalse
  \fi\fi
  \ifx\currentmode\c!answer
    \ifdefined\currentanswer\edef\prevanswer{\currentanswer}\fi
    \edef\p_answer{\csname #1parameter\endcsname\c!answer}%æš«æ™‚å®šç¾©
    \ifenv_subwriting\edef\p_answer{\writingparameter\c!answer}\fi
    \ifempty\p_answer
      \edef\currentanswer{\prevanswer}%
    \else%
      \edef\currentanswer{\csname #1parameter\endcsname\c!answer}%
      \ifdefined\prevanswer
        \ifempty\prevanswer\else
          \ifx\currentanswer\prevanswer\relax\else
            \writestatus{question info}{%
              \currentuserorder     : Two conflicting answers have been detected,
                                      check and delete unnecessary answers.}%
            \writestatus{question info}{%
              \string\prevanswer    : \prevanswer .
              \string\currentanswer : \currentanswer .}%
          \fi
        \fi
      \fi
    \fi
  \fi}

\tolerant\protected\def\show_pointoranswer_text[#1]#*[#2]{{
  \unskip\csname #1parameter\endcsname{#2style}%
  \switchtocolor[\csname #1parameter\endcsname{#2color}]%
  \paren {\csname left_assigned#2label\endcsname % like=>answer : blabla
    \ifx\currentmode\c!point% if #2 = point
      \ifenv_toplevel
        \point_totalpoint
      \else
        \ifenv_answer\point_point\else
        \currentpoint\fi
      \fi
    \else% if #2 = answerã€‚å› ä¸º currentXXXanswer æ˜¯æœ‰å®šä¹‰å†…å®¹çš„ï¼Œ
      \ifmode_example You're in EXAMPLE MODE!\else
        \ifenv_writing\short_writing_answer\else
        \datasetvariable{Answer_collector}{\QuestionID}{answer}\fi
      \fi% ç›´æ¥ç²å–ç•¶å‰ QID ç­”æ¡ˆ
    \fi
  \csname right_assigned#2label\endcsname}}}

\def\p_assigned_currentlabel#1#2{%
  \expandafter\edef%
    \csname p_current#1#2label%
      \expandafter\expandafter%
        \expandafter\endcsname%
          \expandafter\expandafter%
            \expandafter{%
              \csname #1parameter\endcsname{#2label}}}

\def\p_pass_currentlabel[#1]{\p_assign_currentlabel[#1,,]}
\def\p_assign_currentlabel[#1,#2,#3]#4%
 {\expandafter\def\csname  left_assigned#4label\endcsname {#1}%
  \expandafter\def\csname right_assigned#4label\endcsname {#2}}

\tolerant\protected\def\installpointoranswer[#1]#*[#2]{%#1 parameter %#2 modename
  \edef\currentmode{#2}% check point or answer
  \install_point[#1]%
  \install_answer[#1]%
  \p_assigned_currentlabel{#1}{#2}%
  \expandafter\expandafter%
    \expandafter\p_pass_currentlabel%
      \expandafter\expandafter%
        \expandafter[%
            \csname p_current#1#2label\endcsname]{#2}%
  \begingroup
  \csname ifmode_show#2\endcsname
    \show_pointoranswer_text[#1][#2]%
  \fi
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion[tnum][\addff{tabularnumbers}]
\protected\def\installitemgroupoption[#1][#2]{%
  \setupitemgroup[env_#1][each][
                                    \c!margin={\csname #2parameter\endcsname\c!margin},%
                                \c!leftmargin={\csname #2parameter\endcsname\c!leftmargin},%
                               \c!rightmargin={\csname #2parameter\endcsname\c!rightmargin},%
                        \c!leftmargindistance={\csname #2parameter\endcsname\c!leftmargindistance},%
                       \c!rightmargindistance={\csname #2parameter\endcsname\c!rightmargindistance},%
                                \c!indentnext={\csname #2parameter\endcsname\c!indentnext},%
                                     \c!width={\csname #2parameter\endcsname\c!width},%
                                    \c!factor={\csname #2parameter\endcsname\c!factor},%
                                  \c!distance={\csname #2parameter\endcsname\c!distance},%
                                      \c!step={\csname #2parameter\endcsname\c!step},%
                                     \c!align={\csname #2parameter\endcsname\c!align},%
                                  \c!symalign={\csname #2parameter\endcsname\c!symalign},%
                                     \c!color={\csname #2parameter\endcsname\c!color},%
                                 \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                                     \c!style={\csname #2parameter\endcsname\c!style},%
                                  \c!marstyle={\csname #2parameter\endcsname\c!marstyle},%
                                  \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
                                 \c!headstyle={\csname #2parameter\endcsname\c!headstyle},%
                                  \c!marcolor={\csname #2parameter\endcsname\c!marcolor},%
                                  \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
                                 \c!headcolor={\csname #2parameter\endcsname\c!headcolor},%
                                \c!beforehead={\csname #2parameter\endcsname\c!beforehead},%
                                  \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
                                  \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
                                 \c!afterhead={\csname #2parameter\endcsname\c!afterhead},%
                                    \c!before={\csname #2parameter\endcsname\c!before},%
                                 \c!inbetween={\csname #2parameter\endcsname\c!inbetween},%
                                     \c!after={\csname #2parameter\endcsname\c!after},%
                                   \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                              \c!placestopper={\csname #2parameter\endcsname\c!placestopper},%
                                   \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                                     \c!inner={\csname #2parameter\endcsname\c!inner},%
                                         \c!n={\csname #2parameter\endcsname\c!n},%
                                     \c!items={\csname #2parameter\endcsname\c!items},%
                                    \c!levels={\csname #2parameter\endcsname\c!levels},%
                                  \c!lefttext={\csname #2parameter\endcsname\c!lefttext},%
                                 \c!righttext={\csname #2parameter\endcsname\c!righttext},%
                                      \c!left={\csname #2parameter\endcsname\c!left},%
                                     \c!right={\csname #2parameter\endcsname\c!right},%
                             \c!packcriterium={\csname #2parameter\endcsname\c!packcriterium},%
                                 \c!criterium={\csname #2parameter\endcsname\c!criterium},%
                              \c!textdistance={\csname #2parameter\endcsname\c!textdistance},%
                         \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
                         \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
                                   \c!command={\csname #2parameter\endcsname\c!command},%
                                 \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                               \c!alignsymbol={\csname #2parameter\endcsname\c!alignsymbol},%
                                    \c!symbol={\csname #2parameter\endcsname\c!symbol},%
                                    \c!option={\csname #2parameter\endcsname\c!option},%
                                  %  \c!start={\csname #2parameter\endcsname\c!start},%
                                     \c!start={\csname #2parameter\endcsname\c!start},%
                                     \c!state={\csname #2parameter\endcsname\c!state},% % beware, "" == start
                                       \c!way={\csname #2parameter\endcsname\c!way},% % wont work if continue on
                                    \c!prefix={\csname #2parameter\endcsname\c!prefix},%
                        \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
                          \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
                       \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
                             \c!prefixstarter={\csname #2parameter\endcsname\c!prefixstarter},%
                             \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
                                 \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                            \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
                                 \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                           \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
                        \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
                          \c!numberconversion={\csname #2parameter\endcsname\c!numberconversion},%
                       \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
                             \c!numberstarter={\csname #2parameter\endcsname\c!numberstarter},%
                             \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
                            \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
                      %               \c!prefix={\csname #2parameter\endcsname\c!prefix},%
                      %        \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
                      %   \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
                      %     \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
                      %  \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
                      %            \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                      %       \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
                      %      \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
                      %   \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
                      %  \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
                            %  \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
                            % \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
                           ]%
}

\protected\def\installcounteroption[#1][#2]{%
  \cdef\currentenv_counter{\v_strc_itemgroups_counter}%
}

%D \section{è®¾ç½® question ç¯å¢ƒ}

%D The \tex{question} environment command can be used to set the stem.
%D Simply wrap the stem between the \tex{startquestion} \tex{stopquestion} commands.
%D At the same time, we have defined a short command \tex{question},
%D which is used as a synonym for \tex{startquestion} \tex{stopquestion}
%D
%D \startbuffer
%D   \startquestion
%D     The environment is located in: \currentitemgroup ã€‚
%D   \stopquestion
%D   \startquestion
%D     The environment is located in: \currentitemgroup ã€‚
%D   \stopquestion
%D   \question {The environment is located in: \currentitemgroup ã€‚}
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The \tex{question} environment command inherits the option settings for
%D the \tex{itemgroup} environment. Therefore, you can modify the environment
%D using \tex{setupquestion} in the same way you modify \tex{itemgroup}.
%D
%D \bgroup
%D   \startbuffer
%D     \setupquestion[color=green,style=\ss,start=22,
%D                    option={n,packed,joinedup,nowhite,}]
%D     \startquestion
%D       The environment is located in: \currentitemgroup ã€‚
%D     \stopquestion
%D   \stopbuffer
%D   \typebuffer
%D   \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D \egroup

%D question ç¯å¢ƒå¯ä»¥è®¾ç½® {\bf ç­”æ¡ˆ} å’Œ {\bf åˆ†å€¼}ã€‚è¯¥é”®å€¼è¯¦ç»†çš„è®¾ç½®å¦‚ä¸‹ï¼š
%D \starttabulate[|l|l|l|l|]
%D \NC showanswer \NC answer \NC answerstyle    \NC answercolor \NC\NR
%D \NC            \NC        \NC answerlabel    \NC answerlabel \NC\NR\HL
%D \NC showpoint  \NC point  \NC pointstyle     \NC pointcolor  \NC\NR
%D \NC            \NC        \NC pointprelabel  \NC pointlabel  \NC\NR
%D \stoptabulate

%D \startbuffer
%D   \setupquestion[start=1,option={n,packed,joinedup,nowhite,}]
%D   \startquestion[showpoint=true,point=5,pointlabel={points},
%D                  showanswer=true,answer={new answer},answerstyle={\tt},]
%D     The environment is located in: \currentitemgroup ã€‚
%D   \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D æ­¤å¤–ï¼Œquestion è®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„é”®å€¼ example=trueï¼Œå¯ä»¥æ˜¯å½“å‰é¢˜ç›®ä¸è¢«å½•å…¥ç­”æ¡ˆã€‚
%D åœ¨(v20241023)ä¸­ï¼Œé€šè¿‡ä¸å¤ªæ­£å¸¸çš„æ–¹å¼è®¾ç½®äº† example åçš„é¢˜ç›®å¯ä»¥è‡ªåŠ¨é‡ç½®å›åˆ°åºæ•° 1ã€‚
%D æˆ–è®¸ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæ–°çš„é”®å€¼ï¼Œæ¥è®¾å®š example ä¹‹åçš„é¢˜ç›®æ˜¯é‡ç½®ä¸º 1 è¿˜æ˜¯æ¥ç»­ä¸Šä¸€ä¸ªåºå·ã€‚
%D æ­¤å¤–ï¼Œç”±äº question å†…ç½®äº†ä¸€ä¸ª itemï¼Œ å› æ­¤å¯ä»¥ä½¿ç”¨ reference æ¥åˆ›å»ºå¼•ç”¨ã€‚

%D {\bf é—œæ–¼ point å’Œ answer çš„è¨­å®š: }
%D point çš„åˆ†å€¼é»˜èªæ˜¯ä¸€æ•´å€‹é¡Œç›®çš„ç¸½åˆ†æ•¸ã€‚å¦‚æœç•¶å‰å­—ç’°å¢ƒç‚º problemï¼Œåªè¦ç‚ºæ¯å€‹ pitem
%D è¨­è¨ˆäº† point çš„åˆ†å€¼ï¼Œè©²æ¨¡å¡Šå°±æœƒè‡ªå‹•è¨ˆç®—ã€‚answer çš„ç²å–ä¹Ÿæ˜¯ä¸€æ¨£ã€‚åœ¨è¨­è¨ˆæ™‚ï¼Œ
%D pitem é»˜èªæ˜¯æ“æœ‰å¤šå€‹åŒç´šé …ç›®çš„ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œæœƒåœ¨åŒä¸€å€‹ question ç’°å¢ƒä¸­ï¼Œæœ‰å¤šå€‹å­ç­”æ¡ˆã€‚
%D æˆ‘å€‘ç„¡æ³•ç²çŸ¥æ‡‰è©²ä½¿ç”¨å“ªä¸€å€‹ä½œç‚ºç•¶å‰ç’°å¢ƒçš„ç­”æ¡ˆã€‚åŒæ¨£çš„é“ç†ï¼Œæ¯å€‹ question ç’°å¢ƒå…§åªæœ‰ä¸€å€‹
%D choice ç’°å¢ƒï¼Œåªéœ€è¦ç›´æ¥ç‚º question ç’°å¢ƒé…ç½®åˆ†å€¼å³å¯ã€‚choice ç’°å¢ƒä¸¦ä¸èƒ½é…ç½®åˆ†æ•¸ã€‚

\installnamespace          {question}
\installcommandhandler \????question  {question}  \????question

\appendtoks
  \setuevalue        {\currentquestion}{\directnamedquestion[\currentquestion]}%
  \setuevalue{\e!start\currentquestion}{\startnamedquestion [\currentquestion]}%
  \setuevalue{\e!stop \currentquestion}{\stopnamedquestion}%
\to \everydefinequestion

\tolerant\protected\def\directnamedquestion[#S#1]#*[#S#2]{%
  \groupedcommand{\startnamedquestion[#1][#2]}%
                 {\stopnamedquestion}}

\tolerant\protected\def\startnamedquestion[#S#1]#*[#S#2]%
 {\begingroup
  \scratchcounterone\currentitemnumber\relax
% å› ç‚º setcountlevel ç”¨åˆ°äº† scratchcounter,é€™è£¡ä½¿ç”¨æ–°çš„è¨ˆæ•¸å™¨æŠ“å–å‘½ä»¤
  \def\currentquestion{#1}\setupcurrentquestion[#2]%
  \edef\p_class{\questionparameter\c!class}%
  \edef\p_start{\questionparameter\c!start}%
  \edef\p_reset{\questionparameter\c!reset}%
  \edef\p_option{\questionparameter\c!option}%
  \edef\p_defaultoption{n,packed,nowhite,joinedup,continue}%
  \ifx\p_class\s!question
    \env_questiontrue\set_envitem_counter\fi
  \ifx\p_class\s!problem
    \env_problemtrue \set_envitem_counter\fi
  \ifx\p_class\s!optclose
    \env_closetrue   \set_envitem_counter\fi
  \ifx\p_reset\s!true
    \resetcounter[itemgroup:env_question]\fi
  \ifx\p_class\s!question
    \ifmode_example
    \installitemgroupoption[example][question]%
    \startitemgroup[env_example]\else
    \installitemgroupoption[question][question]%
    \startitemgroup[env_question]\fi
    \item[\questionparameter\c!reference]%
    \increaseQuestionID% å…·æœ‰ç¨ç«‹ç­”æ¡ˆï¼Œå¢é•· QID
    \set_count_envlevel  [question]%
    \installpointoranswer[question][point]%
    \installpointoranswer[question][answer]
  \fi
  \ifx\p_class\s!problem
    \ifmode_example
    \installitemgroupoption[example][question]%
    \startitemgroup[env_example]\else
    \installitemgroupoption[problem][question]%
    \startitemgroup[env_problem]\fi
    \set_count_envlevel [problem]%
    \ifenv_toplevel\else
      \decreaseQuestionID% ç›´æ¥è·å– question çš„ ID
      \parentitemnumber=\scratchcounterone\relax
    \fi
  \fi
  \ifx\p_class\s!optclose
    \ifmode_example
    \installitemgroupoption[example][question]%
    \startitemgroup[env_example]\else
    \installitemgroupoption[question][question]%
    \startitemgroup[env_question]
    \fi
    \leftskip=0pt\relax
    \set_count_envlevel[question]
  \fi
  \save_question_order\removeunwantedspaces}

\protected\def\stopnamedquestion{%
  \ifnum\c_envcounter_toggle=1\relax
  \installdatacollectorhelper
  \installdatacollector\fi
  \ifx\p_class\s!problem
    \installdatacollectorhelper
  \fi
  \initcollectanswer
  \stopitemgroup
  \endgroup}

\definequestion[question]

\setupquestion
  [class=question,
  %example=,
  %showpoint=false,
  %point=,
  pointstyle=\ttx,
  %pointcolor=,
  %pointprelabel=,
  pointlabel={,\examtexts{point}},
  %showanswer=false,
  %answer=,
  answerlabel={\examtexts{answer},},
  answerstyle=\ss,
  answercolor=red,
  indenting=no,
  way=bychapter,
  numberconversion=tnum,]

\setupquestion
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{è®¾ç½® problem ç¯å¢ƒ / Problem Environment}

%D The environment \tex{problem} command can set up multiple aggregate issues,
%D and the environment has a specific subcommand \tex{pitem} to list each issue.
%D It can be used to set fill-in-the-blank, Q&A, and other questions.

%D \startbuffer
%D \startproblem
%D \startpitem The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D \startpitem The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D \startpitem The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The problem environment only inherits the key-value pairs from the itemgroup environment
%D and does not set any new key-values. In the current version (v20241023),
%D the settings for answers and scores have been removed. Because, under the problem environment,
%D there are usually many pitems, and each question may have its own score and answer.
%D Therefore, for design purposes, the answers and scores of each question are directly set through \tex{pitem}.

%D \startbuffer
%D \startproblem
%D \startpitem[showpoint=true,point=5]         The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D \startpitem[showanswer=true,answer={newer}] The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D \startpitem[]                               The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D Unlike the \tex{question} environment, where all ordinal numbers are sequential,
%D the \tex{problem} environment is recounted each time it starts.

%D If you want to add stems to the \tex{problem} environment,
%D you can place the \tex{problem} environment in the \tex{question} environment.

%D \startbuffer
%D \startquestion
%D   The environment is located in: \currentitemgroup ã€‚
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D If you want to set a fill-in-the-blank question, you can use the \tex{fillin} command.
%D The use of \tex{fillin} and \tex{startanswer} will be mentioned later.
%D
%D \startbuffer
%D \setupanswer[showanswer=true]
%D \startquestion
%D   The environment is located in: \currentitemgroup ã€‚
%D     \setuppitem[showanswer=true]
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \fillin{env_question:1}ã€‚ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[mp=rules:under:wave]{env_question:1}ã€‚ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem
%D     	The environment is located in: \fillin[empty=number]{env_question:2}ã€‚
%D     \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes]{env_question:3}ã€‚ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes,left={(},right={)}]{env_question:4}ã€‚ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D In addition to this, you can define a new problem environment via \tex{defineproblem}\type{[XXX]},
%D which will generate two new commands \tex{startXXX} , \tex{\stopXXX}

\definequestion[problem]
\def\setupproblem{\setupquestion[problem]}

\setupproblem
  [\c!class=\s!problem,
   \c!lefttext={(},
   \c!righttext={)},
   \c!option={n,packed,joinedup,nowhite},]

%D \section{è®¾ç½® choice ç¯å¢ƒ}
%D è©²ç’°å¢ƒå‘½ä»¤åªèƒ½ç½®æ–¼ \tex{question} ç’°å¢ƒä¹‹ä¸‹ã€‚è©²ç’°å¢ƒæœ‰ä¸€å€‹å­é …ç›®ï¼š
%D \tex{startcitem}
%D \tex{stopcitem}ã€‚
%D \starttyping
%D  \startcitem {é¸é …å…§å®¹} \stopcitem
%D \stoptyping

%D å¯ä»¥é€šé \type{[*]} ä¾†æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆã€‚å¦‚æœæƒ³è¦è¨­ç½®å¤šé¸é¡Œï¼Œåªéœ€è¦å°æ¯å€‹æ­£ç¢ºç­”æ¡ˆæ·»åŠ  \type{[*]} å³å¯ã€‚
%D \startbuffer
%D \setupquestion[showanswer=true]
%D \startquestion
%D     The environment is located in: \currentitemgroup ã€‚
%D     \startchoice
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup ã€‚
%D     \startchoice
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup ã€‚
%D     \startchoice
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D åŒæ™‚ç‚º \tex{startcitem}\tex{stopcitem} å®šç¾©äº†åŒç¾©å‘½ä»¤ \tex{citem} å’Œ \tex{fragilecitem}ã€‚
%D \tex{fragilecitem}å‘½ä»¤å¯ä»¥ä¸é€šéç•Œå®šèŠ±æ‹¬è™Ÿä¾†æ’ç‰ˆé¸é …ï¼Œä½†å¯èƒ½æœƒå¼•ç™¼æœªçŸ¥å•é¡Œï¼Œ
%D ç‰¹åˆ¥æ˜¯é¸é …ä¸­å«æœ‰ç©ºæ ¼æ™‚ã€‚\tex{citem} å‰‡éœ€è¦å°‡é¸é …åŒ…è£¹åœ¨èŠ±æ‹¬è™Ÿä¸­ã€‚
%D \starttyping
%D  \citem {é¸é …å…§å®¹}
%D  \fragilecitem é¸é …å…§å®¹
%D \stoptyping

%D è¯¥ç¯å¢ƒç»§æ‰¿äº†ä¸€éƒ¨åˆ† itemgroup çš„é”®å€¼ï¼Œå°±å¦‚åŒå‰ä¸¤ä¸ªå‘½ä»¤ä¸€æ ·ã€‚
%D ä¸åŒäº question å…·æœ‰answer å’Œ point ä¸¤ç§é”®å€¼ï¼Œè¯¥ç¯å¢ƒåªå…·æœ‰ answer ç›¸å…³çš„é”®å€¼ï¼Œæ¥ç‰¹åˆ«åœ°
%D è®¾ç½®æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆå’Œé…ç½®ç­”æ¡ˆæ¨£å¼ã€‚
%D å› ä¸º choice ç¯å¢ƒçš„ç‰¹æ®Šæ€§ï¼Œpoint é”®å€¼é€šè¿‡ question ç¯å¢ƒæ¥æ˜¾ç¤ºã€‚å’Œ question ç’°å¢ƒçš„å€åˆ¥æ˜¯
%D question ç¯å¢ƒçš„ answer æ§åˆ¶ç­”æ¡ˆæ˜¯å¦æ˜¾ç¤ºåœ¨é¢˜å¹²ä»¥åŠè®¾ç½®ç›¸å…³æ ·å¼ã€‚
%D choice   ç¯å¢ƒçš„ answer æ§åˆ¶ç­”æ¡ˆæ˜¯å¦æ˜¾ç¤ºåœ¨é€‰é¡¹ä»¥åŠè®¾ç½®ç›¸å…³æ ·å¼ã€‚

%D å¦å¤–ï¼Œchoice ç’°å¢ƒæœ‰ä¸€å€‹ç‰¹åˆ¥çš„å€¼ï¼š
%D maxiwidth key is for calcaluted max width of choice and waited to be compareï¼Œ
%D notice this key is maxiwidth ,and difference from maxwidth which
%D for setupitemgroup command

\installnamespace          {choice}
\installcommandhandler \????choice    {choice}    \????choice

\appendtoks
  \setuevalue        {\currentchoice}{\directnamedchoice[\currentchoice]}%
  \setuevalue{\e!start\currentchoice}{\startnamedchoice [\currentchoice]}%
  \setuevalue{\e!stop \currentchoice}{\stopnamedchoice}%
\to \everydefinechoice

\setupchoice [answerstyle=\ss\tf,
              answercolor=red,
              inlinechoice=false,
              point=\questionparameter\c!point,
              maxiwidth=.9\textwidth,
              numberconversion=A,]

\tolerant\protected\def\directnamedchoice[#1]#*[#2]#*#:#3%
{\begingroup
  \def\currentchoice{#1}\setupcurrentchoice[#2]%
  \startnamedchoice[#1]%
    \def\citem_temp##1{\startcitem##1\stopcitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \processcommacommand[#3]\citem_temp
  \stopnamedchoice\endgroup}

\tolerant\protected\def\startnamedchoice[#S#1]#*[#S#2]%
 {\begingroup\def\currentchoice{#1}%
  \ifnum\c_envcounter_toggle = 2\relax
    \errmessage{you cannot put choice in problem environment.
                choice env can only be putted in question environment.}\fi
  \env_choicetrue\set_envitem_counter
  \ifdefined\currentuserorder
    \expandafter\show_check_info{\check_info}%
  \else
    \ifnum\c_envcounter_toggle = 3\relax
    \else \set_count_envlevel[choice]\fi
  \fi
  \doifelsesomething{\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}}% arg_1
     {\scratchcounter\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}}% arg_2
     {\scratchcounter\zerocount}% arg_3
  \current_total_choice_number=\number\scratchcounter\relax
  \doifelsesomething{\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\zerocount}%
  \current_available_columns=\number\scratchcounter\relax
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%    % if calc_horizontal_num >= tbl_cit_count
%%    %                                      set horizontal = tbl_cit_count
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count ~= 1
%%    %                                  set horizontal = two % calc_horizontal_num
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count == 1
%%    %                                      set horizontal = 1
%%    % ç‰¹åˆ«çš„ï¼Œ 3 é€‰é¡¹ ä¸” å¯æ’ç‰ˆæœ€å¤§åˆ—æ•°ä¸º 2 æ—¶ï¼Œæ’ç‰ˆ 1 è¡Œ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \startluacode
  tbl_num_temp = {"one","two","three","four",
                  "five","six","seven","eight","nine"}
  local   tbl_cit_count         = tex.count['current_total_choice_number']
  local   available_columns     = tex.count['current_available_columns']
          available_columns_arg = ""
  if     (tbl_cit_count == 3) and (available_columns   <  tbl_cit_count)
  then    available_columns_arg = "one"
  elseif (tbl_cit_count >  1) and (available_columns   >= tbl_cit_count)
  then    available_columns_arg = "horizontal," .. tbl_num_temp[tbl_cit_count]
  elseif (tbl_cit_count >= 1) and (available_columns   <=            1 )
  then    available_columns_arg = "one"
  else    available_columns_arg = "horizontal,two"
  end
  \stopluacode
  \edef\currentrealavailablecolumns{\ctxlua{context(available_columns_arg,"")}}%
  \setupcurrentchoice[#2]%
  \edef\currentanswer  {\choiceparameter\c!answer      }%
  \edef\p_option       {\choiceparameter\c!option      }%
  \edef\p_showanswer   {\choiceparameter\c!showanswer  }%
  \edef\p_choicetype   {\choiceparameter\c!inlinechoice}%
  \edef\p_correctsymbol{\choiceparameter{correctsymbol}}%
  \edef\p_defaultoption{A,packed,nowhite,joinedup}%
  \installitemgroupoption[choice][choice]%
  \ifx\p_choicetype\s!true
    \startitemgroup[env_choice][text,\p_option]\else
    \startitemgroup[env_choice][\ctxlua{context(available_columns_arg,"")},\p_option]\fi
  \choiceparameter\c!inlineleft
  \ifmode_showanswer\else
    \ifx\p_showanswer\s!true
         \mode_showanswertrue
    \else\mode_showanswerfalse\fi
  \fi\removeunwantedspaces}

\protected\def\stopnamedchoice{%
  \removemarkedcontent[inlinechoice_punctuation]%
  \d_maxwidth_with_label = \dimexpr\d_width_cit_max     +
                           \d_strc_itemgroups_list_width   \relax
  \d_compared_maxwidth   = \choiceparameter{maxiwidth}     \relax
  \startluacode
    local a = tex.dimen['d_compared_maxwidth']
    local b = tex.dimen['d_maxwidth_with_label']
          c = math.floor(a/b)
  \stopluacode
%%   \d_compared_maxwidth æ˜¯å¯æ’ç‰ˆçš„æœ€é•·å¯¬åº¦ã€‚
%%   a å’Œ b å°‡å¯¬åº¦æ•¸å­—åŒ–ï¼Œ ä»¥å‚™æ¯”è¼ƒå‡ºå¯æ’ç‰ˆçš„æ¬„æ•¸ã€‚
%%   å› ç‚ºå–æ¶ˆäº† choice ä½œç‚ºä¸Šç´šç’°å¢ƒæ™‚çš„ \set_count_envlevel å› æ­¤ï¼Œé‡å®šç¾© orderã€‚
%%   å–æ¶ˆåŸå› æ˜¯ è®“ choice ç›´æ¥ç²å– question ç’°å¢ƒçš„ orderã€‚
  \edef\currentchoiceanswer{\collectedanswer}%
  \ifempty\currentchoiceanswer
    \edef\currentanswer{\prevanswer}% è®“ choice ç¹¼æ‰¿ å‰ä¸€å€‹ç­”æ¡ˆ
  \else
    \edef\currentanswer{\collectedanswer}%
  \fi
  \def\currentavailablecolumns{\ctxlua{context(c,"")}}%
  \def\currentitemmaxwidth    {\the\d_width_cit_max}%
  \doifelsesomething{\choiceparameter\c!point}%
    {\scratchcountertwo\choiceparameter\c!point}%
    {\scratchcountertwo\zerocount}%
  \edef\currentpoint     {\the\scratchcountertwo}%
  \edef\currenttotalpoint{\the\scratchcountertwo}%
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer
  \choiceparameter\c!inlineright
  \stopitemgroup
  \endgroup}

\setupchoice
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=.5\emwidth,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={A,packed,joinedup,nowhite,},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definechoice[choice]
\definechoice[inlinechoice]
\tolerant\def\setupinlinechoice[#1]{\setupchoice[inlinechoice][#1]}

\setupinlinechoice[option={text,8,packed,joinedup,nowhite,},
                   inlinechoice=\s!true,
                   correctsymbol={\symbol{marksquarecheck}},
                   inlineleft={ (\nobreak},
                   inlineright={\nobreak ) },
                   %lefttext={},
                   %righttext={},
                   answerstyle=\ss,
                   %stopper=,
                   %showanswer=,% shoule be empty before used
                   separator={\removeunwantedspaces,\space},
                   ]

%D \section{è®¾ç½® writing ç¯å¢ƒ}
%D ç›®å‰è¯¥ç¯å¢ƒåªæ˜¯åˆæ­¥çš„è®¾è®¡ã€‚
%D å¦‚æœåªæœ‰åŒçº§çš„å¤šä¸ªä½œæ–‡é¢˜ç›®ï¼Œåªéœ€è¦ä½¿ç”¨ writing ç¯å¢ƒå³å¯ã€‚
%D ä½†æ˜¯ï¼Œå½“ä¸€ä¸ªä½œæ–‡ä½“ä¸‹é¢æœ‰å¤šä¸ªå­é¢˜ç›®æ—¶ï¼Œéœ€è¦å°†å­é¢˜ç›®æ”¾åˆ° subwriting ç¯å¢ƒå½“ä¸­ã€‚

%D \startbuffer
%D \setupwriting[showanswer=true,showpoint=true]
%D \startwriting[point=45]
%D   ä½œæ–‡é¢˜ç›®è¯´æ˜
%D   \startanswer
%D     å‚è€ƒä½œæ–‡ 1
%D   \stopanswer
%D \stopwriting
%D
%D \startwriting
%D ä½œæ–‡é¢˜ç›®è¯´æ˜
%D   \startsubwriting[point=450]
%D     sub ä½œæ–‡é¢˜ç›®è¯´æ˜
%D     \startanswer
%D       å‚è€ƒä½œæ–‡ 2
%D     \stopanswer
%D   \stopsubwriting
%D   \startsubwriting[point=4588]
%D     sub ä½œæ–‡é¢˜ç›®è¯´æ˜
%D     \startanswer
%D     å‚è€ƒä½œæ–‡ 3
%D     \stopanswer
%D   \stopsubwriting
%D \stopwriting
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {writing}
\installcommandhandler \????writing   {writing}   \????writing

\appendtoks
  \setuevalue{\e!start\currentwriting}{\startnamedwriting[\currentwriting]}%
  \setuevalue{\e!stop \currentwriting}{\stopnamedwriting}%
\to \everydefinewriting

\tolerant\protected\def\startnamedwriting[#S#1]#*[#S#2]
  {\begingroup\env_writingtrue\set_envitem_counter
  \edef\currentwriting{#1}%
  \setupanswer[showanswer=false]%
  \setupcurrentwriting[#2]%æ³¨æ„ï¼Œwriting æ²¡æœ‰å•ç‹¬çš„ itemgroup ç¯å¢ƒ
  \edef\short_writing_answer{\writingparameter\c!answer}%
  \edef\currentanswer{\writingparameter\c!answer}%
  \edef\getanswercontent{}%
  \edef\p_writingtype{\writingparameter{subwriting}}%
  \installitemgroupoption[question][writing]%
  \startitemgroup[env_question]%
  \item[\writingparameter\c!reference]%
  \ifx\p_writingtype\s!true
    \env_subwritingtrue
    \set_envitem_counter
    \ifnum\currentitemnumber=1\relax
          \decreaseQuestionID\increaseQuestionID
    \else\increaseQuestionID\fi
    \set_count_itemlevel[subwriting]%
  % å½“å…·æœ‰å¤šä¸ªå­å†™ä½œç¯å¢ƒæ—¶ï¼Œæ‰å¢é•¿ QID ï¼Œ
  % å¦åˆ™å‰Šå‡è‡³ çˆ¶çº§ QIDï¼ˆç›¸å½“äºç»§æ‰¿ï¼‰
  \else
    \increaseQuestionID
    \set_count_envlevel[writing]
  \fi
  \installpointoranswer[writing][point]%
  \installpointoranswer[writing][answer]%
  \save_question_order\removeunwantedspaces}

\protected\def\stopnamedwriting{%
  \ifnum\c_totalitemnumber<2\relax% åªæœ‰ä¸€å€‹å­é …ç›®
    \ifenv_subwriting% æ˜¯å­ä½œæ–‡
      \installdatacollector%
      \installdatacollectorhelper%
      \initcollectanswer
    \else% æ˜¯ä½œæ–‡
      \edef\currentpoint{\writingparameter\c!point}
      \edef\currenttotalpoint{\writingparameter\c!point}
      \c_totalitemnumber=1\relax
      \installdatacollector%
      \installdatacollectorhelper%
      \initcollectanswer
    \fi
  \else% æ“æœ‰å¤šå€‹å­é …ç›®
  \fi\stopitemgroup\endgroup}


\setupwriting
  [\c!answer={å‚è§å‚è€ƒä½œæ–‡ã€‚},
   \c!pointlabel={,\examtexts{point}},
   \c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!yes,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definewriting[writing]
\definewriting[subwriting]
\def\setupsubwriting{\setupwriting[subwriting]}
\setupsubwriting
  [answer={å‚è§å‚è€ƒä½œæ–‡ã€‚},
   subwriting=true,
   pointlabel={,\examtexts{point}},]

%D \section{è®¾ç½® answer ç¯å¢ƒ}
%D åœ¨(v20241023)ä¸­ï¼Œåˆ é™¤äº† answer ç¯å¢ƒçš„æ ‡ç­¾é€šè¿‡ description æ¥è¿›è¡Œè®¾ç½®ã€‚
%D æ•´ä½“ç¯å¢ƒé€šè¿‡ textbackground ç¯å¢ƒè¿›è¡Œè®¾ç½®ã€‚
%D è¯¥ç¯å¢ƒæä¾›äº†ä¸€å€‹ç‰¹æ®Šçš„éµå€¼ sctiptï¼Œè©²éµå€¼ä¸»è¦ç”¨æ–¼å‰µå»ºç­”é¡Œå€åŸŸã€‚
%D è©²éµå€¼å’Œ showanswer éµå€¼æ˜¯äº’æ–¥çš„ï¼Œä¸æ‡‰è©²åŒæ™‚å•Ÿç”¨ã€‚

%D \tex{answer} æ˜¯çˆ²å¸«ç”Ÿå…©ç‰ˆè¨­ç½®çš„å‘½ä»¤ã€‚ä½†ç›®å‰è©²å‘½ä»¤å’Œç›¸é—œè¨­ç½®é‚„å…·æœ‰è«¸å¤šä¸è¶³ä¹‹è™•ã€‚
%D åªéœ€è¦å°‡è©²ç’°å¢ƒç½®æ–¼é¡Œç›®ä¸‹æ–¹ï¼Œå³å¯ç²å–ç•¶å‰é¡Œç›®è¨­å®šçš„ç­”æ¡ˆï¼Œä¸¦å¯ä»¥çˆ²å…¶ç·¨å¯«ç­”æ¡ˆè§£æã€‚
%D
%D \startbuffer
%D \startquestion[showanswer=true,answer={answer for \currentitemgroup },point=12]
%D     The environment is located in: \currentitemgroup ã€‚
%D     æ³¨æ„ï¼š\tex{answer} å¯ä»¥ç²å–çˆ¶ç’°å¢ƒæˆ–åŒç´šç’°å¢ƒçš„ç­”æ¡ˆè€Œä¸å¿…å†æ¬¡è¨­ç½®ã€‚
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \startquestion[showanswer=true,point=1]]
%D     The environment is located in: \currentitemgroup ã€‚
%D     æ³¨æ„ï¼š\tex{answer} å¯ä»¥ç²å–çˆ¶ç’°å¢ƒæˆ–åŒç´šç’°å¢ƒçš„ç­”æ¡ˆè€Œä¸å¿…å†æ¬¡è¨­ç½®ã€‚
%D     \startchoice
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D \startbuffer
%D \startquestion[showanswer=true]
%D   The environment is located in: \currentitemgroup ã€‚
%D     \startproblem[showanswer=true,left={(},right={)},distance=1em,stopper={}]
%D     \startpitem[showanswer=true,answer={Pitem 1},point=10]
%D        The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 2},point=20]
%D        The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 3},point=30]
%D        The environment is located in: \currentitemgroup ã€‚ \stoppitem
%D     \startanswer
%D     \input knuthmath
%D     \stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%%%%%%%

\installnamespace {answer}
\installnamespace {answeralternative}
\installnamespace {answerrenderings}

\installcommandhandler \????answer            {answer}            \????answer
\installcommandhandler \????answeralternative {answeralternative} \????answeralternative

\appendtoks
    \frozen\instance\protected\edefcsname        \currentanswer\endcsname{\answer_direct_instance}%
    \frozen\protected\instance\edefcsname\e!start\currentanswer\endcsname{\answer_start_instance [\currentanswer]}%
    \frozen\protected\instance\letcsname \e!stop \currentanswer\endcsname\answer_stop_instance
\to \everydefineanswer

\tolerant\protected\def\answer_direct_instance[#S#1]#:#2%
  {\begingroup
   \cdef\currentanswer{#1}%
   \doif{\answerparameter{showanswer}}{true}{\mode_showanswertrue}%
   \ifmode_showanswer
     \useanswerstyleandcolor\c!style\c!color
     \answerparameter\s!command
     {#2}
   \fi
   \endgroup
   \edef\currentanswer{#2\collectanswer{#2}}
   \edef\prevanswer   {\currentanswer}}
   % åªæœ‰ä¸€å€‹åŠŸèƒ½ï¼Œ æ”¶é›†ç­”æ¡ˆã€‚
   % å…·å‚™ç°¡å–®çš„æ¨£å¼æ§åˆ¶å’Œæ§åˆ¶ç­”æ¡ˆé¡¯éš±ã€‚
   % \setupanswer[command=\groupedcommand{\bf}{},style=,color=,showanswer=]

\permanent\protected\def\startanswer
  {\begingroup
   \edef\currentanswer_bak{\currentanswer}%
   \lettonothing\currentanswer
   \doifelsenextoptionalcs\answer_start_delayed\answer_start_indeed}

\def\answer_start_delayed[#S#1]%
  {\doifelseassignmentcs{#1}%
     \answer_start_delayed_parameters
     \answer_start_delayed_name
   [#1]}

\def\answer_start_delayed_parameters[#S#1]%
  {\setupcurrentanswer[#1]%
   \answer_start_indeed}

\def\answer_start_delayed_name[#1]%
  {\cdef\currentanswer{#1}%
   \checkanswerparent
   \doifelsenextoptionalcs\answer_start_delayed_parameters\answer_start_indeed}

\protected\tolerant\def\answer_start_instance[#S#1]#*[#S#2]%
  {\begingroup\env_answertrue\set_envitem_counter
   \edef\currentanswer_bak{\currentanswer}% å‚™ä»½ä¹‹å‰çš„ç­”æ¡ˆ
 %  \lettonothing\currentanswer%é‡‹æ”¾currentanswer
% currentanswer å‘½ä»¤å·²ç¶“è¢«å…¶ä»–ç’°å¢ƒå®šç¾©ç‚ºç­”æ¡ˆç²å–å‘½ä»¤ï¼Œ
% æ­¤è™•çš„ currentanswer æ˜¯å®šç¾©ç’°å¢ƒå‘½ä»¤ï¼Œéœ€è¦é‡æ–°é‡‹æ”¾ã€‚
   \cdef\currentanswer{#1}%
   \setupcurrentanswer[#2]%
   \grabbufferdatadirect
   % {\s!answer:\currentanswer}%
     {\s!answer}% unnested, as before
     {\e!start\currentanswer}%
     {\e!stop \currentanswer}}

\def\answer_start_indeed
  {\grabbufferdatadirect
   % {\s!answer:\currentanswer}%
     {\s!answer}% unnested, as before
     {\csstring\startanswer}%
     {\csstring\stopanswer}}

\permanent\protected\def\stopanswer
  {\answerparameter\c!before
   \dostarttagged\t!answer\currentanswer
   \begingroup
   \useanswerstyleandcolor\c!style\c!color
   \usealignparameter\answerparameter
   \edef\currentansweralternative{\answerparameter\c!alternative}%
   \ifcsname\currentansweralternativehash\s!parent\endcsname \else
     \let\currentansweralternative\s!default
   \fi
   \usesetupsparameter\answerparameter
   \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
   \directsetup\p_renderingsetup
   \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
     {\getbufferdata[\s!answer]}%
% éœ€è¦æ³¨æ„ï¼Œè¯¥å‘½ä»¤ä¼šä¼ é€’ç»™ datasetï¼Œä¸åŒäº writing ç¯å¢ƒçš„ currentanswer
% currentanswer çš„ç›®çš„æ˜¯è®¾ç½®è¾ƒçŸ­çš„ä½œæ–‡ç­”æ¡ˆã€‚
% getanswercontent åˆ™æ˜¯è®¾ç½®å®Œæ•´çš„ä½œæ–‡ç­”æ¡ˆã€‚
% å¦‚æœéœ€è¦ç‚ºå…¶ä»–ç’°å¢ƒç²å–è§£æå…§å®¹ï¼Œ æ‡‰è©²éœ€è¦é‡å®šç¾©å‘½ä»¤ï¼ˆanswer + currentQIDï¼‰
   \endgroup
   \dostoptagged
   \answerparameter\c!after
   \endgroup}

\aliased\let\answer_stop_instance\stopanswer

% kind of nested, when we need it:
%
% \permanent\tolerant\protected\def\getanswer      [#1]{\normalexpanded{\getbufferdata[\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}
% \permanent\tolerant\protected\def\getinlineanswer[#1]{\normalexpanded{\inlinebuffer [\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}

% unnested, as before:

\permanent\tolerant\protected\def\getanswerbuffer      [#1]{\getbufferdata[\s!answer]}
\permanent\tolerant\protected\def\getinlineanswerbuffer[#1]{\inlinebuffer [\s!answer]}

\defineansweralternative
  [\s!default]
  [\c!renderingsetup=\????answerrenderings:\s!default]

% \startsetups[\????answerrenderings:\s!default]
%     \answerparameter\c!before
%     \usesetupsparameter\answerparameter
%     \getbufferdata[\s!answer]
%     \answerparameter\c!after
% \stopsetups

\startsetups[\????answerrenderings:\s!default]
  \doif{\answerparameter  {showscript}}{true}{\mode_showscripttrue\mode_showanswerfalse}%
  \doif{\answerparameter\c!showanswer} {true}{\mode_showanswertrue\mode_showscriptfalse}%
  \doif{\answerparameter\c!showpoint}  {true}{\mode_showpointtrue}%
  \setuptextbackground[env_answer]%
  [location=paragraph,width=local,
  leftoffset=1ex,rightoffset=1ex,
  %topoffset=.5ex,bottomoffset=.5ex,
  before={\leftskip=0pt\startnarrower},
  after={\stopnarrower},
  background=\answerparameter\c!background,
  backgroundcolor=\answerparameter\c!backgroundcolor,
  corner=\answerparameter\c!corner,
  frame=\answerparameter\c!frame,
  framecolor=\answerparameter\c!framecolor,
  rulethickness=\answerparameter\c!rulethickness,
  ]%
  \startenv_answer
  \useanswerstyleandcolor\c!style\c!color
  \ifenv_material% å¯ä»¥ç”¨æ¥åšæ–‡ç« ç¿»è¯‘æˆ–å†…å®¹è§£é‡Šï¼Œ
    \getanswerbuffer%          % ä¹Ÿå¯ä»¥ç›´æ¥æ”¾ç½®åœ¨æ–‡ç« ä¹‹åï¼Œæˆ–è¿™æ¯ä¸€ä¸ªæ®µè½ä¹‹å
  \else
    \ifmode_showscript
        \answerparameter{scriptcontent}%
    \else
      \noindent
      \begingroup
      \edef\currentmode{answer}%
      \p_assigned_currentlabel{answer}{answer}%
      \expandafter\expandafter%
        \expandafter\p_pass_currentlabel%
          \expandafter\expandafter%
            \expandafter[%
                \csname p_currentansweranswerlabel\endcsname]{answer}%
      \ifmode_showanswer
        \show_pointoranswer_text[answer][answer]%
      \fi\endgroup
      \begingroup
      \edef\currentmode{point}%
      \p_assigned_currentlabel{answer}{point}%
      \expandafter\expandafter%
        \expandafter\p_pass_currentlabel%
          \expandafter\expandafter%
            \expandafter[%
                \csname p_currentanswerpointlabel\endcsname]{point}%
      \ifmode_showpoint
        \show_pointoranswer_text[answer][point]%
      \fi\endgroup
      \ifmode_showanswer
          \answerparameter\c!inbetween
          \getanswerbuffer
      \fi
    \fi
  \fi
  \stopenv_answer
\stopsetups

\tolerant\protected\def\startoldanswer[#1]#:#2\stopoldanswer%
{\begingroup\env_answertrue\set_envitem_counter
  \lettonothing\currentanswer%é‡‹æ”¾currentanswer
  \lettonothing\getanswerbuffer\lettonothing\getinlineanswerbuffer
  % currentanswer å‘½ä»¤å·²ç¶“è¢«å…¶ä»–ç’°å¢ƒå®šç¾©ç‚ºç­”æ¡ˆç²å–å‘½ä»¤ï¼Œ
  % æ­¤è™•çš„ currentanswer æ˜¯å®šç¾©ç’°å¢ƒå‘½ä»¤ï¼Œéœ€è¦é‡æ–°é‡‹æ”¾ã€‚
  \cdef\currentanswer{#1}%
  \setupcurrentanswer[#2]%
  \edef\getanswerbuffer{#2}%
  \usesetupsparameter\answerparameter
  \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
    {#2}%%
% éœ€è¦æ³¨æ„ï¼Œè¯¥å‘½ä»¤ä¼šä¼ é€’ç»™ datasetï¼Œä¸åŒäº writing ç¯å¢ƒçš„ currentanswer
% currentanswer çš„ç›®çš„æ˜¯è®¾ç½®è¾ƒçŸ­çš„ä½œæ–‡ç­”æ¡ˆã€‚
% getanswercontent åˆ™æ˜¯è®¾ç½®å®Œæ•´çš„ä½œæ–‡ç­”æ¡ˆã€‚
% å¦‚æœéœ€è¦ç‚ºå…¶ä»–ç’°å¢ƒç²å–è§£æå…§å®¹ï¼Œ æ‡‰è©²éœ€è¦é‡å®šç¾©å‘½ä»¤ï¼ˆanswer + currentQIDï¼‰
\endgroup}

\startuseMPgraphic{normalframeMP}
  draw unitsquare xyscaled (\overlaywidth, \overlayheight);
\stopuseMPgraphic
\defineoverlay       [normalframeOL][\useMPgraphic{normalframeMP}]

%%%%% NOTICE : ç›®å‰ï¼Œç•¶ç”¨æˆ¶ä¸»å‹•è¼¸å…¥å€¼å’Œé¸é …å€¼ç™¼ç”Ÿè¡çªæ™‚ï¼Œä¸¦æœªè¨­ç½®è­¦å‘Šä¿¡æ¯!!!!
\def\getanswerforanswer{% used for answer env to auto get answer
  \ifenv_writing\short_writing_answer
  \else\datasetvariable{Answer_collector}{\QuestionID}{answer}\fi}

\def\getpointforanswer{% used for answer env to auto get point
  \datasetvariable{Answer_collector}{\QuestionID}{point}}

\setupanswer
  [showanswer=true,
  showpoint=true,
  answer=\getanswerforanswer,
  point=\getpointforanswer,
  answerlabel={{\examtexts{answer}}},
  pointlabel={,\examtexts{point}},
  pointstyle=\answerparameter\c!style,
  pointcolor=\answerparameter\c!color,
  answerstyle=\answerparameter\c!style,
  answercolor=\answerparameter\c!color,
  style=\ss\it,
  before=\blank[halfline],
  after=\blank[halfline],
  inbetween={\par},
  showscript=false,
  %scriptcontent={},
  \c!alternative=\s!default,
  background=normalframeOL,%% for env_answer textbackground
  %backgroundcolor=,
  %corner=,
  frame=on,
  %framecolor=,
  %rulethickness=,
  ]
\defineanswer[answer]

%D \section{è®¾ç½® pitem,citem å‘½ä»¤}

\installnamespace                {pitem}
\installsimplecommandhandler \????pitem     {pitem}     \????pitem

\setuppitem    [%showpoint=,
                %point=,
                pointstyle=\ttx,
                %pointcolor=,
                pointlabel={,\examtexts{point}},
                answerlabel={\examtexts{answer},},
                %showanswer=,
                %answer=,
                answerstyle=\ss,
                answercolor=red,
                %reference=,
                ]

\tolerant\protected\def\startpitem[#1]{\begingroup%
  \item_pitemtrue\increaseQuestionID%
  \iffirstargument\setuppitem[#1]\fi%
  \startitem[\pitemparameter{reference}]%
    \ifenv_question% è¨­è¨ˆä¸Šçš„å•é¡Œï¼Œæ­¤æ™‚ pitem è™•æ–¼ botlevelï¼Œå¦å‰‡è™•æ–¼ toplevelã€‚
    \set_count_itemlevel [pitem]\else\ifenv_problem%
    \set_count_envlevel  [pitem]\fi\fi%
    \installpointoranswer[pitem][point]%
    \installpointoranswer[pitem][answer]%
  \removeunwantedspaces}

\def\stoppitem{%
  \ifitem_fillin\edef\currentanswer{\collectedanswer}\fi
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer% æ¸…ç©ºæ”¶é›† fillin çš„ç­”æ¡ˆ
  \stopitem\endgroup}

%D [*](ç”¨äºæ ‡è®°æ­£ç¡®ç­”æ¡ˆ)

\installnamespace                {citem}
\installsimplecommandhandler \????citem     {citem}     \????citem

\setupcitem[
  %style=,
  %color=,
]

\protected\def\check_correct_choice#1#2{%
  \usecitemstyleandcolor\c!style\c!color
  \ifmode_showanswer
    \edef\p_correctmark_m{*}\edef\p_correctmark_p{#1}%
    \ifx\p_correctmark_p\p_correctmark_m
      \edef\p_answerstyle{\choiceparameter\c!answerstyle}%
      \edef\p_answercolor{\choiceparameter\c!answercolor}%
      \ifx\p_choicetype\s!true
        \bgroup
          \ifempty\p_answerstyle
                  \questionparameter\c!answerstyle
            \else\choiceparameter  \c!answerstyle\fi
          \ifempty\p_answercolor
                  \switchtocolor[\questionparameter\c!answercolor]%
            \else \switchtocolor[\choiceparameter  \c!answercolor]\fi
        \sym{\ifempty\p_correctsymbol\symbol{marksquarecheck}\else
                     \p_correctsymbol\fi}% correct inline choice
        #2\collectanswer{#2}\egroup
      \else
        \startitem[\citemparameter\c!reference]{%
          \ifempty\p_answerstyle
                  \questionparameter\c!answerstyle
            \else\choiceparameter  \c!answerstyle\fi
          \ifempty\p_answercolor
                  \switchtocolor[\questionparameter\c!answercolor]%
            \else \switchtocolor[\choiceparameter  \c!answercolor]\fi
                  #2}
        \stopitem% correct normal choice
      \fi
    \else
      \startitem[\citemparameter\c!reference]#2\stopitem% correct choice without *
    \fi
  \else
    \startitem[\citemparameter\c!reference]#2\stopitem%  choice
  \fi
  \ifx\p_choicetype\s!true
    \markcontent[inlinechoice_punctuation]{\choiceparameter\c!separator}%
  \fi}

\protected\def\get_citem_text[#1]{\setbox0=\hbox{#1}%
    \d_width_cit = \the\wd0\relax%relax is neccessary
    \ifdim \d_width_cit_max > \d_width_cit%
           \d_width_cit_max = \d_width_cit_max%
    \else  \d_width_cit_max = \d_width_cit%
    \fi}%%%% éæ­¸è¨ˆç®—å‡ºæœ€å¤§å¯¬åº¦

\tolerant\protected\def\startcitem[#1]#*[#2]#:#3\stopcitem{% #1 correct answer
  \ifsecondargument\setupcitem[#2]\fi%                     #2 option
  \get_citem_text[#3]%                                     #3 choice content
  \edef\p_correctmark_p{#1}\edef\p_correctmark_m{*}%
%  \set_count_itemlevel[citem]
  \incrementitemnumber
  \ifx\p_choicetype\s!true\else
  \ifx\p_correctmark_p\p_correctmark_m
    \edef\currentanswerindex{\the\c_currentitemnumber}
    \edef\correct_choice_index{\convertnumber{\choiceparameter{numberconversion}}{\currentanswerindex}}%
    \collectanswer{\correct_choice_index}% collect current normal answer
  \fi\fi
  \doif{#1}{*}{\choice_checktrue}%
  \check_correct_choice{#1}{#3}%
  \removeunwantedspaces}

%D \section{å®šä¹‰åŒä¹‰å‘½ä»¤}

%D \startquestion[showanswer=true]
%D \fastchoice{a,\correct{F},{[*]E},}
%D \stopquestion

%D \startquestion[showanswer=true]
%D \fastchoicealt{a,\correct{F},{[*]sF}}
%D \stopquestion

\def\pitem{\dosingleempty\pitem_indeed}
\def\pitem_indeed[#1]#2{
  \startpitem[#1]{#2}\stoppitem}

\def\citem{\dosingleempty\citem_indeed}
\def\citem_indeed[#1]#2{%
  \startcitem[#1]{#2}\stopcitem}

\tolerant\protected\def\fastchoice[#1]#:#2{
  \startchoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopchoice}

\tolerant\protected\def\fastchoicealt[#1]#:#2{
  \startinlinechoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopinlinechoice}

%D è°¨æ…ä½¿ç”¨ä¸‹é¢çš„ fragilecitemï¼Œä»–å¹¶ä¸å®‰å…¨ã€‚å¾ˆæœ‰å¯èƒ½å¯¼è‡´é”™è¯¯

\bgroup
\obeylines
\gdef\xcitem{\bgroup\obeylines\dosingleempty\doxcitem}%
\gdef\doxcitem[#1]#2
  {\egroup%
  \doifsomethingelse{#1}%
  {\startcitem[*]#2\stopcitem}%
  {\startcitem #2\stopcitem}%
  }%
\egroup

\let\fragilecitem\xcitem

%D \section{è¨­ç½® fillin å‘½ä»¤}
%D è©²å‘½ä»¤å»ºè­°åœ¨ pitem ç’°å¢ƒå…§é€²è¡Œä½¿ç”¨ã€‚
%D ç•¶ç„¶ï¼ŒåŒæ™‚ç”±æ–¼ pitem æœ¬èº«ä¹Ÿæœ‰ answer éµå€¼ï¼Œå¯ä»¥é€šéè©²éµå€¼é€²è¡Œè¨­å®šã€‚

%D fillin å‘½ä»¤ä¸»è¦ä¾é  bar å‘½ä»¤å¯¦ç¾çš„ã€‚åŸºæœ¬ä¸ŠæŒ‰ç…§ä¿®æ”¹ bar å‘½ä»¤å³å¯ä¿®æ”¹ fillin å‘½ä»¤ã€‚
%D fillin å‘½ä»¤æœ‰å…©å€‹åƒè€ƒ textnote çš„åƒæ•¸ï¼š empty å’Œ nã€‚
%D empty=yesï¼Œéš±è—ç­”æ¡ˆï¼›empty=number é¡¯ç¤ºæ•¸å­—ï¼› empty=none é¡¯ç¤ºç­”æ¡ˆã€‚
%D n=* éš±è—ç­”æ¡ˆ,é•·åº¦ç‚ºç­”æ¡ˆé•·åº¦ï¼› n=NUMBER æ§åˆ¶ bar çš„é•·åº¦ã€‚

%D bar ä¸»è¦æœ‰å››ç¨®æ¨£å¼ï¼Œå¯ä»¥é€šé mp åƒæ•¸é€²è¡Œè¨­ç½®ï¼š
%D rules:under:dots    %rules:under:random
%D rules:under:dash    %rules:under:wave

%D æ–°å¢ä¸€ä¸ª align=autoright æ¥è®© fillin å¯¹é½å³æ–¹ã€‚ä½†å¿…é¡»åŒæ—¶è®¾ç½® n=0 æ‰ä¼šæ­£å¸¸å·¥ä½œã€‚

\installnamespace          {fillin}
\installcommandhandler \????fillin    {fillin}    \????fillin

\setupfillin[%foregroundcolor=,
             %before=,after=,
             %left=,right=,
             %repeat=,mp=
              rule=fillin_text,% å¼•ç”¨ bar å‘½ä»¤
              empty=none,
              continue=yes,
              unit=em,
              order=foreground,
              method=0,
              %color=gray,
              width=4em,
              n=10,
              dy=-0.4,
              max=3,
              offset=-.1,
              rulethickness=.05,
              foregroundstyle=\ss,]

\tolerant\protected\def\fillin[#1]#:#2{%
  \item_pitemfalse\item_fillintrue
  \begingroup\removeunwantedspaces
  \iffirstargument\setupfillin[#1]\fi
  \setupbar[fillin_text][%
           rulethickness=\fillinparameter{rulethickness},
         foregroundcolor=\fillinparameter{foregroundcolor},
         foregroundstyle=\fillinparameter{foregroundstyle},
                continue=\fillinparameter{continue},
                    unit=\fillinparameter{unit},
                   order=\fillinparameter{order},
                  method=\fillinparameter{method},
                      dy=\fillinparameter{dy},
                     max=\fillinparameter{max},
                   width=\fillinparameter{width},
                    left=\fillinparameter{left},
                   right=\fillinparameter{right},
                  repeat=\fillinparameter{repeat},
                   color=\fillinparameter{color},
                  offset=\fillinparameter{offset},
                   empty=\fillinparameter{empty},
                      mp=\fillinparameter{mp}]%
  \global\advance\c_fillin_number by 1\relax
  \edef\p_n{\fillinparameter\c!n}%
  \edef\p_empty{\fillinparameter\c!empty}%
  \edef\p_number{\number\c_fillin_number}%
  \edef\p_align{\fillinparameter\c!align}%
  \edef\currentbar{\fillinparameter\c!rule}%
  \ifx\p_align\c!autoright
    \unskip\nobreak\hfill\penalty50\hskip2em\hbox{}\nobreak\hfill\fi
  \fillinparameter\c!before\fillinparameter\c!left
  \ifx\p_n\wildcardsymbol
     \donefalse
     \ifx\p_empty\v!yes\donetrue
     \else\ifx\p_empty\v!number\donetrue
     \else\ifx\p_empty\v!none\donetrue
     \fi\fi\fi
     \ifdone
      \ifmode_showanswer
        \setupfillin[empty=none]%
      \else
        \setupbar[\currentbar][\c!empty=\v!yes]%
      \fi
      \edef\p_empty{\fillinparameter\c!empty}%
    \fi
     \inlinebar[\currentbar]\bgroup
        \wordboundary#2\egroup
   \else
    \ifmode_showanswer\setupfillin[empty=none]\fi
    \edef\p_empty{\fillinparameter\c!empty}%
    \inlinebar[\currentbar]\bgroup
      \wordboundary\scratchcounter\numexpr\p_n\relax
      \ifx\p_empty\v!yes
        \interwordspacesbefore\scratchcounter
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!number
        \interwordspacesbefore\scratchcounter
        \zwnj\runninghbox{\resetbar\p_number}\zwnj
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!none
        \scratchcounter\numexpr\p_n/\plustwo\relax
        \interwordspacesbefore\scratchcounter
        \zwnj{{#2}}\zwnj
        \interwordspacesafter\scratchcounter
      \else#2\fi\fi\fi
    \egroup
   \fi
  \fillinparameter\c!right\fillinparameter\c!after
  \ifx\p_align\c!autoright
    \parfillskip=0pt \finalhyphendemerits=0 \par\fi
  \aftergrouped{\edef\currentanswer{\collectanswer{#2}#2}}
  \endgroup}

%D \section{è¨­ç½® material ç’°å¢ƒ}
%D é¡§åæ€ç¾©ï¼Œ\tex{material} ç’°å¢ƒç”¨ä¾†æ”¾ç½®å¤§æ®µæ–‡æœ¬ææ–™ã€‚
%D è©²ç’°å¢ƒæ¯”è¼ƒç‰¹æ®Šï¼Œå®ƒè¨­ç½®äº†å¤šå€‹å­å¯¦ä¾‹ä¾†é€²è¡Œæ›´å®Œå–„çš„è¨­ç½®ã€‚
%D é™¤äº† \tex{setupmaterial[number]} é€™å€‹å¯¦ä¾‹ç¹¼æ‰¿äº† \tex{setupcounter} çš„å…¨éƒ¨éµå€¼ä¹‹å¤–ï¼Œ
%D å…¶ä»–å¯¦ä¾‹éƒ½æ˜¯æ–°å®šç¾©çš„éµå€¼ã€‚

%D é€™äº›å¯¦ä¾‹åˆ†åˆ¥æ˜¯ï¼š
%D \startitemize[nowhite,joinedup,packed]
%D \item \tex{setupmaterial[number]}    è¨­ç½® è©²ç’°å¢ƒæ¨™é¡Œçš„ {\bf åºè™Ÿ};
%D \item \tex{setupmaterial[title]}     è¨­ç½® è©²ç’°å¢ƒçš„ {\bf æ¨™é¡Œ} ç›¸é—œçš„æ¨£å¼;
%D \item \tex{setupmaterial[author]}    è¨­ç½® è©²ç’°å¢ƒæ–‡ç« çš„ {\bf ä½œè€…} ç›¸é—œçš„æ¨£å¼;
%D \item \tex{setupmaterial[source]}    è¨­ç½® è©²ç’°å¢ƒæ–‡ç« çš„ {\bf å…·é«”ä¾†æº} çš„ç›¸é—œæ¨£å¼ã€‚
%D \item \tex{setupmaterial[indicator]} è¨­ç½® è©²ç’°å¢ƒæ–‡ç« çš„ {\bf ç•«ç·šåºè™Ÿæ–‡å­—} çš„ç›¸é—œæ¨£å¼ã€‚
%D \stopitemize

%D æ­¤å¤–ï¼Œ\type{title},\type{author},\type{source} çš„åç¨±æ˜¯é€šé \tex{setupmaterial}
%D ä¾†ç›´æ¥è¨­ç½®ã€‚æ­¤å¤–ï¼Œ è©²ç’°å¢ƒå…·æœ‰ä¸€å€‹ç‰¹æ®Šçš„å­å‘½ä»¤ \tex{indicator} ä¾†æ¨™è¨˜æ–‡ç« ä¸­çš„æå•çš„éƒ¨åˆ†ä¸¦
%D é€²è¡Œæ·»åŠ æ•¸å­—æ¨™è­˜ --- ï¼ˆä¸€ï¼‰ç•«ç·šæ–‡å­—ã€‚å› æ­¤ï¼Œ\tex{setupmaterial} é‚„å…·æœ‰ä¸€å€‹éµå€¼ indicator
%D é€šé \type{indicator=reset} å° indicator é€²è¡Œé‡ç½®ï¼Œæ¯ç•¶é–‹å•“ä¸€å€‹æ–°çš„ material ç’°å¢ƒã€‚
%D é€šé \type{indicator=continue} å° indicator å–æ¶ˆé‡ç½®ï¼Œå®ƒå°‡æŒçºŒè¨ˆæ•¸ã€‚
%D ç•¶ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šé \tex{setupmaterial[indicator][reset=true]} ä¾†å•“ç”¨é‡æ–°è¨ˆæ•¸

%D ä»¥ä¸Šæ‰€æœ‰å¯¦ä¾‹éƒ½å…·æœ‰ä»¥ä¸‹éµå€¼ï¼š
%D before after align style color
%D æ­¤å¤–ï¼Œ\tex{setupmaterial} å¯ä»¥é€šè¿‡ spacebefore å’Œspaceafter æ¥æ§åˆ¶ç¯å¢ƒå‰åçš„å‚ç›´è·ç¦»

%D notice , if you want change [start = number] after a chapter ,
%D you should use \tex{resetcount[COUNTER_NAME]} to reset current counter
%D to the number of start you've setted.
%D otherwise, you need put [start = number] before the chapter you want
%D to reset the counter.

%D \startbuffer
%D \setupmaterial[title][color=green]
%D \startmaterial[title={Knuth},author={Mos},source={Yelu}]
%D \input knuth
%D \stopmaterial
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {material}
\installcommandhandler \????material  {material}  \????material
\installcounterassociation {material}

\appendtoks
   \registermaterialcounter\currentmaterial
   \definecounter[\currentmaterial]%
\to \everydefinematerial

\appendtoks
   \synchronizematerialcounters
\to \everysetupmaterial

\definematerial [material]
\definematerial [number]
\definematerial [indicator]
\definematerial [indicator_helper]

\setupmaterial [\c!align=center,
                %\c!color=,
                %\c!style=,
                \c!spacebefore=1em,
                \c!spaceafter=1em,
                %\c!title=,
                %\c!author=,
                %\c!source=,
                \c!indicator=continue,
                indent={first,always,2em},]
\setupmaterial [\c!number] [\c!before={(},\c!after={)},
                            \c!prefix=no,\c!start=0,
                            \c!style=\namedmaterialparameter\c!title\c!style,
                            \c!color=\namedmaterialparameter\c!title\c!color,
                            \c!numberconversion=cn,\c!way=\v!by\v!chapter]
\setupmaterial [\c!title]  [\c!style=\ss\tfa,\c!color=,\c!align=center,
                            \c!before=,]
\setupmaterial [\c!author] [\c!style=\tf,\c!color=,\c!align=flushright]
\setupmaterial [\c!source] [\c!before=\par,\c!align=flushright]
\setupmaterial [indicator,indicator_helper]
               [style=\ss\bf,before={ (~},after={~) },prefix=no,
                numberconversion=cn,type=line,reset=false]

\def\material_counter_parameter#1%
  {\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\c!title\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \incrementcounter[#1]\convertedcounter[#1]%
    \namedmaterialparameter\currentmaterial\c!after
   \endgroup}

\def\material_parameter#1%creat new element in material
  {{\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\currentmaterial\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \rootmaterialparameter\currentmaterial
    \namedmaterialparameter\currentmaterial\c!after
    \par\endgroup}}

\tolerant\protected\def\startmaterial[#1]{\begingroup%
  \lettonothing\currentmaterial%%
  \edef\p_indicator{\rootmaterialparameter\c!indicator}
  \edef\p_reset{\namedmaterialparameter{indicator}\c!reset}
  \processaction[\p_indicator][
    reset=>\let\indicator_reset_helper\resetindicators,
  continue=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \processaction[\p_reset][
    true=>\let\indicator_reset_helper\resetindicators,
    false=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \env_materialtrue\set_envitem_counter%
  \iffirstargument\setupcurrentmaterial[#1]\fi
  \indicator_reset_helper
  \usematerialstyleandcolor\c!style\c!color%
  \blank[\rootmaterialparameter\c!spacebefore]
  \startalignment[\rootmaterialparameter\c!align]
      \material_counter_parameter\c!number
      \material_parameter\c!title
      \material_parameter\c!author
  \stopalignment
  \blank[\rootmaterialparameter\c!spaceafter]
  \setupindenting[\rootmaterialparameter{indent}]
  \removeunwantedspaces}
\def\stopmaterial{%
    \material_parameter\c!source
    \indicator_reset_helper
    \endgroup}

\tolerant\protected\def\indicator[#1]#:#2{\begingroup%
    \def\currentmaterial{indicator}
    \iffirstargument\setupmaterial[indicator][#1]\fi%
    \edef\indicator_type{\namedmaterialparameter\currentmaterial\c!type}%
    \edef\indicator_reset{\namedmaterialparameter\currentmaterial\c!reset}%
    \processaction[\indicator_type]%
              [line=>\let\indicator_type\underbar,%
               none=>\let\indicator_type\relax]%
    \usematerialstyleandcolor\c!style\c!color%
    \indicator_type{%
    \namedmaterialparameter\currentmaterial\c!before%
    \ifmode_check%
      \ifenv_material\color[red]{material}\else\color[red]{\currentitemgroup}\fi%
      \ifcontinue_counter\color[red]{continue}\fi%
    \fi%
    \ifenv_material%
      \ifmode_check\color[red]{::indicator}\fi%
      \incrementcounter[\currentmaterial]%
      \convertedcounter[\currentmaterial]%
    \else%
      \ifmode_check\color[red]{::helper}\fi%
      \incrementcounter[indicator_helper]%
      \convertedcounter[indicator_helper]%
    \fi%
    \namedmaterialparameter\currentmaterial\c!after%
    #2}
\endgroup}

\def\indicators{%%% TODO å¢å¼·è©²å‘½ä»¤çš„ç”¨æ³•
  \ifenv_material
    \ifmode_check\color[red]{::indicator}\fi
    \incrementcounter[indicator]%
    \convertedcounter[indicator]%
  \else
    \ifmode_check\color[red]{::helper}\fi
    \incrementcounter[indicator_helper]%
    \convertedcounter[indicator_helper]%
  \fi}
\def\resetindicators{\setcounter[indicator][0]%
                     \setcounter[indicator_helper] [0]}
%%%%%%%%%%%%%%%%
%D \section{è®¾ç½® close ç¯å¢ƒ}

%D close ç’°å¢ƒè¿‘ä¹æ˜¯å–®ç¨è¨­è¨ˆçš„ã€‚é‚„éœ€è¦æ”¹é€²ï¼šç›´æ¥ä½¿ç”¨ itemgroup é‡ç½®ï¼Œè©²ç’°å¢ƒä¸»è¦ä½¿ç”¨å…©å€‹å‘½ä»¤ï¼š
%D \tex{startclose} å’Œ \tex{stopclose} ç”¨ä¾†å‰µå»ºè©²ç’°å¢ƒï¼Œ
%D \tex{closechoice} ç”¨ä¾†æ¨™è¨˜ç’°å¢ƒå…§çš„é¸é …ï¼Œè©²å‘½ä»¤éš¨è¡Œæ–‡æ”¾ç½®å³å¯ã€‚é¸é …ç„¡é ˆå†æ¬¡åœ¨æ–‡ç« å¾Œæ”¾ç½®ï¼Œ
%D \tex{stopclose} æœƒè‡ªè¡Œæ”¾ç½®ã€‚
%D å› ç‚º \type{close} ç’°å¢ƒçš„å­é …ç›® \tex{closechoice} æ˜¯é€šé choice ç’°å¢ƒè¨­ç½®çš„ã€‚
%D å› æ­¤ï¼Œå¯ä»¥é€šé \type{[*]} ä¾†æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆã€‚

%D close ç’°å¢ƒåŒæ¨£ç¹¼æ‰¿äº† answer çš„éµå€¼ã€‚
%D æ­¤å¤–è¨­ç½®äº† reset éµä¾†é¸æ“‡æ˜¯å¦æ¯ä¸€ç¯‡é‡ç½®é¸é …çš„é¡Œè™Ÿï¼Œ
%D å…¶ä»–çš„éµå€¼ï¼š barcolor barstyle è¨­ç½® ä¸‹åˆ’ç·šæ¨£å¼
%D            before after style color ç”¨æ–¼æ•´é«”ç’°å¢ƒ
%D            width frame stopper distance ç”¨æ–¼é¸é …å‰é¡Œè™Ÿæ¨£å¼

%D \startbuffer
%D \startclose
%D On Oct. 11, hundreds of runners competed in a cross-country race in Minnesota.
%D Melanie Bailey should have \closechoice[designed,followed,changed,finished] the
%D course earlier than she did. Her \closechoice[delay,chance,trouble,excuse] came
%D because she was carrying a \closechoice[judge,volunteer,classmate,competitor]
%D across the finish line.
%D
%D As reported by a local newspaper, Bailey was more than two-thirds of the way
%D through her \closechoice[race,school,town,training] when a runner in front of
%D her began crying in pain. She \closechoice[agreed,returned,stopped,promised]
%D to help her fellow runner, Danielle Lenoue. Bailey took her arm to see if she
%D could walk forward with \closechoice[courage,aid,patience,advice] . She couldn't.
%D Bailey then \closechoice[went away,stood up,stepped aside,bent down] to let Lenoue
%D climb onto her back and carried her all the way to the finish line, then another
%D 300 feet to where Lenoue could get \closechoice[medical,public,constant,equal] attention.
%D
%D Once there, Lenoue was \closechoice[interrupted,assessed,identified,appreciated]
%D and later taken to a hospital, where she learned that she had serious injuries in
%D one of her knees. She would have struggled with extreme \closechoice[hunger,pain,cold,tiredness]
%D to make it to that aid checkpoint without Bailey's help.
%D \stopclose
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupclose[%showanswer=false,
            reset=false,
            %barstyle=,
            %barcolor=,
            showpoint=false,
            answerstyle=\ss,
            answercolor=red,
            width=2em,% set order width
            frame=off,% set order frame
            stopper=.,% set order stopper
            distance=.5em,% set order distance
            after=\blank[halfline]]

\c_closetest=1\relax
\tolerant\protected\def\closebar#1{
  \startbar[underbar]%
    \scratchcounter\numexpr16/\plustwo\relax
    \interwordspacesbefore\scratchcounter
      \zwj\runninghbox{\resetbar{#1}}\zwj
    \interwordspacesafter\scratchcounter
  \stopbar}

\def\closechoice[#1]{% é€™æ˜¯ç”¨æˆ¶å‘½ä»¤ï¼Œç”¨ä¾†è¨˜éŒ„é¸é …(å®šç¾©é¸é …åˆ—è¡¨)
  \expandafter\def\csname close:\romannumerals\c_closetest\endcsname{#1}%
  % c_closetest ç”¨æ–¼æ¨™è¨˜é¸é …åˆ—è¡¨ï¼Œæœƒéš¨è‘—é¸é …é¡Œç›®å¢åŠ ï¼Œç„¡è«–æ˜¯å¦å•“ç”¨é‡ç½®ï¼Œè©²è¨ˆæ•¸å™¨éƒ½æœƒè¨˜éŒ„ä¸¦è‡ªå¢
  % åœ¨ç”Ÿæˆé¸é …åºåˆ—æ™‚ï¼Œè©²è¨ˆæ•¸å™¨å¯ä»¥é€²è¡Œï¼š(1) æ˜¯å¦è¨­ç½®äº†é¸é … (2) éå¢å‡ºé¸é …åºåˆ—
  % è©²è¨ˆæ•¸å™¨å±¬æ–¼å±€åŸŸï¼Œæ¯ç¯‡æ–‡ç« éƒ½æœƒé‡ç½®å› 1ã€‚
  \ifclose_counter_reset
    \begingroup
      \setupbar[underbar]%
       [color=\closeparameter{barcolor},
        mp=\closeparameter{barstyle}]%
      \closebar{\number\c_closetest}%
    \endgroup
  \else
    \begingroup\let\par\relax% å°‡å…¶å°è£åœ¨å±€åŸŸï¼Œé¿å… par å‘½ä»¤å¤±æ•ˆ
       \setupbar[underbar]%
       [color=\closeparameter{barcolor},
        mp=\closeparameter{barstyle}]%
      \startitemgroup[env_question][n,continue,text,nostopper]%
                                   [lefttext=\closebar,righttext=]%
      \item \save_question_order
      \stopitemgroup
    \endgroup
  \fi\advance\c_closetest by 1\relax}

\def\close_order{%é¸é …å‰çš„åºè™Ÿæ¨£å¼ï¼Œåºè™Ÿé€šé tempa è¨­å®š
  \unskip\noindent
  \inframed[width=\closeparameter\c!width,
            frame=\closeparameter\c!frame,
            foreground=color,
            foregroundcolor=\closeparameter\c!color,
            foregroundstyle=\closeparameter\c!style]{%
     \convertnumber{n}{\number\c_closetest_tempa}%
     \closeparameter\c!stopper}%
   \hskip\closeparameter\c!distance\relax
   \global\advance\c_closetest_tempa by 1\relax
  \unskip}

\def\docloseitem#1{\startcitem #1\stopcitem}
\def\placeclosechoice{%
  \scratchcounter\numexpr\c_closetest-1\relax
  \c_closetest=1\relax%
   \dorecurse{\number\scratchcounter}{% start recurse
    \hbox{% start first box
      \hsize=\textwidth
      \increaseQuestionID
      \set_count_envlevel  [close]%
      \installpointoranswer[close][point]%
      \installpointoranswer[close][answer]%
      \edef\currentitemnumber{\the\c_closetest_tempa}%
      \edef\currentuserorder{%
        \currentitemnumber%æ”¾ç½®åœ¨é€™è£¡æ‰èƒ½æ­£ç¢ºç²å–é¡Œè™Ÿ
        \ifnum\rawcountervalue[Unicode_botlevel]=0\else% æŠ½å‡º order å®šç¾©ï¼Œ
          (\rawcountervalue[Unicode_botlevel])\fi}% å› ç‚ºè©²ç’°å¢ƒæ²’æœ‰ä¸Šç´š question ç’°å¢ƒ
       \hbox{\close_order}% close question index  box
       \hbox{\vtop{%   close question choice box start
          \startchoice[point=\closeparameter\c!point]%
            \processcommacommand[\csname close:\romannumerals\c_closetest\endcsname]\docloseitem%
          \stopchoice
          }}%    close question choice box stop
     }% stop first hbox
   \advance\c_closetest by 1\relax}% stop reucrse
  \c_closetest=1\relax%
}

\tolerant\protected\def\startclose[#1]%
 {\begingroup\env_closetrue\set_envitem_counter
  \iffirstargument\setupclose[#1]\fi
  \edef\p_reset{\closeparameter\c!reset}%
  \ifx\p_reset\s!true
    \close_counter_resettrue
  \else
    \close_counter_resetfalse
  \fi\restore_question_order
  \ifclose_counter_reset% å¦‚æœé‡ç½®ï¼Œ å‰‡åºè™Ÿèµ·è‡ª 1
    \c_closetest_tempa=1\relax% tempa æ ‡è®°æ–‡ç« å†…çš„åºå·å’Œé€‰é¡¹å‰çš„åºå·
  \else % å¦å‰‡ï¼Œ æ¢å¾©ä¸Šä¸€å•é¡Œåºè™Ÿï¼Œ ä¸¦éå¢1.
    \c_closetest_tempa=\rawcountervalue[strc_close_counter]%
    \c_closetest_tempa=\numexpr\c_closetest_tempa+1\relax
  \fi
  \closeparameter\c!before
  \useclosestyleandcolor\c!style\c!color
  \removeunwantedspaces}

\def\stopclose{%
  \closeparameter\c!after
  \placeclosechoice
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{è¨­ç½® optclose ç’°å¢ƒ}
%D è©²ç’°å¢ƒæ˜¯ close ç’°å¢ƒçš„è®Šé«”ï¼Œä½†ç›®å‰ä¸¦æœªå°è©²ç’°å¢ƒé€²è¡Œæ›´å¤šçš„è¨­ç½®ã€‚
%D è©²ç’°å¢ƒçš„ä¸»è¦å‘½ä»¤æœ‰å…©å€‹ï¼š
%D \tex{startoptclose} å’Œ \tex{stopoptclose} ç”¨ä¾†å‰µå»ºè©²ç’°å¢ƒï¼Œ
%D \tex{ocitem} ç”¨ä¾†æ¨™è¨˜ç’°å¢ƒå…§çš„é¸é …ï¼Œè©²å‘½ä»¤éš¨è¡Œæ–‡æ”¾ç½®å³å¯ã€‚
%D \tex{ocitem[answer=blabla]}\type{blablabla}

%D æ­¤å¤–ï¼Œé‚„æœ‰ä¸€å€‹ç‰¹æ®Šçš„å‘½ä»¤ï¼Œ\tex{specialocitem} åƒ…å…·æœ‰ answer éµå€¼ã€‚å¯ä»¥é€šé
%D \tex{setupocitem} ä¾†èª¿æ•´è©²å‘½ä»¤çš„æ¨£å¼ã€‚è©²å‘½ä»¤æ¨™è¨˜ç­”æ¡ˆï¼Œä¸”ç„¡é ˆä»»ä½•ç’°å¢ƒåŒ…è£¹ã€‚

%D \startbuffer
%D \startoptclose
%D The latest \ocitem[answer=engineering]{engineer} techniques are applied to create
%D this protective \ocitem[answer=functional]{function} structure that is also
%D beautiful. The design features ten steel â€œsepals (è¼ç‰‡)â€ made of glass and
%D aluminium (é“). These sepals open on warm days \ocitem[answer=to give]{give} the
%D inside plants sunshine and fresh air. In cold weather, the structure stays
%D \ocitem[answer=closed]{close} to protect the plants.
%D
%D Further, the Silk Route Garden around the greenhouse \ocitem[answer=walks]{walk}
%D visitors through a journey influeVLed by the aVLient Silk Road, by which silk as
%D well as many plant species came to Britain for \ocitem[answer=the]{} first time.
%D These plants iVLluded modern Western \ocitem[answer=favorites]{favourite} such as
%D rosemary, lavender and fennel. The garden also contains a winding path that guides
%D visitors through the twelve regions of the Silk Road. The path offers over 300
%D plant species for visitors to see, too.
%D
%D The Glasshouse stands \ocitem[answer=as]{} a great achievement in contemporary
%D design, to house the plants of the southwestern part of China at the end of a path
%D retracing (è¿½æº¯) the steps along the Silk Route \ocitem[answer=which that]{}
%D brought the plants from their native habitat in Asia to come to define much of the
%D \ocitem[answer=richness]{rich} of gardening in England.
%D \stopoptclose
%D \stopbuffer
%D \typebuffer
%D \getbuffer

\installnamespace          {ocitem}
\installcommandhandler \????ocitem    {ocitem}    \????ocitem

\setupocitem [%answer=,
              %color=,
              %point=,
              %showanswer=false,
              pointlabel={,\examtexts{point}},
              answerlabel={{\examtexts{answer}},},
              answercolor=red,
              answerstyle=\ss,]

\definequestion[optclose]
\definequestion[specialocitem]
\def\setupoptclose{\setupquestion[optclose]}
\def\setupspecialoptclose{\setupquestion[specialocitem]}

\setupquestion[optclose]
 [option={n,continue,text,nostopper},
  lefttext=\closebar,
  righttext=,
  reset=false,
  class=optclose,]

\setupquestion[specialocitem]
 [option={n,continue,text,nostopper},
  lefttext=\closebar,
  righttext=,
  reset=false,]

\tolerant\protected\def\ocitem[#1]#:#2%
   {\begingroup%
    \iffirstargument\setupocitem[#1]\fi%
    \useocitemstyleandcolor\c!style\c!color%
    \let\par\relax\increaseQuestionID%
    \item \parentitemnumber=\currentitemnumber\relax
          \set_count_itemlevel[ocitem]%%%% å¿…é ˆå‘½ä»¤ï¼Œè¨­å®šåºè™Ÿ
          % æ³¨æ„ï¼Œæ­¤æ—¶ toplevel å¹¶æ²¡æœ‰æ­£ç¡®çš„å…³é—­ï¼Œå› æ­¤æœ€ç»ˆçš„ç»“æœä¾ç„¶æ˜¯ toplevelã€‚
          % ä½†æ˜¯è¯¥ç¯å¢ƒæœ¬èº«å°±è¢«è§†ä¸º toplevel                =>  5
          % å¦‚æœè¯¥ç¯å¢ƒè¢«è§†ä¸ºå­é¡¹ç›®æ—¶ï¼Œåˆ™éœ€è¦å…³é—­ toplevelã€‚==> 5(1)
          % å¦å¤–ï¼Œå…³é—­ toplevel éœ€è¦åœ¨ set_count_itemlevel å‘½ä»¤ä¹‹å‰æ‰ä¼šç”Ÿæ•ˆã€‚
          \allowbreak\doifsomethingelse{#2}{(#2)}{}% æ”¾ç½®é¸é …ï¼Œé¡ä¼¼ inlinechoice
          \edef\currentpoint{\ocitemparameter\c!point}%
          \edef\currentanswer{\ocitemparameter\c!answer}%
          \installpointoranswer[ocitem][point]%
          \installpointoranswer[ocitem][answer]%
          \installdatacollector%
          \installdatacollectorhelper%
          \initcollectanswer
          \save_question_order%
  \endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{score}
%D æ”¾ç½®åœ¨ answer ç’°å¢ƒå…§æ¨™è¨˜å¾—åˆ†ã€‚

%D \starttyping
%D   score\score{3}\\
%D   score\score[type=dotfill]{30}\\
%D   \resetscore\\
%D   score\score[type=cdotfill]{30}\\
%D   \setupscore[score=calculation]
%D   score\score[type=space]{3}\\
%D   score\score[type=hfill]{3}\\
%D \stoptyping

\def\score_calc#1{% only show number
  \global\c_stepscore_temp=#1\relax%
  \ifnum\c_stepscore=0\global\c_stepscore=#1\relax\else%
  \global\c_stepscore=\numexpr\c_stepscore+\c_stepscore_temp\relax%
  \fi\number\c_stepscore%
}
\def\dotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil.\hfil}%
  \hfill\kern 0pt\relax}
\def\cdotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil$\cdot$\hfil}%
  \hfill\kern 0pt\relax}

\installnamespace                 {score}
\installcommandhandler \????score {score} \????score

\setupscore[style=\ssa,color=red,dotstyle=\ss,dotcolor=red,score=]

\tolerant\protected\def\score[#1]#:#2{\begingroup% format style
  \iffirstargument\setupscore[#1]\fi%
  \scoreparameter\c!before%
  \usescorestyleandcolor\c!style\c!color%
  \start\space\scoreparameter{dotstyle}%
  \switchtocolor[\scoreparameter{dotcolor}]%
  \doif{\scoreparameter\c!type}{}{\dotfill}%
  \doif{\scoreparameter\c!type}{space}{}%
  \doif{\scoreparameter\c!type}{hfill}{\unskip\hfill}%
  \doif{\scoreparameter\c!type}{dotfill}{\dotfill}%
  \doif{\scoreparameter\c!type}{cdotfill}{\cdotfill}%
  \space\stop\scoreparameter\c!left%
  \doif{\scoreparameter{score}}{}           {#2}%
  \doif{\scoreparameter{score}}{default}    {#2}%
  \doif{\scoreparameter{score}}{calculation}{\score_calc{#2}}%
  \doif{\scoreparameter{score}}{complex}    {#2 : \score_calc{#2}}%
  \scoreparameter\c!right\scoreparameter\c!after%
\par\endgroup}
\def\resetscore{%
  \c_stepscore_temp=0\relax%
       \c_stepscore=0\relax%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{ä½œæ–‡æ ¼ / Writing Box}
%D
%D \startbuffer
%D \writingbox
%D  [column=12,
%D   row=15,
%D   evencolor=blue,
%D   oddcolor=darkgray,
%D   evenheight=1cm,
%D   oddheight=.5cm,
%D   align=flushleft,
%D   height=\textheight,
%D   width=\textwidth,]{}
%D \writinggrid
%D  [cellwidth=1cm,
%D   column=12,
%D   row=15,
%D   cellcolor=darkgray,
%D   align=flushleft,
%D   height=\textheight,
%D   width=\textwidth,]{}
%D \stopbuffer
%D \typebuffer
%D \getbuffer

\startuseMPgraphic{grid:writingbox}{column,row,evenheight,oddheight,}
  pageWidth   := OverlayWidth;
  evenRows    := \MPvar{row};
  evenHeight  := \MPvar{evenheight};
  oddHeight   := \MPvar{oddheight};
  evenColumns := \MPvar{column};
  oddColumns  := evenColumns + 1;

  %% ç»˜åˆ¶å¶æ•°è¡Œ
  for i = 1 upto evenColumns: % å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¡Œæ•°
    y1 := i * (oddHeight + evenHeight) + oddHeight;
    y2 := y1 + evenHeight;
    for j = 0 upto evenRows - 1:
        x1 := j  * (pageWidth / evenRows);
        x2 := x1 + (pageWidth / evenRows);
        draw (x1, y1) -- (x2, y1) -- (x2, y2) -- (x1, y2) -- cycle
            withcolor \MPvar{evencolor};
    endfor;
  endfor;

  %% ç»˜åˆ¶å¥‡æ•°è¡Œ
  for i = 1 upto oddColumns: % å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¡Œæ•°
    y1 := i * (oddHeight + evenHeight);
    y2 := y1 + oddHeight;
    draw (0, y1) -- (pageWidth, y1) -- (pageWidth, y2) -- (0, y2) -- cycle
        withcolor \MPvar{oddcolor};
  endfor;
\stopuseMPgraphic

\defineoverlay
[writingbox]
[{\uniqueMPgraphic{grid:writingbox}{
  evencolor=\framedparameter{evencolor},
   oddcolor=\framedparameter{oddcolor},
    column=\framedparameter{column},
        row=\framedparameter{row},
  evenheight=\framedparameter{evenheight},
  oddheight=\framedparameter{oddheight},
 }}]

\defineframed[writingbox]
 [offset=overlay,
  background=writingbox,
  frameoffset=.5pt,
  column=12,
  row=15,
  evencolor=blue,
  oddcolor=darkgray,
  evenheight=1cm,
  oddheight=.5cm,
  align=flushleft,
  height=\textheight,
  width=\textwidth,
  rulethickness=1pt]

% \writingbox[column=12,row=15,]{EEE\par EEEE\par EEEE}

\startuseMPgraphic{grid:writinggrid}{row,column,cellwidth,cellcolor}
  pageWidth   := OverlayWidth;
  m := \MPvar{row};       % è¡Œæ•°
  u := \MPvar{cellwidth}; % å•ä½é•¿åº¦
  n := \MPvar{column};    % åˆ—æ•°
  % ç”»ç«–çº¿
  for i = 0 upto n:
      draw (i*u, 0) -- (i*u, m*u) withcolor \MPvar{cellcolor};
  endfor;

  % ç”»æ¨ªçº¿
  for j = 0 upto m:
      draw (0, j*u) -- (n*u, j*u) withcolor \MPvar{cellcolor};
  endfor;
\stopuseMPgraphic

\defineoverlay
[writinggrid]
[{\uniqueMPgraphic{grid:writinggrid}{
    column=\framedparameter{column},
       row=\framedparameter{row},
 cellwidth=\framedparameter{cellwidth},
 cellcolor=\framedparameter{cellcolor},
 }}]

\defineframed[writinggrid]
  [offset=overlay,
    background=writinggrid,
    frameoffset=.5pt,
    cellwidth=1cm,
    column=12,
    row=15,
    cellcolor=darkgray,
    align=flushleft,
    height=\textheight,
    width=\textwidth,
    rulethickness=1pt]

%  \writinggrid[column=12,row=15,]{EEE\par EEEE\par EEEE}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{æ¨¡æ‹Ÿä¾‹å­}

\dorecurse{2000}{% æé«˜è¿™ä¸ªæ•°å­—ï¼Œå¯ä»¥æå‡å¯ç”Ÿæˆä¾‹å­çš„æ€»æ•°ã€‚æ‰€æœ‰ä¾‹å­å…±ç”¨ä¸€ä¸ªæ€»æ•°
\expandafter\getrandomnumber \csname n_\romannumeral\recurselevel\endcsname  {1} {20}}

\dorecurse{2000}{% ä¸€æ—¦æ€»ä¾‹å­æ•°è¶…è¿‡ï¼Œåˆ™æ— æ³•ç»§ç»­ç”Ÿæˆï¼Œå¹¶æŠ›å‡ºé”™è¯¯ã€‚
\expandafter\getrandomnumber \csname nn_\romannumeral\recurselevel\endcsname {1} {20}}

\def\longtesttxt[#1]{%%1. \longtesttxt[\romannumeral 1]
  \ifcase\csname n_#1\endcsname%
    å°±åƒæŒ‰ S æ¥å“åº”é”™è¯¯ä¸€æ ·ã€‚\or%0
    è¿™ä¸ªä¾‹å­ä¸å¤ªå®Œæ•´ï¼Œå› ä¸ºé¡µç æ²¡æœ‰å­˜å‚¨åœ¨æœ‰ç”¨çš„åœ°æ–¹ã€‚\or%1
    TeX å¤„ç†æ•°å­¦æ˜¾ç¤ºåï¼Œå®ƒå°†ä»¥ä¸‹é¡¹ç›®æ·»åŠ åˆ°å½“å‰å‚ç›´åˆ—è¡¨ä¸­ï¼š æƒ©ç½šã€èƒ¶æ°´ã€å®é™…æ˜¾ç¤ºã€èƒ¶æ°´å’Œæƒ©ç½šã€‚\or%2
    ç„¶è€Œï¼Œå®ƒæ˜¾ç¤ºäº†ä¸€ç§å¢åŠ æˆ–å‡å°‘è®¡æ•°å™¨çš„æ–¹æ³•ï¼Œå¹¶è®¾ç½®æ•°å­—ä¸­çš„æ•°å­—æˆ–ç›¸å½“äºæ•°å­—çš„ç½—é©¬æ•°å­—ä¸­çš„å­—æ¯ã€‚\or%3
    åŸºæœ¬é—®é¢˜æ˜¯ â€œå¯¹ TeXbook çš„é¡µé¢å¼•ç”¨åº”è¯¥å¦‚ä½•å‡ºç°åœ¨å‚è€ƒé¡µé¢çš„æè¿°åŒºåŸŸä¸­ï¼Ÿâ€ è¿™ä¸ªä¾‹å­æ˜¾ç¤ºäº†ä¸‰ç§å¯èƒ½æ€§ã€‚\or%4
    æ­£å¦‚ TeX ä¸ä¼šéšæœºè¿å­—ç¬¦å•è¯ä¸€æ ·ï¼Œå®ƒä¹Ÿä¸ä¼šåœ¨æ®µè½ä¸­çš„è¡Œä¹‹é—´éšæœºæ‰“æ–­æ•°å­¦è¡¨è¾¾å¼ã€‚\or%5
    TeX ä»…è€ƒè™‘åœ¨å…³ç³»ï¼ˆä¾‹å¦‚ = æˆ– < ï¼‰æˆ–äºŒè¿›åˆ¶æ“ä½œï¼ˆä¾‹å¦‚ + æˆ– Ã— ï¼‰ä¹‹åè¿›è¡Œä¸­æ–­ã€‚\or%6
    æ­¤å‘½ä»¤æä¾›å¯¹å½“å‰å­—ä½“ä¸­æ‰€æœ‰å­—ç¬¦çš„è®¿é—®ã€‚å·ç åº”è¯¥åœ¨ 0 -- 255 èŒƒå›´å†…ã€‚\or%7
    Junkjunk.texæ–‡ä»¶ä¸åŒ…å«ä»»ä½•æœ‰ç”¨çš„ä¸œè¥¿ï¼Œä½†è¿™äº›è¡Œè¯´æ˜äº†ä¸€ç§è¯»å–è¾…åŠ©æ–‡ä»¶çš„æ–¹æ³•ã€‚\or%8
    æ­¤å‘½ä»¤å°†æ¡†å¯„å­˜å™¨ä¸­çš„åˆ—è¡¨å‰¯æœ¬æ·»åŠ åˆ°å½“å‰åˆ—è¡¨ä¸­ã€‚\or%9
    è¯·æ³¨æ„ï¼Œæ¯ä¸ªå¯„å­˜å™¨åœ¨åˆ›å»ºåéƒ½ä¼šè¢«åˆå§‹åŒ–ã€‚\or%0
    æ­¤å‘½ä»¤æä¾›äº†ä¸€ç§ç›´æ¥æŒ‡å®šåˆ†éš”ç¬¦çš„æ–¹æ³•ã€‚\or%1
    æ•°å­—åº”è¯¥æ˜¯ä¸ƒä¸ªåå…­è¿›åˆ¶æ•°å­—ã€‚\or%2
    å®ƒçš„å‰å¯¼æ•°å­—å¿…é¡»åœ¨ 0-7 èŒƒå›´å†…ã€‚è¯¥æ•°å­—ç”¨ä½œç±»å·ï¼Œå…¶ä½™å…­ä½æ•°å­—ç”¨ä½œ \type{\delcode} å€¼ã€‚\or%3
    Plain TeX æœ‰äºŒåå¤šä¸ªå®šä¹‰ï¼Œç±»ä¼¼äºï¼š`\type{\def\rceil{\delimiter"5265307 }}'ã€‚\or%4
    è¿™ä¸ªå®šä¹‰æ„å‘³ç€ \type{\rceil} åœ¨å®¶åº­5ï¼ˆå…³é—­ï¼‰ï¼Œå…¶å°å½¢å¼åœ¨å®¶åº­2ä½ç½®"65ï¼Œå…¶å¤§å½¢å¼åœ¨å®¶åº­3ä½ç½®"07"ã€‚\or%5
    \type{\Delimiter} æŒ‡å®šäº†ä¸€ä¸ªæ•°å­¦ç¬¦å·ï¼Œå¹¶ä»¥ä¸¤ç§æ–¹å¼å·¥ä½œã€‚\or%6
    å½“ TeX å¯»æ‰¾åˆ†éš”ç¬¦æ—¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨ \type{\left} ä¹‹åï¼‰ï¼Œå®ƒå¿½ç•¥äº†ç±»æ•°å­—ï¼Œå¹¶ä½¿ç”¨å‰©ä½™çš„å…­ä½æ•°å­—ä½œä¸º \type{\delcode}ã€‚\or%7
    ä½†æ˜¯ï¼Œå½“åˆ†éš”ç¬¦åœ¨å…¶ä»–ä¸Šä¸‹æ–‡ä¸­å‡ºç°æ—¶ï¼Œå³ä¸‰ä½æ•°å­—è¢«åˆ é™¤ï¼Œå…¶ä½™å››ä½æ•°å­—æˆä¸ºç¬¦å·çš„ \type{\mathcode}ã€‚\or%8
    å¯¹äº \type{\rceil}ï¼Œè¿™æ„å‘³ç€ \type{\delcode} æ˜¯"265307ï¼Œ\type{\mathcode} æ˜¯"5265"ã€‚\or%9
    å®ƒé¦–å…ˆè®¡ç®—å­å…¬å¼åœ¨è½´ä¸Šæ–¹å’Œä¸‹å»¶ä¼¸çš„è·ç¦»ã€‚æ¥ä¸‹æ¥ï¼Œå®ƒä½¿ y ç­‰äºåˆšåˆšè®¡ç®—çš„æœ€å¤§è·ç¦»çš„ä¸¤å€ã€‚\fi}

\def\shorttesttxt[#1]{%%1. \shorttesttxt[i]
  \ifcase\csname nn_#1\endcsname%
    æ‚¬æŒ‚å‹ç—•çš„æ•°é‡\or%0
    æ®µè½ä¸­æ­£çº¿çš„å®½åº¦\or%1
    å¼€å§‹ä¸€ä¸ªæ²¡æœ‰ç¼©è¿›çš„æ–°æ®µè½\or%2
    å‘Šè¯‰TeXå°è¯•å¢åŠ æˆ–å‡å°‘æ®µè½ä¸­çš„è¡Œæ•°\or%3
    æ‰©å±•ä»¤ç‰Œï¼Œä½†åœ¨åˆ°è¾¾éç©ºé—´ä»¤ç‰Œä¹‹å‰ä»€ä¹ˆéƒ½ä¸åš\or%4
    åªæœ‰å½“ä¸»å‚ç›´åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œå®ƒæ‰ä¼šç»“æŸå½“å‰å·¥ä½œ\or%5
    è¯¥å‘½ä»¤åœ¨å†…éƒ¨å‚ç›´æ¨¡å¼ä¸‹æ˜¯ä¸å…è®¸çš„\or%6
    ä»»æ„ä¸­æ–­ç”±ä¸‰ä¸ªå­—ç¬¦åºåˆ—ç»„æˆ\or%7
    å¦ä¸€ä¸ªæ— æ•ˆå·ç è¢«ä¼ é€’äº†\or%8
    æ¥è‡ªå‡éƒ¨åˆ†çš„æ¡ä»¶å‘½ä»¤\or%9
    çº¿è·¯éœ€è¦è½¬ç§»çš„é‡‘é¢\or%0
    ç”¨äºæŒ‡å®šæ˜¾ç¤ºæ ·å¼\or%1
    å…³ç³»åæ–­çº¿çš„æƒ©ç½š\or%2
    æ­¤å‘½ä»¤å®šä¹‰äº†å®\or%3
    å®¶åº­çš„è„šæœ¬å­—ä½“\or%4
    å°ºå¯¸æ²¡æœ‰å˜åŒ–\or%5
    é¢å¤–çš„ç©ºé—´\or%6
    å·¦è¾¹çš„æ®µè½\or%7
    å½“å‰çº¿å®½\or%8
    æ–‡æœ¬æ ·å¼\or%9
    åºåˆ—\fi}

\tolerant\protected\def\choicenum[#1][#2][#3]{
  \ifnum\csname nn_#1\endcsname < 6
    \expandafter\startcitem[*]{\shorttesttxt[\romannumeral #2]} \stopcitem
  \else
    \expandafter\startcitem   {\shorttesttxt[\romannumeral #3]} \stopcitem
  \fi
}

\newcount\LNUM\LNUM=1\relax
\newcount\CNUM\CNUM=1\relax
\newcount\DNUM\DNUM=1\relax
\newcount\ENUM\ENUM=2\relax

\protected\def\example@choice#1{
    \setupquestion[point=2]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax\global\advance\DNUM by 2\relax\global\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \stopchoice
            % \startanswer
            % \input knuthmath
            % \stopanswer
    \stopquestion}
}
\def\example@fillin#1{
    \setuppitem   [point=3]
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem
          \longtesttxt[\romannumeral\CNUM]\fillin[]{\fillinanswer}
        \stoppitem
        % \startanswer
        %       \input knuthmath
        %     \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@pitem#1{
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem[answer={answer : \recurselevel},point={\number\CNUM}]
        \longtesttxt[\romannumeral\CNUM]\stoppitem
        % \startanswer
        %       \input knuthmath
        % \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@material#1{
    \startmaterial
    \input knuthmath
    \stopmaterial
    \setupquestion[point=6]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax%
            \global\advance\DNUM by 2\relax%
            \global\advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \stopchoice
            % \startanswer
            %   \input knuthmath
            % \stopanswer
    \stopquestion}
}
\def\example@close#1{
    \startclose
    \def\closechoicex{\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\closechoice[\closechoicex,{[*]\closechoicex},\closechoicex]
      \longtesttxt[\romannumeral\CNUM]}
    \stopclose
}

\def\example@optclose#1{
    \startoptclose
    \def\closechoicex{{\ss\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
          \global\advance\CNUM by 1\relax
        }\ocitem[point=4,answer={\shorttesttxt[\romannumeral\DNUM]}]%
                {\closechoicex,\closechoicex,\closechoicex}
      \longtesttxt[\romannumeral\CNUM]}
    \stopoptclose
}

\def\example@specialoptclose#1{
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\specialocitem[point=2,answer={\shorttesttxt[\romannumeral\DNUM]}]{}
        \global\advance\DNUM by 1\relax
      \longtesttxt[\romannumeral\CNUM]}
}

%\setupanswer[showanswer=true,showscript=true,
%              frame=on,framecolor=red,
%              rulethickness=2pt,
%              scriptcontent={\null\vbox to 4\baselineskip{}\relax}]
%\chapter{}
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%%
%\chapter{}
%
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%\page
%\dorecurse{30}{\typeanswerbychap{1}\par}
%\resetanswerid%
%\dorecurse{30}{\typeanswerbychap{2}\par}
%\resetanswerid
%\noindent\typeanswerlist[1][6]{30}
%\resetanswerid
%\noindent\typeanswerlist[2][6]{30}
%\type@answer@i[6*5,1,28]

%D \section{æ‰“å°ç­”æ¡ˆ / Print answer / ç­”ãˆã®è¼¸å‡º}

\newcount\c_qid_answer

\def\resetanswerid{\global\c_qid_answer=1\relax}

%D Example 1:
%D \starttyping
%D \dorecurse{5}{\typeanswerbychap{1}} % grab answer from chapter 1
%D \newcount\c_tempa\c_tempa=2\relax   % grab answer from 0-\the\c_tempa(chapter=0 qid=\the\c_tempa)
%D \dorecurse{5}{\typeanswerbychap[\c_tempa]{0}\advance\c_tempa by 1\relax}
%D \stoptyping
\tolerant\def\typeanswerbychap[#1]#:#2%
 {\begingroup% #1 = QIDï¼Œ #2 =chap number
  \ifparameter#1\or
    \doifsomethingelse{\scratchcounterone#1}{\scratchcounterone#1}{\scratchcounterone\zerocount}%
    \c_qid_answer=\numexpr\scratchcounterone -1\relax\fi
  \scratchcounter#2\relax
  \global\advance\c_qid_answer by 1\relax
  \datasetvariable{Answer_collector}{\the\scratchcounter-\the\c_qid_answer}{answer}%
  \endgroup}

%D Example 2:
%D \starttyping
%D \typeanswerdirect{0-5} % grab answer from chapter 0 qid 5
%D \stoptyping
\def\typeanswerdirect#1{% #1 = qidï¼Œéœ€è¦è‡ªè¡Œè¼¸å…¥ä¾†ç²å–æŸå€‹é¡Œç›®çš„ç­”æ¡ˆ
  \datasetvariable{Answer_collector}{#1}{answer}}

%D Example 3:
%D \starttyping
%D \typeanswerlist{30}       % type answer from chap 0 and get qid 1 - 30
%D \typeanswerlist[1]{30}    % type answer from chap 1 and get qid 1 - 30
%D \typeanswerlist[1][2]{30} % type answer from chap 1 and get qid 2 - 30
%D \stoptyping
\tolerant\protected\def\typeanswerlist[#chapno][#startno]#*#:#total{%#1 = chapter number
  \begingroup
  \ifparameter#chapno\or
    \doifsomethingelse{\scratchcounterone  #chapno }{\scratchcounterone  #chapno }{\scratchcounterone  \zerocount}\fi
  \ifparameter#startno\or
    \doifsomethingelse{\scratchcountertwo  #startno}{\scratchcountertwo  #startno}{\scratchcountertwo  \zerocount}\fi
  \ifparameter#total\or
    \doifsomethingelse{\scratchcounterthree#total  }{\scratchcounterthree#total  }{\scratchcounterthree\zerocount}\fi
  \c_qid_answer=\scratchcountertwo
  \dorecurse{\the\scratchcounterthree}{% answer amount
    \datasetvariable{Answer_collector}{\the\scratchcounterone-\the\c_qid_answer}{answer},%
  \advance\c_qid_answer by 1\relax}%
  \endgroup}

%D Example 4:
%D \starttyping
%D \typeanswertable[2,5]% #3 = 0 #4 = 1
%D \typeanswertable[2,5][0]% #4 = 1
%D \typeanswertable[2,5][0][6] % type answer in table
%D  ----------------------------------
%D |  ID  |  ID  |  ID  |  ID  |  ID  | #1 = 2
%D |  01  |  02  |  03  |  04  |  05  | #2 = 5
%D |  AS  |  AS  |  AS  |  AS  |  AS  | #3 = from chap 0
%D |  01  |  02  |  03  |  04  |  05  | #4 = type start QID 6
%D ------------------------------------
%D \stoptyping
\newcount\answer@seq@tempa
\newcount\answer@seq@tempb
\tolerant\def\typeanswertable[#rows,#columns]#*[#chapno]#*[#startno]%
 {\begingroup
  \ifarguments\or\or
  \scratchcounter    \zerocount\relax
  \scratchcounterone \plusone  \relax
  \or
  \doifsomethingelse{\scratchcounter    #chapno \relax}
                    {\scratchcounter    #chapno \relax}
                    {\scratchcounter    \zerocount\relax}
  \scratchcounterone \plusone  \relax
  \or
  \doifsomethingelse{\scratchcounter    #chapno \relax}
                    {\scratchcounter    #chapno \relax}
                    {\scratchcounter    \zerocount\relax}
  \doifsomethingelse{\scratchcounterone #startno\relax}
                    {\scratchcounterone #startno\relax}
                    {\scratchcounterone \zerocount\relax}
  \or\fi
  \answer@seq@tempa=\numexpr\scratchcounterone-1\relax
  \answer@seq@tempb=\numexpr\scratchcounterone-1\relax
  % \the\answer@seq@tempa == \the\answer@seq@tempb
  \bTABLE
    \dorecurse{#rows}{
      \bTR
      \dorecurse{#columns}{\advance\answer@seq@tempa by 1\relax
        \expanded{\bTD\tt\datasetvariable{Answer_collector}{\the\scratchcounter-\the\answer@seq@tempa}{userorder}\eTD}}%
      \eTR\bTR
      \dorecurse{#columns}{\advance\answer@seq@tempb by 1\relax
          \expanded{\bTD\ss\datasetvariable{Answer_collector}{\the\scratchcounter-\the\answer@seq@tempb}{answer}\eTD}}%
      \eTR}%
  \eTABLE
\par\endgroup}

%D Example 5:
%D \starttyping
%D \typeanswertablealt[4,2]% #3 = 0 #4 = 1
%D \typeanswertablealt[4,2][1]% #4 = 1
%D \typeanswertablealt[4,2][1][2] % type answer in table
%D  ----------------------------------
%D |  ID  |  01  |  AS  |  01  | #1 = 4
%D |  ID  |  02  |  AS  |  02  | #2 = 2
%D |  ID  |  03  |  AS  |  03  | #3 = from chap 0
%D |  ID  |  04  |  AS  |  04  | #4 = type start QID 2
%D ------------------------------------
%D \stoptyping
\tolerant\def\typeanswertablealt[#rows,#columns]#*[#chapno]#*[#startno]%
 {\begingroup\ifarguments 0\or
  \scratchcounter      \zerocount\relax
  \scratchcounterthree \plusone  \relax
  \or
  \scratchcounter      \zerocount\relax
  \scratchcounterthree \plusone  \relax
  \or
  \scratchcounterthree \plusone  \relax% for startno
  \doifsomethingelse{\scratchcounter      #chapno \relax}
                    {\scratchcounter      #chapno \relax}
                    {\scratchcounter      \zerocount\relax}
  \or
  \doifsomethingelse{\scratchcounter      #chapno \relax}
                    {\scratchcounter      #chapno \relax}
                    {\scratchcounter      \zerocount\relax}
  \doifsomethingelse{\scratchcounterthree #startno\relax}
                    {\scratchcounterthree #startno\relax}
                    {\scratchcounterthree \zerocount\relax}
  \or\fi
  \scratchcounterone #rows   \relax
  \scratchcountertwo #columns\relax
  \answer@seq@tempa=\numexpr\scratchcounterthree-1\relax
  \def\getdata##1{\datasetvariable
                 {Answer_collector}%
                 {\the\scratchcounter-\the\answer@seq@tempa}%
                 {##1}}%
  \bTABLE
    \dorecurse{\the\scratchcounterone}{\bTR
      \dorecurse{\the\scratchcountertwo}{\advance\answer@seq@tempa by 1\relax
        \expanded{\bTD\tt\getdata{userorder}\eTD}
        \expanded{\bTD\ss\getdata{answer}   \eTD}
       }
    \eTR}
  \eTABLE
\par\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{æ¨¡å¼è¨­ç½® / Mode Setting/ ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆ}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definemode[teacher][keep]
\definemode[student][keep]
\definemode[check]  [keep]
\startmode[teacher]
  \mode_showanswertrue
  \mode_showpointtrue
  % \setupquestion[showanswer=true,showpoint=true]
  % \setupchoice  [showanswer=true,showpoint=true]
  % \setupcitem   [showanswer=true,showpoint=true]
  % \setuppitem   [showanswer=true,showpoint=true]
  % \setupclose   [showanswer=true,showpoint=true]
  % \setupocitem  [showanswer=true,showpoint=true]
  % \setupanswer  [showanswer=true,showpoint=true,showscript=false]
\stopmode
\startmode[student]
  \mode_showanswerfalse
  \mode_showpointfalse
  % \setupquestion[showanswer=false,showpoint=true]
  % \setupchoice  [showanswer=false,showpoint=true]
  % \setupcitem   [showanswer=false,showpoint=true]
  % \setuppitem   [showanswer=false,showpoint=true]
  % \setupclose   [showanswer=false,showpoint=true]
  % \setupocitem  [showanswer=false,showpoint=true]
  % \setupanswer  [showanswer=false,showpoint=true,showscript=false]
\stopmode
\startmode[check]
  \mode_checktrue
\stopmode
\def\showanswer{\mode_showanswertrue\setupanswer[showscript=false]}
\def\hideanswer{\mode_showanswerfalse\setupanswer[showscript=true]}
\let\showpoint\mode_showpointtrue
\let\hidepoint\mode_showanswerfalse
\let\showchekinfo\mode_checktrue
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\protect
\stopmodule
\endinput