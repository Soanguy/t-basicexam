%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \module
%D   [     file=t-basicexam,
%D      version=2024-10-24,
%D        title=basicexam,
%D     subtitle=Memoir Ever,
%D       author=å•†æ— è¾›(Shueng Mosan),
%D         date=2024-6-1,
%D    copyright=å•†æ— è¾›(Shueng Mosan),
%D      license=,
%D          url=]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\startmodule[basicexam]
\unprotect
\setupmodule[mode=student,layout=default,footer=default]
\def\errorparameter#1{\begingroup
    \startalignment[center]
    \framed[align={center,lohi},width=max]{
    \switchtocolor[blue]\ttxx
    Module \currentmodule : 
    There is something Wrong happened at \color[red]{\underbar{parameter:#1}}.\\
    Please check your code.\\
    }\stopalignment
    \endgroup}

\newif\iflay_twoup   \lay_twoupfalse
\newif\ifhdr_default \hdr_defaultfalse

\processallactionsinset[\currentmoduleparameter{mode}][
     teacher=>{\enablemode[teacher]},
     student=>{\enablemode[student]},
       check=>{\enablemode[check]},
  \v!default=>{\enablemode[student]},
  \v!unknown=>\errorparameter{mode},
]

\processallactionsinset[\currentmoduleparameter{layout}][
       twoup=>\lay_twouptrue,
        none=>\relax,
  \v!default=>\relax,
  \v!unknown=>\errorparameter{layout},
]

\processallactionsinset[\currentmoduleparameter{footer}][
        none=>{\relax},
  \v!default=>\hdr_defaulttrue,
  \v!unknown=>\errorparameter{footer},
]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% æ³¨æ„ âš ï¸
%% åœ¨å®šä¹‰å‘½ä»¤æ—¶ï¼Œå‚æ•°åä¸å¯ä»¥ç›´æ¥æ–­è¡Œï¼Œä¼šå¯¼è‡´å‚æ•°æŸ¥æ‰¾å¤±è´¥ã€‚
%%ï¼ˆå¯èƒ½æ˜¯å› ä¸º tex è®¤ä¸ºå‚æ•°åæ–­è¡Œï¼Œåˆ™å‚æ•°çš„ç»“æŸåˆ†ç•Œç¬¦ä¸ºæ–­è¡Œï¼Œè€Œéæ‹¬å·ï¼‰
%% \def\foo#1{ .. some word ...}   \foo{..} å°†æ­£ç¡®è¿è¡Œ
%% \def\foo#1
%%     { .. some word ...}         \foo{..} å°†å¯¼è‡´å¤±è´¥
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% æ³¨æ„ âš ï¸
%% åœ¨ lua ä¸­ä½¿ç”¨ å¾ªç¯ ç­‰ç»“æ„æ—¶ï¼Œè¦æ³¨æ„ % ç™¾åˆ†æ¯”ç¬¦å·çš„ä½¿ç”¨ã€‚ä¸å¯ä»¥ç›´æ¥åœ¨å…³é”®å­—å
%% ä½¿ç”¨ã€‚ä¼šå¯¼è‡´è¿è¡Œå‡ºé”™ï¼š'do' expected near 'docontext' ç­‰æ¶ˆæ¯ã€‚
%% for i > 10 do % do å’Œ % å·ä¹‹é—´æœ‰ç©ºæ ¼ï¼Œ  ä¼šæ­£å¸¸è¿è¡Œ
%% for i > 10 do%  do å’Œ % å·ä¹‹é—´æ²¡æœ‰ç©ºæ ¼ï¼Œä¼šè¿è¡Œé”™è¯¯
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%\newcount\itindexn \itindexn=1
%%\def\itvariable{\ifcase\itindexn%
%%                       \or a\or b\or c\or d\or e%
%%                       \or f\or g\or h\or i\or j%
%%                       \or k\or l\or m\or n\or o%
%%                       \or p\or q\or r\or s\or t%
%%                       \or u\or v\or w\or x\or y\or z
%%                \fi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\begingroup
%\catcode`\%=12\relax
%\gdef\percentchar{%}
%\endgroup
%\ctxlua{context(string.format("\percentchar8s",456))}

%D \section{å°šæœªè™•ç†çš„çµ„åˆ}
%D è¨­ç½®é é¢
%D 2UP Printing
%D \starttyping
%D \setuppapersize[user pagesize][real pagesize,real orientation]
%D \setuparranging[page arrange method]
%D more info : https://wiki.contextgarden.net/Command/setuparranging
%D             https://wiki.contextgarden.net/Imposition
%D \stoptyping
%D ä¾‹å¦‚ï¼š
%D \starttyping
%D \setuppapersize[A4][A3,landscape]
%D \setuparranging[2SIDE]%[2UP]
%D \setuppagenumbering[alternative=singlesided]%{doublesided}]
%D \stoptyping

\iflay_twoup
  \setuppapersize[A4][A3,landscape]
  \setuparranging[2SIDE]% 2SIDE start page at odd [2UP] start at even
  \setuppagenumbering[alternative={doublesided}]%singlesided]
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion [hiragana]      [ã‚,ã„,ã†,ãˆ,ãŠ,ã‹,ã,ã,ã‘,ã“,ã•,ã—,ã™,ã›,ã,
                                   ãŸ,ã¡,ã¤,ã¦,ã¨,ãª,ã«,ã¬,ã­,ã®,ã¯,ã²,ãµ,ã¸,ã»,
                                   ã¾,ã¿,ã‚€,ã‚,ã‚‚,ã‚„,ã‚†,ã‚ˆ,ã‚‰,ã‚Š,ã‚‹,ã‚Œ,ã‚,ã‚,ã‚“]
\defineconversion [katakana]      [ã‚¢,ã‚¤,ã‚¦,ã‚¨,ã‚ª,ã‚«,ã‚­,ã‚¯,ã‚±,ã‚³,ã‚µ,ã‚·,ã‚¹,ã‚»,ã‚½,
                                   ã‚¿,ãƒ,ãƒ„,ãƒ†,ãƒˆ,ãƒŠ,ãƒ‹,ãƒŒ,ãƒ,ãƒ,ãƒ,ãƒ’,ãƒ•,ãƒ˜,ãƒ›,
                                   ãƒ,ãƒŸ,ãƒ ,ãƒ¡,ãƒ¢,ãƒ¤,ãƒ¦,ãƒ¨,ãƒ©,ãƒª,ãƒ«,ãƒ¬,ãƒ­,ãƒ¯,ãƒ³]
\defineconversion [hiragana-iroha][ã„,ã‚,ã¯,ã«,ã»,ã¸,ã¨,ã¡,ã‚Š,ã¬,ã‚‹,ã‚’,ã‚,ã‹,ã‚ˆ,
                                   ãŸ,ã‚Œ,ã,ã¤,ã­,ãª,ã‚‰,ã‚€,ã†,ã‚,ã®,ãŠ,ã,ã‚„,ã¾,
                                   ã‘,ãµ,ã“,ãˆ,ã¦,ã‚,ã•,ã,ã‚†,ã‚,ã¿,ã—,ã‚‘,ã²,ã‚‚,
                                   ã›,ã™,ã‚“]
\defineconversion [katakana-iroha][ã‚¤,ãƒ­,ãƒ,ãƒ‹,ãƒ›,ãƒ˜,ãƒˆ,ãƒ,ãƒª,ãƒŒ,ãƒ«,ãƒ²,ãƒ¯,ã‚«,ãƒ¨,
                                   ã‚¿,ãƒ¬,ã‚½,ãƒ„,ãƒ,ãƒŠ,ãƒ©,ãƒ ,ã‚¦,ãƒ°,ãƒ,ã‚ª,ã‚¯,ãƒ¤,ãƒ,
                                   ã‚±,ãƒ•,ã‚³,ã‚¨,ãƒ†,ã‚¢,ã‚µ,ã‚­,ãƒ¦,ãƒ¡,ãƒŸ,ã‚·,ãƒ±,ãƒ’,ãƒ¢,
                                   ã‚»,ã‚¹,ãƒ³]
%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% setupinfos è®¾ç½®è¯•å·æŠ¬å¤´ä¿¡æ¯å’Œæ ¼å¼
%D \section{ç¹ªè£½å·é ­}
%D
%D ä¸‹é¢çš„å‘½ä»¤ç°¡å–®åœ°å±•ç¤ºäº†å¦‚ä½•å®šç¾©ã€è¨­å®šä¸¦ç¹ªè£½ä¸€å€‹æ–°å·é ­ã€‚
%D \startitemize[nowhite,packed,joinedup]
%D \item é€šé \type{\definepapertitle[PaperTitleName]} å‘½ä»¤å¯ä»¥æ–°å»ºå·é ­ä¿¡æ¯ï¼Œ
%D \item é€šé  \type{\setuppapertitle[PaperTitleName]} å‘½ä»¤å¯ä»¥è¨­å®šå·é ­ä¿¡æ¯ï¼Œ
%D \item é€šé   \type{\makepapertitle[PaperTitleName]} å‘½ä»¤å¯ä»¥ç¹ªè£½å·é ­çµæœã€‚
%D \stopitemize
%D
%D \startbuffer
%D  \definepapertitle[papertitles]
%D  % ç¬¬ä¸€å€‹åƒæ•¸æ˜¯è©¦å·åç¨±ï¼Œä¸‹åŒã€‚
%D  % ç¬¬äºŒå€‹åƒæ•¸æ˜¯çˆ¶ç´šè©¦å·åç¨±ï¼Œå¯ä»¥è¨­ç½®çˆ¶ç´šé€²è¡Œç¹¼æ‰¿ã€‚
%D  % ç¬¬ä¸‰å€‹åƒæ•¸å¯ä»¥ç›´æ¥è¨­å®šç›¸é—œæ¨£å¼å’Œå…§å®¹ã€‚ä¸‹åŒã€‚
%D  % é€šé list åƒæ•¸å¯ä»¥è¨­ç½®é †åº
%D  % é è¨­é †åºç‚º secret,title,subject,information,notice
%D \setuppapertitle [papertitles][
%D     list={secret,title,subject,information,notice},subjectsuffix=å­¦ç§‘è¯•å·,
%D     secretstyle=\ss,
%D     titlestyle=\ssa,
%D     subjectstyle=\ssb,
%D     informationstyle=\ttx,
%D     noticestyle=\rm\it,
%D     secretalign=flushleft,
%D     titlealign=center,
%D     subjectalign=center,
%D     informationalign=center,
%D     noticealign=flushleft,
%D     secret={ç»å¯† â˜… å¯ç”¨å‰},
%D     title={2021 å¹´æ™®é€šé«˜ç­‰å­¦æ ¡æ‹›ç”Ÿå…¨å›½ç»Ÿä¸€è€ƒè¯•},
%D     subject={æ—¥è¯­},
%D     information={æ€»åˆ†:150 åˆ†ï¼Œè€ƒè¯•æ—¶é—´:120 åˆ†é’Ÿ},
%D     notice={æ³¨æ„äº‹é¡¹ï¼š
%D       \startitemize[n,packed,joinedup]
%D         \item ç­”é¢˜å‰ï¼ŒåŠ¡å¿…å°†è‡ªå·±çš„å§“åã€å‡†è€ƒè¯å·å¡«å†™åœ¨%
%D               ç­”é¢˜å¡è§„å®šçš„ä½ç½®ä¸Šã€‚%
%D         \item ç­”é€‰æ‹©é¢˜æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ 2B é“…ç¬”å°†ç­”é¢˜å¡ä¸Šå¯¹%
%D               åº”é¢˜ç›®çš„ç­”æ¡ˆæ ‡å·æ¶‚é»‘ã€‚å¦‚éœ€æ”¹åŠ¨ï¼Œç”¨æ©¡çš®æ“¦%
%D               æ“¦å¹²å‡€åï¼Œå†é€‰æ¶‚å…¶å®ƒç­”æ¡ˆæ ‡å·ã€‚ç­”éé€‰æ‹©é¢˜%
%D               æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ 0.5 æ¯«ç±³é»‘è‰²ç­¾å­—ç¬”ï¼Œå°†ç­”æ¡ˆ%
%D               ä¹¦å†™åœ¨ç­”é¢˜å¡è§„å®šçš„ä½ç½®ä¸Šã€‚æ‰€æœ‰é¡Œç›®å¿…é¡»åœ¨ç­”%
%D               é¢˜å¡ä¸Šä½œç­”ï¼Œåœ¨è¯•é¢˜å·ä¸Šç­”é¢˜æ— æ•ˆã€‚ %
%D         \item è€ƒè¯•ç»“æŸåï¼Œå°†è¯•é¢˜å·å’Œç­”é¢˜å¡ä¸€å¹¶äº¤å›ã€‚
%D         \stopitemize},
%D     ]
%D  \makepapertitle [papertitles]% å¯ä»¥æ¥å—ç¬¬äºŒåƒæ•¸ç›´æ¥è¨­ç½®
%D \stopbuffer
%D \typebuffer

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ego=section isea=subsection
\setuplabeltext [cn] [section={ç¬¬,éƒ¨åˆ†},subsection={ç¬¬,èŠ‚},]

\definehead [tu]   [chapter]
\definehead [ego]  [section]       % me  latin
\definehead [isea] [subsection]    % he or she latin
\definehead [heu]  [subsubsection] % och
\setuphead  [tu]   [placehead=empty]
\setuphead  [ego]  [sectionsegments=section,style=\ssa]
\setupheads [isea] [style=\hwa]
\setupheads [tu,ego,isea]
                   [indentnext=yes,align=flushleft,
                   before={\blank[quarterline]},
                   after={\blank[quarterline]},
                   sectionconversionset=examnum]
\definelist[tu]
\setuplist [tu][style={\feature[+][tabularnumbers]}]
\definestructureconversionset[examnum][chinesenumerals][chinesenumerals]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\installnamespace          {papertitle}
\installcommandhandler \????papertitle  {papertitle}  \????papertitle

\definemarking[title]
\definemarking[subject]

\setuppapertitle [list={secret,title,subject,information,signinformation,notice},subjectsuffix=å­¦ç§‘è¯•å·]
\setuppapertitle [
    secretstyle=\ss,
    titlestyle=\ssa,
    subjectstyle=\ssb,
    informationstyle=\ttx,
    noticestyle=\rm\it,
    secretalign=flushleft,
    titlealign=center,
    subjectalign=center,
    informationalign=center,
    noticealign=flushleft,
    secret={ç»å¯† â˜… å¯ç”¨å‰},
    title={2024å¹´æ™®é€šé«˜ç­‰å­¦æ ¡æ‹›ç”Ÿå…¨å›½ç»Ÿä¸€è€ƒè¯•},
    subject={è‹±è¯­å­¦ç§‘},
    signinformation={{å§“å:     }{\blackrule[width=4em,height=.2pt]}
                     {å‡†è€ƒè¯å·: }{\blackrule[width=4em,height=.2pt]}},
    information={å…¨å·å…±12é¡µï¼Œæ»¡åˆ†150åˆ†ï¼Œè€ƒè¯•æ—¶é—´120åˆ†é’Ÿã€‚},
    notice={è€ƒç”Ÿæ³¨æ„ï¼š
            \startitemize[n,packed,joinedup]
            \item ç­”é¢˜å‰ï¼Œè¯·åŠ¡å¿…å°†è‡ªå·±çš„å§“åã€å‡†è€ƒè¯å·ç”¨é»‘è‰²å­—è¿¹çš„ç­¾å­—ç¬”
                  æˆ–é’¢ç¬”åˆ†åˆ«å¡«å†™åœ¨è¯•é¢˜å·å’Œç­”é¢˜çº¸è§„å®šçš„ä½ç½®ä¸Šã€‚ %
            \item ç­”é¢˜æ—¶ï¼Œè¯·æŒ‰ç…§ç­”é¢˜çº¸ä¸Šâ€œæ³¨æ„äº‹é¡¹â€çš„è¦æ±‚ï¼Œåœ¨ç­”é¢˜çº¸ç›¸åº”çš„
                  ä½ç½®ä¸Šè§„èŒƒä½œç­”ï¼Œåœ¨æœ¬è¯•é¢˜å·ä¸Šçš„ä½œç­”ä¸€å¾‹æ— æ•ˆã€‚ %
            \stopitemize},
]

\def\doifemptyelsex#1#2{\doifelse{#1}{}{#2}{#1}}
\def\definepapertitlevariable#1{\begingroup% #1=element name
    \parindent0pt\relax\par%
    \doifelse{\namedpapertitleparameter{\currentpapertitle}{#1align}}{}%
             {\setupalign[center]}%
             {\setupalign[\namedpapertitleparameter{\currentpapertitle}{#1align}]}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{before#1}}{}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1style}}{}%
    \expandafter\begincsname\namedpapertitleparameter{\currentpapertitle}{#1color}\endcsname
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1}}%
                   {\writestatus{module exam}{warning: #1 is empty ! please input #1.
                        or maybe you have some value is undefined}}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{after#1}}{}%
    \par\endgroup}

\tolerant\def\makepapertitle[#1][#2]%
  {\begingroup\edef\currentpapertitle{#1}%
   \ifarguments\or\or\setuppapertitle[#1][#2]\fi
   \edef\currentlist{\namedpapertitleparameter\currentpapertitle\c!list}
   \edef\currenttitle{\namedpapertitleparameter\currentpapertitle\c!title}
   \expandafter\expandafter\expandafter\tu\expandafter{\currenttitle}
   \processcommacommand[\currentlist]\definepapertitlevariable
   \marking[subject]{\namedpapertitleparameter\currentpapertitle{subject}
                     \namedpapertitleparameter\currentpapertitle{subjectsuffix}}
   \marking[title]{\namedpapertitleparameter\currentpapertitle\c!title}
  \endgroup}

%% #1 = newpapertitle #2 =  parent newpapertitle #3 = setup elements of newpapertitle
\definepapertitle[newpaper]
%% #1 = newpapertitle #2 = setup elements of newpapertitle
\setuppapertitle[newpaper][
             secretstyle=\ss,
              titlestyle=\ssa,
            subjectstyle=\ssb,
        informationstyle=\ttx,
             noticestyle=\rm\it,
             secretalign=flushleft,
              titlealign=center,
            subjectalign=center,
        informationalign=center,
             noticealign=flushleft,
                  secret={ç»å¯† â˜… å¯ç”¨å‰},
                   title={\currentdate[year] å¹´æ™®é€šé«˜ç­‰å­¦æ ¡æ‹›ç”Ÿå…¨å›½ç»Ÿä¸€è€ƒè¯•},
                 subject={SubJect},
             information={æ€»åˆ†:150 åˆ†ï¼Œè€ƒè¯•æ—¶é—´:120 åˆ†é’Ÿ},
                  notice={æ³¨æ„äº‹é¡¹ï¼š
                          \startitemize[n,packed,joinedup]
                            \item ç­”é¢˜å‰ï¼ŒåŠ¡å¿…å°†è‡ªå·±çš„å§“åã€å‡†è€ƒè¯å·å¡«å†™åœ¨%
                                  ç­”é¢˜å¡è§„å®šçš„ä½ç½®ä¸Šã€‚%
                            \item ç­”é€‰æ‹©é¡Œæ—¶ï¼Œå¿…é¡»ä½¿ç”¨ 2B é“…ç¬”å°†ç­”é¢˜å¡ä¸Šå¯¹%
                                  åº”é¢˜ç›®çš„ç­”æ¡ˆæ ‡å·æ¶‚é»‘ã€‚å¦‚éœ€æ”¹åŠ¨ï¼Œç”¨æ©¡çš®æ“¦%
                                  æ“¦å¹²å‡€åï¼Œå†é€‰æ¶‚å…¶å®ƒç­”æ¡ˆæ ‡å·ã€‚ç­”éé€‰æ‹©é¢˜%
                                  æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ 0.5 æ¯«ç±³é»‘è‰²ç­¾å­—ç¬”ï¼Œå°†ç­”æ¡ˆ%
                                  ä¹¦å†™åœ¨ç­”é¢˜å¡è§„å®šçš„ä½ç½®ä¸Šã€‚æ‰€æœ‰é¡Œç›®å¿…é¡»åœ¨ç­”%
                                  é¢˜å¡ä¸Šä½œç­”ï¼Œåœ¨è¯•é¢˜å·ä¸Šç­”é¢˜æ— æ•ˆã€‚ %
                            \item è€ƒè¯•ç»“æŸåï¼Œå°†è¯•é¢˜å·å’Œç­”é¢˜å¡ä¸€å¹¶äº¤å›ã€‚
                            \stopitemize},
]
%% #1 = newpapertitle #2 = setup elements of newpapertitle
%% \makepapertitle[newpaper][title=OOOOOOO]
%% quickly get elements at header and footer:
%% \getmarking[title][page][first] :: \getmarking[title][current]

\setuplabeltext[cn]  [totalpage={å…±,é¡µ}]
\setuplabeltext[hans][totalpage={å…±,é¡µ}] % work with memos
\setuplabeltext[hant][totalpage={å…±,é }] % work with memos
\setuplabeltext[ja]  [totalpage={å…±,ãƒšãƒ¼ã‚¸}]

\ifhdr_default
  \definedelimitedtext    [paren]   [location=text]
  \setupdelimitedtext     [paren:1] [left={ï¼ˆ\nobreak}, right={\nobreakï¼‰}]
  \setupdelimitedtext     [paren:2] [left={\,[~}, right={~]\,}]
  \setupdelimitedtext     [paren:3] [left={\,\{~}, right={~\}\,}]
  \setupmarking[subject][expansion=yes]
  \setupfooter [state=start]
  \startsetups hdr:infos
  \framed[height=max,align=lohi,frame=off]{%
    \getmarking[subject][page][current]
    \paren{\labeltexts{page}{\pagenumber},\ %
           \labeltexts{totalpage}{\lastpagenumber}}%
    }
  \stopsetups
  \setupfootertexts[\setups{hdr:infos}]
\fi
%D \section{å®šä¹‰å…¶åç¯å¢ƒæ‰€éœ€å‘½ä»¤}

%D å®šä¹‰å…³é”®è¯
\startinterface all
\setinterfaceconstant {showanswer}  {showanswer}
\setinterfaceconstant {showpoint}   {showpoint}
\setinterfaceconstant {answer}      {answer}
\setinterfaceconstant {answerstyle} {answerstyle}
\setinterfaceconstant {answercolor} {answercolor}
\setinterfaceconstant {point}       {point}
\setinterfaceconstant {pointstyle}  {pointstyle}
\setinterfaceconstant {pointcolor}  {pointcolor}
\setinterfaceconstant {label}       {label}
\setinterfaceconstant {labelstyle}  {labelstyle}
\setinterfaceconstant {labelcolor}  {labelcolor}
\stopinterface
%D å®‰è£…å®šä¹‰å‘½åç©ºé—´å’Œç¯å¢ƒåŠ©æ‰‹
\installnamespace          {question}
\installcommandhandler \????question  {question}  \????question
\installnamespace          {problem}
\installcommandhandler \????problem   {problem}   \????problem
\installnamespace          {choice}
\installcommandhandler \????choice    {choice}    \????choice
\installnamespace          {writing}
\installcommandhandler \????writing   {writing}   \????writing
\installnamespace          {subwriting}
\installcommandhandler \????subwriting{subwriting}\????subwriting
\installnamespace          {answer}
\installcommandhandler \????answer    {answer}    \????answer
\installnamespace          {close}
\installcommandhandler \????close     {close}     \????close
\installnamespace          {pitem}
\installcommandhandler \????pitem     {pitem}     \????pitem
\installnamespace          {citem}
\installcommandhandler \????citem     {citem}     \????citem
\installnamespace          {ocitem}
\installcommandhandler \????ocitem    {ocitem}    \????ocitem
\installnamespace          {fillin}
\installcommandhandler \????fillin    {fillin}    \????fillin
%%%%%%%%%%%%%%%%%%%%%%%%%
\installnamespace          {material}
\installcommandhandler \????material  {material}  \????material
\installcounterassociation {material}
\appendtoks
   \registermaterialcounter\currentmaterial
   \definecounter[\currentmaterial]%
\to \everydefinematerial
\appendtoks
   \synchronizematerialcounters
\to \everysetupmaterial
\definematerial [material]
\definematerial [number]
\definematerial [indicator]
\definematerial [indicator_helper]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifmode_quickcheck  \mode_quickcheckfalse
\newif\ifmode_check       \mode_checkfalse
\newif\ifmode_showanswer  \mode_showanswerfalse
\newif\ifmode_showpoint   \mode_showpointfalse
\newif\ifmode_showscript  \mode_showscriptfalse
\newif\ifmode_example     \mode_examplefalse
\newif\ifenv_question     \env_questionfalse
\newif\ifenv_problem      \env_problemfalse
\newif\ifenv_choice       \env_choicefalse
\newif\ifenv_material     \env_materialfalse
\newif\ifenv_close        \env_closefalse
\newif\ifenv_writing      \env_writingfalse
\newif\ifenv_subwriting   \env_subwritingfalse
\newif\ifenv_answer       \env_answerfalse
\newif\ifenv_toplevel     \env_topleveltrue
\newif\ifenv_botlevel     \env_botlevelfalse
\newif\ifitem_pitem       \item_pitemfalse
\newif\ifitem_fillin      \item_fillinfalse
\newif\ifchoice_check     \choice_checkfalse
\newif\ifcontinue_counter \continue_counterfalse
\newif\ifclose_counter_reset\close_counter_resetfalse

\newdimen\width_cit
\newdimen\width_cit_max
\newdimen\choice_max_compared_width%
\newdimen\width_max_with_label
\newdimen\label_width
\newcount\totalchoicenumber%
\newcount\currentchoicenumber%
\newcount\totalpitemnumber%
\newcount\currentpitemnumber%
\newcount\cnt_step_point% for point calculate
\newcount\cnt_step_point_temp%
\newcount\current_total_choice_number% ç•¶å‰é¸é … ABCD ç¸½è¨ˆæ•¸
\newcount\current_available_columns%å¯æ’ç‰ˆçš„æœ€å¤šåˆ—æ•¸
\newcount\cnt_closetest
\newcount\cnt_closetest_tempa
\newcount\tempa\newcount\tempb
\newcount\cnt_example_question

\definecounter[Unicode][way=bychapter]
\definecounter[Unicode_toplevel]        % for level 1 : question or problem
\definecounter[Unicode_midlevel]        % for level 2 : problem or level 1
\definecounter[Unicode_botlevel]        % for level 3 : only for level 2
\definecounter[strc_close_counter]      % ä¸º close ç¯å¢ƒå¯ä»¥ç»§ç»­ question åºå·è€Œè®¾ç½®
\def\save_question_order{\setcounter[strc_close_counter][\currentitemnumber]\savecounter[strc_close_counter]}
\def\restore_question_order{\restorecounter[strc_close_counter]\scratchcounter\rawcountervalue[strc_close_counter]}
\def\EQuestionID{E-\somenamedheadnumber{chapter}{current}-\number\cnt_example_question}
\def\QuestionID{\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}
\def\HelperID{\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]}
\def\increaseEQuestionID{\advance\cnt_example_question by  1\relax}
\def\decreaseEQuestionID{\advance\cnt_example_question by -1\relax}
\def\increaseQuestionID{\ifmode_example\increaseEQuestionID\else\incrementcounter[Unicode]\fi}
\def\decreaseQuestionID{\ifmode_example\decreaseEQuestionID\else\decrementcounter[Unicode]\fi}

\definedataset[Answer_collector]
\definedataset[Answer_collectorhelper]
\definedataset[Choice_collector]
\definedataset[Subwriting_collector]

\definetextbackground[env_answer]
\defineitemgroup     [env_question] %
\setupitemgroup      [env_question] [each] [n,packed,joinedup,nowhite,continue]
\defineitemgroup     [env_choice]   %
\setupitemgroup      [env_choice]   [each] [A,packed,joinedup,nowhite]
\definebar           [fillin_text]
\defineoverlay       [normalframeOL]
                    [\useMPgraphic{normalframeMP}]
\startuseMPgraphic{normalframeMP}
  draw unitsquare xyscaled (\overlaywidth, \overlayheight);
\stopuseMPgraphic
\startuseMPgraphic{rules:under:wave}
    vardef lsin primary x =
        lua("mp.print(math.sin(" & decimal x & "))")
    enddef ;
    draw function(1, "x", "lsin(1.2*x)", 0, RuleWidth, .1pt)
         shifted (0,RuleFactor*RuleOffset+RuleDepth)
         withpen pencircle scaled RuleThickness
         withcolor RuleColor ;
    setbounds currentpicture to unitsquare xysized(RuleWidth,RuleHeight) ;
\stopuseMPgraphic
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{è®¾å®šä¸€äº›å¯èƒ½ç”¨å¾—åˆ°çš„ç¬¦å·}
%D éœ€è¦æ³¨æ„ï¼Œè¿™äº›ç¬¦å·éœ€è¦é¢„å…ˆå®‰è£…å­—ä½“ NotoSansSymbols2ã€‚
%D
%D \starttabulate[|l|r|l|r|]
%D \NC \type{\symbol{marksquare}}           \NC \symbol{marksquare}
%D \VL \type{\symbol{markcircle}}           \NC \symbol{markcircle}          \NC\NR\HL
%D \NC \type{\symbol{markcheck}}            \NC \symbol{markcheck}
%D \VL \type{\symbol{markcross}}            \NC \symbol{markcross}           \NC\NR
%D \NC \type{\symbol{markheavycheck}}       \NC \symbol{markheavycheck}
%D \VL \type{\symbol{markheavycross}}       \NC \symbol{markheavycross}      \NC\NR
%D \NC \type{\symbol{marksquarecheck}}      \NC \symbol{marksquarecheck}
%D \VL \type{\symbol{marksquarecross}}      \NC \symbol{marksquarecross}     \NC\NR
%D \NC \type{\symbol{marksquareheavycheck}} \NC \symbol{marksquareheavycheck}
%D \VL \type{\symbol{marksquareheavycross}} \NC \symbol{marksquareheavycross}\NC\NR
%D \NC \type{\symbol{markcirclecheck}}      \NC \symbol{markcirclecheck}
%D \VL \type{\symbol{markcirclecross}}      \NC \symbol{markcirclecross}     \NC\NR
%D \NC \type{\symbol{markcircleheavycheck}} \NC \symbol{markcircleheavycheck}
%D \VL \type{\symbol{markcircleheavycross}} \NC \symbol{markcircleheavycross}\NC\NR
%D \NC \type{\symbol{marknotcheck}}         \NC \symbol{marknotcheck}
%D \VL                                      \NC                              \NC\NR
%D \stoptabulate
\doifelsefontpresent{NotoSansSymbols2-Regular}{}{
  \writestatus{Warning}{Symbol Font is not Found,Please install NotoSansSymbols2 font.}
}
\definefontsynonym[NotoSansSymbols2][file:NotoSansSymbols2-Regular]
\def\notosymb#1{\getglyphstyled{NotoSansSymbols2}{\tochar{n:#1}}}

\definesymbol[marksquare]          [\notosymb{â˜}]
\definesymbol[markcircle]          [\notosymb{â—‹}]
\definesymbol[marknotcheck]        [\notosymb{â»}]
\definesymbol[markcheck]           [\notosymb{ğŸ—¸}]
\definesymbol[markheavycheck]      [\notosymb{âœ“}]
\definesymbol[marksquarecheck]     [\notosymb{\rlap{â˜}\,\raise.2em\hbox{ğŸ—¸}}]
\definesymbol[marksquareheavycheck][\notosymb{\rlap{â˜}\,\raise.2em\hbox{âœ“}}]
\definesymbol[markcirclecheck]     [\notosymb{\rlap{â—‹}\,\raise.2em\hbox{ğŸ—¸}}]
\definesymbol[markcircleheavycheck][\notosymb{\rlap{â—‹}\,\raise.2em\hbox{âœ“}}]
\definesymbol[markcross]           [\notosymb{âœ—}]
\definesymbol[markheavycross]      [\notosymb{âœ˜}]
\definesymbol[marksquarecross]     [\notosymb{\rlap{â˜}\,\raise.1em\hbox{âœ—}}]
\definesymbol[marksquareheavycross][\notosymb{\rlap{â˜}\,\raise.1em\hbox{âœ˜}}]
\definesymbol[markcirclecross]     [\notosymb{\rlap{â—‹}\,\raise.1em\hbox{âœ—}}]
\definesymbol[markcircleheavycross][\notosymb{\rlap{â—‹}\,\raise.1em\hbox{âœ˜}}]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\choice_availablecolumns{ \unskip\datasetvariable{Choice_collector}{\QuestionID}{availablecolumns}}
\def\choice_itemmaxwidth{     \unskip\datasetvariable{Choice_collector}{\QuestionID}{itemmaxwidth}}
\def\choice_totalchoicenumber{\unskip\datasetvariable{Choice_collector}{\QuestionID}{totalchoicenumber}}
\def\choice_answer{           \unskip\datasetvariable{Choice_collector}{\QuestionID}{answer}}
\def\choice_answerstatus{     \unskip\datasetvariable{Choice_collector}{\QuestionID}{answerstatus}}
\def\item_totalnumber{        \unskip\datasetvariable{Answer_collectorhelper}{\HelperID}{totalpitemnumber}}
\def\item_totalpoint{         \unskip\datasetvariable{Answer_collectorhelper}{\HelperID}{totalpoint}}
\def\answer_id{               \unskip\datasetvariable{Answer_collector}{\QuestionID}{id}}
\def\answer_envid{            \unskip\datasetvariable{Answer_collector}{\QuestionID}{envid}}
\def\answer_order{            \unskip\datasetvariable{Answer_collector}{\QuestionID}{order}}
\def\answer_userorder{        \unskip\datasetvariable{Answer_collector}{\QuestionID}{userorder}}
\def\answer_answer{           \unskip\ifmode_example You're in EXAMPLE MODE!\else%
                              \unskip\datasetvariable{Answer_collector}{\QuestionID}{answer}\fi}
\def\answer_point{            \unskip\datasetvariable{Answer_collector}{\QuestionID}{point}}
\def\answer_totalnumber{      \unskip\datasetvariable{Answer_collector}{\QuestionID}{totalnumber}}
\def\point_point{             \unskip\datasetvariable{Answer_collector}{\QuestionID}{point}}
\def\point_totalpoint{        \unskip\datasetvariable{Answer_collector}{\QuestionID}{totalpoint}}
\def\show_check_info{
   \ifmode_quickcheck
     \par\framed[width=\textwidth,align=flushleft]%
    {\answer_id\ ** \answer_answer\ ** \mode_status}\par
  \else%
       \ifmode_check\show_check_infos\else\fi%
   \fi}

\def\show_check_infos{\begingroup\par\leftskip 0pt\relax\noindent%
  \ifdefined\currentorder%
    \let\old_currentorder\currentorder
    \let\old_currentorder\currentuserorder
  \else%
    \def\currentorder{    {\ttx currentorder didn't define}}
    \def\currentuserorder{{\ttx currentorder didn't define}}
  \fi%
  \setupinterlinespace[line=2ex]%
  \framed[align=flushleft]{\language[en]%
    \hfil \ttx {\bf NOTICE: MODE CHECK   IS ON}         \hfil\par\ifmode_example
    \hfil      {\bf NOTICE: MODE EXAMPLE IS ON}         \hfil\par\fi
    \hfil \ttx Notice,{\bf Cinfos} only show choice env information \hfil\par
    \hfil      {\bf CU} means 'current' , if CUuserorder â‰  CUorder, \hfil\par
    \hfil      It maybe because START parameter is enabled.         \hfil\par\ifmode_example
    \hfil     Notice,{\bf MODE EXAMPLE} wont provide data infos    \hfil\par\fi
    \setuptabulate[bodyfont={tt,9pt}]
    \starttabulate[|rp(.2\textwidth)|lp(.25\textwidth)|rp(.2\textwidth)|lp(.25\textwidth)|lwlB|]
      \NC {\bf Name}    \NC {\bf Content}           \NC {\bf Cinfos} \NC {\bf Content}             \NC\NR\HL
      \NC CUitemgroup   \NC \currentitemgroup       \NC CUQuestionID \NC \QuestionID               \NC\NR
      \NC CUparen       \NC \currentparentitemgroup \NC CUCmaxwidth  \NC \choice_itemmaxwidth      \NC\NR
      \NC CUorder       \NC \currentorder           \NC totalCnumber \NC \choice_totalchoicenumber \NC\NR
      \NC CUuserorder   \NC \currentuserorder       \NC Cavailable   \NC \choice_availablecolumns  \NC\NR
      \NC answer        \NC \answer_answer          \NC Canswer      \NC \choice_answer            \NC\NR
      \NC CUpoint       \NC \point_point            \NC              \NC                           \NC\NR\HL
      \NC mode.status   \NC \mode_status            \NC CUHelperID   \NC \HelperID                 \NC\NR
      \NC level.check   \NC \level_status           \NC totalnumber  \NC \item_totalnumber         \NC\NR
      \NC Canswerstatus \NC \choice_answerstatus    \NC totalpoint   \NC \item_totalpoint          \NC\NR
    \stoptabulate}
    \par\endgroup}

\def\dimtonum #1{\number\numexpr \dimexpr #1\relax*635/65536\relax }
\newcount\cnt_floor
\def\floor#1{\floorhelper#1.\relax}
\def\floorhelper#1.#2\relax{\ifx\relax#2\relax#1%
    \else\if.#2#1\else\floorhelphelper{#1}#2\fi\fi}
\def\floorhelphelper#1#2.{\ifnum#2>0%
    \floorhelphelphelper#1\relax\relax\relax\else#1\fi}
\def\floorhelphelphelper#1#2\relax{%
  \if-#1\relax-\cnt_floor=0#2\relax%
  \advance\cnt_floor by 1\relax%
  \number\cnt_floor\relax%
  \else\cnt_floor=0#1#2\relax%
  \number\cnt_floor\relax\fi%
}

\def\initcollectanswer{\directlua{MultiAnswerCollector = {}}}
\def\collectanswer#1{\directlua{table.insert(MultiAnswerCollector, [[#1]])}}
\def\collectedanswer{\directlua{tex.sprint(table.concat(MultiAnswerCollector,","))}}

\newcount\c_envcounter_toggle
\def\example_toggle[#1]% ä¸“ç”¨äºæµ‹è¯•æ˜¯å¦å¼€å¯äº† example mode
    {\doif{\csname #1parameter\endcsname{example}}{true}%
          {\mode_exampletrue\global\c_envcounter_toggle=999\relax}}

\def\set_envitem_counter{%
  \initcollectanswer% åˆå§‹åŒ–å¤šé¡¹ç­”æ¡ˆæ”¶é›†å™¨
  \global\c_envcounter_toggle=1\relax% é»˜èªå°±æ˜¯questionç’°å¢ƒ
  \ifenv_question   \global\c_envcounter_toggle=1\relax\fi
  \ifenv_problem    \global\c_envcounter_toggle=2\relax\fi
  \ifenv_choice     \global\c_envcounter_toggle=3\relax\fi
  \ifenv_material   \global\c_envcounter_toggle=4\relax\fi
  \ifenv_close      \global\c_envcounter_toggle=5\relax\fi
  \ifenv_writing    \global\c_envcounter_toggle=6\relax\fi
  \ifenv_subwriting \global\c_envcounter_toggle=7\relax\fi
  \ifenv_answer     \global\advance\c_envcounter_toggle by 10\relax\fi}

\def\level_status{\ifenv_toplevel <env_toplevel>\else%
                  \ifenv_botlevel <env_botlevel>\else
                                  <env_midlevel>\fi\fi}

\def\mode_status{ \ifmode_check      <M:C>\fi%check
                  \ifmode_showanswer <M:A>\fi%answer
                  \ifmode_showpoint  <M:P>\fi%point
                  \ifmode_example    <M:E>\fi}

%% æ³¨æ„ï¼Œåªè¦æŸä¸ªæ¡ä»¶ä¸å…³é—­ï¼Œä»–å°±ä¼šä¸€ç›´å¼€å¯ã€‚ä¾‹å¦‚ï¼š
% {\env_topleveltrue
%    1. \ifenv_toplevel top \else bot \fi  % top
%    \env_toplevelfalse\env_botleveltrue   % å…³é—­äº† toplevel æ‰èƒ½æ­£ç¡®è¾“å‡º
%    2. \ifenv_toplevel top \else bot \fi  % bot
%    3. \ifenv_botlevel bot \else top \fi} % bot
% ä¸€å®šè¦å…³é—­ï¼Œå› ä¸ºé»˜è®¤å¹¶æ²¡æœ‰è®¾ç½® top å’Œ bot çš„äºŒå…ƒå…³ç³»ã€‚
% æ‰€ä»¥å³ä¾¿æ˜¯ä¸“é—¨æµ‹è¯• bot æ˜¯å¦å¼€å¯çš„ 3 ï¼Œ
% ä¹Ÿåªä¼šåœ¨å…³é—­ top çš„æƒ…å†µä¸‹è·å–æ­£ç¡®çš„ç»“æœã€‚

\newcount\parentitemnumber% \parentitemnumber ä¼šç­‰äºçˆ¶çº§åˆ—è¡¨ç¯å¢ƒçš„åºå·
\def\set_currentuserorder[#1]{% set order that user setted
    \ifcsname #1order\endcsname\else%
    \expandafter\newcount\csname #1order\endcsname\fi%
    \ifenv_toplevel\csname #1order\endcsname=\currentitemnumber\relax
    \else          \csname #1order\endcsname=\parentitemnumber \relax
    \fi}%ä¸“ä¸ºå­çº§è®¾è®¡æ¥è·å–çˆ¶çº§åºå·ï¼Œå¦åˆ™ç›´æ¥è·å–å½“å‰åºå·

\def\current_user_order#1{% get user order which can by changed by START
    \number\csname #1order\endcsname% ç²å¾—çš„çµæœé¡ä¼¼æ–¼ 2(4)
    \ifnum\rawcountervalue[Unicode_botlevel]=0\relax\else%
    (\rawcountervalue[Unicode_botlevel])\fi}

\tolerant\def\set_count_envlevel[#1]#*[#2]{% #1 å°æ¯”é ‚ç´šç’°å¢ƒé … , #2 å®šç¾© #2order
% é€šéå°æ¯” #1 å’Œç•¶å‰ç’°å¢ƒåˆ¤å®šæ˜¯å¦ä½æ–¼é ‚ç´šç’°å¢ƒ
% #2 ç”¨æ–¼å®šç¾©ç•¶å‰ç’°å¢ƒçš„ order
  \setcounter[Unicode_midlevel][0]%
  \setcounter[Unicode_botlevel][0]%
  \doifincsnameelse{#1}{\currentitemgroup}%
                  {\env_topleveltrue{}}% å¦‚æœ #1 ç­‰äºå½“å‰ç¯å¢ƒè®¾ä¸ºé¡¶çº§
                  {\env_toplevelfalse{}}%
  \ifenv_toplevel\incrementcounter[Unicode_toplevel]%
            \else\incrementcounter[Unicode_midlevel]\fi%
  \parentitemnumber=\currentitemnumber\relax
  \set_currentuserorder[#2]% åˆ›å»º #2order ä»¥å¤‡ä½¿ç”¨
  \edef\currentid{\QuestionID}%
  \edef\currentorder{% get unique order ( no chapter number )
    \somenamedheadnumber{chapter}{current}-%
    \rawcountervalue[Unicode_toplevel]-%
    \rawcountervalue[Unicode_midlevel]-%
    \rawcountervalue[Unicode_botlevel]}%
  \edef\currentuserorder{\current_user_order{#2}}%è·å– ä¸Šé¢å®šä¹‰çš„ #2order
  \show_check_info%
}

\tolerant\def\set_count_itemlevel[#1]#*[#2]{%
  \env_toplevelfalse%
  \doifincsnameelse{#1}{\currentitemgroup}%
                    {\env_botleveltrue{}}%
                    {\env_botlevelfalse{}}%
  \ifenv_botlevel\incrementcounter[Unicode_botlevel]%
            \else\incrementcounter[Unicode_midlevel]\fi%
  \set_currentuserorder[#2]%
  \ifenv_subwriting\env_botleveltrue\else\fi%
  \edef\currentid{\QuestionID}%
  \edef\currentorder{% get unique order ( no chapter number )
    \somenamedheadnumber{chapter}{current}-%
    \rawcountervalue[Unicode_toplevel]-%
    \rawcountervalue[Unicode_midlevel]-%
    \rawcountervalue[Unicode_botlevel]}%
  \edef\currentuserorder{\current_user_order{#2}}%
  \show_check_info%
}

%%% id        ç”± ç« ç¯€è™Ÿ + é¡Œè™Ÿ çµ„æˆï¼Œé¡Œè™Ÿåœ¨æ¯ä¸€ç« ç¯€ä¸­é‡æ–°å¾ 1 è¨ˆæ•¸
%%% envid     ç•¶å‰åˆ—è¡¨åç¨±å’Œå±¤æ•¸
%%% order     ç•¶å‰å­é¡Œè™Ÿï¼Œä¾‹å¦‚ ç¬¬ä¸€é¡Œ ï¼š 1 ç¬¬å…­é¡Œç¬¬ä¸‰å°é¡Œ ï¼š 6(3)
%%% userorder ç•¶å‰åˆ—è¡¨åºè™Ÿ(å¯ç²å–è¢«startæ›´æ”¹å¾Œçš„åºè™Ÿ)

\def\installdatacollector{%
    \setdataset [Answer_collector][\QuestionID]%æ”¶é›†ç­”æ¡ˆä¸¦åœ¨æœªä¾†å±•é–‹
                [id={\QuestionID},%
                 envid={\currentitemgroup},%
                 order={\number\currentorder},%
                 userorder={\currentuserorder},%
                 answer={\pass_parameter_answer},%
                 point={\currentpoint},
                 totalpoint={\item_totalpoint},]}

\def\installdatacollectorhelper{%
  \setdataset [Answer_collectorhelper][\HelperID]%æ”¶é›†ä¿¡æ¯ä¸¦åœ¨æœªä¾†å±•é–‹
              [totalpitemnumber={\the\totalpitemnumber},
               totalpoint={\currenttotalpoint},]%
}

% ç¯å¢ƒå±‚çº§ä¸€è§ˆ
% question ç¯å¢ƒ                 % close ç¯å¢ƒ                      % material ç¯å¢ƒ
%    choice ç¯å¢ƒ                %       closechoice é¡¹ç›®    â­•    % question ç¯å¢ƒ
%       citem é¡¹ç›®        â­•    % optclose ç¯å¢ƒ                   %    choice ç¯å¢ƒ
%    problem ç¯å¢ƒ               %       ocitem é¡¹ç›®         â­•    %       citem é¡¹ç›®    â­•
%       pitem é¡¹ç›®        â­•    %       specialocitem é¡¹ç›®  â­•
%         fillin é¡¹ç›®     â­•
% ======================================================================================
% writing ç¯å¢ƒ            â­•
%     subwriting ç¯å¢ƒ
%

% è·å–å½“å‰ç¯å¢ƒçš„ç­”æ¡ˆï¼Œå¹¶ä¼ é€’ç»™æœ€ç»ˆçš„ answer dataset
% ä½†æ˜¯ï¼Œæ¡ä»¶åˆ¤æ–­çš„å¥—åµŒè¿˜éœ€è¦ä¼˜åŒ–ã€‚å½“å‰(20241029)çš„ä¿®æ”¹åä¼¼ä¹å¢åŠ äº† 0.2~0.4 ç§’çš„ç”Ÿæˆæ—¶é—´
\def\pass_parameter_answer{%
  \ifenv_writing\get_writing_answer%
  \else\check_answer\currentanswer\fi}

\def\check_answer#1{\removeunwantedspaces%
  \doifsomethingelse{#1}{#1}%
  {{\ttxx no \color[red]{answer} value here,please check.}}%
}

%%%%% NOTICE : ç›®å‰ï¼Œç•¶ç”¨æˆ¶ä¸»å‹•è¼¸å…¥å€¼å’Œé¸é …å€¼ç™¼ç”Ÿè¡çªæ™‚ï¼Œä¸¦æœªè¨­ç½®è­¦å‘Šä¿¡æ¯!!!!
\def\getanswerforanswer{% used for answer env to auto get answer
  \ifenv_writing% å› ä¸ºå†™ä½œç¯å¢ƒçš„ç­”æ¡ˆä¸€èˆ¬æ¯”è¾ƒé•¿ï¼Œåœ¨è·å–ç­”æ¡ˆæ—¶ï¼Œanswer ç¯å¢ƒä¼šè·å–æ˜¾ç¤ºçš„å¾ˆé•¿ã€‚
    \ifx\current_writing_answer\empty%åˆ¤æ–­ç¯å¢ƒï¼Œå¹¶ç¡®è®¤ writing ç¯å¢ƒæ˜¯å¦å·²ç»è®¾ç½® answer é”®å€¼
      \datasetvariable{Answer_collector}{\QuestionID}{answer}%è‹¥æ˜¯ï¼Œç›´æ¥è·å– writing ç¯å¢ƒçš„
    \else \current_writing_answer\fi%answer é”®å€¼ï¼Œè‹¥å¦ï¼Œåˆ™æŒ‰ç…§ QID è·å–ç­”æ¡ˆã€‚
  \else \datasetvariable{Answer_collector}{\QuestionID}{answer}\fi}
\def\getpointforanswer{% used for answer env to auto get point
  \datasetvariable{Answer_collector}{\QuestionID}{point}}

\def\check_choice_answerstatus{
    \ifchoice_check checked!%
    \else%
      \color[red]{unchecked!}\\
      please set the answer manually
      by add \[*\] parameter to {\tt citem} command.\\
  \fi}

\def\paren#1{(#1)}

\def\install_point[#1]{%
  \ifx\currentmode\c!point%
    \ifenv_subwriting%
      \edef\currentpoint{\namedwritingparameter{subwriting}\c!point}%
    \else%
      \edef\currentpoint{\csname #1parameter\endcsname\c!point}%
    \fi%
    \ifempty\currentpoint% æŠ“å–ç•¶å‰åˆ†æ•¸å€¼
      \scratchcounter\zerocount%
    \else%
      \scratchcounter\currentpoint%
    \fi%
    \ifenv_toplevel% é‡ç½®åˆ†æ•¸è¨ˆç®—
      \cnt_step_point\scratchcounter\relax
      \cnt_step_point_temp\scratchcounter\relax
    \fi%
    \global\cnt_step_point_temp\scratchcounter\relax
    \ifnum\cnt_step_point=\scratchcounter\relax
      \global\cnt_step_point=\cnt_step_point_temp\relax
    \else%
      \global\cnt_step_point=\numexpr\cnt_step_point+\cnt_step_point_temp\relax
    \fi% éæ­¸å‡ºç¸½åˆ†æ•¸
    \ifenv_toplevel%
      \gdef\currenttotalpoint{\currentpoint}%
    \else%
      \gdef\currenttotalpoint{\the\cnt_step_point}%
    \fi%
  \fi}

\def\install_answer[#1]{%
  \ifx\currentmode\c!answer
    \ifdefined\currentanswer\edef\prevanswer{\currentanswer}\fi%
    \edef\current_answer{\csname #1parameter\endcsname\c!answer}%æš«æ™‚å®šç¾©
    \ifenv_subwriting%
      \edef\current_answer{\namedwritingparameter{subwriting}\c!answer}%æš«æ™‚å®šç¾©
    \fi%
    \ifempty\current_answer%
      \edef\currentanswer{\prevanswer}%
    \else%
      \edef\currentanswer{\csname #1parameter\endcsname\c!answer}%
    \fi%
  \fi}

\tolerant\def\installpointoranswer[#1]#*[#2]{%#1 parameter %#2 modename
%   éœ€è¦æ›´å¥½çš„é€»è¾‘è¿›è¡Œè®¾è®¡ç­”æ¡ˆç©ºå€¼çš„æƒ…å†µ
  \edef\currentmode{#2}% check point or answer
  \processaction[\csname     #1parameter\endcsname{show#2}][%
           true=>\csname mode_show#2true\endcsname,
          false=>\csname mode_show#2false\endcsname,]%
  \install_point[#1]\install_answer[#1]\begingroup%%
  \csname ifmode_show#2\endcsname%
    \csname #1parameter\endcsname{#2style}%
    \switchtocolor[\csname #1parameter\endcsname{#2color}]%
    \paren {\csname #1parameter\endcsname{#2prelabel}% like=>answer : blabla
      \ifx\currentmode\c!point% if #2 = point
        \ifenv_toplevel\point_totalpoint%
        \else\currentpoint\fi%
      \else% if #2 = answerã€‚å› ä¸º currentXXXanswer æ˜¯æœ‰å®šä¹‰å†…å®¹çš„ï¼Œ
        \ifempty\current_answer\answer_answer% ç›´æ¥ç²å–ç•¶å‰ QID ç­”æ¡ˆ
        \else\currentanswer\fi% å¦‚æœéç©ºï¼Œå–è¨­ç½®å¥½çš„ç­”æ¡ˆå€¼
      \fi%
  \csname #1parameter\endcsname{#2label}}\hairspace%
  \fi\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion[tnum][\addff{tabularnumbers}]
\protected\def\installitemgroupoption[#1][#2]{%
    \edef\p_env{[env_#1]}\edef\p_trueenv{#2}%
    \setupcounter[itemgroup:env_\p_env]%
                   [  way=\csname #2parameter\endcsname\c!way]%
    \expandafter\setupitemgroup\p_env
                   [ left=\csname #2parameter\endcsname\c!left,
                    right=\csname #2parameter\endcsname\c!right,
                  stopper=\csname #2parameter\endcsname\c!stopper,
                 distance=\csname #2parameter\endcsname\c!distance,
                   before=\csname #2parameter\endcsname\c!before,
                    after=\csname #2parameter\endcsname\c!after,
                    width=\csname #2parameter\endcsname\c!width,
                    align=\csname #2parameter\endcsname\c!align,
                indenting=\csname #2parameter\endcsname\c!indenting,
                 symalign=\csname #2parameter\endcsname\c!symalign,
                   symbol=\csname #2parameter\endcsname\c!symbol,
                itemalign=\csname #2parameter\endcsname\c!itemalign,
                   option=\csname #2parameter\endcsname\c!option,
                    style=\csname #2parameter\endcsname\c!style,
                    color=\csname #2parameter\endcsname\c!color,
         numberconversion=\csname #2parameter\endcsname\c!numberconversion,
                      ]%
}

%D \section{è®¾ç½® problem ç¯å¢ƒ}
%D \tex{problem} ç’°å¢ƒå‘½ä»¤å¯ä»¥è¨­ç½®å¤šå€‹èšåˆå•é¡Œï¼Œè©²ç’°å¢ƒå…·æœ‰ä¸€å€‹ç‰¹å®šçš„å­å‘½ä»¤ \tex{pitem} ä¾†åˆ—æ˜æ¯å€‹å•é¡Œã€‚
%D å¯ä»¥ç”¨ä¾†è¨­ç½®å¡«ç©ºã€å•ç­”ç­‰é¡Œç›®ã€‚
%D
%D \startbuffer
%D \startproblem
%D \startpitem è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D \startpitem è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D \startpitem è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupproblem  [left={},  %%%%% follow is itemize option
                right={},
                stopper={.~},
                distance=.5em,
                %before=,
                %after=,
                width=.5em,
                %align=,
                indenting=no,
                %symalign=,
                %symbol=,
                %itemalign=,
                option={packed,joinedup,nowhite},
                way=bysection,
                numberconversion=tnum,]

%D problem åªç»§æ‰¿äº†éƒ¨åˆ† itemgroup çš„é”®å€¼ï¼Œå¹¶æ²¡æœ‰æ–°çš„é”®å€¼è®¾å®šã€‚
%D åœ¨å½“å‰(v20241023)ä¸­å·²ç»åˆ å»äº†è®¾ç½®ç­”æ¡ˆå’Œåˆ†å€¼çš„è®¾ç½®ã€‚
%D å› ä¸ºï¼Œproblem ç¯å¢ƒä¸‹ä¸€èˆ¬æœ‰è®¸å¤š pitemï¼Œæ¯ä¸ªé¢˜ç›®éƒ½å¯èƒ½æœ‰è‡ªå·±çš„åˆ†å€¼å’Œç­”æ¡ˆã€‚
%D å› æ­¤ï¼Œå‡ºæ–¼è¨­è¨ˆç›®çš„ï¼Œæ¯å€‹å•é¡Œçš„ç­”æ¡ˆå’Œåˆ†æ•¸ç­‰ç›´æ¥é€šé \tex{pitem} ä¾†è¨­å®šã€‚

%D \startbuffer
%D \startproblem
%D \startpitem[showpoint=true,point=5]         è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D \startpitem[showanswer=true,answer={newer}] è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D \startpitem[]                               è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D ä¸åŒæ–¼ \tex{question} ç’°å¢ƒæ‰€æœ‰çš„åºè™Ÿéƒ½æ˜¯é€£çºŒçš„ï¼Œ\tex{problem} ç’°å¢ƒæ¯æ¬¡é–‹å§‹å¾Œéƒ½æ˜¯é‡æ–°é€²è¡Œè¨ˆæ•¸ã€‚

%D å¦‚æœæƒ³è¦çˆ² \tex{problem} ç’°å¢ƒæ·»åŠ é¡Œå¹¹ï¼Œå¯ä»¥å°‡ \tex{problem} ç’°å¢ƒæ”¾ç½®åœ¨ \tex{question} ç’°å¢ƒä¹‹ä¸­ã€‚
%D \startbuffer
%D \startquestion
%D   è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D å¦‚æœæƒ³è¦è¨­ç½®å¡«ç©ºé¡Œï¼Œå¯ä»¥ä½¿ç”¨ \tex{fillin} å‘½ä»¤ã€‚
%D åŒæ™‚ï¼Œ\tex{getanswerfromfillin}å‘½ä»¤æœƒç²å–è‡¨è¿‘ \tex{fillin} çš„å…§å®¹ï¼Œä¸¦è¼¸å‡ºçˆ²ç­”æ¡ˆã€‚
%D
%D \startbuffer
%D \setupanswer[showanswer=true]
%D \startquestion
%D   è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \setuppitem[showanswer=true]
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \fillin{env_question:1}ã€‚ \stoppitem
%D     \startanswer
%D     	\input knuthmath
%D     \stopanswer
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \fillin[mp=rules:under:wave]{env_question:1}ã€‚ \stoppitem
%D     \startanswer
%D     	\input knuthmath
%D     \stopanswer
%D     \startpitem
%D     	è©²ç’°å¢ƒä½æ–¼ \fillin[empty=number]{env_question:2}ã€‚
%D     \stoppitem
%D     \startanswer
%D     	\input knuthmath
%D     \stopanswer
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \fillin[empty=yes]{env_question:3}ã€‚ \stoppitem
%D     \startanswer
%D     	\input knuthmath
%D     \stopanswer
%D     \startpitem è©²ç’°å¢ƒä½æ–¼ \fillin[empty=yes,left={(},right={)}]{env_question:4}ã€‚ \stoppitem
%D     \startanswer
%D     	\input knuthmath
%D     \stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\tolerant\protected\def\startproblem[#1]{%
  \scratchcounterone\currentitemnumber\relax
% å› ç‚º setcountlevel ç”¨åˆ°äº† scratchcounter,é€™è£¡å°±å¿…é ˆä½¿ç”¨æ–°çš„è¨ˆæ•¸å™¨æŠ“å–å‘½ä»¤
  \begingroup\env_problemtrue\set_envitem_counter%
  \iffirstargument\setupproblem[#1]\fi%
  \installitemgroupoption[question][problem]%
  \edef\p_start{\problemparameter\c!start}%
  \edef\p_conversion{\problemparameter\c!numberconversion}%
  \ifempty\p_start% é¿å… continue å’Œ start å±æ€§å†²çª
       \startitemgroup[env_question]%
                      [\p_conversion,continue,#1]%
                      [#1]%
  \else\startitemgroup[env_question]%
                      [\p_conversion,#1]%
                      [#1]%
  \fi\currentpitemnumber=0\relax%
  \setupproblem[showanswer=false,showpoint=false,]%
  \set_count_envlevel  [env_question:1][problem]%
  \installpointoranswer[problem]       [point]%
  \installpointoranswer[problem]       [answer]%
  \ifenv_toplevel\else%
    \decreaseQuestionID%
    \parentitemnumber=\scratchcounterone\relax% ç›´æ¥è·å– question çš„ ID
  \fi}

\def\stopproblem{%
  \ifnum\totalpitemnumber > \currentpitemnumber%
        \totalpitemnumber = \totalpitemnumber%
  \else \totalpitemnumber = \numexpr\currentpitemnumber-1\relax%
  \fi%éæ­¸å‡ºç¸½åºè™Ÿ
  \installdatacollectorhelper%
  \stopitemgroup%
  \endgroup}

%D \section{è®¾ç½® question ç¯å¢ƒ}

%D \tex{question} ç’°å¢ƒå‘½ä»¤å¯ä»¥ç”¨ä¾†è¨­ç½®é¡Œå¹¹ã€‚
%D åªéœ€å°‡é¡Œå¹¹åŒ…è£¹åœ¨ \tex{startquestion}  \tex{stopquestion} å‘½ä»¤ä¹‹é–“å³å¯ã€‚
%D
%D \startbuffer
%D   \startquestion
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D   \stopquestion
%D   \startquestion
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D   \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D \tex{question} ç’°å¢ƒå‘½ä»¤ç¹¼æ‰¿äº†å¤§éƒ¨åˆ† \tex{itemgroup} ç’°å¢ƒçš„é¸é …è¨­ç½®ã€‚
%D å› æ­¤ï¼Œå¯ä»¥åƒä¿®æ”¹ \tex{itemgroup} ä¸€æ¨£ï¼Œä½¿ç”¨ \tex{setupquestion} ä¾†ä¿®æ”¹è©²ç’°å¢ƒã€‚
%D
%D \bgroup
%D   \startbuffer
%D     \setupquestion[color=green,style=\ss,start=22]
%D     \startquestion
%D       è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \stopquestion
%D   \stopbuffer
%D   \typebuffer
%D   \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D \egroup

%D question ç¯å¢ƒå¯ä»¥è®¾ç½® {\bf ç­”æ¡ˆ} å’Œ {\bf åˆ†å€¼}ã€‚è¯¥é”®å€¼è¯¦ç»†çš„è®¾ç½®å¦‚ä¸‹ï¼š
%D \starttabulate[|l|l|l|l|]
%D \NC showanswer \NC answer \NC answerstyle    \NC answercolor \NC\NR
%D \NC            \NC        \NC answerprelabel \NC answerlabel \NC\NR\HL
%D \NC showpoint  \NC point  \NC pointstyle     \NC pointcolor  \NC\NR
%D \NC            \NC        \NC pointprelabel  \NC pointlabel  \NC\NR
%D \stoptabulate

%D \startbuffer
%D   \startquestion[showpoint=true,point=5,pointlabel={points},
%D                  showanswer=true,answer={new answer},answerstyle={\tt},]
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D   \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D æ­¤å¤–ï¼Œquestion è®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„é”®å€¼ example=trueï¼Œå¯ä»¥æ˜¯å½“å‰é¢˜ç›®ä¸è¢«å½•å…¥ç­”æ¡ˆã€‚
%D åœ¨(v20241023)ä¸­ï¼Œé€šè¿‡ä¸å¤ªæ­£å¸¸çš„æ–¹å¼è®¾ç½®äº† example åçš„é¢˜ç›®å¯ä»¥è‡ªåŠ¨é‡ç½®å›åˆ°åºæ•° 1ã€‚
%D æˆ–è®¸ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæ–°çš„é”®å€¼ï¼Œæ¥è®¾å®š example ä¹‹åçš„é¢˜ç›®æ˜¯é‡ç½®ä¸º 1 è¿˜æ˜¯æ¥ç»­ä¸Šä¸€ä¸ªåºå·ã€‚
%D æ­¤å¤–ï¼Œç”±äº question å†…ç½®äº†ä¸€ä¸ª itemï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ reference æ¥åˆ›å»ºå¼•ç”¨ã€‚

%D {\bf é—œæ–¼ point å’Œ answer çš„è¨­å®š: }
%D point çš„åˆ†å€¼é»˜èªæ˜¯ä¸€æ•´å€‹é¡Œç›®çš„ç¸½åˆ†æ•¸ã€‚å¦‚æœç•¶å‰å­—ç’°å¢ƒç‚º problemï¼Œåªè¦ç‚ºæ¯å€‹ pitem
%D è¨­è¨ˆäº† point çš„åˆ†å€¼ï¼Œè©²æ¨¡å¡Šå°±æœƒè‡ªå‹•è¨ˆç®—ï¼Œä¸¦é€šé \tex{getpointfrompitem}
%D ä¾†ç²å–è¨ˆç®—å¾Œçš„ pointã€‚answer çš„ç²å–ä¹Ÿæ˜¯ä¸€æ¨£ã€‚å¯ä»¥é€šé \tex{getanswerfromchoice} ä¾†
%D ç²å–ç•¶å‰ç’°å¢ƒçš„é¸é …ç­”æ¡ˆã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸¦æ²’æœ‰è¨­è¨ˆ  \tex{getanswerfrompitem}ã€‚åœ¨è¨­è¨ˆæ™‚ï¼Œ
%D pitem é»˜èªæ˜¯æ“æœ‰å¤šå€‹åŒç´šé …ç›®çš„ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œæœƒåœ¨åŒä¸€å€‹ question ç’°å¢ƒä¸­ï¼Œæœ‰å¤šå€‹å­ç­”æ¡ˆã€‚
%D æˆ‘å€‘ç„¡æ³•ç²çŸ¥æ‡‰è©²ä½¿ç”¨å“ªä¸€å€‹ä½œç‚ºç•¶å‰ç’°å¢ƒçš„ç­”æ¡ˆã€‚åŒæ¨£çš„é“ç†ï¼Œæ¯å€‹ question ç’°å¢ƒå…§åªæœ‰ä¸€å€‹
%D choice ç’°å¢ƒï¼Œåªéœ€è¦ç›´æ¥ç‚º question ç’°å¢ƒé…ç½®åˆ†å€¼å³å¯ã€‚choice ç’°å¢ƒä¸¦ä¸èƒ½é…ç½®åˆ†æ•¸ã€‚

\setupquestion [%showpoint=false,
                point=0,
                pointstyle=\ttx,
                %pointcolor=,
                %pointprelabel=,
                pointlabel={åˆ†},
                %showanswer=false,
                %answer=,
                %answerlabel=,
                %answerprelabel=,
                answerstyle=\ss,
                answercolor=red,
                %example=,
                left={},  %%%%% follow is itemize option
                right={},
                stopper={.~},
                distance=0em,
                option={packed,joinedup,nowhite},
                %before=,
                %after=,
                width=1.5em,
                %align=,
                indenting=no,
                %symalign=,
                %symbol=,
                %itemalign=,
                way=bychapter,%wont work if continue on
                numberconversion=tnum,]


\tolerant\protected\def\startquestion[#1]%
 {\begingroup\env_questiontrue\set_envitem_counter%%
  \iffirstargument\setupquestion[#1]\fi%
  \installitemgroupoption[question][question]%
  \example_toggle[question]% ç”¨æ–¼æ¸¬è©¦æ˜¯å¦é–‹å•Ÿ example_mode
  \edef\p_start{\questionparameter\c!start}%
  \edef\p_conversion{\questionparameter\c!numberconversion}%
  \ifempty\p_start% é¿å… continue å’Œ start å±æ€§å†²çª
       \startitemgroup[env_question]%
                      [\p_conversion,continue,#1]%
                      [#1]%
  \else\startitemgroup[env_question]%
                      [\p_conversion,#1]%
                      [#1]%
  \fi\item[\questionparameter\c!reference]%
  \increaseQuestionID% å…·æœ‰ç¨ç«‹ç­”æ¡ˆï¼Œå¢é•· QID
  \set_count_envlevel  [env_question:1][question]%
  \installpointoranswer[question]      [point]%
  \installpointoranswer[question]      [answer]%
  \save_question_order}

\def\stopquestion{%
  \ifnum\c_envcounter_toggle=1\relax
  \installdatacollector%
  \installdatacollectorhelper\fi%
  \stopitemgroup\endgroup%
  \ifnum\c_envcounter_toggle=999\relax%
  \resetcounter [itemgroup:env_question]%
  \fi}

%D \section{è®¾ç½® choice ç¯å¢ƒ}
%D è©²ç’°å¢ƒå‘½ä»¤åªèƒ½ç½®æ–¼ \tex{question} ç’°å¢ƒä¹‹ä¸‹ã€‚è©²ç’°å¢ƒæœ‰ä¸€å€‹å­é …ç›®ï¼š
%D \tex{startcitem}
%D \tex{stopcitem}ã€‚
%D \starttyping
%D  \startcitem {é¸é …å…§å®¹} \stopcitem
%D \stoptyping

%D å¯ä»¥é€šé \type{[*]} ä¾†æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆã€‚å¦‚æœæƒ³è¦è¨­ç½®å¤šé¸é¡Œï¼Œåªéœ€è¦å°æ¯å€‹æ­£ç¢ºç­”æ¡ˆæ·»åŠ  \type{[*]} å³å¯ã€‚
%D \startbuffer
%D \setupquestion[showanswer=true]
%D \startquestion
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \startchoice
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \startchoice
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \startchoice
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D åŒæ™‚ç‚º \tex{startcitem}\tex{stopcitem} å®šç¾©äº†åŒç¾©å‘½ä»¤ \tex{citem} å’Œ \tex{fragilecitem}ã€‚
%D \tex{fragilecitem}å‘½ä»¤å¯ä»¥ä¸é€šéç•Œå®šèŠ±æ‹¬è™Ÿä¾†æ’ç‰ˆé¸é …ï¼Œä½†å¯èƒ½æœƒå¼•ç™¼æœªçŸ¥å•é¡Œï¼Œ
%D ç‰¹åˆ¥æ˜¯é¸é …ä¸­å«æœ‰ç©ºæ ¼æ™‚ã€‚\tex{citem} å‰‡éœ€è¦å°‡é¸é …åŒ…è£¹åœ¨èŠ±æ‹¬è™Ÿä¸­ã€‚
%D \starttyping
%D  \citem {é¸é …å…§å®¹}
%D  \fragilecitem é¸é …å…§å®¹
%D \stoptyping

%D è¯¥ç¯å¢ƒç»§æ‰¿äº†ä¸€éƒ¨åˆ† itemgroup çš„é”®å€¼ï¼Œå°±å¦‚åŒå‰ä¸¤ä¸ªå‘½ä»¤ä¸€æ ·ã€‚
%D ä¸åŒäº question å…·æœ‰answer å’Œ point ä¸¤ç§é”®å€¼ï¼Œè¯¥ç¯å¢ƒåªå…·æœ‰ answer ç›¸å…³çš„é”®å€¼ï¼Œæ¥ç‰¹åˆ«åœ°
%D è®¾ç½®æ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆå’Œé…ç½®ç­”æ¡ˆæ¨£å¼ã€‚
%D å› ä¸º choice ç¯å¢ƒçš„ç‰¹æ®Šæ€§ï¼Œpoint é”®å€¼é€šè¿‡ question ç¯å¢ƒæ¥æ˜¾ç¤ºã€‚å’Œ question ç’°å¢ƒçš„å€åˆ¥æ˜¯
%D question ç¯å¢ƒçš„ answer æ§åˆ¶ç­”æ¡ˆæ˜¯å¦æ˜¾ç¤ºåœ¨é¢˜å¹²ä»¥åŠè®¾ç½®ç›¸å…³æ ·å¼ã€‚
%D choice   ç¯å¢ƒçš„ answer æ§åˆ¶ç­”æ¡ˆæ˜¯å¦æ˜¾ç¤ºåœ¨é€‰é¡¹ä»¥åŠè®¾ç½®ç›¸å…³æ ·å¼ã€‚

%D å¦å¤–ï¼Œchoice ç’°å¢ƒæœ‰ä¸€å€‹ç‰¹åˆ¥çš„å€¼ï¼š
%D maxiwidth key is for calcaluted max width of choice and waited to be compareï¼Œ
%D notice this key is maxiwidth ,and difference from maxwidth which
%D for setupitemgroup command
\setupchoice [answerstyle=\ss\tf,
              answercolor=red,
              left={},  %%%%% follow is itemize option
              right={},
              stopper={.~},
              distance=.5em,
              option={packed,joinedup,nowhite},
              %before=,
              %after=,
              width=1em,
              maxiwidth=.9\textwidth,
              start=1,
              %align=,
              indenting=no,
              %symalign=,
              %symbol=,
              %itemalign=,
              way=bysection,
              numberconversion=A,]

\tolerant\protected\def\startchoice[#1]%
 {\begingroup\env_choicetrue\set_envitem_counter%%
  \doifelsesomething{\datasetvariable{Choice_collector}{\QuestionID}{totalchoicenumber}}% arg_1
     {\scratchcounter\datasetvariable{Choice_collector}{\QuestionID}{totalchoicenumber}}% arg_2
     {\scratchcounter\zerocount}% arg_3
  \current_total_choice_number=\number\scratchcounter\relax%
  \doifelsesomething{\datasetvariable{Choice_collector}{\QuestionID}{availablecolumns}}%
     {\scratchcounter\datasetvariable{Choice_collector}{\QuestionID}{availablecolumns}}%
     {\scratchcounter\zerocount}%
  \current_available_columns=\number\scratchcounter\relax%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    % if calc_horizontal_num >= tbl_cit_count
%    %                                      set horizontal = tbl_cit_count
%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count ~= 1
%    %                                  set horizontal = two % calc_horizontal_num
%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count == 1
%    %                                      set horizontal = 1
%    % ç‰¹åˆ«çš„ï¼Œ 3 é€‰é¡¹ ä¸” å¯æ’ç‰ˆæœ€å¤§åˆ—æ•°ä¸º 2 æ—¶ï¼Œæ’ç‰ˆ 1 è¡Œ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \startluacode
  tbl_num_temp = {"one","two","three","four",
                  "five","six","seven","eight","nine"}
  local   tbl_cit_count         = tex.count['current_total_choice_number']
  local   available_columns     = tex.count['current_available_columns']
          available_columns_arg = ""
  if     (tbl_cit_count == 3) and (available_columns   <  tbl_cit_count)
  then    available_columns_arg = "one"
  elseif (tbl_cit_count >  1) and (available_columns   >= tbl_cit_count)
  then    available_columns_arg = "horizontal," .. tbl_num_temp[tbl_cit_count]
  elseif (tbl_cit_count >= 1) and (available_columns   <=            1 )
  then    available_columns_arg = "one"
  else    available_columns_arg = "horizontal,two"
  end
  \stopluacode
  \iffirstargument\setupchoice[#1]\fi%
  \installitemgroupoption[choice][choice]
  \startitemgroup[env_choice]%
                 [\choiceparameter{numberconversion},#1,%
                  \ctxlua{context(available_columns_arg,"")},]%
                 [#1]%
  \processaction [\choiceparameter{showanswer}][%
                  true=>\mode_showanswertrue,
                 false=>\mode_showanswerfalse,]%
  \totalchoicenumber   = 0\relax%
  \currentchoicenumber = 0\relax%
  }

\def\stopchoice{%
    \width_max_with_label      = \dimexpr\width_cit_max + %
                                 \d_strc_itemgroups_list_width\relax%
    \currentchoicenumber       = \numexpr\currentchoicenumber-1\relax%
    \ifnum \totalchoicenumber  > \currentchoicenumber%
           \totalchoicenumber  = \totalchoicenumber%
    \else  \totalchoicenumber  = \currentchoicenumber%
    \fi%éæ­¸å‡ºç¸½åºè™Ÿ
    \choice_max_compared_width = \choiceparameter{maxiwidth}\relax%
    \tempa                     = \dimtonum{\choice_max_compared_width}\relax%
    \tempb                     = \dimtonum{\the\width_max_with_label}\relax%
    \startluacode
      local a = tex.count['tempa']
      local b = tex.count['tempb']
            c = math.floor(a/b)
    \stopluacode
%   \choice_max_compared_width æ˜¯å¯æ’ç‰ˆçš„æœ€é•·å¯¬åº¦ã€‚
%   tempa å’Œ tempb å°‡å¯¬åº¦æ•¸å­—åŒ–ï¼Œä»¥å‚™æ¯”è¼ƒå‡ºå¯æ’ç‰ˆçš„æ¬„æ•¸ã€‚
%   å› ç‚ºå–æ¶ˆäº† choice ä½œç‚ºä¸Šç´šç’°å¢ƒæ™‚çš„ \set_count_envlevel å› æ­¤ï¼Œé‡å®šç¾© orderã€‚
%   å–æ¶ˆåŸå› æ˜¯ è®“ choice ç›´æ¥ç²å– question ç’°å¢ƒçš„ orderã€‚
    \ifdefined\currentuserorder\show_check_info\else%
              \doifincsnameelse{env_choice:2}{\currentitemgroup}%
                   {}%
                   {\set_count_envlevel[env_choice:1][choice]}\fi%
    \edef\currentchoiceanswer{\collectedanswer}%
    \ifempty\currentchoiceanswer%
      \let\prevanswer\currentanswer%
      \edef\currentanswer{\prevanswer}%
    \else%
      \edef\currentanswer{\collectedanswer}%
    \fi%
    \setdataset [Choice_collector][\QuestionID][%æ”¶é›†é¸é …ä¿¡æ¯,å‚³éçµ¦ä¸‹é¢çš„ç¸½æ”¶é›†è™•
                 id={\QuestionID},%
              envid={\currentitemgroup},%
              order={\number\currentorder},%
          userorder={\currentuserorder},%
   availablecolumns={\ctxlua{context(c,"")}},
       itemmaxwidth={\the\width_cit_max},
  totalchoicenumber={\number\totalchoicenumber},
              point={\questionparameter\c!point},
       answerstatus={\check_choice_answerstatus},
             answer={\currentanswer},]%
    \edef\currentpoint{\questionparameter\c!point}%
    \edef\currenttotalpoint{\questionparameter\c!point}%
    \installdatacollector%
    \installdatacollectorhelper%
    \stopitemgroup\endgroup}

%D \section{è®¾ç½® writing ç¯å¢ƒ}
%D ç›®å‰è¯¥ç¯å¢ƒåªæ˜¯åˆæ­¥çš„è®¾è®¡ã€‚
%D å¦‚æœåªæœ‰åŒçº§çš„å¤šä¸ªä½œæ–‡é¢˜ç›®ï¼Œåªéœ€è¦ä½¿ç”¨ writing ç¯å¢ƒå³å¯ã€‚
%D ä½†æ˜¯ï¼Œå½“ä¸€ä¸ªä½œæ–‡ä½“ä¸‹é¢æœ‰å¤šä¸ªå­é¢˜ç›®æ—¶ï¼Œéœ€è¦å°†å­é¢˜ç›®æ”¾åˆ° subwriting ç¯å¢ƒå½“ä¸­ã€‚

%D è¯¥ç¯å¢ƒç›®å‰å…³äº itemgroup çš„è®¾ç½®æ˜¯ç›´æ¥ç»§æ‰¿è‡ª question ç¯å¢ƒã€‚ç›´æ¥é€šè¿‡ \tex{setupquestion}
%D æ¥è¿›è¡Œè®¾ç½®çš†å¯ã€‚

%D å¦‚æœå«æœ‰ subwriting ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨ \tex{getanswerfromsubwriting} æ¥è·å–æ€»åˆ†æ•°ã€‚
%D \startbuffer
%D \setupwriting[showanswer=true,showpoint=true]
%D \startwriting[point=45]
%D   ä½œæ–‡é¢˜ç›®è¯´æ˜
%D   \startanswer
%D     å‚è€ƒä½œæ–‡ 1
%D   \stopanswer
%D \stopwriting
%D
%D \startwriting
%D ä½œæ–‡é¢˜ç›®è¯´æ˜
%D   \startsubwriting[point=450]
%D     sub ä½œæ–‡é¢˜ç›®è¯´æ˜
%D     \startanswer
%D       å‚è€ƒä½œæ–‡ 2
%D     \stopanswer
%D   \stopsubwriting
%D   \startsubwriting[point=4588]
%D     sub ä½œæ–‡é¢˜ç›®è¯´æ˜
%D     \startanswer
%D     å‚è€ƒä½œæ–‡ 3
%D     \stopanswer
%D   \stopsubwriting
%D \stopwriting
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupwriting[answer={å‚è§å‚è€ƒä½œæ–‡ã€‚},
              pointlabel={åˆ†},
              left={},  %%%%% follow is itemize option
              right={},
              stopper={.~},
              distance=0em,
              option={packed,joinedup,nowhite},
              %before=,
              %after=,
              width=1.5em,
              %align=,
              indenting=no,
              %symalign=,
              %symbol=,
              %itemalign=,
              way=bychapter,%wont work if continue on
              numberconversion=tnum,]
\setupsubwriting[answer={å‚è§å‚è€ƒä½œæ–‡ã€‚},point=0,pointlabel={åˆ†}]
\definewriting[subwriting]


\tolerant\protected\def\startwriting[#1]{\begingroup%
  \env_writingtrue\set_envitem_counter%%
  \setupanswer[showanswer=false]%
  \iffirstargument\setupwriting[#1]\fi%æ³¨æ„ï¼Œwriting æ²¡æœ‰å•ç‹¬çš„ itemgroup ç¯å¢ƒ
  \installitemgroupoption[question][writing]
  \edef\current_writing_answer{\writingparameter\c!answer}%
  \edef\p_start{\writingparameter\c!start}%
  \edef\p_conversion{\writingparameter\c!numberconversion}%
  \ifempty\p_start% é¿å… continue å’Œ start å±æ€§å†²çª
       \startitemgroup[env_question]%
                      [\p_conversion,continue,#1]%
                      [#1]%
  \else\startitemgroup[env_question]%
                      [\p_conversion,#1]%
                      [#1]%
  \fi\item[\writingparameter\c!reference]%
  \increaseQuestionID%
  \installpointoranswer[writing][point]%
  \installpointoranswer[writing][answer]%
  \set_count_envlevel[env_question:1][writing]%
  \save_question_order}

\def\stopwriting{%
  \ifenv_subwriting\else%
    \installdatacollector%
    \installdatacollectorhelper%
  \fi\stopitemgroup\endgroup}

\tolerant\protected\def\startsubwriting[#1]{%
  \env_subwritingtrue% å¿…é ˆè™•åœ¨å¤–åœæ‰å¯ä»¥æ­£å¸¸åˆ¤æ–·ç’°å¢ƒï¼Œæ”¶é›†ä¿¡æ¯ã€‚
  \begingroup\env_toplevelfalse\set_envitem_counter%%
  \iffirstargument\setupwriting[subwriting][#1]\fi
  \edef\p_start{\namedwritingparameter{subwriting}\c!start}%
  \edef\p_conversion{\namedwritingparameter{subwriting}\c!numberconversion}%
  \ifempty\p_start% é¿å… continue å’Œ start å±æ€§å†²çª
       \startitemgroup[env_question]%
                      [\p_conversion,continue,#1]%
                      [#1]%
  \else\startitemgroup[env_question]%
                      [\p_conversion,#1]%
                      [#1]%
  \fi\item%
  \ifnum\currentitemnumber=1\relax
        \decreaseQuestionID\increaseQuestionID%
  \else\increaseQuestionID\fi%
  %å½“å…·æœ‰å¤šä¸ªå­å†™ä½œç¯å¢ƒæ—¶ï¼Œæ‰å¢é•¿ QID ï¼Œå¦åˆ™å‰Šå‡è‡³ çˆ¶çº§ QIDï¼ˆç›¸å½“äºç»§æ‰¿ï¼‰
  \set_count_itemlevel[env_question:2][subwriting]%
  \installpointoranswer[subwriting][point]%
  \installpointoranswer[subwriting][answer]%
  \def\current_writing_answer{\subwritingparameter\c!answer}%
  \save_question_order}
\def\stopsubwriting{\installdatacollector\installdatacollectorhelper\stopitemgroup\endgroup}

%D \section{è®¾ç½® answer ç¯å¢ƒ}
%D åœ¨(v20241023)ä¸­ï¼Œåˆ é™¤äº† answer ç¯å¢ƒçš„æ ‡ç­¾é€šè¿‡ description æ¥è¿›è¡Œè®¾ç½®ã€‚
%D æ•´ä½“ç¯å¢ƒé€šè¿‡ textbackground ç¯å¢ƒè¿›è¡Œè®¾ç½®ã€‚
%D è¯¥ç¯å¢ƒå…·æœ‰ answer å’Œ point çš„å…¨éƒ¨é”®å€¼ã€‚
%D åŒæ—¶ï¼Œé€šè¿‡ label labelstyle labelcolor æ¥è®¾ç½®ç­”æ¡ˆç¯å¢ƒçš„æ ‡ç­¾ã€‚
%D æ­¤å¤–ï¼Œé‚„æä¾›äº†ä¸€å€‹ç‰¹æ®Šçš„éµå€¼ sctiptï¼Œè©²éµå€¼ä¸»è¦ç”¨æ–¼å‰µå»ºç­”é¡Œå€åŸŸã€‚
%D è©²éµå€¼å’Œ answer éµå€¼æ˜¯äº’æ–¥çš„ï¼Œä¸æ‡‰è©²åŒæ™‚å•Ÿç”¨ã€‚

%D \tex{answer} æ˜¯çˆ²å¸«ç”Ÿå…©ç‰ˆè¨­ç½®çš„å‘½ä»¤ã€‚ä½†ç›®å‰è©²å‘½ä»¤å’Œç›¸é—œè¨­ç½®é‚„å…·æœ‰è«¸å¤šä¸è¶³ä¹‹è™•ã€‚åªéœ€è¦å°‡è©²ç’°å¢ƒç½®æ–¼é¡Œç›®ä¸‹æ–¹ï¼Œå³å¯ç²å–ç•¶å‰é¡Œç›®è¨­å®š%D çš„ç­”æ¡ˆï¼Œä¸¦å¯ä»¥çˆ²å…¶ç·¨å¯«ç­”æ¡ˆè§£æã€‚
%D
%D \startbuffer
%D \startquestion[showanswer=true,answer={answer for \currentitemgroup }]
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ æ³¨æ„ï¼š\tex{answer} å¯ä»¥ç²å–çˆ¶ç’°å¢ƒæˆ–åŒç´šç’°å¢ƒçš„ç­”æ¡ˆè€Œä¸å¿…å†æ¬¡è¨­ç½®ã€‚
%D     \startanswer[point=12]
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \startquestion[showanswer=true]
%D     è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ æ³¨æ„ï¼š\tex{answer} å¯ä»¥ç²å–çˆ¶ç’°å¢ƒæˆ–åŒç´šç’°å¢ƒçš„ç­”æ¡ˆè€Œä¸å¿…å†æ¬¡è¨­ç½®ã€‚
%D     \startchoice
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D     \startanswer[point=1]
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D \startbuffer
%D \startquestion[showanswer=true]
%D   è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚
%D     \startproblem[showanswer=true,left={(},right={)},distance=1em,stopper={}]
%D     \startpitem[showanswer=true,answer={Pitem 1}] è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D     \startanswer[point=10]
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 2}] è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D     \startanswer[point=20]
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 3}] è©²ç’°å¢ƒä½æ–¼ \currentitemgroup ã€‚ \stoppitem
%D     \startanswer[point=30]
%D     \input knuthmath
%D     \stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%%%%%%%
\setuptextbackground[env_answer]
                    [location=paragraph,width=local,
                     leftoffset=1ex,rightoffset=1ex,
                     %topoffset=.5ex,bottomoffset=.5ex,
                     before={\leftskip=0pt\startnarrower},
                     after={\stopnarrower},
                     background=\answerparameter\c!background,
                     backgroundcolor=\answerparameter\c!backgroundcolor,
                     corner=\answerparameter\c!corner,
                     frame=\answerparameter\c!frame,
                     framecolor=\answerparameter\c!framecolor,
                     rulethickness=\answerparameter\c!rulethickness,
                    ]

\setupanswer[showanswer=true,
             showpoint=true,
             answer=\getanswerforanswer,
             point=\getpointforanswer,
             label={ç­”æ¡ˆ : },
             pointlabel={åˆ†},
             pointstyle=\answerparameter\c!style,
             pointcolor=\answerparameter\c!color,
             answerstyle=\answerparameter\c!style,
             answercolor=\answerparameter\c!color,
             style=\ss\it,
             before=\blank[halfline],
             after=\blank[halfline],
             afteranswer={\par},
             showscript=false,
             %scriptcontent={},
             %scriptbefore={},
             %scriptafter={},
             background=normalframeOL,
             %backgroundcolor=,
             %corner=,
             frame=on,
             %framecolor=,
             %rulethickness=,
             ]

\tolerant\protected\def\startanswer[#1]#:#2\stopanswer{%
  \begingroup\lettonothing\currentanswer%é‡‹æ”¾currentanswer
% currentanswer å‘½ä»¤å·²ç¶“è¢«å…¶ä»–ç’°å¢ƒå®šç¾©ç‚ºç­”æ¡ˆç²å–å‘½ä»¤ï¼Œ
% æ­¤è™•çš„ currentanswer æ˜¯å®šç¾©ç’°å¢ƒå‘½ä»¤ï¼Œéœ€è¦é‡æ–°é‡‹æ”¾ã€‚
  \env_answertrue\set_envitem_counter%
  \xdef\get_writing_answer{#2}% only for writing env
% éœ€è¦æ³¨æ„ï¼Œè¯¥å‘½ä»¤ä¼šä¼ é€’ç»™ datasetï¼Œä¸åŒäº writing ç¯å¢ƒçš„ current_writing_answer
% current_writing_answer çš„ç›®çš„æ˜¯è®¾ç½®è¾ƒçŸ­çš„ä½œæ–‡ç­”æ¡ˆã€‚
% get_writing_answer åˆ™æ˜¯è®¾ç½®å®Œæ•´çš„ä½œæ–‡ç­”æ¡ˆã€‚
  \iffirstargument\setupanswer[#1]\fi%
  \doif{\answerparameter{showscript}}{true}{\mode_showscripttrue}%
  \doif{\answerparameter\c!showanswer}{true}{\mode_showanswertrue}%
  \doif{\answerparameter\c!showpoint}{true}{\mode_showpointtrue}%
  \answerparameter{before}%
  \ifenv_material
    \startenv_answer
      \useanswerstyleandcolor\c!style\c!color%
      #2
    \stopenv_answer
  \else%
    \ifmode_showscript%
      \startenv_answer%
        \answerparameter{scriptbefore}%
        \answerparameter{scriptcontent}%
        \answerparameter{scriptafter}%
      \stopenv_answer%
    \fi%
    \ifmode_showanswer%
      \startenv_answer%
      \bgroup
          \answerparameter\c!answerstyle%
          \switchtocolor[\answerparameter{answercolor}]%
          \answerparameter\c!label%
          \ifmode_showpoint%
            \paren{\answerparameter\c!pointstyle%
                   \switchtocolor[\answerparameter{pointcolor}]%
                   \point_point\answerparameter{pointlabel}}
          \fi%
        \answer_answer%
        \answerparameter{afteranswer}%
      \egroup%
      \useanswerstyleandcolor\c!style\c!color%
      #2
      \stopenv_answer%
    \fi%
  \fi
  \answerparameter{after}%
  \endgroup}

%D \section{è®¾ç½® pitem,citem å‘½ä»¤}
%D ä»…å…·æœ‰ answer point å’Œ reference é”®å€¼ã€‚

%D è«‹æ³¨æ„ï¼Œä¸è¦åŒæ™‚ç‚ºå–®å€‹ pitem æˆ–è€… fillin å‘½ä»¤åŒæ™‚è¨­ç½®ç­”æ¡ˆï¼Œ
%D é€™å¯èƒ½æœƒå¼•èµ·ç­”æ¡ˆç„¡æ³•æ­£ç¢ºç²å–ã€‚

\setuppitem    [%showpoint=false,
                point=0,% å¿…é ˆæœ‰é è¨­å€¼ï¼Œå¦å‰‡å‡ºç¾è¨ˆæ•¸å™¨éŒ¯èª¤(missing number)
                pointstyle=\ttx,
                %pointcolor=,
                pointlabel={åˆ†},
                %showanswer=false,
                %answer=,
                answerstyle=\ss,
                answercolor=red,
                %reference=,
                ]
\tolerant\protected\def\startpitem[#1]{\begingroup%
  \item_pitemtrue\increaseQuestionID%
  \iffirstargument\setuppitem[#1]\fi%
  \startitem[\pitemparameter{reference}]%
    \ifnum\currentpitemnumber=0\currentpitemnumber=1\relax\fi%
    \ifenv_question% è¨­è¨ˆä¸Šçš„å•é¡Œï¼Œæ­¤æ™‚ pitem è™•æ–¼ botlevelï¼Œå¦å‰‡è™•æ–¼ toplevelã€‚
    \set_count_itemlevel [env_question:2] [pitem]\else\ifenv_problem%
    \set_count_envlevel  [env_question:2] [pitem]\fi\fi%
    \installpointoranswer[pitem]          [point]%
    \installpointoranswer[pitem]          [answer]%
  }

\def\stoppitem{%
  \ifitem_fillin%
    \edef\currentfillinanswer{\collectedanswer}
    \ifempty\currentfillinanswer\relax\else%
      \edef\currentanswer{\collectedanswer}\fi\fi%
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer% æ¸…ç©ºæ”¶é›† fillin çš„ç­”æ¡ˆ
  \stopitem\global\advance\currentpitemnumber by 1\relax
  \endgroup}

%D choice åªå…·æœ‰ showanswer å’Œ [*](ç”¨äºæ ‡è®°æ­£ç¡®ç­”æ¡ˆ) ä¸¤ä¸ªè®¾ç½®

\def\correct_choice#1#2{%
    \ifmode_showanswer%
      \doif{#1}{*}{%
        {\doifelse{\choiceparameter\c!answerstyle}{}%
                  {\choiceparameter\c!answerstyle}%
                  {\questionparameter\c!answerstyle}%
         \doifelse{\choiceparameter\c!answercolor}{}%
                  {\switchtocolor[\choiceparameter\c!answercolor]}%
                  {\switchtocolor[\questionparameter\c!answercolor]}%
          #2}}%%correct choice
    \else #2\fi}
\def\get_citem_text[#1]{\setbox0=\hbox{#1}%
    \width_cit = \the\wd0\relax%relax is neccessary
    \ifdim \width_cit_max > \width_cit%
           \width_cit_max = \width_cit_max%
    \else  \width_cit_max = \width_cit%
    \fi}%%%% éæ­¸è¨ˆç®—å‡ºæœ€å¤§å¯¬åº¦

\tolerant\protected\def\startcitem[#1]#*[#2]#:#3\stopcitem{% #1 correct answer
    \ifsecondargument\setupcitem[#2]\fi%                     #2 options
    \get_citem_text[#3]%                                     #3 choice content
    \processaction[\choiceparameter{showanswer}][%
         true=>\mode_showanswertrue,
        false=>\mode_showanswerfalse,]%
%    \set_count_itemlevel[env_choice:2][citem]
%    æ²¡æœ‰å¿…è¦è®¡ç®—å­é€‰é¡¹çš„ idï¼Œchoice ç¯å¢ƒçš„ id å°±å·²ç»è¶³å¤Ÿäº†ã€‚
%    åŒæ—¶ä¹Ÿå·²ç»æœ‰ totalchoicenumber æ¥è·å–å­é€‰é¡¹çš„æ•°é‡äº†ã€‚
    \doif{#1}{*}{\choice_checktrue}%
    \ifnum\currentchoicenumber < 1\relax
          \currentchoicenumber = 1\relax\fi%
    \ifconditional\c_strc_itemgroups_horizontal% mode_horizontal
       \doif{#1}{*}{\collectanswer{\convertnumber%
                   {\choiceparameter{numberconversion}}%
                   {\currentchoicenumber}}}%
    \fi%
    \startitem[\citemparameter\c!reference]
    \ifconditional\c_strc_itemgroups_horizontal% mode_horizontal
      \doifelse{#1}{*}{\correct_choice{#1}{#3}}{#3}%
      % å¦‚æœ * è¢«è¨­ç½®ï¼Œå°‡è©²é¸é …è¨­ç‚ºæ­£ç¢ºé¸é …ï¼Œå¦å‰‡é¡¯ç¤ºç‚ºå…¶ä»–é¸é …
    \else%
      \doifelse{#1}{*}{\correct_choice{#1}{#3}}{#3}%
      \doif{#1}{*}{\collectanswer{\convertnumber%
                  {\choiceparameter{numberconversion}}%
                  {\currentchoicenumber}}}%
    \fi%
    \stopitem%
    \advance\currentchoicenumber by 1\relax%
}

%D \startquestion[showanswer=true]
%D kk\startinlinechoice[answer=GE]
%D     \starticitem 1H\stopicitem
%D     \starticitem 2O\stopicitem
%D     \starticitem 3P\stopicitem
%D   \stopinlinechoice
%D oo\stopquestion

%D \startquestion[showanswer=true]
%D kk\startinlinechoice[answer=GE]
%D     \starticitem[*] 1H\stopicitem
%D     \starticitem[*] 2O\stopicitem
%D     \starticitem 3P\stopicitem
%D   \stopinlinechoice
%D oo\stopquestion

\newif\ifinlinechoice_correctanswer\inlinechoice_correctanswerfalse
\definechoice[inlinechoice]
\tolerant\def\setupinlinechoice[#1]{\setupchoice[inlinechoice][#1]}
\setupinlinechoice[option={text,8},
                   correctsymbol={\symbol{marksquarecheck}},
                   left={ (},
                   right={) },
                   lefttext={},
                   righttext={},
                   answerstyle=\ss,
                   showanswer=,% shoule be empty before used
                   separator={\removeunwantedspaces,\space},
                   stopper=,]

\tolerant\protected\def\startinlinechoice[#1]{\unskip\begingroup%
   \env_choicetrue\set_envitem_counter%
   \iffirstargument\setupinlinechoice[#1]\fi%
   \installitemgroupoption[choice][choice]%
   \edef\currentanswer{\namedchoiceparameter{inlinechoice}\c!answer}%
   \startitemgroup[env_choice][text,\namedchoiceparameter{inlinechoice}\c!option]%
   \namedchoiceparameter{inlinechoice}\c!left
   \namedchoiceparameter{inlinechoice}\c!style
   \begincsname\namedchoiceparameter{inlinechoice}\c!color\endcsname}

\tolerant\protected\def\starticitem[#1]#:#2\stopicitem%
{\unskip%
 \edef\p_ic_showanswer{\namedchoiceparameter{inlinechoice}\c!showanswer}%
 \edef\p_q_showanswer{\questionparameter\c!showanswer}%
 \edef\p_showanswer{\ifempty\p_ic_showanswer\p_q_showanswer\else\p_ic_showanswer\fi}%
 \edef\p_correctanswersymbol{\namedchoiceparameter{inlinechoice}{correctsymbol}}%
 \bgroup\ifx\p_showanswer\s!true
   \doif{#1}{*}{%
       \inlinechoice_correctanswertrue%
       \namedchoiceparameter{inlinechoice}\c!answerstyle
       \begincsname\namedchoiceparameter{inlinechoice}\c!answercolor\endcsname}%
   \fi%
   \ifinlinechoice_correctanswer%
     \sym{\p_correctanswersymbol}#2\collectanswer{#2}%
   \else\startitem#2\stopitem\fi%
 \egroup\markcontent[punctuation]{\namedchoiceparameter{inlinechoice}\c!separator}}

\def\stopinlinechoice{%
  \removemarkedcontent[punctuation]%
  \namedchoiceparameter{inlinechoice}\c!right
  \edef\currentinlinechoiceanswer{\collectedanswer}%
  \ifempty\currentinlinechoiceanswer%
    \let\prevanswer\currentanswer%
    \edef\currentanswer{\prevanswer}%
  \else%
    \edef\currentanswer{\removeunwantedspaces\collectedanswer}%
  \fi%
  \installdatacollector%
  \installdatacollectorhelper%
  \stopitemgroup\unskip%
  \endgroup}

%D \section{å®šä¹‰åŒä¹‰å‘½ä»¤}

%D \startquestion[showanswer=true]
%D \fastchoice{a,\correct{F},{[*]E},}
%D \stopquestion

%D \startquestion[showanswer=true]
%D \fastchoicealt{a,\correct{F},{[*]sF}}
%D \stopquestion

\def\pitem{\dosingleempty\pitem_indeed}
\def\pitem_indeed[#1]#2{
  \startpitem[#1]{#2}\stoppitem
}
\def\citem{\dosingleempty\citem_indeed}
\def\citem_indeed[#1]#2{%
  \startcitem[#1]{#2}\stopcitem%
}
\def\icitem{\dosingleempty\icitem_indeed}
\def\icitem_indeed[#1]#2{%
  \starticitem[#1]{#2}\stopicitem%
}

\tolerant\protected\def\fastchoice[#1]#:#2{
  \startchoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopchoice}

\tolerant\protected\def\fastchoicealt[#1]#:#2{
  \startinlinechoice[#1]%
    \def\icitem_temp##1{\starticitem##1\stopicitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \rawprocesscommalist[#2]\icitem_temp%
  \stopinlinechoice}

%D è°¨æ…ä½¿ç”¨ä¸‹é¢çš„ fragilecitemï¼Œä»–å¹¶ä¸å®‰å…¨ã€‚å¾ˆæœ‰å¯èƒ½å¯¼è‡´é”™è¯¯

\bgroup
\obeylines
\gdef\xcitem{\bgroup\obeylines\dosingleempty\doxcitem}%
\gdef\doxcitem[#1]#2
  {\egroup%
  \doifsomethingelse{#1}%
  {\startcitem[*]#2\stopcitem}%
  {\startcitem #2\stopcitem}%
  }%
\egroup

\let\fragilecitem\xcitem

%D \section{è¨­ç½® fillin å‘½ä»¤}
%D è©²å‘½ä»¤å»ºè­°åœ¨ pitem ç’°å¢ƒå…§é€²è¡Œä½¿ç”¨ã€‚
%D ç•¶ç„¶ï¼ŒåŒæ™‚ç”±æ–¼ pitem æœ¬èº«ä¹Ÿæœ‰ answer éµå€¼ï¼Œå¯ä»¥é€šéè©²éµå€¼é€²è¡Œè¨­å®šã€‚

%D fillin å‘½ä»¤ä¸»è¦ä¾é  bar å‘½ä»¤å¯¦ç¾çš„ã€‚åŸºæœ¬ä¸ŠæŒ‰ç…§ä¿®æ”¹ bar å‘½ä»¤å³å¯ä¿®æ”¹ fillin å‘½ä»¤ã€‚
%D fillin å‘½ä»¤æœ‰å…©å€‹åƒè€ƒ textnote çš„åƒæ•¸ï¼š empty å’Œ nã€‚
%D empty=yesï¼Œéš±è—ç­”æ¡ˆï¼›empty=number é¡¯ç¤ºæ•¸å­—ï¼› empty=none é¡¯ç¤ºç­”æ¡ˆã€‚
%D n=* éš±è—ç­”æ¡ˆï¼› n=NUMBER æ§åˆ¶ bar çš„é•·åº¦ã€‚

%D bar ä¸»è¦æœ‰å››ç¨®æ¨£å¼ï¼Œå¯ä»¥é€šé mp åƒæ•¸é€²è¡Œè¨­ç½®ï¼š
%D rules:under:dots    %rules:under:random
%D rules:under:dash    %rules:under:wave

%D æ–°å¢ä¸€ä¸ª align=autoright æ¥è®© fillin å¯¹é½å³æ–¹ã€‚ä½†å¿…é¡»åŒæ—¶è®¾ç½® n=0 æ‰ä¼šæ­£å¸¸å·¥ä½œã€‚

\setupbar[fillin_text]
         [ rulethickness=\fillinparameter{rulethickness},
         foregroundcolor=\fillinparameter{foregroundcolor},
         foregroundstyle=\fillinparameter{foregroundstyle},
                continue=\fillinparameter{continue},
                    unit=\fillinparameter{unit},
                   order=\fillinparameter{order},
                  method=\fillinparameter{method},
                      dy=\fillinparameter{dy},
                     max=\fillinparameter{max},
                   width=\fillinparameter{width},
                    left=\fillinparameter{left},
                   right=\fillinparameter{right},
                  repeat=\fillinparameter{repeat},
                   color=\fillinparameter{color},
                  offset=\fillinparameter{offset},
                   empty=\fillinparameter{empty},
                      mp=\fillinparameter{mp}]
\setupfillin[%foregroundcolor=,
             %before=,after=,
             %left=,right=,
             %repeat=,mp=
              rule=fillin_text,% å¼•ç”¨ bar å‘½ä»¤
              empty=none,
              continue=yes,
              unit=em,
              order=foreground,
              method=0,
              %color=gray,
              width=4em,
              n=10,
              dy=-0.4,
              max=3,
              offset=-.1,
              rulethickness=.05,
              foregroundstyle=\ss,]

\newcount\c_fillin_number
\tolerant\protected\def\fillin[#1]#:#2{%
  \item_pitemfalse\item_fillintrue%
  \begingroup%
  \iffirstargument\setupfillin[#1]\fi%
  \removeunwantedspaces%
  \global\advance\c_fillin_number by 1\relax
  \edef\p_n{\fillinparameter\c!n}%
  \edef\p_empty{\fillinparameter\c!empty}%
  \edef\p_number{\number\c_fillin_number}%
  \edef\currentbar{\fillinparameter\c!rule}%
  \edef\fillin_align{\fillinparameter\c!align}
  \ifmode_showanswer\setupfillin[empty=none]%
  \else\setupfillin[empty=yes]\fi
  \doifelse{\fillin_align}{autoright}%
           {\unskip\nobreak\hfill\penalty20\hskip2em\hbox{}\nobreak\hfill}{\relax}%
  \fillinparameter\c!before\fillinparameter\c!left%
  \ifx\p_n\wildcardsymbol
     \donefalse
     \ifx\p_empty\v!yes
       \donetrue
     \else\ifx\p_empty\v!number
       \donetrue
     \else\ifx\p_empty\v!none
       \donetrue
     \fi\fi\fi
     \ifdone
       \setupbar[\currentbar][\c!empty=\v!yes]%
     \fi%
     \inlinebar[\currentbar]\bgroup
       \wordboundary#2%
       \ifx\p_empty\v!yes
       \else\ifx\p_empty\v!number
       \else\ifx\p_empty\v!none
       \fi\fi\fi
     \egroup
   \else
      \inlinebar[\currentbar]\bgroup
      \wordboundary
      \scratchcounter\numexpr\p_n\relax
      \ifx\p_empty\v!yes
        \interwordspacesbefore\scratchcounter
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!number
        \interwordspacesbefore\scratchcounter
        \zwnj\runninghbox{\resetbar\p_number}\zwnj
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!none
        \scratchcounter\numexpr\p_n/\plustwo\relax
        \interwordspacesbefore\scratchcounter
        \zwnj\runninghbox{\resetbar{#2}}\zwnj
        \interwordspacesafter\scratchcounter
      \else
        #2%
      \fi\fi\fi%
    \egroup%
   \fi%
  \fillinparameter\c!right\fillinparameter\c!after%
  \doifelse{\fillin_align}{autoright}%
           {\parfillskip=0pt \finalhyphendemerits=0 \par}{}%
  \endgroup% å› ç‚ºç­”æ¡ˆè¢«ä¿å­˜åœ¨çµ„å…§ï¼Œå¿…é ˆæå–å‡ºä¾†
  \edef\currentfillinanswer{#2}% å¦‚æœ fillin ä¸ºç©ºï¼Œè€Œ pitem å«æœ‰å«æœ‰ç­”æ¡ˆï¼Œ
  \ifempty\currentfillinanswer\else% åº”å½“ä½¿ç”¨ pitem è€Œé fillin
    \collectanswer{#2}
    \edef\currentanswer{#2}%
  \fi}

%D \section{è¨­ç½® material ç’°å¢ƒ}
%D é¡§åæ€ç¾©ï¼Œ\tex{material} ç’°å¢ƒç”¨ä¾†æ”¾ç½®å¤§æ®µæ–‡æœ¬ææ–™ã€‚
%D è©²ç’°å¢ƒæ¯”è¼ƒç‰¹æ®Šï¼Œå®ƒè¨­ç½®äº†å¤šå€‹å­å¯¦ä¾‹ä¾†é€²è¡Œæ›´å®Œå–„çš„è¨­ç½®ã€‚
%D é™¤äº† \tex{setupmaterial[number]} é€™å€‹å¯¦ä¾‹ç¹¼æ‰¿äº† \tex{setupcounter} çš„å…¨éƒ¨éµå€¼ä¹‹å¤–ï¼Œ
%D å…¶ä»–å¯¦ä¾‹éƒ½æ˜¯æ–°å®šç¾©çš„éµå€¼ã€‚

%D é€™äº›å¯¦ä¾‹åˆ†åˆ¥æ˜¯ï¼š
%D \startitemize[nowhite,joinedup,packed]
%D \item \tex{setupmaterial[number]}    è¨­ç½® è©²ç’°å¢ƒæ¨™é¡Œçš„ {\bf åºè™Ÿ};
%D \item \tex{setupmaterial[title]}     è¨­ç½® è©²ç’°å¢ƒçš„ {\bf æ¨™é¡Œ} ç›¸é—œçš„æ¨£å¼;
%D \item \tex{setupmaterial[author]}    è¨­ç½® è©²ç’°å¢ƒæ–‡ç« çš„ {\bf ä½œè€…} ç›¸é—œçš„æ¨£å¼;
%D \item \tex{setupmaterial[source]}    è¨­ç½® è©²ç’°å¢ƒæ–‡ç« çš„ {\bf å…·é«”ä¾†æº} çš„ç›¸é—œæ¨£å¼ã€‚
%D \item \tex{setupmaterial[indicator]} è¨­ç½® è©²ç’°å¢ƒæ–‡ç« çš„ {\bf ç•«ç·šåºè™Ÿæ–‡å­—} çš„ç›¸é—œæ¨£å¼ã€‚
%D \stopitemize

%D æ­¤å¤–ï¼Œ\type{title},\type{author},\type{source} çš„åç¨±æ˜¯é€šé \tex{setupmaterial}
%D ä¾†ç›´æ¥è¨­ç½®ã€‚æ­¤å¤–ï¼Œ è©²ç’°å¢ƒå…·æœ‰ä¸€å€‹ç‰¹æ®Šçš„å­å‘½ä»¤ \tex{indicator} ä¾†æ¨™è¨˜æ–‡ç« ä¸­çš„æå•çš„éƒ¨åˆ†ä¸¦
%D é€²è¡Œæ·»åŠ æ•¸å­—æ¨™è­˜ --- ï¼ˆä¸€ï¼‰ç•«ç·šæ–‡å­—ã€‚å› æ­¤ï¼Œ\tex{setupmaterial} é‚„å…·æœ‰ä¸€å€‹éµå€¼ indicator
%D é€šé \type{indicator=reset} å° indicator é€²è¡Œé‡ç½®ï¼Œæ¯ç•¶é–‹å•“ä¸€å€‹æ–°çš„ material ç’°å¢ƒã€‚
%D é€šé \type{indicator=continue} å° indicator å–æ¶ˆé‡ç½®ï¼Œå®ƒå°‡æŒçºŒè¨ˆæ•¸ã€‚
%D ç•¶ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šé \tex{setupmaterial[indicator][reset=true]} ä¾†å•“ç”¨é‡æ–°è¨ˆæ•¸

%D ä»¥ä¸Šæ‰€æœ‰å¯¦ä¾‹éƒ½å…·æœ‰ä»¥ä¸‹éµå€¼ï¼š
%D before after align style color
%D æ­¤å¤–ï¼Œ\tex{setupmaterial} å¯ä»¥é€šè¿‡ spacebefore å’Œspaceafter æ¥æ§åˆ¶ç¯å¢ƒå‰åçš„å‚ç›´è·ç¦»

%D notice , if you want change [start = number] after a chapter ,
%D you should use \tex{resetcount[COUNTER_NAME]} to reset current counter
%D to the number of start you've setted.
%D otherwise, you need put [start = number] before the chapter you want
%D to reset the counter.

%D \startbuffer
%D \setupmaterial[title][color=green]
%D \startmaterial[title={Knuth},author={Mos},source={Yelu}]
%D \input knuth
%D \stopmaterial
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupmaterial [\c!align=center,
                %\c!color=,
                %\c!style=,
                \c!spacebefore=1em,
                \c!spaceafter=1em,
                %\c!title=,
                %\c!author=,
                %\c!source=,
                \c!indicator=continue,
                indent={first,always,2em},]
\setupmaterial [\c!number] [\c!before={(},\c!after={)},
                            \c!prefix=no,\c!start=0,
                            \c!style=\namedmaterialparameter\c!title\c!style,
                            \c!color=\namedmaterialparameter\c!title\c!color,
                            \c!numberconversion=cn,\c!way=\v!by\v!chapter]
\setupmaterial [\c!title]  [\c!style=\ss\tfa,\c!color=,\c!align=center,
                            \c!before=,]
\setupmaterial [\c!author] [\c!style=\tf,\c!color=,\c!align=flushright]
\setupmaterial [\c!source] [\c!before=\par,\c!align=flushright]
\setupmaterial [indicator,indicator_helper]
               [style=\ss\bf,before={ (~},after={~) },prefix=no,
                numberconversion=cn,type=line,reset=false]

\def\material_counter_parameter#1%
  {\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\c!title\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \incrementcounter[#1]\convertedcounter[#1]%
    \namedmaterialparameter\currentmaterial\c!after
   \endgroup}

\def\material_parameter#1%creat new element in material
  {{\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\currentmaterial\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \rootmaterialparameter\currentmaterial
    \namedmaterialparameter\currentmaterial\c!after
    \par\endgroup}}

\tolerant\protected\def\startmaterial[#1]{\begingroup%
    \lettonothing\currentmaterial%%
    \edef\p_indicator{\rootmaterialparameter\c!indicator}
    \edef\p_reset{\namedmaterialparameter{indicator}\c!reset}
    \processaction[\p_indicator][
      reset=>\let\indicator_reset_helper\resetindicators,
    continue=>\continue_countertrue\let\indicator_reset_helper\relax,]
    \processaction[\p_reset][
      true=>\let\indicator_reset_helper\resetindicators,
     false=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \env_materialtrue\set_envitem_counter%
  \iffirstargument\setupcurrentmaterial[#1]\fi
  \indicator_reset_helper
  \usematerialstyleandcolor\c!style\c!color%
    \blank[\rootmaterialparameter\c!spacebefore]
    \startalignment[\rootmaterialparameter\c!align]
        \material_counter_parameter\c!number
        \material_parameter\c!title
        \material_parameter\c!author
    \stopalignment
    \blank[\rootmaterialparameter\c!spaceafter]
    \setupindenting[\rootmaterialparameter{indent}]
}
\def\stopmaterial{%
    \material_parameter\c!source
    \indicator_reset_helper
    \endgroup}

\tolerant\protected\def\indicator[#1]#:#2{\begingroup%
    \def\currentmaterial{indicator}
    \iffirstargument\setupmaterial[indicator][#1]\fi%
    \edef\indicator_type{\namedmaterialparameter\currentmaterial\c!type}%
    \edef\indicator_reset{\namedmaterialparameter\currentmaterial\c!reset}%
    \processaction[\indicator_type]%
              [line=>\let\indicator_type\underbar,%
               none=>\let\indicator_type\relax]%
    \usematerialstyleandcolor\c!style\c!color%
    \indicator_type{%
    \namedmaterialparameter\currentmaterial\c!before%
    \ifmode_check%
      \ifenv_material\color[red]{material}\else\color[red]{\currentitemgroup}\fi%
      \ifcontinue_counter\color[red]{continue}\fi%
    \fi%
    \ifenv_material%
      \ifmode_check\color[red]{::indicator}\fi%
      \incrementcounter[\currentmaterial]%
      \convertedcounter[\currentmaterial]%
    \else%
      \ifmode_check\color[red]{::helper}\fi%
      \incrementcounter[indicator_helper]%
      \convertedcounter[indicator_helper]%
    \fi%
    \namedmaterialparameter\currentmaterial\c!after%
    #2}
\endgroup}

\def\indicators{\convertedcounter[indicator]%%% TODO å¢å¼·è©²å‘½ä»¤çš„ç”¨æ³•
                \incrementcounter[indicator]}
\def\resetindicators{\setcounter[indicator][0]%
                     \setcounter[indicator_helper] [0]}
%%%%%%%%%%%%%%%%
%D \section{è®¾ç½® close ç¯å¢ƒ}

\cnt_closetest=1\relax
\tolerant\protected\def\closebar#1{
  \startbar[underbar]
    \scratchcounter\numexpr16/\plustwo\relax
    \interwordspacesbefore\scratchcounter
      \zwj\runninghbox{\resetbar{#1}}\zwj
    \interwordspacesafter\scratchcounter
  \stopbar}

%D close ç’°å¢ƒè¿‘ä¹æ˜¯å–®ç¨è¨­è¨ˆçš„ã€‚é‚„éœ€è¦æ”¹é€²ï¼šç›´æ¥ä½¿ç”¨ itemgroup é‡ç½®ï¼Œè©²ç’°å¢ƒä¸»è¦ä½¿ç”¨å…©å€‹å‘½ä»¤ï¼š
%D \tex{startclose} å’Œ \tex{stopclose} ç”¨ä¾†å‰µå»ºè©²ç’°å¢ƒï¼Œ
%D \tex{closechoice} ç”¨ä¾†æ¨™è¨˜ç’°å¢ƒå…§çš„é¸é …ï¼Œè©²å‘½ä»¤éš¨è¡Œæ–‡æ”¾ç½®å³å¯ã€‚é¸é …ç„¡é ˆå†æ¬¡åœ¨æ–‡ç« å¾Œæ”¾ç½®ï¼Œ
%D \tex{stopclose} æœƒè‡ªè¡Œæ”¾ç½®ã€‚
%D å› ç‚º \type{close} ç’°å¢ƒçš„å­é …ç›® \tex{closechoice} æ˜¯é€šé choice ç’°å¢ƒè¨­ç½®çš„ã€‚
%D å› æ­¤ï¼Œå¯ä»¥é€šé \type{[*]} ä¾†æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆã€‚

%D close ç’°å¢ƒåŒæ¨£ç¹¼æ‰¿äº† answer çš„éµå€¼ã€‚
%D æ­¤å¤–è¨­ç½®äº† reset éµä¾†é¸æ“‡æ˜¯å¦æ¯ä¸€ç¯‡é‡ç½®é¸é …çš„é¡Œè™Ÿï¼Œ
%D å…¶ä»–çš„éµå€¼ï¼š barcolor barstyle è¨­ç½® ä¸‹åˆ’ç·šæ¨£å¼
%D            before after style color ç”¨æ–¼æ•´é«”ç’°å¢ƒ
%D            width frame stopper distance ç”¨æ–¼é¸é …å‰é¡Œè™Ÿæ¨£å¼

%D \startbuffer
%D \startclose
%D On Oct. 11, hundreds of runners competed in a cross-country race in Minnesota.
%D Melanie Bailey should have \closechoice[designed,followed,changed,finished] the
%D course earlier than she did. Her \closechoice[delay,chance,trouble,excuse] came
%D because she was carrying a \closechoice[judge,volunteer,classmate,competitor]
%D across the finish line.
%D
%D As reported by a local newspaper, Bailey was more than two-thirds of the way
%D through her \closechoice[race,school,town,training] when a runner in front of
%D her began crying in pain. She \closechoice[agreed,returned,stopped,promised]
%D to help her fellow runner, Danielle Lenoue. Bailey took her arm to see if she
%D could walk forward with \closechoice[courage,aid,patience,advice] . She couldn't.
%D Bailey then \closechoice[went away,stood up,stepped aside,bent down] to let Lenoue
%D climb onto her back and carried her all the way to the finish line, then another
%D 300 feet to where Lenoue could get \closechoice[medical,public,constant,equal] attention.
%D
%D Once there, Lenoue was \closechoice[interrupted,assessed,identified,appreciated]
%D and later taken to a hospital, where she learned that she had serious injuries in
%D one of her knees. She would have struggled with extreme \closechoice[hunger,pain,cold,tiredness]
%D to make it to that aid checkpoint without Bailey's help.
%D
%D As for Bailey, she is more \closechoice[worried,ashamed,confused,discouraged]
%D about why her act is considered a big \closechoice[game,problem,lesson,deal] .
%D "She was just crying. I couldn't \closechoice[leave,cure,bother,understand] her,"
%D Bailey told the reporter. "I feel like I was just doing the right thing.â€
%D
%D Although the two young women were strangers before the \closechoice[ride,test,meet,show] ,
%D they've since become friends. Neither won the race, but the \closechoice[secret,display,benefit,exchange]
%D of human kindness won the day.
%D \stopclose
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupclose[%showanswer=false,
            reset=true,
            %mp=,
            answerstyle=\ss,
            answercolor=red,
            width=2em,% set order width
            frame=off,% set order frame
            stopper=.,% set order stopper
            distance=.5em,% set order distance
            after=\blank[halfline]]


\def\closechoice[#1]{%å®šç¾©æ–‡ç« å…§çš„åºè™Ÿã€‚é€™æ˜¯ç”¨æˆ¶å‘½ä»¤ï¼Œç”¨ä¾†è¨˜éŒ„é¸é …(å®šç¾©é¸é …åˆ—è¡¨)
  \expandafter\gdef\csname close:\romannumerals\cnt_closetest\endcsname{#1}%
  % cnt_closetest ç”¨æ–¼æ¨™è¨˜é¸é …åˆ—è¡¨ï¼Œæœƒéš¨è‘—é¸é …é¡Œç›®å¢åŠ ï¼Œç„¡è«–æ˜¯å¦å•“ç”¨é‡ç½®ï¼Œè©²è¨ˆæ•¸å™¨éƒ½æœƒè¨˜éŒ„ä¸¦è‡ªå¢
  % åœ¨ç”Ÿæˆé¸é …åºåˆ—æ™‚ï¼Œè©²è¨ˆæ•¸å™¨å¯ä»¥é€²è¡Œï¼š(1) æ˜¯å¦è¨­ç½®äº†é¸é … (2) éå¢å‡ºé¸é …åºåˆ—
  % è©²è¨ˆæ•¸å™¨å±¬æ–¼å±€åŸŸï¼Œæ¯ç¯‡æ–‡ç« éƒ½æœƒé‡ç½®å› 1ã€‚
  \ifclose_counter_reset%
    \begingroup%
      \switchtocolor[\closeparameter{barcolor}]%
      \closeparameter{barstyle}%
      \closebar{\number\cnt_closetest}%
    \endgroup%
  \else%
    \begingroup\let\par\relax% å°‡å…¶å°è£åœ¨å±€åŸŸï¼Œé¿å… par å‘½ä»¤å¤±æ•ˆ
      \switchtocolor[\closeparameter{barcolor}]%
      \closeparameter{barstyle}%
      \startitemgroup[env_question][n,continue,text,nostopper]%
                                   [lefttext=\closebar,righttext=]%
      \item \save_question_order%
      \stopitemgroup%
    \endgroup%
  \fi\advance\cnt_closetest by 1\relax}

\def\docloseitem#1{\startcitem #1\stopcitem}
\def\close_order{%é¸é …å‰çš„åºè™Ÿæ¨£å¼ï¼Œåºè™Ÿé€šé tempa è¨­å®š
  \noindent\unskip%
  \inframed[width=\closeparameter\c!width,
            frame=\closeparameter\c!frame,
            foreground=color,
            foregroundcolor=\closeparameter\c!color,
            foregroundstyle=\closeparameter\c!style]{%
    \convertnumber{n}{\number\cnt_closetest_tempa}%
    \closeparameter\c!stopper%
    \increaseQuestionID%
    \installpointoranswer[close][answer]}%
  \hskip\closeparameter\c!distance\relax
  \global\advance\cnt_closetest_tempa by 1\relax
  \unskip}

\def\placeclosechoice{%
  \ifnum\cnt_closetest=1\relax
        \color[red]{it seems that there is no
                    "closechoice" be setted,
                    please check it!}%
  \fi%
  \scratchcounter\numexpr\cnt_closetest-1\relax
  \cnt_closetest=1\relax%
  \def\closetest_list{\csname close:\romannumerals\cnt_closetest\endcsname}%
  \useclosestyleandcolor\c!style\c!color%
  \dorecurse{\number\scratchcounter}{%
    \hbox{%
      \hsize=\textwidth%
      \edef\currentitemnumber{\the\cnt_closetest_tempa}
      \edef\currentcloseuserorder{%
        \number\cnt_closetest_tempa%æ”¾ç½®åœ¨é€™è£¡æ‰èƒ½æ­£ç¢ºç²å–é¡Œè™Ÿ
        \ifnum\rawcountervalue[Unicode_botlevel]=0\relax\else% æŠ½å‡º order å®šç¾©ï¼Œ
        (\rawcountervalue[Unicode_botlevel])\fi}% å› ç‚ºè©²ç’°å¢ƒæ²’æœ‰ä¸Šç´š question ç’°å¢ƒ
      \hbox{\close_order}
      \hbox{%
        \vtop{%
          \startchoice%
            \processcommacommand[\closetest_list]\docloseitem%
          \stopchoice%
        }
      }
    }%
  \advance\cnt_closetest by 1\relax}%
  \cnt_closetest=1\relax%
}

\tolerant\protected\def\startclose[#1]{\begingroup%
  \env_closetrue\set_envitem_counter%%
  \iffirstargument\setupclose[#1]\fi%
  \edef\p_reset{\closeparameter\c!reset}
  \ifx\p_reset\s!true%
       \close_counter_resettrue%
  \else\close_counter_resetfalse\fi%
  \restore_question_order%
  \ifclose_counter_reset\cnt_closetest_tempa=1\relax\else%
    \cnt_closetest_tempa=\number\scratchcounter%tempa æ ‡è®°æ–‡ç« å†…çš„åºå·å’Œé€‰é¡¹å‰çš„åºå·
    \cnt_closetest_tempa=\numexpr\cnt_closetest_tempa+1\relax
  \fi\closeparameter\c!before%
}
\def\stopclose{%
  \closeparameter\c!after%
  \placeclosechoice%
  \endgroup%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{è¨­ç½® optclose ç’°å¢ƒ}
%D è©²ç’°å¢ƒæ˜¯ close ç’°å¢ƒçš„è®Šé«”ï¼Œä½†ç›®å‰ä¸¦æœªå°è©²ç’°å¢ƒé€²è¡Œæ›´å¤šçš„è¨­ç½®ã€‚
%D è©²ç’°å¢ƒçš„ä¸»è¦å‘½ä»¤æœ‰å…©å€‹ï¼š
%D \tex{startoptclose} å’Œ \tex{stopoptclose} ç”¨ä¾†å‰µå»ºè©²ç’°å¢ƒï¼Œ
%D \tex{ocitem} ç”¨ä¾†æ¨™è¨˜ç’°å¢ƒå…§çš„é¸é …ï¼Œè©²å‘½ä»¤éš¨è¡Œæ–‡æ”¾ç½®å³å¯ã€‚
%D \tex{ocitem[answer=blabla]}\type{blablabla}

%D æ­¤å¤–ï¼Œé‚„æœ‰ä¸€å€‹ç‰¹æ®Šçš„å‘½ä»¤ï¼Œ\tex{specialocitem} åƒ…å…·æœ‰ answer éµå€¼ã€‚å¯ä»¥é€šé
%D \tex{setupocitem} ä¾†èª¿æ•´è©²å‘½ä»¤çš„æ¨£å¼ã€‚è©²å‘½ä»¤æ¨™è¨˜ç­”æ¡ˆï¼Œä¸”ç„¡é ˆä»»ä½•ç’°å¢ƒåŒ…è£¹ã€‚

\setupocitem [%answer=,
              %color=,
              %point=,
              %showanswer=false,
              answerprelabel={answer: },
              answercolor=red,answerstyle=\ss,]

\tolerant\protected\def\startoptclose[#1]{%
  \begingroup\env_closetrue\set_envitem_counter%%
  \iffirstargument\setupclose[#1]\fi%
  \edef\p_reset{\closeparameter\c!reset}%
  \ifx\p_reset\s!true\resetcounter [itemgroup:env_question]\fi%
  \useclosestyleandcolor\c!style\c!color%
  \startitemgroup[env_question][n,continue,text,nostopper][lefttext=\closebar,righttext=]%
  \leftskip=0pt\relax\set_count_envlevel[env_question:1][question]}

\def\stopoptclose{\stopitemgroup\endgroup}

\tolerant\protected\def\ocitem[#1]#:#2%
   {\begingroup%
    \iffirstargument\setupocitem[#1]\fi%
    \useocitemstyleandcolor\c!style\c!color%
    \let\par\relax\increaseQuestionID%                 %%% å¿…é ˆå‘½ä»¤ï¼Œè‡ªå¢åºè™Ÿä»¥å‚™èª¿ç”¨
    \item \parentitemnumber=\currentitemnumber\relax
          \set_count_itemlevel[env_question:2][ocitem]%%%% å¿…é ˆå‘½ä»¤ï¼Œè¨­å®šåºè™Ÿ
          % æ³¨æ„ï¼Œæ­¤æ—¶ toplevel å¹¶æ²¡æœ‰æ­£ç¡®çš„å…³é—­ï¼Œå› æ­¤æœ€ç»ˆçš„ç»“æœä¾ç„¶æ˜¯ toplevelã€‚
          % ä½†æ˜¯è¯¥ç¯å¢ƒæœ¬èº«å°±è¢«è§†ä¸º toplevel                =>  5
          % å¦‚æœè¯¥ç¯å¢ƒè¢«è§†ä¸ºå­é¡¹ç›®æ—¶ï¼Œåˆ™éœ€è¦å…³é—­ toplevelã€‚==> 5(1)
          % å¦å¤–ï¼Œå…³é—­ toplevel éœ€è¦åœ¨ set_count_itemlevel å‘½ä»¤ä¹‹å‰æ‰ä¼šç”Ÿæ•ˆã€‚
          \allowbreak\doifsomethingelse{#2}{(#2)}{}%
          \installpointoranswer[ocitem][point]%
          \installpointoranswer[ocitem][answer]%
          \installdatacollector%             %%% å¿…é ˆå‘½ä»¤ï¼Œè¨­å®šå¯èª¿ç”¨ä¿¡æ¯
          \save_question_order%
  \endgroup}

\tolerant\protected\def\specialocitem[#1]{%
  \begingroup\let\par\relax%
  \iffirstargument\setupocitem[#1]\fi%
  \useocitemstyleandcolor\c!style\c!color%
  \startitemgroup[env_question][n,continue,text,nostopper][lefttext=\closebar,righttext=]%
  \item \parentitemnumber=\currentitemnumber\relax
        \increaseQuestionID%
        %\installpointoranswer[ocitem][point]%
        \set_count_itemlevel[env_question:2][ocitem]%
        % å…³äº toplevel çš„é—®é¢˜å‚è§ ocitem çš„è§£é‡Šã€‚
        % æ˜¯å¦éœ€è¦è®¾ç½®å­é¡¹ç›®è¿˜æœ‰å¾…è€ƒè™‘ã€‚
        \installpointoranswer[ocitem][point]%
        \installpointoranswer[ocitem][answer]%
        \installdatacollector%
        \save_question_order%
  \stopitemgroup\removeunwantedspaces\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{score}
%D æ”¾ç½®åœ¨ answer ç’°å¢ƒå…§æ¨™è¨˜å¾—åˆ†ã€‚

%D \starttyping
%D   score\score{3}\\
%D   score\score[type=dotfill]{30}\\
%D   \resetscore\\
%D   score\score[type=cdotfill]{30}\\
%D   \setupscore[score=calculation]
%D   score\score[type=space]{3}\\
%D   score\score[type=hfill]{3}\\
%D \stoptyping

\newcount\cnt_step_score
\def\score_calc#1{% only show number
  \newcount\cnt_step_score_temp%
  \global\cnt_step_score_temp=#1\relax%
  \ifnum\cnt_step_score=0\global\cnt_step_score=#1\relax\else%
  \global\cnt_step_score=\numexpr\cnt_step_score+\cnt_step_score_temp\relax%
  \fi\number\cnt_step_score%
}
\def\dotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil.\hfil}%
  \hfill\kern 0pt\relax}
\def\cdotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil$\cdot$\hfil}%
  \hfill\kern 0pt\relax}

\installnamespace                 {score}
\installcommandhandler \????score {score} \????score
\setupscore[style=\ssa,color=red,dotstyle=\ss,dotcolor=red,score=]

\tolerant\protected\def\score[#1]#:#2{\begingroup% format style
  \iffirstargument\setupscore[#1]\fi%
  \scoreparameter\c!before%
  \usescorestyleandcolor\c!style\c!color%
  \start\space\scoreparameter{dotstyle}%
  \switchtocolor[\scoreparameter{dotcolor}]%
  \doif{\scoreparameter\c!type}{}{\dotfill}%
  \doif{\scoreparameter\c!type}{space}{}%
  \doif{\scoreparameter\c!type}{hfill}{\unskip\hfill}%
  \doif{\scoreparameter\c!type}{dotfill}{\dotfill}%
  \doif{\scoreparameter\c!type}{cdotfill}{\cdotfill}%
  \space\stop\scoreparameter\c!left%
  \doif{\scoreparameter{score}}{}           {#2}%
  \doif{\scoreparameter{score}}{default}    {#2}%
  \doif{\scoreparameter{score}}{calculation}{\score_calc{#2}}%
  \doif{\scoreparameter{score}}{complex}    {#2 : \score_calc{#2}}%
  \scoreparameter\c!right\scoreparameter\c!after%
\par\endgroup}
\def\resetscore{%
  \cnt_step_score_temp=0\relax%
       \cnt_step_score=0\relax%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\installnamespace          {writingbox}
\installcommandhandler \????writingbox    {writingbox}    \????writingbox
\setupwritingbox[row=10,column=18,width=2em,height=2em,midheight=1em]
\newcount \tbl_row
\newcount \tbl_col
\def\makewritingbox{\dosingleempty\makewritingbox_indeed}
\def\makewritingbox_indeed[#1]{\begingroup%
    \tbl_row=\writingboxparameter{row} % yoko
    \tbl_col=\writingboxparameter{column} % tate
    \setupTABLE[split=yes]
    \setupTABLE[column][width=\writingboxparameter{width}]
    \setupTABLE[row][odd][height=\writingboxparameter{midheight}]
    \setupTABLE[row][even][height=\writingboxparameter{height}]
    \bTABLE
        \bTR \bTD[nc=\number\tbl_col] {} \eTD \eTR
        \dorecurse{\number\tbl_row}{
        \bTR
            \dorecurse{\number\tbl_col}{\bTD {} \eTD}
        \eTR
        \bTR \bTD[nc=\number\tbl_col] {} \eTD \eTR}
    \eTABLE
\endgroup}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{æ¨¡æ‹Ÿä¾‹å­}

\dorecurse{2000}{% æé«˜è¿™ä¸ªæ•°å­—ï¼Œå¯ä»¥æå‡å¯ç”Ÿæˆä¾‹å­çš„æ€»æ•°ã€‚æ‰€æœ‰ä¾‹å­å…±ç”¨ä¸€ä¸ªæ€»æ•°
\expandafter\getrandomnumber \csname n_\romannumeral\recurselevel\endcsname  {1} {20}}

\dorecurse{2000}{% ä¸€æ—¦æ€»ä¾‹å­æ•°è¶…è¿‡ï¼Œåˆ™æ— æ³•ç»§ç»­ç”Ÿæˆï¼Œå¹¶æŠ›å‡ºé”™è¯¯ã€‚
\expandafter\getrandomnumber \csname nn_\romannumeral\recurselevel\endcsname {1} {20}}

\def\longtesttxt[#1]{%%1. \longtesttxt[\romannumeral 1]
  \ifcase\csname n_#1\endcsname%
    å°±åƒæŒ‰ S æ¥å“åº”é”™è¯¯ä¸€æ ·ã€‚\or%0
    è¿™ä¸ªä¾‹å­ä¸å¤ªå®Œæ•´ï¼Œå› ä¸ºé¡µç æ²¡æœ‰å­˜å‚¨åœ¨æœ‰ç”¨çš„åœ°æ–¹ã€‚\or%1
    TeX å¤„ç†æ•°å­¦æ˜¾ç¤ºåï¼Œå®ƒå°†ä»¥ä¸‹é¡¹ç›®æ·»åŠ åˆ°å½“å‰å‚ç›´åˆ—è¡¨ä¸­ï¼š æƒ©ç½šã€èƒ¶æ°´ã€å®é™…æ˜¾ç¤ºã€èƒ¶æ°´å’Œæƒ©ç½šã€‚\or%2
    ç„¶è€Œï¼Œå®ƒæ˜¾ç¤ºäº†ä¸€ç§å¢åŠ æˆ–å‡å°‘è®¡æ•°å™¨çš„æ–¹æ³•ï¼Œå¹¶è®¾ç½®æ•°å­—ä¸­çš„æ•°å­—æˆ–ç›¸å½“äºæ•°å­—çš„ç½—é©¬æ•°å­—ä¸­çš„å­—æ¯ã€‚\or%3
    åŸºæœ¬é—®é¢˜æ˜¯ â€œå¯¹ TeXbook çš„é¡µé¢å¼•ç”¨åº”è¯¥å¦‚ä½•å‡ºç°åœ¨å‚è€ƒé¡µé¢çš„æè¿°åŒºåŸŸä¸­ï¼Ÿâ€ è¿™ä¸ªä¾‹å­æ˜¾ç¤ºäº†ä¸‰ç§å¯èƒ½æ€§ã€‚\or%4
    æ­£å¦‚ TeX ä¸ä¼šéšæœºè¿å­—ç¬¦å•è¯ä¸€æ ·ï¼Œå®ƒä¹Ÿä¸ä¼šåœ¨æ®µè½ä¸­çš„è¡Œä¹‹é—´éšæœºæ‰“æ–­æ•°å­¦è¡¨è¾¾å¼ã€‚\or%5
    TeX ä»…è€ƒè™‘åœ¨å…³ç³»ï¼ˆä¾‹å¦‚ = æˆ– < ï¼‰æˆ–äºŒè¿›åˆ¶æ“ä½œï¼ˆä¾‹å¦‚ + æˆ– Ã— ï¼‰ä¹‹åè¿›è¡Œä¸­æ–­ã€‚\or%6
    æ­¤å‘½ä»¤æä¾›å¯¹å½“å‰å­—ä½“ä¸­æ‰€æœ‰å­—ç¬¦çš„è®¿é—®ã€‚å·ç åº”è¯¥åœ¨ 0 -- 255 èŒƒå›´å†…ã€‚\or%7
    Junkjunk.texæ–‡ä»¶ä¸åŒ…å«ä»»ä½•æœ‰ç”¨çš„ä¸œè¥¿ï¼Œä½†è¿™äº›è¡Œè¯´æ˜äº†ä¸€ç§è¯»å–è¾…åŠ©æ–‡ä»¶çš„æ–¹æ³•ã€‚\or%8
    æ­¤å‘½ä»¤å°†æ¡†å¯„å­˜å™¨ä¸­çš„åˆ—è¡¨å‰¯æœ¬æ·»åŠ åˆ°å½“å‰åˆ—è¡¨ä¸­ã€‚\or%9
    è¯·æ³¨æ„ï¼Œæ¯ä¸ªå¯„å­˜å™¨åœ¨åˆ›å»ºåéƒ½ä¼šè¢«åˆå§‹åŒ–ã€‚\or%0
    æ­¤å‘½ä»¤æä¾›äº†ä¸€ç§ç›´æ¥æŒ‡å®šåˆ†éš”ç¬¦çš„æ–¹æ³•ã€‚\or%1
    æ•°å­—åº”è¯¥æ˜¯ä¸ƒä¸ªåå…­è¿›åˆ¶æ•°å­—ã€‚\or%2
    å®ƒçš„å‰å¯¼æ•°å­—å¿…é¡»åœ¨ 0-7 èŒƒå›´å†…ã€‚è¯¥æ•°å­—ç”¨ä½œç±»å·ï¼Œå…¶ä½™å…­ä½æ•°å­—ç”¨ä½œ \type{\delcode} å€¼ã€‚\or%3
    Plain TeX æœ‰äºŒåå¤šä¸ªå®šä¹‰ï¼Œç±»ä¼¼äºï¼š`\type{\def\rceil{\delimiter"5265307 }}'ã€‚\or%4
    è¿™ä¸ªå®šä¹‰æ„å‘³ç€ \type{\rceil} åœ¨å®¶åº­5ï¼ˆå…³é—­ï¼‰ï¼Œå…¶å°å½¢å¼åœ¨å®¶åº­2ä½ç½®"65ï¼Œå…¶å¤§å½¢å¼åœ¨å®¶åº­3ä½ç½®"07"ã€‚\or%5
    \type{\Delimiter} æŒ‡å®šäº†ä¸€ä¸ªæ•°å­¦ç¬¦å·ï¼Œå¹¶ä»¥ä¸¤ç§æ–¹å¼å·¥ä½œã€‚\or%6
    å½“ TeX å¯»æ‰¾åˆ†éš”ç¬¦æ—¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨ \type{\left} ä¹‹åï¼‰ï¼Œå®ƒå¿½ç•¥äº†ç±»æ•°å­—ï¼Œå¹¶ä½¿ç”¨å‰©ä½™çš„å…­ä½æ•°å­—ä½œä¸º \type{\delcode}ã€‚\or%7
    ä½†æ˜¯ï¼Œå½“åˆ†éš”ç¬¦åœ¨å…¶ä»–ä¸Šä¸‹æ–‡ä¸­å‡ºç°æ—¶ï¼Œå³ä¸‰ä½æ•°å­—è¢«åˆ é™¤ï¼Œå…¶ä½™å››ä½æ•°å­—æˆä¸ºç¬¦å·çš„ \type{\mathcode}ã€‚\or%8
    å¯¹äº \type{\rceil}ï¼Œè¿™æ„å‘³ç€ \type{\delcode} æ˜¯"265307ï¼Œ\type{\mathcode} æ˜¯"5265"ã€‚\or%9
    å®ƒé¦–å…ˆè®¡ç®—å­å…¬å¼åœ¨è½´ä¸Šæ–¹å’Œä¸‹å»¶ä¼¸çš„è·ç¦»ã€‚æ¥ä¸‹æ¥ï¼Œå®ƒä½¿ y ç­‰äºåˆšåˆšè®¡ç®—çš„æœ€å¤§è·ç¦»çš„ä¸¤å€ã€‚\fi}

\def\shorttesttxt[#1]{%%1. \shorttesttxt[i]
  \ifcase\csname nn_#1\endcsname%
    æ‚¬æŒ‚å‹ç—•çš„æ•°é‡\or%0
    æ®µè½ä¸­æ­£çº¿çš„å®½åº¦\or%1
    å¼€å§‹ä¸€ä¸ªæ²¡æœ‰ç¼©è¿›çš„æ–°æ®µè½\or%2
    å‘Šè¯‰TeXå°è¯•å¢åŠ æˆ–å‡å°‘æ®µè½ä¸­çš„è¡Œæ•°\or%3
    æ‰©å±•ä»¤ç‰Œï¼Œä½†åœ¨åˆ°è¾¾éç©ºé—´ä»¤ç‰Œä¹‹å‰ä»€ä¹ˆéƒ½ä¸åš\or%4
    åªæœ‰å½“ä¸»å‚ç›´åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œå®ƒæ‰ä¼šç»“æŸå½“å‰å·¥ä½œ\or%5
    è¯¥å‘½ä»¤åœ¨å†…éƒ¨å‚ç›´æ¨¡å¼ä¸‹æ˜¯ä¸å…è®¸çš„\or%6
    ä»»æ„ä¸­æ–­ç”±ä¸‰ä¸ªå­—ç¬¦åºåˆ—ç»„æˆ\or%7
    å¦ä¸€ä¸ªæ— æ•ˆå·ç è¢«ä¼ é€’äº†\or%8
    æ¥è‡ªå‡éƒ¨åˆ†çš„æ¡ä»¶å‘½ä»¤\or%9
    çº¿è·¯éœ€è¦è½¬ç§»çš„é‡‘é¢\or%0
    ç”¨äºæŒ‡å®šæ˜¾ç¤ºæ ·å¼\or%1
    å…³ç³»åæ–­çº¿çš„æƒ©ç½š\or%2
    æ­¤å‘½ä»¤å®šä¹‰äº†å®\or%3
    å®¶åº­çš„è„šæœ¬å­—ä½“\or%4
    å°ºå¯¸æ²¡æœ‰å˜åŒ–\or%5
    é¢å¤–çš„ç©ºé—´\or%6
    å·¦è¾¹çš„æ®µè½\or%7
    å½“å‰çº¿å®½\or%8
    æ–‡æœ¬æ ·å¼\or%9
    åºåˆ—\fi}

\def\choicenum[#1][#2][#3]{
  \ifnum\csname nn_#1\endcsname < 6
    \expandafter\startcitem[*]{\shorttesttxt[\romannumeral #2]}  \stopcitem
  \else
    \expandafter\startcitem{\shorttesttxt[\romannumeral #3]}  \stopcitem
  \fi
}

\newcount\LNUM\LNUM=1\relax
\newcount\CNUM\CNUM=1\relax
\newcount\DNUM\DNUM=1\relax
\newcount\ENUM\ENUM=2\relax

\def\example@choice#1{
    \setupquestion[point=2]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax\global\advance\DNUM by 2\relax\global\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \stopchoice
            \startanswer
            \input knuthmath
            \stopanswer
    \stopquestion}
}
\def\example@fillin#1{
    \setuppitem   [point=3]
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem
          \ifmode_showanswer DDD \else XXXX\fi
          \longtesttxt[\romannumeral\CNUM]\fillin[]{\fillinanswer}
        \stoppitem
        \startanswer
              \ifmode_showanswer DDD \else XXXX\fi
              \input knuthmath
            \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@pitem#1{
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem[answer={answer : \recurselevel},point={\number\CNUM\relax}]
        \longtesttxt[\romannumeral\CNUM]\stoppitem
        \startanswer
              \input knuthmath
        \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@material#1{
    \startmaterial
    \input knuthmath
    \stopmaterial
    \setupquestion[point=6]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax%
            \global\advance\DNUM by 2\relax%
            \global\advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \stopchoice
            \startanswer
              \input knuthmath
            \stopanswer
    \stopquestion}
}
\def\example@close#1{
    \startclose
    \def\closechoicex{\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\closechoice[\closechoicex,{[*]\closechoicex},\closechoicex]
      \longtesttxt[\romannumeral\CNUM]}
    \stopclose
}

\def\example@optclose#1{
    \startoptclose
    \def\closechoicex{{\ss\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\ocitem[answer={\shorttesttxt[\romannumeral\DNUM]}]{\closechoicex,\closechoicex,\closechoicex}
      \longtesttxt[\romannumeral\CNUM]}
    \stopoptclose
}

\def\example@specialoptclose#1{
    \def\closechoicex{\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\specialocitem[answer={\closechoicex}]
      \longtesttxt[\romannumeral\CNUM]}
}

%\setupanswer[showanswer=true,showscript=true,
%              frame=on,framecolor=red,
%              rulethickness=2pt,
%              scriptcontent={\null\vbox to 4\baselineskip{}\relax}]
%\chapter{}
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%%
%\chapter{}
%
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%\page
%\dorecurse{30}{\typeanswerbychap{1}\par}
%\resetanswerid%
%\dorecurse{30}{\typeanswerbychap{2}\par}
%\resetanswerid
%\noindent\typeanswerlist[1][6]{30}
%\resetanswerid
%\noindent\typeanswerlist[2][6]{30}
%\type@answer@i[6*5,1,28]

\newcount\qid_in_chap\qid_in_chap=1\relax
\def\resetanswerid{\qid_in_chap=1\relax}
\def\typeanswerbychap{\dosingleempty\typeanswerbychap_indeed}
\def\typeanswerbychap_indeed[#1]#2{% #1 = chapter numberï¼Œè©²å‘½ä»¤æœƒè‡ªè¡Œéå¢è¨ˆæ•¸å™¨ä¾†ç²å–ç­”æ¡ˆ
  \iffirstargument\qid_in_chap=#1\relax\fi%
  \datasetvariable{Answer_collector}{#2-\the\qid_in_chap}{answer}%
  \advance\qid_in_chap by 1\relax}
\def\typeanswerdirect#1{% #1 = qidï¼Œéœ€è¦è‡ªè¡Œè¼¸å…¥ä¾†ç²å–æŸå€‹é¡Œç›®çš„ç­”æ¡ˆ
  \datasetvariable{Answer_collector}{#1}{answer}}
\def\typeanswerlist{\dodoubleempty\typeanswerlist_indeed}
\def\typeanswerlist_indeed[#1][#2]#3{%#1 = chapter number
  \ifsecondargument\qid_in_chap=#2\fi% #2 = from which question to start
  \dorecurse{#3}{% answer amount
    \datasetvariable{Answer_collector}{#1-\the\qid_in_chap}{answer}%
  \advance\qid_in_chap by 1\relax}
}

\newcount\answer@seq@tempa\answer@seq@tempa=0\relax%
\newcount\answer@seq@tempb\answer@seq@tempb=0\relax%
\newcount\answer@seq@tempc
\def\type@answer@i[#1*#2,#3,#4]{% #1 for row #2 for column %
                                % #3 chapter number #4 last answer id%
  \answer@seq@tempc=\numexpr#4-1\relax%
    \bTABLE
      \dorecurse{#1}{\bTR
        \dorecurse{#2}{%
        \ifnum\answer@seq@tempa>\answer@seq@tempc \bTD\eTD\relax\else%
              \advance\answer@seq@tempa by 1\relax%
                \expanded{\bTD
                  \datasetvariable{Answer_collector}{#3-\the\answer@seq@tempa}{userorder}
      \eTD}\fi}
      \eTR\bTR
        \dorecurse{#2}{%
          \ifnum\answer@seq@tempb>\answer@seq@tempc \bTD\eTD\relax\else%
        \advance\answer@seq@tempb by 1\relax%
            \expanded{\bTD
            \datasetvariable{Answer_collector}{#3-\the\answer@seq@tempb}{answer}
        \eTD}\fi}
      \eTR}
    \eTABLE
}

\def\type@answer@ii{
\answer_seq=0\relax
\bTABLE
\dorecurse{4}{\bTR
  \dorecurse{5}{
        \advance\answer_seq by 1\relax%
            \expanded{\bTD\the\answer_seq\eTD}
      \expanded{\bTD
        \datasetvariable{Answer_collector}{\the\answer_seq}{answer}
    \eTD}}
\eTR}
\eTABLE}
%\type@answer@i{4}{5}{18}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{æ¨¡å¼è¨­ç½®}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definemode[teacher][keep]
\definemode[student][keep]
\definemode[check]  [keep]
\startmode[teacher]
  \mode_showanswertrue
  \mode_showpointtrue
  \setupquestion[showanswer=true,showpoint=true]
  \setupchoice  [showanswer=true,showpoint=true]
  \setupcitem   [showanswer=true,showpoint=true]
  \setuppitem   [showanswer=true,showpoint=true]
  \setupclose   [showanswer=true,showpoint=true]
  \setupocitem  [showanswer=true,showpoint=true]
  \setupanswer  [showanswer=true,showpoint=true,showscript=false]
\stopmode
\startmode[student]
  \mode_showanswerfalse
  \mode_showpointfalse
  \setupquestion[showanswer=false,showpoint=true]
  \setupchoice  [showanswer=false,showpoint=true]
  \setupcitem   [showanswer=false,showpoint=true]
  \setuppitem   [showanswer=false,showpoint=true]
  \setupclose   [showanswer=false,showpoint=true]
  \setupocitem  [showanswer=false,showpoint=true]
  \setupanswer  [showanswer=false,showpoint=true,showscript=false]
\stopmode
\startmode[check]
  \mode_checktrue
\stopmode
\def\showanswer{\mode_showanswertrue\setupanswer[showscript=false]}
\def\hideanswer{\mode_showanswerfalse\setupanswer[showscript=true]}
\let\showpoint\mode_showpointtrue
\let\hidepoint\mode_showanswerfalse
\let\showchekinfo\mode_checktrue
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\protect
\stopmodule
\endinput