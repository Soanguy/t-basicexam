%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \module
%D   [     file=t-basicexam,
%D      version=2024-10-24,
%D        title=basicexam,
%D     subtitle=Memoir Ever,
%D       author=ÂïÜÊó†Ëæõ(Shueng Mosan),
%D         date=2024-6-1,
%D    copyright=ÂïÜÊó†Ëæõ(Shueng Mosan),
%D      license=,
%D          url=]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\startmodule[basicexam]
\unprotect
%D \placecontent
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Ê®°Â°äÂèÉÊï∏ / Module Setups / „É¢„Ç∏„É•„Éº„É´„ÄÄ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó}

%D \starttabulate[|r|lB|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC mode=   \NC student \NC will show point and hide answer                \NC\NR
%D \NC mode=   \NC teacher \NC will show point and answer                     \NC\NR
%D \NC mode=   \NC check   \NC will show some infos to console                \NC\NR
%D \HL
%D \NC layout= \NC twoup   \NC print two virtual pages on each physical page. \NC\NR
%D \NC layout= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \NC footer= \NC default \NC show subject and page at footer                \NC\NR
%D \NC footer= \NC none    \NC donothing                                      \NC\NR
%D \HL
%D \stoptabulate

\setupmodule[mode=student,layout=default,footer=none]
% \doifnotmode{mkiv}{\writestatus{error}{needs luatex}\wait\end}% check context version

% 1 for module
% 2 for question
% 3 for papertitle
% 9 for font

\startinterface english
  \setinterfacemessage{basicexam}{1}{There are unknown parameters in --, please check.}
  \setinterfacemessage{basicexam}{2}{Question (--): answer is (--).}
  \setinterfacemessage{basicexam}{3}{You defined --, but you don't assign a value to it. Please check.}
  \setinterfacemessage{basicexam}{9}{-- is not installed, some -- will not display properly.}
\stopinterface

% \showmessage{basicexam}{2}{}%

\newif\iflay_twoup   \lay_twoupfalse
\newif\ifhdr_default \hdr_defaultfalse

\processallactionsinset[\currentmoduleparameter{mode}][
     teacher=>{\enablemode[teacher]},
     student=>{\enablemode[student]},
       check=>{\enablemode[check]},
  \v!default=>{\enablemode[student]},
  \v!unknown=>\showmessage{basicexam}{1}{mode},
]

\processallactionsinset[\currentmoduleparameter{layout}][
       twoup=>\lay_twouptrue,
        none=>\relax,
  \v!default=>\relax,
  \v!unknown=>\showmessage{basicexam}{1}{layout},
]

\processallactionsinset[\currentmoduleparameter{footer}][
        none=>{\relax},
  \v!default=>\hdr_defaulttrue,
  \v!unknown=>\showmessage{basicexam}{1}{footer},
]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Ê≥®ÊÑè ‚ö†Ô∏è
%% Âú®ÂÆö‰πâÂëΩ‰ª§Êó∂ÔºåÂèÇÊï∞Âêé‰∏çÂèØ‰ª•Áõ¥Êé•Êñ≠Ë°åÔºå‰ºöÂØºËá¥ÂèÇÊï∞Êü•ÊâæÂ§±Ë¥•„ÄÇ
%%ÔºàÂèØËÉΩÊòØÂõ†‰∏∫ tex ËÆ§‰∏∫ÂèÇÊï∞ÂêéÊñ≠Ë°åÔºåÂàôÂèÇÊï∞ÁöÑÁªìÊùüÂàÜÁïåÁ¨¶‰∏∫Êñ≠Ë°åÔºåËÄåÈùûÊã¨Âè∑Ôºâ
%% \def\foo#1{ .. some word ...}   \foo{..} Â∞ÜÊ≠£Á°ÆËøêË°å
%% \def\foo#1
%%     { .. some word ...}         \foo{..} Â∞ÜÂØºËá¥Â§±Ë¥•
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Ê≥®ÊÑè ‚ö†Ô∏è
%% Âú® lua ‰∏≠‰ΩøÁî® Âæ™ÁéØ Á≠âÁªìÊûÑÊó∂ÔºåË¶ÅÊ≥®ÊÑè % ÁôæÂàÜÊØîÁ¨¶Âè∑ÁöÑ‰ΩøÁî®„ÄÇ‰∏çÂèØ‰ª•Áõ¥Êé•Âú®ÂÖ≥ÈîÆÂ≠óÂêé
%% ‰ΩøÁî®„ÄÇ‰ºöÂØºËá¥ËøêË°åÂá∫ÈîôÔºö'do' expected near 'docontext' Á≠âÊ∂àÊÅØ„ÄÇ
%% for i > 10 do % do Âíå % Âè∑‰πãÈó¥ÊúâÁ©∫Ê†ºÔºå  ‰ºöÊ≠£Â∏∏ËøêË°å
%% for i > 10 do%  do Âíå % Âè∑‰πãÈó¥Ê≤°ÊúâÁ©∫Ê†ºÔºå‰ºöËøêË°åÈîôËØØ
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%\newcount\itindexn \itindexn=1
%%\def\itvariable{\ifcase\itindexn%
%%                       \or a\or b\or c\or d\or e%
%%                       \or f\or g\or h\or i\or j%
%%                       \or k\or l\or m\or n\or o%
%%                       \or p\or q\or r\or s\or t%
%%                       \or u\or v\or w\or x\or y\or z
%%                \fi}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\begingroup
%\catcode`\%=12\relax
%\gdef\percentchar{%}
%\endgroup
%\ctxlua{context(string.format("\percentchar8s",456))}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Â∞öÊú™ËôïÁêÜÁöÑÁµÑÂêà„ÄÄ/ Command under handling / Êú™ÂÆåÊàê„ÅÆ„Ç≥„Éû„É≥„Éâ}

%D Ë®≠ÁΩÆÈ†ÅÈù¢
%D 2UP Printing
%D \starttyping
%D \setuppapersize[user pagesize][real pagesize,real orientation]
%D \setuparranging[page arrange method]
%D more info : https://wiki.contextgarden.net/Command/setuparranging
%D             https://wiki.contextgarden.net/Imposition
%D \stoptyping
%D ‰æãÂ¶ÇÔºö
%D \starttyping
%D \setuppapersize[A4][A3,landscape]
%D \setuparranging[2SIDE]%[2UP]
%D \setuppagenumbering[alternative=singlesided]%{doublesided}]
%D \stoptyping

\iflay_twoup
  \setuppapersize[A4][A3,landscape]
  \setuparranging[2SIDE]% 2SIDE start page at odd [2UP] start at even
  \setuppagenumbering[alternative={doublesided}]%singlesided]
\fi

%D \section{ÂÆö‰πâÂÖ∂ÂêéÁéØÂ¢ÉÊâÄÈúÄÂëΩ‰ª§}

%D ÂÆö‰πâÂÖ≥ÈîÆËØç
\startinterface all
\setinterfaceconstant {answer}         {answer}
\setinterfaceconstant {point}          {point}
\setinterfaceconstant {showanswer}     {showanswer}
\setinterfaceconstant {showpoint}      {showpoint}
\setinterfaceconstant {answerstyle}    {answerstyle}
\setinterfaceconstant {answercolor}    {answercolor}
\setinterfaceconstant {answerlabel}    {answerlabel}
\setinterfaceconstant {pointstyle}     {pointstyle}
\setinterfaceconstant {pointcolor}     {pointcolor}
\setinterfaceconstant {pointlabel}     {pointlabel}
\setinterfaceconstant {autoright}      {autoright}
\setinterfaceconstant {inlineleft}     {inlineleft}
\setinterfaceconstant {inlineright}    {inlineright}
\setinterfaceconstant {inlinechoice}   {inlinechoice}
\stopinterface
%D ÂÆâË£ÖÂÆö‰πâÂëΩÂêçÁ©∫Èó¥ÂíåÁéØÂ¢ÉÂä©Êâã
\installnamespace          {close}
\installcommandhandler \????close     {close}     \????close
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newif\ifmode_quickcheck     \mode_quickcheckfalse
\newif\ifmode_check          \mode_checkfalse
\newif\ifmode_showanswer     \mode_showanswerfalse
\newif\ifmode_showpoint      \mode_showpointfalse
\newif\ifmode_showscript     \mode_showscriptfalse
\newif\ifmode_example        \mode_examplefalse
\newif\ifenv_question        \env_questionfalse
\newif\ifenv_problem         \env_problemfalse
\newif\ifenv_choice          \env_choicefalse
\newif\ifenv_material        \env_materialfalse
\newif\ifenv_close           \env_closefalse
\newif\ifenv_writing         \env_writingfalse
\newif\ifenv_subwriting      \env_subwritingfalse
\newif\ifenv_answer          \env_answerfalse
\newif\ifenv_toplevel        \env_topleveltrue
\newif\ifenv_botlevel        \env_botlevelfalse
\newif\ifitem_pitem          \item_pitemfalse
\newif\ifitem_fillin         \item_fillinfalse
\newif\ifitem_inlinechoice   \item_inlinechoicefalse
\newif\ifchoice_check        \choice_checkfalse
\newif\ifcontinue_counter    \continue_counterfalse
\newif\ifclose_counter_reset \close_counter_resetfalse

\newdimen\d_width_cit
\newdimen\d_width_cit_max
\newdimen\d_compared_maxwidth
\newdimen\d_maxwidth_with_label
\newcount\c_currentitemnumber% Â∞ÅË£ùÂú® inititemnumber Âíå incrementitemnumber ‰∏≠
\newcount\c_totalitemnumber% Â∞ÅË£ùÂú® recurseditemnumber ‰∏≠
\newcount\c_steppoint% Â∞ÅË£ùÂú® install_point ÂëΩ‰ª§‰∏≠
\newcount\c_steppoint_temp
\newcount\c_stepscore
\newcount\c_stepscore_temp
\newcount\c_closetest
\newcount\c_closetest_tempa
\newcount\c_example_question
\newcount\c_envcounter_toggle
\newcount\c_fillin_number
\newcount\current_total_choice_number% Áï∂ÂâçÈÅ∏È†Ö ABCD Á∏ΩË®àÊï∏, Ëé∑ÂèñÂ∑≤ÁªèËÆ°ÁÆóÂêéÁöÑ totalitemnumber 
\newcount\current_available_columns%ÂèØÊéíÁâàÁöÑÊúÄÂ§öÂàóÊï∏
\newcount\parentitemnumber% \parentitemnumber ‰ºöÁ≠â‰∫éÁà∂Á∫ßÂàóË°®ÁéØÂ¢ÉÁöÑÂ∫èÂè∑

\definecounter[Unicode][way=bychapter]
\definecounter[Unicode_toplevel]        % for level 1 : question or problem
\definecounter[Unicode_midlevel]        % for level 2 : problem or level 1
\definecounter[Unicode_botlevel]        % for level 3 : only for level 2
\definecounter[strc_close_counter]      % ‰∏∫ close ÁéØÂ¢ÉÂèØ‰ª•ÁªßÁª≠ question Â∫èÂè∑ËÄåËÆæÁΩÆ

\def\inititemnumber{\c_currentitemnumber=0\relax\c_totalitemnumber=0\relax}
\def\incrementitemnumber{\global\advance\c_currentitemnumber by 1\relax}
\def\recurseditemnumber%%ÈÅûÊ≠∏Âá∫Á∏ΩÂ∫èËôü
  {\ifnum       \c_totalitemnumber > \c_currentitemnumber%
         \global\c_totalitemnumber = \c_totalitemnumber%
   \else \global\c_totalitemnumber = \numexpr\c_currentitemnumber\relax\fi}
%% ÈÄô‰∏âÂÄãÂëΩ‰ª§ÂèØ‰ª•ÈÅûÊ≠∏Â∞èÈ°åÁ∏ΩÊï∏Ôºå 
%% ‰ªñÂÄëÂàÜÂà•Â∞ÅË£ùÂú® set_envcounter, set_itemcount,installdatacollectorhelper ‰∏≠
\def\save_question_order{\setcounter[strc_close_counter][\currentitemnumber]\savecounter[strc_close_counter]}
\def\restore_question_order{\restorecounter[strc_close_counter]\scratchcounter\rawcountervalue[strc_close_counter]}
\def\EQuestionID{E-\somenamedheadnumber{chapter}{current}-\number\c_example_question}
\def\QuestionID{\ifmode_example\EQuestionID\else\somenamedheadnumber{chapter}{current}-\rawcountervalue[Unicode]\fi}
\def\HelperID{\namedheadnumber{chapter}-\rawcountervalue[Unicode_toplevel]}
\def\increaseEQuestionID{\advance\c_example_question by  1\relax}
\def\decreaseEQuestionID{\advance\c_example_question by -1\relax}
\def\increaseQuestionID{\ifmode_example\increaseEQuestionID\else\incrementcounter[Unicode]\fi}
\def\decreaseQuestionID{\ifmode_example\decreaseEQuestionID\else\decrementcounter[Unicode]\fi}

\definedataset[Answer_collector]
\definedataset[Answer_collectorhelper]
\definedataset[Subwriting_collector]

\definetextbackground[env_answer]
\defineitemgroup     [env_question]
\defineitemgroup     [env_problem]
\defineitemgroup     [env_choice]
\definebar           [fillin_text]
\definemarking       [title]
\definemarking       [subject]
\defineoverlay       [normalframeOL][\useMPgraphic{normalframeMP}]

\startuseMPgraphic{normalframeMP}
  draw unitsquare xyscaled (\overlaywidth, \overlayheight);
\stopuseMPgraphic
\startuseMPgraphic{rules:under:wave}
    vardef lsin primary x =
        lua("mp.print(math.sin(" & decimal x & "))")
    enddef ;
    draw function(1, "x", "lsin(1.2*x)", 0, RuleWidth, .1pt)
         shifted (0,RuleFactor*RuleOffset+RuleDepth)
         withpen pencircle scaled RuleThickness
         withcolor RuleColor ;
    setbounds currentpicture to unitsquare xysized(RuleWidth,RuleHeight) ;
\stopuseMPgraphic

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion [hiragana]      [„ÅÇ,„ÅÑ,„ÅÜ,„Åà,„Åä,„Åã,„Åç,„Åè,„Åë,„Åì,„Åï,„Åó,„Åô,„Åõ,„Åù,
                                   „Åü,„Å°,„Å§,„Å¶,„Å®,„Å™,„Å´,„Å¨,„Å≠,„ÅÆ,„ÅØ,„Å≤,„Åµ,„Å∏,„Åª,
                                   „Åæ,„Åø,„ÇÄ,„ÇÅ,„ÇÇ,„ÇÑ,„ÇÜ,„Çà,„Çâ,„Çä,„Çã,„Çå,„Çç,„Çè,„Çì]
\defineconversion [katakana]      [„Ç¢,„Ç§,„Ç¶,„Ç®,„Ç™,„Ç´,„Ç≠,„ÇØ,„Ç±,„Ç≥,„Çµ,„Ç∑,„Çπ,„Çª,„ÇΩ,
                                   „Çø,„ÉÅ,„ÉÑ,„ÉÜ,„Éà,„Éä,„Éã,„Éå,„Éç,„Éé,„Éè,„Éí,„Éï,„Éò,„Éõ,
                                   „Éû,„Éü,„É†,„É°,„É¢,„É§,„É¶,„É®,„É©,„É™,„É´,„É¨,„É≠,„ÉØ,„É≥]
\defineconversion [hiragana-iroha][„ÅÑ,„Çç,„ÅØ,„Å´,„Åª,„Å∏,„Å®,„Å°,„Çä,„Å¨,„Çã,„Çí,„Çè,„Åã,„Çà,
                                   „Åü,„Çå,„Åù,„Å§,„Å≠,„Å™,„Çâ,„ÇÄ,„ÅÜ,„Çê,„ÅÆ,„Åä,„Åè,„ÇÑ,„Åæ,
                                   „Åë,„Åµ,„Åì,„Åà,„Å¶,„ÅÇ,„Åï,„Åç,„ÇÜ,„ÇÅ,„Åø,„Åó,„Çë,„Å≤,„ÇÇ,
                                   „Åõ,„Åô,„Çì]
\defineconversion [katakana-iroha][„Ç§,„É≠,„Éè,„Éã,„Éõ,„Éò,„Éà,„ÉÅ,„É™,„Éå,„É´,„É≤,„ÉØ,„Ç´,„É®,
                                   „Çø,„É¨,„ÇΩ,„ÉÑ,„Éç,„Éä,„É©,„É†,„Ç¶,„É∞,„Éé,„Ç™,„ÇØ,„É§,„Éû,
                                   „Ç±,„Éï,„Ç≥,„Ç®,„ÉÜ,„Ç¢,„Çµ,„Ç≠,„É¶,„É°,„Éü,„Ç∑,„É±,„Éí,„É¢,
                                   „Çª,„Çπ,„É≥]
%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% ego=section isea=subsection
\definelabelclass [exam] [0]
\setuplabeltext   [cn]   [section={Á¨¨,ÈÉ®ÂàÜ},subsection={Á¨¨,ËäÇ}]
\setupexamtext    [cn]   [point={ÂàÜ}, answer={Á≠îÊ°à},  page={Á¨¨,È°µ},    totalpage={ÂÖ±,È°µ}]
\setupexamtext    [hans] [point={ÂàÜ}, answer={Á≠îÊ°à},  page={Á¨¨,È°µ},    totalpage={ÂÖ±,È°µ}]% work with memos module
\setupexamtext    [hant] [point={ÂàÜ}, answer={Á≠îÊ°à},  page={Á¨¨,È†Å},    totalpage={ÂÖ±,È†Å}]% work with memos module
\setupexamtext    [en]   [point={pts},answer={answer},page={pages},    totalpage={total,pages}]
\setupexamtext    [ja]   [point={ÁÇπ}, answer={Á≠î„Åà},  page={Á¨¨,„Éö„Éº„Ç∏},totalpage={ÂÖ±,„Éö„Éº„Ç∏}]

\definehead [tu]   [chapter]
\definehead [ego]  [section]       % me  latin
\definehead [isea] [subsection]    % he or she latin
\definehead [heu]  [subsubsection] % och
\setuphead  [tu]   [placehead=empty]
\setuphead  [ego]  [sectionsegments=section,style=\ssa]
\setupheads [isea] [style=\hwa]
\setupheads [tu,ego,isea]
                   [indentnext=yes,align=flushleft,
                   before={\blank[quarterline]},
                   after={\blank[quarterline]},
                   sectionconversionset=examnum]
\definelist[tu]
\setuplist [tu][style={\feature[+][tabularnumbers]}]
\definestructureconversionset[examnum][chinesenumerals][chinesenumerals]

\ifhdr_default
  \definedelimitedtext    [paren]   [location=text]
  \setupdelimitedtext     [paren:1] [left={Ôºà\nobreak}, right={\nobreakÔºâ}]
  \setupdelimitedtext     [paren:2] [left={\,[~}, right={~]\,}]
  \setupdelimitedtext     [paren:3] [left={\,\{~}, right={~\}\,}]
  \setupmarking[subject][expansion=yes]
  \setupfooter [state=start]
  \startsetups hdr:infos
  \framed[height=max,align=lohi,frame=off]{%
    \getmarking[subject][page][current]
    \paren{\examtexts{page}{\pagenumber},\ %
           \examtexts{totalpage}{\lastpagenumber}}%
    }
  \stopsetups
  \setupfootertexts[\setups{hdr:infos}]
\fi

%%%%% setupinfos ËÆæÁΩÆËØïÂç∑Êä¨Â§¥‰ø°ÊÅØÂíåÊ†ºÂºè
%D \section{Áπ™Ë£ΩÂç∑È†≠ / print title / „Çø„Ç§„Éà„É´„ÅÆ‰ΩúÊàê}
%D
%D The following command simply shows how to define, set and draw a new test paper information.

%D \startitemize[nowhite,packed,joinedup]
%D \item ÈÄöÈÅé \type{\definepapertitle[PaperTitleName]} ÂëΩ‰ª§ÂèØ‰ª•Êñ∞Âª∫Âç∑È†≠‰ø°ÊÅØÔºå
%D \item ÈÄöÈÅé  \type{\setuppapertitle[PaperTitleName]} ÂëΩ‰ª§ÂèØ‰ª•Ë®≠ÂÆöÂç∑È†≠‰ø°ÊÅØÔºå
%D \item ÈÄöÈÅé   \type{\makepapertitle[PaperTitleName]} ÂëΩ‰ª§ÂèØ‰ª•Áπ™Ë£ΩÂç∑È†≠ÁµêÊûú„ÄÇ
%D \stopitemize

%D \type{\definepapertitle} and \type{\setuppapertitle} accept one required and two optional parameters.
%D The first parameter is the name of the test paper.
%D The second parameter is the name of the parent test paper, which can be inherited by setting the parent.
%D The third parameter can directly set the relevant style and content.
%D The order can be set through ‚Äòlist‚Äô parameters.
%D The default order is ‚Äòsecret, title, subject, information, notice‚Äô.

%D Once you've defined the {\bf list} parameter, 
%D it will automatically expand the relevant parameters to define its style.
%D For example, if you define a {\bf title} parameter in the {\bf list}, 
%D it will automatically expand the following parameters:

%D \type{\setuppapertitle[list={title,and some other info}]}

%D \starttabulate[|r|l|l|]
%D \HL
%D \NC {\bf Value} \NC {\bf Value}   \NC \NC\NR
%D \HL
%D \NC title       \NC  titlealign   \NC \NC\NR
%D \NC titlestyle  \NC  beforetitle  \NC \NC\NR
%D \NC titlecolor  \NC  aftertitle   \NC \NC\NR
%D \HL
%D \stoptabulate

%D \startbuffer
%D  \definepapertitle[papertitles]
%D  \setuppapertitle [papertitles][
%D     list={secret,title,subject,information,notice},
%D     subjectsuffix=Â≠¶ÁßëËØïÂç∑,
%D     secretstyle=\ss,
%D     titlestyle=\ssa,
%D     subjectstyle=\ssb,
%D     informationstyle=\ttx,
%D     noticestyle=\rm\it,
%D     secretalign=flushleft,
%D     titlealign=center,
%D     subjectalign=center,
%D     informationalign=center,
%D     noticealign=flushleft,
%D     secret={ÁªùÂØÜ ‚òÖ ÂêØÁî®Ââç},
%D     title={2021 Âπ¥ÊôÆÈÄöÈ´òÁ≠âÂ≠¶Ê†°ÊãõÁîüÂÖ®ÂõΩÁªü‰∏ÄËÄÉËØï},
%D     subject={Êó•ËØ≠},
%D     information={ÊÄªÂàÜ:150 ÂàÜÔºåËÄÉËØïÊó∂Èó¥:120 ÂàÜÈíü},
%D     notice={Ê≥®ÊÑè‰∫ãÈ°πÔºö
%D       \startitemize[n,packed,joinedup]
%D         \item Á≠îÈ¢òÂâçÔºåÂä°ÂøÖÂ∞ÜËá™Â∑±ÁöÑÂßìÂêç„ÄÅÂáÜËÄÉËØÅÂè∑Â°´ÂÜôÂú®%
%D               Á≠îÈ¢òÂç°ËßÑÂÆöÁöÑ‰ΩçÁΩÆ‰∏ä„ÄÇ%
%D         \item Á≠îÈÄâÊã©È¢òÊó∂ÔºåÂøÖÈ°ª‰ΩøÁî® 2B ÈìÖÁ¨îÂ∞ÜÁ≠îÈ¢òÂç°‰∏äÂØπ%
%D               Â∫îÈ¢òÁõÆÁöÑÁ≠îÊ°àÊ†áÂè∑Ê∂ÇÈªë„ÄÇÂ¶ÇÈúÄÊîπÂä®ÔºåÁî®Ê©°ÁöÆÊì¶%
%D               Êì¶Âπ≤ÂáÄÂêéÔºåÂÜçÈÄâÊ∂ÇÂÖ∂ÂÆÉÁ≠îÊ°àÊ†áÂè∑„ÄÇÁ≠îÈùûÈÄâÊã©È¢ò%
%D               Êó∂ÔºåÂøÖÈ°ª‰ΩøÁî® 0.5 ÊØ´Á±≥ÈªëËâ≤Á≠æÂ≠óÁ¨îÔºåÂ∞ÜÁ≠îÊ°à%
%D               ‰π¶ÂÜôÂú®Á≠îÈ¢òÂç°ËßÑÂÆöÁöÑ‰ΩçÁΩÆ‰∏ä„ÄÇÊâÄÊúâÈ°åÁõÆÂøÖÈ°ªÂú®Á≠î%
%D               È¢òÂç°‰∏ä‰ΩúÁ≠îÔºåÂú®ËØïÈ¢òÂç∑‰∏äÁ≠îÈ¢òÊó†Êïà„ÄÇ %
%D         \item ËÄÉËØïÁªìÊùüÂêéÔºåÂ∞ÜËØïÈ¢òÂç∑ÂíåÁ≠îÈ¢òÂç°‰∏ÄÂπ∂‰∫§Âõû„ÄÇ
%D         \stopitemize},
%D     ]
%D  \makepapertitle [papertitles]
%D  %If you want, you can also change the key value directly here.like
%D  % \makepapertitle [papertitles][title=new paper title]
%D \stopbuffer
%D \typebuffer
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\installnamespace {papertitle}
\installnamespace {papertitlealternative}
\installnamespace {papertitlerenderings}

\installcommandhandler \????papertitle            {papertitle}            \????papertitle
\installcommandhandler \????papertitlealternative {papertitlealternative} \????papertitlealternative

\def\doifemptyelsex#1#2{\doifelse{#1}{}{#2}{#1}}
\def\definepapertitlevariable#1{\begingroup% #1=element name
    \parindent0pt\relax\par%
    \doifelse{\namedpapertitleparameter{\currentpapertitle}{#1align}}{}%
             {\setupalign[center]}%
             {\setupalign[\namedpapertitleparameter{\currentpapertitle}{#1align}]}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{before#1}}{}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1style}}{}%
    \expandafter\begincsname\namedpapertitleparameter{\currentpapertitle}{#1color}\endcsname
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{#1}}%
                   {\showmessage{basicexam}{3}{#1}}%
    \doifemptyelsex{\namedpapertitleparameter{\currentpapertitle}{after#1}}{}%
    \par\endgroup}

\tolerant\def\makepapertitle[#1][#2]%
  {\begingroup\cdef\currentpapertitle{#1}%
  \ifarguments\or\or\setuppapertitle[#1][#2]\fi
  \edef\currentpapertitlealternative{\papertitleparameter\c!alternative}%
  \ifcsname\currentpapertitlealternativehash\s!parent\endcsname \else
    \let\currentpapertitlealternative\s!default
  \fi
  \usesetupsparameter\papertitleparameter
  \edef\p_renderingsetup{\papertitlealternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \marking[subject]{\papertitleparameter{subject}
                    \papertitleparameter{subjectsuffix}}
  \marking[title]{\papertitleparameter\c!title}
  \endgroup}

%D At the same time, you can define your own test paper title template through {\bf alternative}.
%D here is an example for default alternative.

\definepapertitlealternative
  [\s!default]
  [\c!renderingsetup=\????papertitlerenderings:\s!default]

\startsetups[\????papertitlerenderings:\s!default]
  \edef\currentlist{\papertitleparameter\c!list}
  \edef\currenttitle{\papertitleparameter\c!title}
  \expandafter\expandafter\expandafter\tu\expandafter{\currenttitle}
  \processcommacommand[\currentlist]\definepapertitlevariable
\stopsetups

\setuppapertitle [
  \c!alternative=\s!default,
  subjectsuffix=Â≠¶ÁßëËØïÂç∑,
  list={secret,title,subject,information,signinformation,notice},
  ]
\setuppapertitle [
    secretstyle=\ss,
    titlestyle=\ssa,
    subjectstyle=\ssb,
    informationstyle=\ttx,
    noticestyle=\rm\it,
    secretalign=flushleft,
    titlealign=center,
    subjectalign=center,
    informationalign=center,
    noticealign=flushleft,
    secret={ÁªùÂØÜ ‚òÖ ÂêØÁî®Ââç},
    title={\currentdate[year] Âπ¥ÊôÆÈÄöÈ´òÁ≠âÂ≠¶Ê†°ÊãõÁîüÂÖ®ÂõΩÁªü‰∏ÄËÄÉËØï},
    subject={Ëã±ËØ≠},
    signinformation={{ÂßìÂêç:     }{\blackrule[width=4em,height=.2pt]}
                     {ÂáÜËÄÉËØÅÂè∑: }{\blackrule[width=4em,height=.2pt]}},
    information={ÂÖ®Âç∑ÂÖ±12È°µÔºåÊª°ÂàÜ150ÂàÜÔºåËÄÉËØïÊó∂Èó¥120ÂàÜÈíü„ÄÇ},
    notice={ËÄÉÁîüÊ≥®ÊÑèÔºö
            \startitemize[n,packed,joinedup]
            \item Á≠îÈ¢òÂâçÔºåËØ∑Âä°ÂøÖÂ∞ÜËá™Â∑±ÁöÑÂßìÂêç„ÄÅÂáÜËÄÉËØÅÂè∑Áî®ÈªëËâ≤Â≠óËøπÁöÑÁ≠æÂ≠óÁ¨î
                  ÊàñÈí¢Á¨îÂàÜÂà´Â°´ÂÜôÂú®ËØïÈ¢òÂç∑ÂíåÁ≠îÈ¢òÁ∫∏ËßÑÂÆöÁöÑ‰ΩçÁΩÆ‰∏ä„ÄÇ %
            \item Á≠îÈ¢òÊó∂ÔºåËØ∑ÊåâÁÖßÁ≠îÈ¢òÁ∫∏‰∏ä‚ÄúÊ≥®ÊÑè‰∫ãÈ°π‚ÄùÁöÑË¶ÅÊ±ÇÔºåÂú®Á≠îÈ¢òÁ∫∏Áõ∏Â∫îÁöÑ
                  ‰ΩçÁΩÆ‰∏äËßÑËåÉ‰ΩúÁ≠îÔºåÂú®Êú¨ËØïÈ¢òÂç∑‰∏äÁöÑ‰ΩúÁ≠î‰∏ÄÂæãÊó†Êïà„ÄÇ %
            \stopitemize},
]

\definepapertitle[newpaper]
%% #1 = newpapertitle #2 = setup elements of newpapertitle
%% \makepapertitle[newpaper][title=OOOOOOO]
%% quickly get elements at header and footer:
%% \getmarking[title][page][first] :: \getmarking[title][current]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{ËÆæÂÆö‰∏Ä‰∫õÂèØËÉΩÁî®ÂæóÂà∞ÁöÑÁ¨¶Âè∑ / Symbol Defination / „Ç∑„É≥„Éú„É´„ÅÆÂÆöÁæ©}

\doifelsefontpresent{NotoSansSymbols2-Regular}{}{
  \showmessage{basicexam}{9}{NotoSansSymbols2 font,symbol}}
\definefontsynonym[NotoSansSymbols2][file:NotoSansSymbols2-Regular]
\def\notosymb#1{\getglyphstyled{NotoSansSymbols2}{\tochar{n:#1}}}

\definesymbol[marksquare]          [\notosymb{‚òê}]
\definesymbol[markcircle]          [\notosymb{‚óã}]
\definesymbol[marknotcheck]        [\notosymb{‚çª}]
\definesymbol[markcheck]           [\notosymb{üó∏}]
\definesymbol[markheavycheck]      [\notosymb{‚úì}]
\definesymbol[marksquarecheck]     [\notosymb{\rlap{‚òê}\,\raise.2em\hbox{üó∏}}]
\definesymbol[marksquareheavycheck][\notosymb{\rlap{‚òê}\,\raise.2em\hbox{‚úì}}]
\definesymbol[markcirclecheck]     [\notosymb{\rlap{‚óã}\,\raise.2em\hbox{üó∏}}]
\definesymbol[markcircleheavycheck][\notosymb{\rlap{‚óã}\,\raise.2em\hbox{‚úì}}]
\definesymbol[markcross]           [\notosymb{‚úó}]
\definesymbol[markheavycross]      [\notosymb{‚úò}]
\definesymbol[marksquarecross]     [\notosymb{\rlap{‚òê}\,\raise.1em\hbox{‚úó}}]
\definesymbol[marksquareheavycross][\notosymb{\rlap{‚òê}\,\raise.1em\hbox{‚úò}}]
\definesymbol[markcirclecross]     [\notosymb{\rlap{‚óã}\,\raise.1em\hbox{‚úó}}]
\definesymbol[markcircleheavycross][\notosymb{\rlap{‚óã}\,\raise.1em\hbox{‚úò}}]

%D It is important to note that these symbols require 
%D the font {\bf NotoSansSymbols2} to be pre-installed.
%D
%D \starttabulate[|l|r|l|r|]
%D \NC \type{\symbol{marksquare}}           \NC \symbol{marksquare}
%D \VL \type{\symbol{markcircle}}           \NC \symbol{markcircle}          \NC\NR\HL
%D \NC \type{\symbol{markcheck}}            \NC \symbol{markcheck}
%D \VL \type{\symbol{markcross}}            \NC \symbol{markcross}           \NC\NR
%D \NC \type{\symbol{markheavycheck}}       \NC \symbol{markheavycheck}
%D \VL \type{\symbol{markheavycross}}       \NC \symbol{markheavycross}      \NC\NR
%D \NC \type{\symbol{marksquarecheck}}      \NC \symbol{marksquarecheck}
%D \VL \type{\symbol{marksquarecross}}      \NC \symbol{marksquarecross}     \NC\NR
%D \NC \type{\symbol{marksquareheavycheck}} \NC \symbol{marksquareheavycheck}
%D \VL \type{\symbol{marksquareheavycross}} \NC \symbol{marksquareheavycross}\NC\NR
%D \NC \type{\symbol{markcirclecheck}}      \NC \symbol{markcirclecheck}
%D \VL \type{\symbol{markcirclecross}}      \NC \symbol{markcirclecross}     \NC\NR
%D \NC \type{\symbol{markcircleheavycheck}} \NC \symbol{markcircleheavycheck}
%D \VL \type{\symbol{markcircleheavycross}} \NC \symbol{markcircleheavycross}\NC\NR
%D \NC \type{\symbol{marknotcheck}}         \NC \symbol{marknotcheck}
%D \VL                                      \NC                              \NC\NR
%D \stoptabulate

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\choice_answerstatus        {\datasetvariable{Choice_collector}{\QuestionID}{answerstatus}}
\def\point_totalpoint           {\datasetvariable{Answer_collector}{\QuestionID}{totalpoint}}
\def\currentavailablecolumns    {}
\def\currentrealavailablecolumns{}
\def\currentitemmaxwidth        {}
\def\currentanswerstatus        {}
\def\example_mode{\ifmode_example NOTICE: MODE EXAMPLE IS ON !\fi} 

\startluacode
  local report = logs.reporter("question info")

  local function center_text(text, total_width)
      local text_length = #text
      local left_padding = math.floor((total_width - text_length) / 2)
      local right_padding = total_width - left_padding - text_length
      return string.rep(' ', left_padding) .. text .. string.rep(' ', right_padding)
  end

  local function center_report(centerinfos)
      for _, row in ipairs(centerinfos) do
          local centered_line = center_text(row, 60)
          report(centered_line)
      end
  end

  local lines = {
      "NOTICE: MODE CHECK   IS ON !",
      "Notice,Cinfos only show choice env information",
      "CU means 'current' , if CUuserorder ‚â† CUorder,",
      "It maybe because START parameter is enabled.  ",
      "Notice,MODE EXAMPLE wont provide data infos   "
  }

  function formatted_report(data)
    -- ÂÆö‰πâÊ†ºÂºèÂåñÂ≠óÁ¨¶‰∏≤ÔºåÂä†ÂÖ•Á´ñÁ∫ø‰Ωú‰∏∫ÂàÜÈöîÁ¨¶
    local format_str = "%15s  %-20s  %15s  %-20s"

    report("----------------------------------------------------------------")
    center_report(lines,60)

    -- ËæìÂá∫Êï∞ÊçÆ
    for _, row in ipairs(data) do
        report(format_str:format(row[1], row[2], row[3], row[4]))
    end
    report("----------------------------------------------------------------")
  end
\stopluacode

\def\check_info{
      {"","\example_mode","",""},
      {"Name         ", "Content                                                             ", 
       "Cinfos       ", "Content                                                             "},
      {"CUitemgroup  ", "\datasetvariable{Answer_collector}{\QuestionID}{envid}              ", 
       "CUparen      ", "\currentparentitemgroup                                             "},
      {"QuestionID   ", "\QuestionID                                                         ", 
       "HelperID     ", "\HelperID                                                           "},
      {"order        ", "\currentorder                                                       ", 
       "userorder    ", "\currentuserorder                                                   "},
      {"point        ", "\datasetvariable{Answer_collector}    {\QuestionID}{point}          ", 
       "             ", "                                                                    "},
      {"totalnumber  ", "\datasetvariable{Answer_collector}    {\QuestionID}{totalnumber}    ", 
       "Htotalnumber ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}"},
      {"totalpoint   ", "\datasetvariable{Answer_collector}    {\QuestionID}{totalpoint}     ", 
       "Htotalpoint  ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{totalpoint}     "},
      {"CUCmaxwidth  ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{itemmaxwidth}   ",
       "Cavailable   ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns} &
                         \datasetvariable{Answer_collectorhelper}{\HelperID}{realavailablecolumns}"},
      {"answer       ", "\datasetvariable{Answer_collector}    {\QuestionID}{answer}         ", 
       "             ", "                                                                    "},
      {"Hanswer      ", "\datasetvariable{Answer_collectorhelper}{\HelperID}{answer}         ",
       "             ", "                                                                    "},
      {"mode.status  ", "\mode_status                                                        ", 
       "level.check  ", "\level_status                                                       "},
      {"Canswerstatus", "\choice_answerstatus                                                ", 
       "             ", "                                                                    "},
}

\def\show_check_info#1{\begingroup\ifmode_check%
  \ifdefined\currentorder%
    \let\old_currentorder\currentorder
    \let\old_currentorder\currentuserorder
  \else%
    \def\currentorder{    {\ttx currentorder didn't define}}
    \def\currentuserorder{{\ttx currentorder didn't define}}
  \fi%
  \directlua{formatted_report({#1})}\fi\endgroup}

\def\dimtonum #1{\number\numexpr \dimexpr #1\relax*635/65536\relax }
\newcount\cnt_floor
\def\floor#1{\floorhelper#1.\relax}
\def\floorhelper#1.#2\relax{\ifx\relax#2\relax#1%
    \else\if.#2#1\else\floorhelphelper{#1}#2\fi\fi}
\def\floorhelphelper#1#2.{\ifnum#2>0%
    \floorhelphelphelper#1\relax\relax\relax\else#1\fi}
\def\floorhelphelphelper#1#2\relax{%
  \if-#1\relax-\cnt_floor=0#2\relax%
  \advance\cnt_floor by 1\relax%
  \number\cnt_floor\relax%
  \else\cnt_floor=0#1#2\relax%
  \number\cnt_floor\relax\fi%
}

\def\initcollectanswer{\directlua{MultiAnswerCollector = {}}}
\def\collectanswer#1{\directlua{table.insert(MultiAnswerCollector, [[#1]])}}
\def\collectedanswer{\directlua{tex.sprint(table.concat(MultiAnswerCollector,","))}}

\def\example_toggle[#1]% ‰∏ìÁî®‰∫éÊµãËØïÊòØÂê¶ÂºÄÂêØ‰∫Ü example mode
    {\doif{\csname #1parameter\endcsname{example}}{true}%
          {\mode_exampletrue\global\c_envcounter_toggle=999\relax}}

\def\set_envitem_counter{%
  \ifdefined\currentenvnumber
    \edef\prevenvnumber{\currentenvnumber}%
  \fi\initcollectanswer% ÂàùÂßãÂåñÂ§öÈ°πÁ≠îÊ°àÊî∂ÈõÜÂô®
  \global\c_envcounter_toggle=0\relax%
  \ifenv_question   \global\c_envcounter_toggle=1\relax\fi
  \ifenv_problem    \global\c_envcounter_toggle=2\relax\fi
  \ifenv_choice     \global\c_envcounter_toggle=3\relax\fi
  \ifenv_material   \global\c_envcounter_toggle=4\relax\fi
  \ifenv_close      \global\c_envcounter_toggle=5\relax\fi
  \ifenv_writing    \global\c_envcounter_toggle=6\relax\fi
  \ifenv_subwriting \global\c_envcounter_toggle=7\relax\fi
  \ifenv_answer     \global\advance\c_envcounter_toggle by 10\relax\fi
  \edef\currentenvnumber{\the\c_envcounter_toggle}}

\def\level_status{\ifenv_toplevel <env_toplevel>\else%
                  \ifenv_botlevel <env_botlevel>\else%
                                  <env_midlevel>\fi\fi}

\def\mode_status{\ifmode_check      <M:C>\fi%check
                 \ifmode_showanswer <M:A>\fi%answer
                 \ifmode_showpoint  <M:P>\fi%point
                 \ifmode_example    <M:E>\fi}

%% Ê≥®ÊÑèÔºåÂè™Ë¶ÅÊüê‰∏™Êù°‰ª∂‰∏çÂÖ≥Èó≠Ôºå‰ªñÂ∞±‰ºö‰∏ÄÁõ¥ÂºÄÂêØ„ÄÇ‰æãÂ¶ÇÔºö
% {\env_topleveltrue
%    1. \ifenv_toplevel top \else bot \fi  % top
%    \env_toplevelfalse\env_botleveltrue   % ÂÖ≥Èó≠‰∫Ü toplevel ÊâçËÉΩÊ≠£Á°ÆËæìÂá∫
%    2. \ifenv_toplevel top \else bot \fi  % bot
%    3. \ifenv_botlevel bot \else top \fi} % bot
% ‰∏ÄÂÆöË¶ÅÂÖ≥Èó≠ÔºåÂõ†‰∏∫ÈªòËÆ§Âπ∂Ê≤°ÊúâËÆæÁΩÆ top Âíå bot ÁöÑ‰∫åÂÖÉÂÖ≥Á≥ª„ÄÇ
% ÊâÄ‰ª•Âç≥‰æøÊòØ‰∏ìÈó®ÊµãËØï bot ÊòØÂê¶ÂºÄÂêØÁöÑ 3 Ôºå
% ‰πüÂè™‰ºöÂú®ÂÖ≥Èó≠ top ÁöÑÊÉÖÂÜµ‰∏ãËé∑ÂèñÊ≠£Á°ÆÁöÑÁªìÊûú„ÄÇ

\def\current_user_order#1{% get user order which can by changed by START
    \number\csname #1order\endcsname% Áç≤ÂæóÁöÑÁµêÊûúÈ°û‰ººÊñº 2(4)
    \ifnum\rawcountervalue[Unicode_botlevel]=0\else%
    (\rawcountervalue[Unicode_botlevel])\fi}

\def\set_currentuserorder[#1]{% set order that user setted
  \ifcsname #1order\endcsname\else
    \expandafter\newcount\csname #1order\endcsname\fi
  \ifenv_toplevel\csname #1order\endcsname=\currentitemnumber
            \else\csname #1order\endcsname=\parentitemnumber \fi
  \edef\currentid{\QuestionID}%
  \edef\currentorder{% get unique order ( no chapter number )
    \somenamedheadnumber{chapter}{current}-%
    \rawcountervalue[Unicode_toplevel]-%
    \rawcountervalue[Unicode_midlevel]-%
    \rawcountervalue[Unicode_botlevel]}%
  \edef\currentuserorder{\current_user_order{#1}}%Ëé∑Âèñ ‰∏äÈù¢ÂÆö‰πâÁöÑ #1order
% % ==  \currentid ++ \currentorder @@ \currentorder
}%‰∏ì‰∏∫Â≠êÁ∫ßËÆæËÆ°Êù•Ëé∑ÂèñÁà∂Á∫ßÂ∫èÂè∑ÔºåÂê¶ÂàôÁõ¥Êé•Ëé∑ÂèñÂΩìÂâçÂ∫èÂè∑

\tolerant\def\set_count_envlevel[#1]{% #1 ÂÆöÁæ© #2order
% Â¶ÇÊûú cur = prevÔºå Ë™™ÊòéÂ∑≤Á∂ìÊúâ‰∫Ü‰∏äÂ±§Áí∞Â¢ÉÔºå Âà§ÂÆöÁÇ∫ ‰∏≠Â±§Áí∞Â¢ÉÔºå
% Â¶ÇÊûú prev Êú™Ë¢´ÂÆöÁæ©Ôºå Ë™™ÊòéÊ≤íÊúâ‰∏äÂ±§Áí∞Â¢ÉÔºå Âà§ÂÆöÁÇ∫  ‰∏äÂ±§Áí∞Â¢É
  \setcounter[Unicode_midlevel][0]%
  \setcounter[Unicode_botlevel][0]%
  \ifdefined\prevenvnumber
    \ifx\currentenvnumber\prevenvnumber
        \env_topleveltrue \incrementcounter[Unicode_toplevel]%
   \else\env_toplevelfalse\incrementcounter[Unicode_midlevel]\fi
   \else\env_topleveltrue \incrementcounter[Unicode_toplevel]\fi
  \parentitemnumber=\currentitemnumber\relax
  \set_currentuserorder[#1]% ÂàõÂª∫ #2order ‰ª•Â§á‰ΩøÁî®
  \inititemnumber%ÂàùÂßãÂåñÂ≠êÈ°åÁõÆË®àÊï∏Âô®
  \expandafter\show_check_info{\check_info}%
}

\tolerant\def\set_count_itemlevel[#1]{%
  \env_toplevelfalse
  \ifdefined\prevenvnumber
    \ifx\currentenvnumber\prevenvnumber
        \env_botlevelfalse\incrementcounter[Unicode_midlevel]\else
        \env_botleveltrue \incrementcounter[Unicode_botlevel]\fi
   \else\env_botlevelfalse\incrementcounter[Unicode_midlevel]%
  \fi\ifenv_subwriting\env_botleveltrue\fi
  \set_currentuserorder[#1]%
  \incrementitemnumber%Â¢ûÈï∑Â≠êÈ°åÁõÆË®àÊï∏Âô®
  \expandafter\show_check_info{\check_info}%
}

%%% id        Áî± Á´†ÁØÄËôü + È°åËôü ÁµÑÊàêÔºåÈ°åËôüÂú®ÊØè‰∏ÄÁ´†ÁØÄ‰∏≠ÈáçÊñ∞Âæû 1 Ë®àÊï∏
%%% envid     Áï∂ÂâçÂàóË°®ÂêçÁ®±ÂíåÂ±§Êï∏
%%% order     Áï∂ÂâçÂ≠êÈ°åËôüÔºå‰æãÂ¶Ç Á¨¨‰∏ÄÈ°å Ôºö 1 Á¨¨ÂÖ≠È°åÁ¨¨‰∏âÂ∞èÈ°å Ôºö 6(3)
%%% userorder Áï∂ÂâçÂàóË°®Â∫èËôü(ÂèØÁç≤ÂèñË¢´startÊõ¥ÊîπÂæåÁöÑÂ∫èËôü)

\def\installdatacollector%
  {\writestatus{basicexam}{Question (\currentuserorder): answer is (\currentanswer).}%È°ØÁ§∫È°åËôüÂíåÁ≠îÊ°àÂà∞ÊéßÂà∂Ê™Ø
  \setdataset [Answer_collector][\QuestionID]%Êî∂ÈõÜÁ≠îÊ°à‰∏¶Âú®Êú™‰æÜÂ±ïÈñã
              [id={\QuestionID},%
                envid={\the\c_envcounter_toggle :\currentitemgroup},%
                order={\number\currentorder},%
                userorder={\currentuserorder},%
                answer={\pass_parameter_answer},%
                point={\currentpoint},%
                totalnumber={\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}},%
                totalpoint={\datasetvariable {Answer_collectorhelper}{\HelperID}{totalpoint}},]}

\protected\def\installdatacollectorhelper{%
  \recurseditemnumber%
  \setdataset [Answer_collectorhelper][\HelperID]%Êî∂ÈõÜ‰ø°ÊÅØ‰∏¶Âú®Êú™‰æÜÂ±ïÈñã
              [totalitemnumber={\the\c_totalitemnumber},
               totalpoint={\currenttotalpoint},
               availablecolumns={\currentavailablecolumns},
               realavailablecolumns={\currentrealavailablecolumns},
               itemmaxwidth={\currentitemmaxwidth},
               answer={\currentanswer},
               answerstatus={\check_choice_answerstatus},
              ]%
}

% ÁéØÂ¢ÉÂ±ÇÁ∫ß‰∏ÄËßà
% question ÁéØÂ¢É                 % close ÁéØÂ¢É                      % material ÁéØÂ¢É
%    choice ÁéØÂ¢É                %       closechoice È°πÁõÆ    ‚≠ï    % question ÁéØÂ¢É
%       citem È°πÁõÆ        ‚≠ï    % optclose ÁéØÂ¢É                   %    choice ÁéØÂ¢É
%    problem ÁéØÂ¢É               %       ocitem È°πÁõÆ         ‚≠ï    %       citem È°πÁõÆ    ‚≠ï
%       pitem È°πÁõÆ        ‚≠ï    %       specialocitem È°πÁõÆ  ‚≠ï
%         fillin È°πÁõÆ     ‚≠ï
% ======================================================================================
% writing ÁéØÂ¢É            ‚≠ï
%     subwriting ÁéØÂ¢É
%

% Ëé∑ÂèñÂΩìÂâçÁéØÂ¢ÉÁöÑÁ≠îÊ°àÔºåÂπ∂‰º†ÈÄíÁªôÊúÄÁªàÁöÑ answer dataset
\def\pass_parameter_answer{%
  \ifenv_writing\short_writing_answer\else
    \ifempty\currentanswer there is no answer setted.\else
  \currentanswer\fi\fi}

%%%%% NOTICE : ÁõÆÂâçÔºåÁï∂Áî®Êà∂‰∏ªÂãïËº∏ÂÖ•ÂÄºÂíåÈÅ∏È†ÖÂÄºÁôºÁîüË°ùÁ™ÅÊôÇÔºå‰∏¶Êú™Ë®≠ÁΩÆË≠¶Âëä‰ø°ÊÅØ!!!!
\def\getanswerforanswer{% used for answer env to auto get answer
  \ifenv_writing
    \short_writing_answer
  \else
    \datasetvariable{Answer_collector}{\QuestionID}{answer}%
  \fi}

\def\getpointforanswer{% used for answer env to auto get point
  \datasetvariable{Answer_collector}{\QuestionID}{point}}

\def\check_choice_answerstatus{\ifchoice_check checked!\else%
    unchecked!please set the answer manually by add [*] parameter to citem command.\fi}

\def\paren#1{(#1)}

\protected\def\install_point[#1]{%
  \edef\p_showpoint{\csname #1parameter\endcsname{showpoint}}%
  \ifempty\p_showpoint\else
    \ifx\p_showpoint\s!true\mode_showpointtrue
    \else\mode_showpointfalse
  \fi\fi
  \ifx\currentmode\c!point
    \ifdefined\currentpoint\edef\prevpoint{\currentpoint}\fi
    \edef\p_point{\csname #1parameter\endcsname\c!point}%Êö´ÊôÇÂÆöÁæ©
    \ifempty\p_point
      \ifenv_toplevel% Áï∂ËôïÊñºÈ†ÇÂ±§ÊôÇÔºå Áî±Êñº prev ‰πüÊú™ÂÆöÁæ©Ôºå ÊúÉÊããÂá∫ÈåØË™§
      \edef\currentpoint{0}\else% Âõ†Ê≠§Ôºå Áõ¥Êé•Ë≥¶ÂÄºÊú™ 0
      \edef\currentpoint{\prevpoint}\fi
    \else%
      \ifenv_subwriting
        \edef\currentpoint{\namedwritingparameter{subwriting}\c!point}%
      \else
        \edef\currentpoint{\csname #1parameter\endcsname\c!point}%
      \fi
    \fi
    \ifempty\currentpoint% ÊäìÂèñÁï∂ÂâçÂàÜÊï∏ÂÄº
      \scratchcounter\zerocount
    \else
      \scratchcounter\currentpoint
    \fi
    \ifenv_toplevel% ÈáçÁΩÆÂàÜÊï∏Ë®àÁÆó 
      \c_steppoint\zerocount
      \c_steppoint_temp\zerocount
    \fi
    \global\c_steppoint_temp\scratchcounter
    \ifnum\c_steppoint=0
      \global\c_steppoint=\c_steppoint_temp
    \else%
      \global\c_steppoint=\numexpr\c_steppoint+\c_steppoint_temp\relax
    \fi% ÈÅûÊ≠∏Âá∫Á∏ΩÂàÜÊï∏
    \ifenv_toplevel% Â¶ÇÊûúÊúâÂ≠êÈ°åÁõÆÔºå ‰∏çÊáâÁï∂ Ë®àÁÆó question Êú¨Ë∫´ÁöÑÂàÜÂÄº, ‰ΩÜÈÄô‰ºº‰πéÂ¢ûÂä†‰∫ÜÁ∑®Ë≠ØÊ¨°Êï∏
      \edef\p_totalitemnumber{\datasetvariable{Answer_collector}{\QuestionID}{totalnumber}}%
      \doifelsesomething{\p_totalitemnumber}{\scratchcounter\p_totalitemnumber}{\scratchcounter\zerocount}%
      \writestatus{question info}{currentsteppoint is \the\c_steppoint ::\the\c_steppoint_temp}%
      % ‰∏çÁü•ÈÅìÁÇ∫‰ªÄÈ∫ºÔºå ‰ΩÜÂ¢ûÂä†Ëº∏Âá∫ steppoint ÂèØ‰ª•Áç≤ÂèñÊ≠£Á¢∫ÁöÑÊúÄÁµÇË®àÊï∏„ÄÇ
      \ifnum\scratchcounter>1\global\c_steppoint=\numexpr\c_steppoint-\c_steppoint_temp\relax\fi
      \xdef\currenttotalpoint{\number\currentpoint}%
    \else%
      \xdef\currenttotalpoint{\number\c_steppoint}% 
    \fi%
  \fi
}

\def\install_answer[#1]{%
  \edef\p_showanswer{\csname  #1parameter\endcsname\c!showanswer}%
  \ifempty\p_showanswer\else
    \ifx\p_showanswer\s!true
           \mode_showanswertrue
      \else\mode_showanswerfalse
  \fi\fi
  \ifx\currentmode\c!answer
    \ifdefined\currentanswer\edef\prevanswer{\currentanswer}\fi
    \edef\p_answer{\csname #1parameter\endcsname\c!answer}%Êö´ÊôÇÂÆöÁæ©
    \ifenv_subwriting\edef\p_answer{\writingparameter\c!answer}\fi
    \ifempty\p_answer
      \edef\currentanswer{\prevanswer}%
    \else%
      \edef\currentanswer{\csname #1parameter\endcsname\c!answer}%
      \ifdefined\prevanswer
        \ifempty\prevanswer\else
          \ifx\currentanswer\prevanswer\relax\else
            \writestatus{question info}{%
              \currentuserorder     : Two conflicting answers have been detected,
                                      check and delete unnecessary answers.}%
            \writestatus{question info}{%
              \string\prevanswer    : \prevanswer .
              \string\currentanswer : \currentanswer .}%
          \fi
        \fi
      \fi
    \fi
  \fi}

\tolerant\protected\def\show_pointoranswer_text[#1]#*[#2]{{
  \unskip\csname #1parameter\endcsname{#2style}%
  \switchtocolor[\csname #1parameter\endcsname{#2color}]%  
  \paren {\csname left_assigned#2label\endcsname % like=>answer : blabla
    \ifx\currentmode\c!point% if #2 = point
      \ifenv_toplevel\point_totalpoint%
      \else\currentpoint\fi%
    \else% if #2 = answer„ÄÇÂõ†‰∏∫ currentXXXanswer ÊòØÊúâÂÆö‰πâÂÜÖÂÆπÁöÑÔºå
      \ifmode_example You're in EXAMPLE MODE!\else%
        \ifenv_writing\short_writing_answer\else
        \datasetvariable{Answer_collector}{\QuestionID}{answer}\fi
      \fi% Áõ¥Êé•Áç≤ÂèñÁï∂Ââç QID Á≠îÊ°à
    \fi%
  \csname right_assigned#2label\endcsname }}}

\def\p_assigned_currentlabel#1#2{%
  \expandafter\edef%
    \csname p_current#1#2label%
      \expandafter\expandafter%
        \expandafter\endcsname%
          \expandafter\expandafter%
            \expandafter{%
              \csname #1parameter\endcsname{#2label}}}

\def\p_pass_currentlabel[#1]{\p_assign_currentlabel[#1,,]}
\def\p_assign_currentlabel[#1,#2,#3]#4%
 {\expandafter\def\csname  left_assigned#4label\endcsname {#1}%
  \expandafter\def\csname right_assigned#4label\endcsname {#2}}

\tolerant\protected\def\installpointoranswer[#1]#*[#2]{%#1 parameter %#2 modename
  \edef\currentmode{#2}% check point or answer
  \install_point[#1]%
  \install_answer[#1]%
  \p_assigned_currentlabel{#1}{#2}%
  \expandafter\expandafter%
    \expandafter\p_pass_currentlabel%
      \expandafter\expandafter%
        \expandafter[%
            \csname p_current#1#2label\endcsname]{#2}%
  \begingroup
  \csname ifmode_show#2\endcsname
    \show_pointoranswer_text[#1][#2]%
  \fi\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\defineconversion[tnum][\addff{tabularnumbers}]
\protected\def\installitemgroupoption[#1][#2]{%
  \setupitemgroup[env_#1][each][
                                    \c!margin={\csname #2parameter\endcsname\c!margin},%
                                \c!leftmargin={\csname #2parameter\endcsname\c!leftmargin},%
                               \c!rightmargin={\csname #2parameter\endcsname\c!rightmargin},%
                        \c!leftmargindistance={\csname #2parameter\endcsname\c!leftmargindistance},%
                       \c!rightmargindistance={\csname #2parameter\endcsname\c!rightmargindistance},%
                                \c!indentnext={\csname #2parameter\endcsname\c!indentnext},%
                                     \c!width={\csname #2parameter\endcsname\c!width},%
                                    \c!factor={\csname #2parameter\endcsname\c!factor},%
                                  \c!distance={\csname #2parameter\endcsname\c!distance},%
                                      \c!step={\csname #2parameter\endcsname\c!step},%
                                     \c!align={\csname #2parameter\endcsname\c!align},%
                                  \c!symalign={\csname #2parameter\endcsname\c!symalign},%
                                     \c!color={\csname #2parameter\endcsname\c!color},%
                                 \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                                     \c!style={\csname #2parameter\endcsname\c!style},%
                                  \c!marstyle={\csname #2parameter\endcsname\c!marstyle},%
                                  \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
                                 \c!headstyle={\csname #2parameter\endcsname\c!headstyle},%
                                  \c!marcolor={\csname #2parameter\endcsname\c!marcolor},%
                                  \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
                                 \c!headcolor={\csname #2parameter\endcsname\c!headcolor},%
                                \c!beforehead={\csname #2parameter\endcsname\c!beforehead},%
                                  \c!symcolor={\csname #2parameter\endcsname\c!symcolor},%
                                  \c!symstyle={\csname #2parameter\endcsname\c!symstyle},%
                                 \c!afterhead={\csname #2parameter\endcsname\c!afterhead},%
                                    \c!before={\csname #2parameter\endcsname\c!before},%
                                 \c!inbetween={\csname #2parameter\endcsname\c!inbetween},%
                                     \c!after={\csname #2parameter\endcsname\c!after},%
                                   \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                              \c!placestopper={\csname #2parameter\endcsname\c!placestopper},%
                                   \c!stopper={\csname #2parameter\endcsname\c!stopper},%
                                     \c!inner={\csname #2parameter\endcsname\c!inner},%
                                         \c!n={\csname #2parameter\endcsname\c!n},%
                                     \c!items={\csname #2parameter\endcsname\c!items},%
                                    \c!levels={\csname #2parameter\endcsname\c!levels},%
                                  \c!lefttext={\csname #2parameter\endcsname\c!lefttext},%
                                 \c!righttext={\csname #2parameter\endcsname\c!righttext},%
                                      \c!left={\csname #2parameter\endcsname\c!left},%
                                     \c!right={\csname #2parameter\endcsname\c!right},%
                             \c!packcriterium={\csname #2parameter\endcsname\c!packcriterium},%
                                 \c!criterium={\csname #2parameter\endcsname\c!criterium},%
                              \c!textdistance={\csname #2parameter\endcsname\c!textdistance},%
                         \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
                         \c!lasttextseparator={\csname #2parameter\endcsname\c!lasttextseparator},%
                                   \c!command={\csname #2parameter\endcsname\c!command},%
                                 \c!indenting={\csname #2parameter\endcsname\c!indenting},%
                               \c!alignsymbol={\csname #2parameter\endcsname\c!alignsymbol},%
                                    \c!symbol={\csname #2parameter\endcsname\c!symbol},%
                                    \c!option={\csname #2parameter\endcsname\c!option},%
                                  %  \c!start={\csname #2parameter\endcsname\c!start},%
                                     \c!start={\csname #2parameter\endcsname\c!start},%
                                     \c!state={\csname #2parameter\endcsname\c!state},% % beware, "" == start
                                       \c!way={\csname #2parameter\endcsname\c!way},% % wont work if continue on
                                    \c!prefix={\csname #2parameter\endcsname\c!prefix},%
                        \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
                          \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
                       \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
                             \c!prefixstarter={\csname #2parameter\endcsname\c!prefixstarter},%
                             \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
                                 \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                            \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
                                 \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                           \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
                        \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
                          \c!numberconversion={\csname #2parameter\endcsname\c!numberconversion},%
                       \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
                             \c!numberstarter={\csname #2parameter\endcsname\c!numberstarter},%
                             \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
                            \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
                      %               \c!prefix={\csname #2parameter\endcsname\c!prefix},%
                      %        \c!prefixstopper={\csname #2parameter\endcsname\c!prefixstopper},%
                      %   \c!prefixseparatorset={\csname #2parameter\endcsname\c!prefixseparatorset},%
                      %     \c!prefixconversion={\csname #2parameter\endcsname\c!prefixconversion},%
                      %  \c!prefixconversionset={\csname #2parameter\endcsname\c!prefixconversionset},%
                      %            \c!prefixset={\csname #2parameter\endcsname\c!prefixset},%
                      %       \c!prefixsegments={\csname #2parameter\endcsname\c!prefixsegments},%
                      %      \c!prefixconnector={\csname #2parameter\endcsname\c!prefixconnector},%
                      %   \c!numberseparatorset={\csname #2parameter\endcsname\c!numberseparatorset},%
                      %  \c!numberconversionset={\csname #2parameter\endcsname\c!numberconversionset},%
                            %  \c!numberstopper={\csname #2parameter\endcsname\c!numberstopper},%
                            % \c!numbersegments={\csname #2parameter\endcsname\c!numbersegments},
                           ]%
}

\protected\def\installcounteroption[#1][#2]{%
  \cdef\currentenv_counter{\v_strc_itemgroups_counter}% 
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{ËÆæÁΩÆ problem ÁéØÂ¢É / Problem Environment}

%D The environment \tex{problem} command can set up multiple aggregate issues, 
%D and the environment has a specific subcommand \tex{pitem} to list each issue. 
%D It can be used to set fill-in-the-blank, Q&A, and other questions.

%D \startbuffer
%D \startproblem
%D \startpitem The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D \startpitem The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D \startpitem The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The problem environment only inherits the key-value pairs from the itemgroup environment 
%D and does not set any new key-values. In the current version (v20241023), 
%D the settings for answers and scores have been removed. Because, under the problem environment, 
%D there are usually many pitems, and each question may have its own score and answer. 
%D Therefore, for design purposes, the answers and scores of each question are directly set through \tex{pitem}.

%D \startbuffer
%D \startproblem
%D \startpitem[showpoint=true,point=5]         The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D \startpitem[showanswer=true,answer={newer}] The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D \startpitem[]                               The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D \stopproblem
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D Unlike the \tex{question} environment, where all ordinal numbers are sequential, 
%D the \tex{problem} environment is recounted each time it starts.

%D If you want to add stems to the \tex{problem} environment, 
%D you can place the \tex{problem} environment in the \tex{question} environment.

%D \startbuffer
%D \startquestion
%D   The environment is located in: \currentitemgroup „ÄÇ
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D     \startpitem The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D If you want to set a fill-in-the-blank question, you can use the \tex{fillin} command.
%D The use of \tex{fillin} and \tex{startanswer} will be mentioned later.
%D
%D \startbuffer
%D \setupanswer[showanswer=true]
%D \startquestion
%D   The environment is located in: \currentitemgroup „ÄÇ
%D     \setuppitem[showanswer=true]
%D     \startproblem[left={(},right={)},distance=1em,stopper={}]
%D     \startpitem The environment is located in: \fillin{env_question:1}„ÄÇ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[mp=rules:under:wave]{env_question:1}„ÄÇ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem
%D     	The environment is located in: \fillin[empty=number]{env_question:2}„ÄÇ
%D     \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes]{env_question:3}„ÄÇ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \startpitem The environment is located in: \fillin[empty=yes,left={(},right={)}]{env_question:4}„ÄÇ \stoppitem
%D     \startanswer\input knuthmath\stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D In addition to this, you can define a new problem environment via \tex{defineproblem}\type{[XXX]}, 
%D which will generate two new commands \tex{startXXX} , \tex{\stopXXX}

\installnamespace          {problem}
\installcommandhandler \????problem   {problem}   \????problem

\appendtoks
  \setuevalue{\e!start\currentproblem}{\startnamedproblem[\currentproblem]}%
  \setuevalue{\e!stop \currentproblem}{\stopnamedproblem}%
\to \everydefineproblem

\tolerant\protected\def\startnamedproblem[#S#1]#*[#S#2]{%
  \scratchcounterone\currentitemnumber\relax
% Âõ†ÁÇ∫ setcountlevel Áî®Âà∞‰∫Ü scratchcounter,ÈÄôË£°Â∞±ÂøÖÈ†à‰ΩøÁî®Êñ∞ÁöÑË®àÊï∏Âô®ÊäìÂèñÂëΩ‰ª§
  \begingroup\env_problemtrue\set_envitem_counter
  \def\currentproblem{#1}%
  \ifparameter#2\or\setupcurrentproblem[#2]\fi
  \edef\p_defaultoption{n,packed,nowhite,joinedup}%
  \edef\p_option{\problemparameter\c!option}
  \installitemgroupoption[problem][problem]%
  \startitemgroup[env_problem]%
  \set_count_envlevel [problem]%
  \ifenv_toplevel\else
    \decreaseQuestionID
    \parentitemnumber=\scratchcounterone\relax% Áõ¥Êé•Ëé∑Âèñ question ÁöÑ ID
  \fi\removeunwantedspaces}

\protected\def\stopnamedproblem{%
  \installdatacollectorhelper%
  \initcollectanswer
  \stopitemgroup\endgroup}

\setupproblem
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!no,
   \c!width=.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=.5\emwidth,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext={(},
   \c!righttext={)},
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1,
   \c!numberconversion=tnum,]

\defineproblem[problem]

%D \section{ËÆæÁΩÆ question ÁéØÂ¢É}

%D The \tex{question} environment command can be used to set the stem.
%D Simply wrap the stem between the \tex{startquestion} \tex{stopquestion} commands.
%D At the same time, we have defined a short command \tex{question}, 
%D which is used as a synonym for \tex{startquestion} \tex{stopquestion}
%D
%D \startbuffer
%D   \startquestion
%D     The environment is located in: \currentitemgroup „ÄÇ
%D   \stopquestion
%D   \startquestion
%D     The environment is located in: \currentitemgroup „ÄÇ
%D   \stopquestion
%D   \question {The environment is located in: \currentitemgroup „ÄÇ}
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D The \tex{question} environment command inherits the option settings for 
%D the \tex{itemgroup} environment. Therefore, you can modify the environment 
%D using \tex{setupquestion} in the same way you modify \tex{itemgroup}.
%D
%D \bgroup
%D   \startbuffer
%D     \setupquestion[color=green,style=\ss,start=22,
%D                    option={n,packed,joinedup,nowhite,}]
%D     \startquestion
%D       The environment is located in: \currentitemgroup „ÄÇ
%D     \stopquestion
%D   \stopbuffer
%D   \typebuffer
%D   \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D \egroup

%D question ÁéØÂ¢ÉÂèØ‰ª•ËÆæÁΩÆ {\bf Á≠îÊ°à} Âíå {\bf ÂàÜÂÄº}„ÄÇËØ•ÈîÆÂÄºËØ¶ÁªÜÁöÑËÆæÁΩÆÂ¶Ç‰∏ãÔºö
%D \starttabulate[|l|l|l|l|]
%D \NC showanswer \NC answer \NC answerstyle    \NC answercolor \NC\NR
%D \NC            \NC        \NC answerlabel    \NC answerlabel \NC\NR\HL
%D \NC showpoint  \NC point  \NC pointstyle     \NC pointcolor  \NC\NR
%D \NC            \NC        \NC pointprelabel  \NC pointlabel  \NC\NR
%D \stoptabulate

%D \startbuffer
%D   \startquestion[showpoint=true,point=5,pointlabel={points},
%D                  showanswer=true,answer={new answer},answerstyle={\tt},]
%D     The environment is located in: \currentitemgroup „ÄÇ
%D   \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D Ê≠§Â§ñÔºåquestion ËÆæÁΩÆ‰∫Ü‰∏Ä‰∏™ÁâπÊÆäÁöÑÈîÆÂÄº example=trueÔºåÂèØ‰ª•ÊòØÂΩìÂâçÈ¢òÁõÆ‰∏çË¢´ÂΩïÂÖ•Á≠îÊ°à„ÄÇ
%D Âú®(v20241023)‰∏≠ÔºåÈÄöËøá‰∏çÂ§™Ê≠£Â∏∏ÁöÑÊñπÂºèËÆæÁΩÆ‰∫Ü example ÂêéÁöÑÈ¢òÁõÆÂèØ‰ª•Ëá™Âä®ÈáçÁΩÆÂõûÂà∞Â∫èÊï∞ 1„ÄÇ
%D ÊàñËÆ∏ÔºåÂèØ‰ª•ËÆæÁΩÆ‰∏Ä‰∏™Êñ∞ÁöÑÈîÆÂÄºÔºåÊù•ËÆæÂÆö example ‰πãÂêéÁöÑÈ¢òÁõÆÊòØÈáçÁΩÆ‰∏∫ 1 ËøòÊòØÊé•Áª≠‰∏ä‰∏Ä‰∏™Â∫èÂè∑„ÄÇ
%D Ê≠§Â§ñÔºåÁî±‰∫é question ÂÜÖÁΩÆ‰∫Ü‰∏Ä‰∏™ itemÔºå Âõ†Ê≠§ÂèØ‰ª•‰ΩøÁî® reference Êù•ÂàõÂª∫ÂºïÁî®„ÄÇ

%D {\bf ÈóúÊñº point Âíå answer ÁöÑË®≠ÂÆö: }
%D point ÁöÑÂàÜÂÄºÈªòË™çÊòØ‰∏ÄÊï¥ÂÄãÈ°åÁõÆÁöÑÁ∏ΩÂàÜÊï∏„ÄÇÂ¶ÇÊûúÁï∂ÂâçÂ≠óÁí∞Â¢ÉÁÇ∫ problemÔºåÂè™Ë¶ÅÁÇ∫ÊØèÂÄã pitem
%D Ë®≠Ë®à‰∫Ü point ÁöÑÂàÜÂÄºÔºåË©≤Ê®°Â°äÂ∞±ÊúÉËá™ÂãïË®àÁÆó„ÄÇanswer ÁöÑÁç≤Âèñ‰πüÊòØ‰∏ÄÊ®£„ÄÇÂú®Ë®≠Ë®àÊôÇÔºå
%D pitem ÈªòË™çÊòØÊìÅÊúâÂ§öÂÄãÂêåÁ¥öÈ†ÖÁõÆÁöÑ„ÄÇ‰πüÂ∞±ÊòØË™™ÔºåÊúÉÂú®Âêå‰∏ÄÂÄã question Áí∞Â¢É‰∏≠ÔºåÊúâÂ§öÂÄãÂ≠êÁ≠îÊ°à„ÄÇ
%D ÊàëÂÄëÁÑ°Ê≥ïÁç≤Áü•ÊáâË©≤‰ΩøÁî®Âì™‰∏ÄÂÄã‰ΩúÁÇ∫Áï∂ÂâçÁí∞Â¢ÉÁöÑÁ≠îÊ°à„ÄÇÂêåÊ®£ÁöÑÈÅìÁêÜÔºåÊØèÂÄã question Áí∞Â¢ÉÂÖßÂè™Êúâ‰∏ÄÂÄã
%D choice Áí∞Â¢ÉÔºåÂè™ÈúÄË¶ÅÁõ¥Êé•ÁÇ∫ question Áí∞Â¢ÉÈÖçÁΩÆÂàÜÂÄºÂç≥ÂèØ„ÄÇchoice Áí∞Â¢É‰∏¶‰∏çËÉΩÈÖçÁΩÆÂàÜÊï∏„ÄÇ

\installnamespace          {question}
\installcommandhandler \????question  {question}  \????question

\appendtoks
  \setuevalue        {\currentquestion}{\directnamedquestion[\currentquestion]}%
  \setuevalue{\e!start\currentquestion}{\startnamedquestion [\currentquestion]}%
  \setuevalue{\e!stop \currentquestion}{\stopnamedquestion}%
\to \everydefinequestion

\tolerant\protected\def\directnamedquestion[#S#1]#*[#S#2]{%
  \groupedcommand{\startnamedquestion[#1][#2]}%
                 {\stopnamedquestion}}

\tolerant\protected\def\startnamedquestion[#S#1]#*[#S#2]%
 {\begingroup\env_questiontrue\set_envitem_counter%%
  \def\currentquestion{#1}%
  \ifparameter#2\or\setupcurrentquestion[#2]\fi%
  \example_toggle[question]% Áî®ÊñºÊ∏¨Ë©¶ÊòØÂê¶ÈñãÂïü example_mode
  \edef\p_start{\questionparameter\c!start}
  \edef\p_defaultoption{n,packed,nowhite,joinedup,continue}%
  \edef\p_option{\questionparameter\c!option}
  \installitemgroupoption[question][question]%
  \startitemgroup[env_question]%
  \item[\questionparameter\c!reference]%
  \increaseQuestionID% ÂÖ∑ÊúâÁç®Á´ãÁ≠îÊ°àÔºåÂ¢ûÈï∑ QID
  \set_count_envlevel  [question]%
  \installpointoranswer[question][point]%
  \installpointoranswer[question][answer]%
  \save_question_order\removeunwantedspaces}

\protected\def\stopnamedquestion{%
  \ifnum\c_envcounter_toggle=1\relax
  \installdatacollectorhelper%
  \installdatacollector\fi%
  \initcollectanswer
  \stopitemgroup\endgroup%
  \ifnum\c_envcounter_toggle=999\relax%
  \resetcounter [itemgroup:env_question]%
  \fi}

\definequestion[question]

\setupquestion 
  [%example=,
  %showpoint=false,
  %point=,
   pointstyle=\ttx,
  %pointcolor=,
  %pointprelabel=,
   pointlabel={,\examtexts{point}},
  %showanswer=false,
  %answer=,
  %answerlabel=,
  %answerlabel=,
   answerstyle=\ss,
   answercolor=red,
   indenting=no,
   way=bychapter,
   numberconversion=tnum,]

\setupquestion
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!no,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

%D \section{ËÆæÁΩÆ choice ÁéØÂ¢É}
%D Ë©≤Áí∞Â¢ÉÂëΩ‰ª§Âè™ËÉΩÁΩÆÊñº \tex{question} Áí∞Â¢É‰πã‰∏ã„ÄÇË©≤Áí∞Â¢ÉÊúâ‰∏ÄÂÄãÂ≠êÈ†ÖÁõÆÔºö
%D \tex{startcitem}
%D \tex{stopcitem}„ÄÇ
%D \starttyping
%D  \startcitem {ÈÅ∏È†ÖÂÖßÂÆπ} \stopcitem
%D \stoptyping

%D ÂèØ‰ª•ÈÄöÈÅé \type{[*]} ‰æÜÊ®ôË®òÊ≠£Á¢∫Á≠îÊ°à„ÄÇÂ¶ÇÊûúÊÉ≥Ë¶ÅË®≠ÁΩÆÂ§öÈÅ∏È°åÔºåÂè™ÈúÄË¶ÅÂ∞çÊØèÂÄãÊ≠£Á¢∫Á≠îÊ°àÊ∑ªÂä† \type{[*]} Âç≥ÂèØ„ÄÇ
%D \startbuffer
%D \setupquestion[showanswer=true]
%D \startquestion
%D     The environment is located in: \currentitemgroup „ÄÇ
%D     \startchoice
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup „ÄÇ
%D     \startchoice
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D         \startcitem[*]{Some More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \startquestion
%D     The environment is located in: \currentitemgroup „ÄÇ
%D     \startchoice
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D         \startcitem{Some More More Words}\stopcitem
%D         \startcitem[*]{Some More More Words}\stopcitem
%D     \stopchoice
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%D ÂêåÊôÇÁÇ∫ \tex{startcitem}\tex{stopcitem} ÂÆöÁæ©‰∫ÜÂêåÁæ©ÂëΩ‰ª§ \tex{citem} Âíå \tex{fragilecitem}„ÄÇ
%D \tex{fragilecitem}ÂëΩ‰ª§ÂèØ‰ª•‰∏çÈÄöÈÅéÁïåÂÆöËä±Êã¨Ëôü‰æÜÊéíÁâàÈÅ∏È†ÖÔºå‰ΩÜÂèØËÉΩÊúÉÂºïÁôºÊú™Áü•ÂïèÈ°åÔºå
%D ÁâπÂà•ÊòØÈÅ∏È†Ö‰∏≠Âê´ÊúâÁ©∫Ê†ºÊôÇ„ÄÇ\tex{citem} ÂâáÈúÄË¶ÅÂ∞áÈÅ∏È†ÖÂåÖË£πÂú®Ëä±Êã¨Ëôü‰∏≠„ÄÇ
%D \starttyping
%D  \citem {ÈÅ∏È†ÖÂÖßÂÆπ}
%D  \fragilecitem ÈÅ∏È†ÖÂÖßÂÆπ
%D \stoptyping

%D ËØ•ÁéØÂ¢ÉÁªßÊâø‰∫Ü‰∏ÄÈÉ®ÂàÜ itemgroup ÁöÑÈîÆÂÄºÔºåÂ∞±Â¶ÇÂêåÂâç‰∏§‰∏™ÂëΩ‰ª§‰∏ÄÊ†∑„ÄÇ
%D ‰∏çÂêå‰∫é question ÂÖ∑Êúâanswer Âíå point ‰∏§ÁßçÈîÆÂÄºÔºåËØ•ÁéØÂ¢ÉÂè™ÂÖ∑Êúâ answer Áõ∏ÂÖ≥ÁöÑÈîÆÂÄºÔºåÊù•ÁâπÂà´Âú∞
%D ËÆæÁΩÆÊòØÂê¶ÊòæÁ§∫Á≠îÊ°àÂíåÈÖçÁΩÆÁ≠îÊ°àÊ®£Âºè„ÄÇ
%D Âõ†‰∏∫ choice ÁéØÂ¢ÉÁöÑÁâπÊÆäÊÄßÔºåpoint ÈîÆÂÄºÈÄöËøá question ÁéØÂ¢ÉÊù•ÊòæÁ§∫„ÄÇÂíå question Áí∞Â¢ÉÁöÑÂçÄÂà•ÊòØ
%D question ÁéØÂ¢ÉÁöÑ answer ÊéßÂà∂Á≠îÊ°àÊòØÂê¶ÊòæÁ§∫Âú®È¢òÂπ≤‰ª•ÂèäËÆæÁΩÆÁõ∏ÂÖ≥Ê†∑Âºè„ÄÇ
%D choice   ÁéØÂ¢ÉÁöÑ answer ÊéßÂà∂Á≠îÊ°àÊòØÂê¶ÊòæÁ§∫Âú®ÈÄâÈ°π‰ª•ÂèäËÆæÁΩÆÁõ∏ÂÖ≥Ê†∑Âºè„ÄÇ

%D Âè¶Â§ñÔºåchoice Áí∞Â¢ÉÊúâ‰∏ÄÂÄãÁâπÂà•ÁöÑÂÄºÔºö
%D maxiwidth key is for calcaluted max width of choice and waited to be compareÔºå
%D notice this key is maxiwidth ,and difference from maxwidth which
%D for setupitemgroup command

\installnamespace          {choice}
\installcommandhandler \????choice    {choice}    \????choice

\appendtoks
  \setuevalue        {\currentchoice}{\directnamedchoice[\currentchoice]}%
  \setuevalue{\e!start\currentchoice}{\startnamedchoice [\currentchoice]}%
  \setuevalue{\e!stop \currentchoice}{\stopnamedchoice}%
\to \everydefinechoice

\setupchoice [answerstyle=\ss\tf,
              answercolor=red,
              inlinechoice=false,
              point=\questionparameter\c!point,
              maxiwidth=.9\textwidth,
              numberconversion=A,]

\tolerant\protected\def\directnamedchoice[#1]#*[#2]#*#:#3%
{\begingroup
  \def\currentchoice{#1}%
  \ifparameter#2\or\setupcurrentchoice[#2]\fi
  \startnamedchoice[#1]%
    \def\citem_temp##1{\startcitem##1\stopcitem}%
    \def\correct##1{##1\collectanswer{##1}}%
    \processcommacommand[#3]\citem_temp
  \stopnamedchoice\endgroup}

\tolerant\protected\def\startnamedchoice[#S#1]#*[#S#2]%
 {\begingroup\def\currentchoice{#1}%
  \ifnum\c_envcounter_toggle = 2\relax
    \errmessage{you cannot put choice in problem environment.
                choice env can only be putted in question environment.}\fi
  \env_choicetrue\set_envitem_counter
  \ifdefined\currentuserorder
    \expandafter\show_check_info{\check_info}%
  \else
    \ifnum\c_envcounter_toggle = 3\relax
    \else \set_count_envlevel[choice]\fi
  \fi
  \doifelsesomething{\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}}% arg_1
     {\scratchcounter\datasetvariable{Answer_collectorhelper}{\HelperID}{totalitemnumber}}% arg_2
     {\scratchcounter\zerocount}% arg_3
  \current_total_choice_number=\number\scratchcounter\relax
  \doifelsesomething{\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\datasetvariable{Answer_collectorhelper}{\HelperID}{availablecolumns}}%
     {\scratchcounter\zerocount}%
  \current_available_columns=\number\scratchcounter\relax
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%    % if calc_horizontal_num >= tbl_cit_count
%%    %                                      set horizontal = tbl_cit_count
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count ~= 1
%%    %                                  set horizontal = two % calc_horizontal_num
%%    % if calc_horizontal_num <  tbl_cit_count and tbl_cit_count == 1
%%    %                                      set horizontal = 1
%%    % ÁâπÂà´ÁöÑÔºå 3 ÈÄâÈ°π ‰∏î ÂèØÊéíÁâàÊúÄÂ§ßÂàóÊï∞‰∏∫ 2 Êó∂ÔºåÊéíÁâà 1 Ë°å
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \startluacode
  tbl_num_temp = {"one","two","three","four",
                  "five","six","seven","eight","nine"}
  local   tbl_cit_count         = tex.count['current_total_choice_number']
  local   available_columns     = tex.count['current_available_columns']
          available_columns_arg = ""
  if     (tbl_cit_count == 3) and (available_columns   <  tbl_cit_count)
  then    available_columns_arg = "one"
  elseif (tbl_cit_count >  1) and (available_columns   >= tbl_cit_count)
  then    available_columns_arg = "horizontal," .. tbl_num_temp[tbl_cit_count]
  elseif (tbl_cit_count >= 1) and (available_columns   <=            1 )
  then    available_columns_arg = "one"
  else    available_columns_arg = "horizontal,two"
  end
  \stopluacode
  \edef\currentrealavailablecolumns{\ctxlua{context(available_columns_arg,"")}}%
  \ifparameter#2\or\setupchoice[#2]\fi
  \edef\currentanswer  {\choiceparameter\c!answer      }%
  \edef\p_option       {\choiceparameter\c!option      }%
  \edef\p_showanswer   {\choiceparameter\c!showanswer  }%
  \edef\p_choicetype   {\choiceparameter\c!inlinechoice}%
  \edef\p_correctsymbol{\choiceparameter{correctsymbol}}%
  \edef\p_defaultoption{A,packed,nowhite,joinedup}%
  \installitemgroupoption[choice][choice]%
  \ifx\p_choicetype\s!true
    \startitemgroup[env_choice][text,\p_option]\else
    \startitemgroup[env_choice][\ctxlua{context(available_columns_arg,"")},\p_option]\fi
  \choiceparameter\c!inlineleft
  \ifmode_showanswer\else
    \ifx\p_showanswer\s!true
         \mode_showanswertrue
    \else\mode_showanswerfalse\fi
  \fi\removeunwantedspaces}

\protected\def\stopnamedchoice{%
  \removemarkedcontent[inlinechoice_punctuation]%
  \d_maxwidth_with_label = \dimexpr\d_width_cit_max     + 
                           \d_strc_itemgroups_list_width   \relax
  \d_compared_maxwidth   = \choiceparameter{maxiwidth}     \relax
  \startluacode
    local a = tex.dimen['d_compared_maxwidth']
    local b = tex.dimen['d_maxwidth_with_label']
          c = math.floor(a/b)
  \stopluacode
%%   \d_compared_maxwidth ÊòØÂèØÊéíÁâàÁöÑÊúÄÈï∑ÂØ¨Â∫¶„ÄÇ
%%   a Âíå b Â∞áÂØ¨Â∫¶Êï∏Â≠óÂåñÔºå ‰ª•ÂÇôÊØîËºÉÂá∫ÂèØÊéíÁâàÁöÑÊ¨ÑÊï∏„ÄÇ
%%   Âõ†ÁÇ∫ÂèñÊ∂à‰∫Ü choice ‰ΩúÁÇ∫‰∏äÁ¥öÁí∞Â¢ÉÊôÇÁöÑ \set_count_envlevel Âõ†Ê≠§ÔºåÈáçÂÆöÁæ© order„ÄÇ
%%   ÂèñÊ∂àÂéüÂõ†ÊòØ ËÆì choice Áõ¥Êé•Áç≤Âèñ question Áí∞Â¢ÉÁöÑ order„ÄÇ
  \edef\currentchoiceanswer{\collectedanswer}%
  \ifempty\currentchoiceanswer
    \edef\currentanswer{\prevanswer}% ËÆì choice ÁπºÊâø Ââç‰∏ÄÂÄãÁ≠îÊ°à 
  \else
    \edef\currentanswer{\collectedanswer}%
  \fi
  \def\currentavailablecolumns{\ctxlua{context(c,"")}}%
  \def\currentitemmaxwidth    {\the\d_width_cit_max}%
  \doifelsesomething{\choiceparameter\c!point}%
    {\scratchcountertwo\choiceparameter\c!point}%
    {\scratchcountertwo\zerocount}%
  \edef\currentpoint     {\the\scratchcountertwo}%
  \edef\currenttotalpoint{\the\scratchcountertwo}%
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer
  \choiceparameter\c!inlineright
  \stopitemgroup
  \endgroup}

\setupchoice
  [\c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!no,
   \c!width=1\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=.5\emwidth,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={A,packed,joinedup,nowhite,},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definechoice[choice]
\definechoice[inlinechoice]
\tolerant\def\setupinlinechoice[#1]{\setupchoice[inlinechoice][#1]}

\setupinlinechoice[option={text,8,packed,joinedup,nowhite,},
                   inlinechoice=\s!true,                
                   correctsymbol={\symbol{marksquarecheck}},
                   inlineleft={ (\nobreak},
                   inlineright={\nobreak ) },
                   %lefttext={},
                   %righttext={},
                   answerstyle=\ss,
                   %stopper=,
                   %showanswer=,% shoule be empty before used
                   separator={\removeunwantedspaces,\space},
                   ]

%D \section{ËÆæÁΩÆ writing ÁéØÂ¢É}
%D ÁõÆÂâçËØ•ÁéØÂ¢ÉÂè™ÊòØÂàùÊ≠•ÁöÑËÆæËÆ°„ÄÇ
%D Â¶ÇÊûúÂè™ÊúâÂêåÁ∫ßÁöÑÂ§ö‰∏™‰ΩúÊñáÈ¢òÁõÆÔºåÂè™ÈúÄË¶Å‰ΩøÁî® writing ÁéØÂ¢ÉÂç≥ÂèØ„ÄÇ
%D ‰ΩÜÊòØÔºåÂΩì‰∏Ä‰∏™‰ΩúÊñá‰Ωì‰∏ãÈù¢ÊúâÂ§ö‰∏™Â≠êÈ¢òÁõÆÊó∂ÔºåÈúÄË¶ÅÂ∞ÜÂ≠êÈ¢òÁõÆÊîæÂà∞ subwriting ÁéØÂ¢ÉÂΩì‰∏≠„ÄÇ

%D ËØ•ÁéØÂ¢ÉÁõÆÂâçÂÖ≥‰∫é itemgroup ÁöÑËÆæÁΩÆÊòØÁõ¥Êé•ÁªßÊâøËá™ question ÁéØÂ¢É„ÄÇÁõ¥Êé•ÈÄöËøá \tex{setupquestion}
%D Êù•ËøõË°åËÆæÁΩÆÁöÜÂèØ„ÄÇ

% Â¶ÇÊûúÂê´Êúâ subwriting ÁéØÂ¢ÉÔºåÂèØ‰ª•‰ΩøÁî® \tex{getanswerfromsubwriting} Êù•Ëé∑ÂèñÊÄªÂàÜÊï∞„ÄÇ
% \startbuffer
% \setupwriting[showanswer=true,showpoint=true]
% \startwriting[point=45]
%   ‰ΩúÊñáÈ¢òÁõÆËØ¥Êòé
%   \startanswer
%     ÂèÇËÄÉ‰ΩúÊñá 1
%   \stopanswer
% \stopwriting
%
% \startwriting
% ‰ΩúÊñáÈ¢òÁõÆËØ¥Êòé
%   \startsubwriting[point=450]
%     sub ‰ΩúÊñáÈ¢òÁõÆËØ¥Êòé
%     \startanswer
%       ÂèÇËÄÉ‰ΩúÊñá 2
%     \stopanswer
%   \stopsubwriting
%   \startsubwriting[point=4588]
%     sub ‰ΩúÊñáÈ¢òÁõÆËØ¥Êòé
%     \startanswer
%     ÂèÇËÄÉ‰ΩúÊñá 3
%     \stopanswer
%   \stopsubwriting
% \stopwriting
% \stopbuffer
% \typebuffer
% \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {writing}
\installcommandhandler \????writing   {writing}   \????writing

\appendtoks
  \setuevalue{\e!start\currentwriting}{\startnamedwriting[\currentwriting]}%
  \setuevalue{\e!stop \currentwriting}{\stopnamedwriting}%
\to \everydefinewriting

\tolerant\protected\def\startnamedwriting[#S#1]#*[#S#2]
  {\begingroup\env_writingtrue\set_envitem_counter
  \edef\currentwriting{#1}%
  \setupanswer[showanswer=false]%
  \setupcurrentwriting[#2]%Ê≥®ÊÑèÔºåwriting Ê≤°ÊúâÂçïÁã¨ÁöÑ itemgroup ÁéØÂ¢É
  \edef\short_writing_answer{\writingparameter\c!answer}%
  \edef\currentanswer{\writingparameter\c!answer}%
  \edef\getanswercontent{}%
  \edef\p_writingtype{\writingparameter{subwriting}}%
  \installitemgroupoption[question][writing]%
  \startitemgroup[env_question]%
  \item[\writingparameter\c!reference]%
  \ifx\p_writingtype\s!true
    \env_subwritingtrue
    \set_envitem_counter
    \ifnum\currentitemnumber=1\relax
          \decreaseQuestionID\increaseQuestionID
    \else\increaseQuestionID\fi
    \set_count_itemlevel[subwriting]%
  % ÂΩìÂÖ∑ÊúâÂ§ö‰∏™Â≠êÂÜô‰ΩúÁéØÂ¢ÉÊó∂ÔºåÊâçÂ¢ûÈïø QID Ôºå
  % Âê¶ÂàôÂâäÂáèËá≥ Áà∂Á∫ß QIDÔºàÁõ∏ÂΩì‰∫éÁªßÊâøÔºâ
  \else
    \increaseQuestionID
    \set_count_envlevel[writing]
  \fi
  \installpointoranswer[writing][point]%
  \installpointoranswer[writing][answer]%
  \save_question_order\removeunwantedspaces}

\protected\def\stopnamedwriting{%
  \ifnum\c_totalitemnumber<2\relax% Âè™Êúâ‰∏ÄÂÄãÂ≠êÈ†ÖÁõÆ
    \ifenv_subwriting% ÊòØÂ≠ê‰ΩúÊñá
      \installdatacollector%
      \installdatacollectorhelper%
      \initcollectanswer
    \else% ÊòØ‰ΩúÊñá
      \edef\currentpoint{\writingparameter\c!point}
      \edef\currenttotalpoint{\writingparameter\c!point}
      \c_totalitemnumber=1\relax
      \installdatacollector%
      \installdatacollectorhelper%
      \initcollectanswer
    \fi
  \else% ÊìÅÊúâÂ§öÂÄãÂ≠êÈ†ÖÁõÆ
  \fi\stopitemgroup\endgroup}


\setupwriting
  [\c!answer={ÂèÇËßÅÂèÇËÄÉ‰ΩúÊñá„ÄÇ},
   \c!pointlabel={,\examtexts{point}},
   \c!margin=\zeropoint,
   \c!leftmargin=\zeropoint,
   \c!rightmargin=\zeropoint,
   \c!leftmargindistance=\zeropoint,
   \c!rightmargindistance=\zeropoint,
   \c!indentnext=\v!no,
   \c!width=1.5\emwidth,
   \c!factor=0,
   \c!step=.5\emwidth, % deals with broad
   \c!distance=\zeropoint,
  %\c!align=\v!normal, % definitely not \v!normal !
  %\c!symalign=,
  %\c!color=,
  %\c!indenting=, % untouched if empty
  %\c!style=,
   \c!marstyle=\v!type,
  %\c!symstyle=,
  %\c!headstyle=,
  %\c!marcolor=,
  %\c!symcolor=,
  %\c!headcolor=,
  %\c!beforehead=,
   \c!symcolor=\itemgroupparameter\c!color, % new per 2012.01.17
   \c!symstyle=\itemgroupparameter\c!style, % new per 2012.01.17
   \c!afterhead=\blank,
   \c!before=,
   \c!inbetween=,
   \c!after=,
  %\c!stopper=.,
   \c!placestopper=\v!yes,
   \c!stopper={. },
  %\c!inner=,
   \c!n=2,
   \c!items=4,
   \c!levels=10,
   \c!lefttext=,
   \c!righttext=,
   \c!start=1,
   \c!packcriterium=\zerocount,
   \c!criterium=\v!all, % permits 0 and negative numbers
   \c!option={n,packed,joinedup,nowhite,continue},
   \c!textdistance=\v!space, % none big medium small <dimension>
   \c!lasttextseparator=\itemgroupparameter\c!textseparator,
  %\c!lasttextseparator=,
   \c!command=\strc_itemgroups_default_command,
   \c!indenting=\v!next,
  %\c!alignsymbol=v!no,
   \c!symbol=\currentitemlevel,
   \c!prefix=\v!no,
  %\c!prefixstopper=.,
  %\c!prefixseparatorset=,
  %\c!prefixconversion=,
  %\c!prefixconversionset=,
  %\c!prefixset=,
  %\c!prefixsegments=1:100,
   \c!prefixconnector=.,
   \c!numberseparatorset=,
   \c!numberconversionset=,
   \c!numberstopper=.,
   \c!numbersegments=1]

\definewriting[writing]
\definewriting[subwriting]
\def\setupsubwriting{\setupwriting[subwriting]}
\setupsubwriting
  [answer={ÂèÇËßÅÂèÇËÄÉ‰ΩúÊñá„ÄÇ},
   subwriting=true,
   pointlabel={,\examtexts{point}},]

%D \section{ËÆæÁΩÆ answer ÁéØÂ¢É}
%D Âú®(v20241023)‰∏≠ÔºåÂà†Èô§‰∫Ü answer ÁéØÂ¢ÉÁöÑÊ†áÁ≠æÈÄöËøá description Êù•ËøõË°åËÆæÁΩÆ„ÄÇ
%D Êï¥‰ΩìÁéØÂ¢ÉÈÄöËøá textbackground ÁéØÂ¢ÉËøõË°åËÆæÁΩÆ„ÄÇ
%D ËØ•ÁéØÂ¢ÉÂÖ∑Êúâ answer Âíå point ÁöÑÂÖ®ÈÉ®ÈîÆÂÄº„ÄÇ
%D Ê≠§Â§ñÔºåÈÇÑÊèê‰æõ‰∫Ü‰∏ÄÂÄãÁâπÊÆäÁöÑÈçµÂÄº sctiptÔºåË©≤ÈçµÂÄº‰∏ªË¶ÅÁî®ÊñºÂâµÂª∫Á≠îÈ°åÂçÄÂüü„ÄÇ
%D Ë©≤ÈçµÂÄºÂíå answer ÈçµÂÄºÊòØ‰∫íÊñ•ÁöÑÔºå‰∏çÊáâË©≤ÂêåÊôÇÂïüÁî®„ÄÇ

%D \tex{answer} ÊòØÁà≤Â∏´ÁîüÂÖ©ÁâàË®≠ÁΩÆÁöÑÂëΩ‰ª§„ÄÇ‰ΩÜÁõÆÂâçË©≤ÂëΩ‰ª§ÂíåÁõ∏ÈóúË®≠ÁΩÆÈÇÑÂÖ∑ÊúâË´∏Â§ö‰∏çË∂≥‰πãËôï„ÄÇÂè™ÈúÄË¶ÅÂ∞áË©≤Áí∞Â¢ÉÁΩÆÊñºÈ°åÁõÆ‰∏ãÊñπÔºåÂç≥ÂèØÁç≤ÂèñÁï∂ÂâçÈ°åÁõÆË®≠ÂÆö%D ÁöÑÁ≠îÊ°àÔºå‰∏¶ÂèØ‰ª•Áà≤ÂÖ∂Á∑®ÂØ´Á≠îÊ°àËß£Êûê„ÄÇ
%D
%D \startbuffer
%D \startquestion[showanswer=true,answer={answer for \currentitemgroup }]
%D     The environment is located in: \currentitemgroup „ÄÇ Ê≥®ÊÑèÔºö\tex{answer} ÂèØ‰ª•Áç≤ÂèñÁà∂Áí∞Â¢ÉÊàñÂêåÁ¥öÁí∞Â¢ÉÁöÑÁ≠îÊ°àËÄå‰∏çÂøÖÂÜçÊ¨°Ë®≠ÁΩÆ„ÄÇ
%D     \startanswer[point=12]
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \startquestion[showanswer=true]
%D     The environment is located in: \currentitemgroup „ÄÇ Ê≥®ÊÑèÔºö\tex{answer} ÂèØ‰ª•Áç≤ÂèñÁà∂Áí∞Â¢ÉÊàñÂêåÁ¥öÁí∞Â¢ÉÁöÑÁ≠îÊ°àËÄå‰∏çÂøÖÂÜçÊ¨°Ë®≠ÁΩÆ„ÄÇ
%D     \startchoice
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D         \startcitem[*]{Some Words}\stopcitem
%D         \startcitem{Some Words}\stopcitem
%D     \stopchoice
%D     \startanswer[point=1]
%D     \input knuthmath
%D     \stopanswer
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}
%D
%D \startbuffer
%D \startquestion[showanswer=true]
%D   The environment is located in: \currentitemgroup „ÄÇ
%D     \startproblem[showanswer=true,left={(},right={)},distance=1em,stopper={}]
%D     \startpitem[showanswer=true,answer={Pitem 1}] The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D     \startanswer[point=10]
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 2}] The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D     \startanswer[point=20]
%D     \input knuthmath
%D     \stopanswer
%D     \startpitem[showanswer=true,answer={Pitem 3}] The environment is located in: \currentitemgroup „ÄÇ \stoppitem
%D     \startanswer[point=30]
%D     \input knuthmath
%D     \stopanswer
%D     \stopproblem
%D \stopquestion
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

%%%%%%%

\installnamespace {answer}
\installnamespace {answeralternative}
\installnamespace {answerrenderings}

\installcommandhandler \????answer            {answer}            \????answer
\installcommandhandler \????answeralternative {answeralternative} \????answeralternative

\appendtoks
    \frozen\instance\protected\edefcsname        \currentanswer\endcsname{\answer_direct_instance}%
    \frozen\protected\instance\edefcsname\e!start\currentanswer\endcsname{\answer_start_instance [\currentanswer]}%
    \frozen\protected\instance\letcsname \e!stop \currentanswer\endcsname\answer_stop_instance
\to \everydefineanswer

\definesystemconstant{answer}

\tolerant\protected\def\answer_direct_instance[#S#1]#:#2%
  {\begingroup
   \cdef\currentanswer{#1}%
   \doif{\answerparameter{showanswer}}{true}{\mode_showanswertrue}%
   \ifmode_showanswer
     \useanswerstyleandcolor\c!style\c!color
     \answerparameter\s!command
     {#2}
   \fi
   \endgroup
   \edef\currentanswer{#2\collectanswer{#2}}
   \edef\prevanswer   {\currentanswer}}
   % Âè™Êúâ‰∏ÄÂÄãÂäüËÉΩÔºå Êî∂ÈõÜÁ≠îÊ°à„ÄÇ
   % ÂÖ∑ÂÇôÁ∞°ÂñÆÁöÑÊ®£ÂºèÊéßÂà∂ÂíåÊéßÂà∂Á≠îÊ°àÈ°ØÈö±„ÄÇ
   % \setupanswer[command=\groupedcommand{\bf}{},style=,color=,showanswer=]

\permanent\protected\def\startanswer
  {\begingroup
   \edef\currentanswer_bak{\currentanswer}%
   \lettonothing\currentanswer
   \doifelsenextoptionalcs\answer_start_delayed\answer_start_indeed}

\def\answer_start_delayed[#S#1]%
  {\doifelseassignmentcs{#1}%
     \answer_start_delayed_parameters
     \answer_start_delayed_name
   [#1]}

\def\answer_start_delayed_parameters[#S#1]%
  {\setupcurrentanswer[#1]%
   \answer_start_indeed}

\def\answer_start_delayed_name[#1]%
  {\cdef\currentanswer{#1}%
   \checkanswerparent
   \doifelsenextoptionalcs\answer_start_delayed_parameters\answer_start_indeed}

\protected\tolerant\def\answer_start_instance[#S#1]#*[#S#2]%
  {\begingroup\env_answertrue\set_envitem_counter
   \edef\currentanswer_bak{\currentanswer}% ÂÇô‰ªΩ‰πãÂâçÁöÑÁ≠îÊ°à
 %  \lettonothing\currentanswer%ÈáãÊîæcurrentanswer
% currentanswer ÂëΩ‰ª§Â∑≤Á∂ìË¢´ÂÖ∂‰ªñÁí∞Â¢ÉÂÆöÁæ©ÁÇ∫Á≠îÊ°àÁç≤ÂèñÂëΩ‰ª§Ôºå
% Ê≠§ËôïÁöÑ currentanswer ÊòØÂÆöÁæ©Áí∞Â¢ÉÂëΩ‰ª§ÔºåÈúÄË¶ÅÈáçÊñ∞ÈáãÊîæ„ÄÇ
   \cdef\currentanswer{#1}%
   \setupcurrentanswer[#2]%
   \grabbufferdatadirect
   % {\s!answer:\currentanswer}%
     {\s!answer}% unnested, as before
     {\e!start\currentanswer}%
     {\e!stop \currentanswer}}

\def\answer_start_indeed
  {\grabbufferdatadirect
   % {\s!answer:\currentanswer}%
     {\s!answer}% unnested, as before
     {\csstring\startanswer}%
     {\csstring\stopanswer}}

\permanent\protected\def\stopanswer
  {\answerparameter\c!before
   \dostarttagged\t!answer\currentanswer
   \begingroup
   \useanswerstyleandcolor\c!style\c!color
   \usealignparameter\answerparameter
   \edef\currentansweralternative{\answerparameter\c!alternative}%
   \ifcsname\currentansweralternativehash\s!parent\endcsname \else
     \let\currentansweralternative\s!default
   \fi
   \usesetupsparameter\answerparameter
   \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
   \directsetup\p_renderingsetup
   \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
     {\getbufferdata[\s!answer]}% 
% ÈúÄË¶ÅÊ≥®ÊÑèÔºåËØ•ÂëΩ‰ª§‰ºö‰º†ÈÄíÁªô datasetÔºå‰∏çÂêå‰∫é writing ÁéØÂ¢ÉÁöÑ currentanswer
% currentanswer ÁöÑÁõÆÁöÑÊòØËÆæÁΩÆËæÉÁü≠ÁöÑ‰ΩúÊñáÁ≠îÊ°à„ÄÇ
% getanswercontent ÂàôÊòØËÆæÁΩÆÂÆåÊï¥ÁöÑ‰ΩúÊñáÁ≠îÊ°à„ÄÇ
% Â¶ÇÊûúÈúÄË¶ÅÁÇ∫ÂÖ∂‰ªñÁí∞Â¢ÉÁç≤ÂèñËß£ÊûêÂÖßÂÆπÔºå ÊáâË©≤ÈúÄË¶ÅÈáçÂÆöÁæ©ÂëΩ‰ª§Ôºàanswer + currentQIDÔºâ
   \endgroup
   \dostoptagged
   \answerparameter\c!after
   \endgroup}

\aliased\let\answer_stop_instance\stopanswer

% kind of nested, when we need it:
%
% \permanent\tolerant\protected\def\getanswer      [#1]{\normalexpanded{\getbufferdata[\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}
% \permanent\tolerant\protected\def\getinlineanswer[#1]{\normalexpanded{\inlinebuffer [\s!answer:\ifparameter#1\or#1\else\currentanswer\fi]}}

% unnested, as before:

\permanent\tolerant\protected\def\getanswer      [#1]{\getbufferdata[\s!answer]}
\permanent\tolerant\protected\def\getinlineanswer[#1]{\inlinebuffer [\s!answer]}

\defineansweralternative
  [\s!default]
  [\c!renderingsetup=\????answerrenderings:\s!default]

% \startsetups[\????answerrenderings:\s!default]
%     \answerparameter\c!before
%     \usesetupsparameter\answerparameter
%     \getbufferdata[\s!answer]
%     \answerparameter\c!after
% \stopsetups

\startsetups[\????answerrenderings:\s!default]
  \doif{\answerparameter  {showscript}}{true}{\mode_showscripttrue\mode_showanswerfalse}%
  \doif{\answerparameter\c!showanswer} {true}{\mode_showanswertrue\mode_showscriptfalse}%
  \doif{\answerparameter\c!showpoint}  {true}{\mode_showpointtrue}%
  \startenv_answer
  \useanswerstyleandcolor\c!style\c!color
  \ifenv_material% ÂèØ‰ª•Áî®Êù•ÂÅöÊñáÁ´†ÁøªËØëÊàñÂÜÖÂÆπËß£ÈáäÔºå 
    \getanswer%          % ‰πüÂèØ‰ª•Áõ¥Êé•ÊîæÁΩÆÂú®ÊñáÁ´†‰πãÂêéÔºåÊàñËøôÊØè‰∏Ä‰∏™ÊÆµËêΩ‰πãÂêé
  \else
    \ifmode_showscript
        \answerparameter{scriptcontent}%
    \else
      \noindent
      \begingroup
      \edef\currentmode{answer}%
      \p_assigned_currentlabel{answer}{answer}%
      \expandafter\expandafter%
        \expandafter\p_pass_currentlabel%
          \expandafter\expandafter%
            \expandafter[%
                \csname p_currentansweranswerlabel\endcsname]{answer}%
      \ifmode_showanswer
        \show_pointoranswer_text[answer][answer]%
      \fi\endgroup
      \begingroup
      \edef\currentmode{point}%
      \p_assigned_currentlabel{answer}{point}%
      \expandafter\expandafter%
        \expandafter\p_pass_currentlabel%
          \expandafter\expandafter%
            \expandafter[%
                \csname p_currentanswerpointlabel\endcsname]{point}%
      \ifmode_showpoint
        \show_pointoranswer_text[answer][point]%
      \fi\endgroup
      \ifmode_showanswer
          \answerparameter\c!inbetween
          \getanswer
      \fi
    \fi
  \fi
  \stopenv_answer
\stopsetups

\tolerant\protected\def\startoldanswer[#1]#:#2\stopoldanswer%
{\begingroup\env_answertrue\set_envitem_counter
  \lettonothing\currentanswer%ÈáãÊîæcurrentanswer
  \lettonothing\getanswer\lettonothing\getinlineanswer
  % currentanswer ÂëΩ‰ª§Â∑≤Á∂ìË¢´ÂÖ∂‰ªñÁí∞Â¢ÉÂÆöÁæ©ÁÇ∫Á≠îÊ°àÁç≤ÂèñÂëΩ‰ª§Ôºå
  % Ê≠§ËôïÁöÑ currentanswer ÊòØÂÆöÁæ©Áí∞Â¢ÉÂëΩ‰ª§ÔºåÈúÄË¶ÅÈáçÊñ∞ÈáãÊîæ„ÄÇ
  \cdef\currentanswer{#1}%
  \setupcurrentanswer[#2]%
  \edef\getanswer{#2}%
  \usesetupsparameter\answerparameter
  \edef\p_renderingsetup{\answeralternativeparameter\c!renderingsetup}%
  \directsetup\p_renderingsetup
  \tolerant\protected\xdef\getanswercontent[##1]% only for writing env
    {#2}%% 
% ÈúÄË¶ÅÊ≥®ÊÑèÔºåËØ•ÂëΩ‰ª§‰ºö‰º†ÈÄíÁªô datasetÔºå‰∏çÂêå‰∫é writing ÁéØÂ¢ÉÁöÑ currentanswer
% currentanswer ÁöÑÁõÆÁöÑÊòØËÆæÁΩÆËæÉÁü≠ÁöÑ‰ΩúÊñáÁ≠îÊ°à„ÄÇ
% getanswercontent ÂàôÊòØËÆæÁΩÆÂÆåÊï¥ÁöÑ‰ΩúÊñáÁ≠îÊ°à„ÄÇ
% Â¶ÇÊûúÈúÄË¶ÅÁÇ∫ÂÖ∂‰ªñÁí∞Â¢ÉÁç≤ÂèñËß£ÊûêÂÖßÂÆπÔºå ÊáâË©≤ÈúÄË¶ÅÈáçÂÆöÁæ©ÂëΩ‰ª§Ôºàanswer + currentQIDÔºâ
\endgroup}

\setuptextbackground
  [env_answer]
  [location=paragraph,width=local,
  leftoffset=1ex,rightoffset=1ex,
  %topoffset=.5ex,bottomoffset=.5ex,
  before={\leftskip=0pt\startnarrower},
  after={\stopnarrower},
  background=\answerparameter\c!background,
  backgroundcolor=\answerparameter\c!backgroundcolor,
  corner=\answerparameter\c!corner,
  frame=\answerparameter\c!frame,
  framecolor=\answerparameter\c!framecolor,
  rulethickness=\answerparameter\c!rulethickness,
  ]

\setupanswer
  [showanswer=true,
  showpoint=true,
  answer=\getanswerforanswer,
  point=\getpointforanswer,
  answerlabel={{\examtexts{answer}:}},
  pointlabel={,\examtexts{point}},
  pointstyle=\answerparameter\c!style,
  pointcolor=\answerparameter\c!color,
  answerstyle=\answerparameter\c!style,
  answercolor=\answerparameter\c!color,
  style=\ss\it,
  before=\blank[halfline],
  after=\blank[halfline],
  inbetween={\par},
  showscript=false,
  %scriptcontent={},
  \c!alternative=\s!default,
  background=normalframeOL,%% for env_answer textbackground
  %backgroundcolor=,
  %corner=,
  frame=on,
  %framecolor=,
  %rulethickness=,
  ]
\defineanswer[answer]

%D \section{ËÆæÁΩÆ pitem,citem ÂëΩ‰ª§}
%D ‰ªÖÂÖ∑Êúâ answer point Âíå reference ÈîÆÂÄº„ÄÇ

%D Ë´ãÊ≥®ÊÑèÔºå‰∏çË¶ÅÂêåÊôÇÁÇ∫ÂñÆÂÄã pitem ÊàñËÄÖ fillin ÂëΩ‰ª§ÂêåÊôÇË®≠ÁΩÆÁ≠îÊ°àÔºå
%D ÈÄôÂèØËÉΩÊúÉÂºïËµ∑Á≠îÊ°àÁÑ°Ê≥ïÊ≠£Á¢∫Áç≤Âèñ„ÄÇ

\installnamespace                {pitem}
\installsimplecommandhandler \????pitem     {pitem}     \????pitem

% \appendtoks
%   \setuevalue        {\currentquestion}{\directnamedquestion[\currentquestion]}%
%   \setuevalue{\e!start\currentquestion}{\startnamedquestion [\currentquestion]}%
%   \setuevalue{\e!stop \currentquestion}{\stopnamedquestion}%
% \to \everydefinequestion

\setuppitem    [%showpoint=,
                %point=,
                pointstyle=\ttx,
                %pointcolor=,
                pointlabel={,\examtexts{point}},,
                %showanswer=,
                %answer=,
                answerstyle=\ss,
                answercolor=red,
                %reference=,
                ]

\tolerant\protected\def\startpitem[#1]{\begingroup%
  \item_pitemtrue\increaseQuestionID%
  \iffirstargument\setuppitem[#1]\fi%
  \startitem[\pitemparameter{reference}]%
    \ifenv_question% Ë®≠Ë®à‰∏äÁöÑÂïèÈ°åÔºåÊ≠§ÊôÇ pitem ËôïÊñº botlevelÔºåÂê¶ÂâáËôïÊñº toplevel„ÄÇ
    \set_count_itemlevel [pitem]\else\ifenv_problem%
    \set_count_envlevel  [pitem]\fi\fi%
    \installpointoranswer[pitem][point]%
    \installpointoranswer[pitem][answer]%
  \removeunwantedspaces}

\def\stoppitem{%
  \ifitem_fillin\edef\currentanswer{\collectedanswer}\fi
  \installdatacollector%
  \installdatacollectorhelper%
  \initcollectanswer% Ê∏ÖÁ©∫Êî∂ÈõÜ fillin ÁöÑÁ≠îÊ°à
  \stopitem\endgroup}

%D [*](Áî®‰∫éÊ†áËÆ∞Ê≠£Á°ÆÁ≠îÊ°à)

\installnamespace                {citem}
\installsimplecommandhandler \????citem     {citem}     \????citem

\setupcitem[
  %style=,
  %color=,
]

\protected\def\check_correct_choice#1#2{%
  \usecitemstyleandcolor\c!style\c!color
  \ifmode_showanswer
    \edef\p_correctmark_m{*}\edef\p_correctmark_p{#1}%
    \ifx\p_correctmark_p\p_correctmark_m 
      \edef\p_answerstyle{\choiceparameter\c!answerstyle}%
      \edef\p_answercolor{\choiceparameter\c!answercolor}%
      \ifx\p_choicetype\s!true
        \bgroup
          \ifempty\p_answerstyle
                  \questionparameter\c!answerstyle
            \else\choiceparameter  \c!answerstyle\fi
          \ifempty\p_answercolor
                  \switchtocolor[\questionparameter\c!answercolor]%
            \else \switchtocolor[\choiceparameter  \c!answercolor]\fi
        \sym{\ifempty\p_correctsymbol\symbol{marksquarecheck}\else
                     \p_correctsymbol\fi}% correct inline choice
        #2\collectanswer{#2}\egroup
      \else
        \startitem[\citemparameter\c!reference]{%
          \ifempty\p_answerstyle
                  \questionparameter\c!answerstyle
            \else\choiceparameter  \c!answerstyle\fi
          \ifempty\p_answercolor
                  \switchtocolor[\questionparameter\c!answercolor]%
            \else \switchtocolor[\choiceparameter  \c!answercolor]\fi
                  #2}
        \stopitem% correct normal choice
      \fi
    \else
      \startitem[\citemparameter\c!reference]#2\stopitem% correct choice without *
    \fi
  \else
    \startitem[\citemparameter\c!reference]#2\stopitem%  choice
  \fi
  \ifx\p_choicetype\s!true
    \markcontent[inlinechoice_punctuation]{\choiceparameter\c!separator}%
  \fi}

\protected\def\get_citem_text[#1]{\setbox0=\hbox{#1}%
    \d_width_cit = \the\wd0\relax%relax is neccessary
    \ifdim \d_width_cit_max > \d_width_cit%
           \d_width_cit_max = \d_width_cit_max%
    \else  \d_width_cit_max = \d_width_cit%
    \fi}%%%% ÈÅûÊ≠∏Ë®àÁÆóÂá∫ÊúÄÂ§ßÂØ¨Â∫¶

\tolerant\protected\def\startcitem[#1]#*[#2]#:#3\stopcitem{% #1 correct answer
  \ifsecondargument\setupcitem[#2]\fi%                     #2 option
  \get_citem_text[#3]%                                     #3 choice content
  \edef\p_correctmark_p{#1}\edef\p_correctmark_m{*}%
%  \set_count_itemlevel[citem]
  \incrementitemnumber
  \ifx\p_choicetype\s!true\else
  \ifx\p_correctmark_p\p_correctmark_m
    \edef\currentanswerindex{\the\c_currentitemnumber}
    \edef\correct_choice_index{\convertnumber{\choiceparameter{numberconversion}}{\currentanswerindex}}%
    \collectanswer{\correct_choice_index}% collect current normal answer
  \fi\fi
  \doif{#1}{*}{\choice_checktrue}%
  \check_correct_choice{#1}{#3}%
  \removeunwantedspaces}

%D \section{ÂÆö‰πâÂêå‰πâÂëΩ‰ª§}

%D \startquestion[showanswer=true]
%D \fastchoice{a,\correct{F},{[*]E},}
%D \stopquestion

%D \startquestion[showanswer=true]
%D \fastchoicealt{a,\correct{F},{[*]sF}}
%D \stopquestion

\def\pitem{\dosingleempty\pitem_indeed}
\def\pitem_indeed[#1]#2{
  \startpitem[#1]{#2}\stoppitem}

\def\citem{\dosingleempty\citem_indeed}
\def\citem_indeed[#1]#2{%
  \startcitem[#1]{#2}\stopcitem}

\tolerant\protected\def\fastchoice[#1]#:#2{
  \startchoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopchoice}

\tolerant\protected\def\fastchoicealt[#1]#:#2{
  \startinlinechoice[#1]
    \def\citem_temp##1{\startcitem##1\stopcitem}
    \def\correct##1{##1\collectanswer{##1}}
    \processcommacommand[#2]\citem_temp
  \stopinlinechoice}

%D Ë∞®ÊÖé‰ΩøÁî®‰∏ãÈù¢ÁöÑ fragilecitemÔºå‰ªñÂπ∂‰∏çÂÆâÂÖ®„ÄÇÂæàÊúâÂèØËÉΩÂØºËá¥ÈîôËØØ

\bgroup
\obeylines
\gdef\xcitem{\bgroup\obeylines\dosingleempty\doxcitem}%
\gdef\doxcitem[#1]#2
  {\egroup%
  \doifsomethingelse{#1}%
  {\startcitem[*]#2\stopcitem}%
  {\startcitem #2\stopcitem}%
  }%
\egroup

\let\fragilecitem\xcitem

%D \section{Ë®≠ÁΩÆ fillin ÂëΩ‰ª§}
%D Ë©≤ÂëΩ‰ª§Âª∫Ë≠∞Âú® pitem Áí∞Â¢ÉÂÖßÈÄ≤Ë°å‰ΩøÁî®„ÄÇ
%D Áï∂ÁÑ∂ÔºåÂêåÊôÇÁî±Êñº pitem Êú¨Ë∫´‰πüÊúâ answer ÈçµÂÄºÔºåÂèØ‰ª•ÈÄöÈÅéË©≤ÈçµÂÄºÈÄ≤Ë°åË®≠ÂÆö„ÄÇ

%D fillin ÂëΩ‰ª§‰∏ªË¶Å‰æùÈù† bar ÂëΩ‰ª§ÂØ¶ÁèæÁöÑ„ÄÇÂü∫Êú¨‰∏äÊåâÁÖß‰øÆÊîπ bar ÂëΩ‰ª§Âç≥ÂèØ‰øÆÊîπ fillin ÂëΩ‰ª§„ÄÇ
%D fillin ÂëΩ‰ª§ÊúâÂÖ©ÂÄãÂèÉËÄÉ textnote ÁöÑÂèÉÊï∏Ôºö empty Âíå n„ÄÇ
%D empty=yesÔºåÈö±ËóèÁ≠îÊ°àÔºõempty=number È°ØÁ§∫Êï∏Â≠óÔºõ empty=none È°ØÁ§∫Á≠îÊ°à„ÄÇ
%D n=* Èö±ËóèÁ≠îÊ°à,Èï∑Â∫¶ÁÇ∫Á≠îÊ°àÈï∑Â∫¶Ôºõ n=NUMBER ÊéßÂà∂ bar ÁöÑÈï∑Â∫¶„ÄÇ

%D bar ‰∏ªË¶ÅÊúâÂõõÁ®ÆÊ®£ÂºèÔºåÂèØ‰ª•ÈÄöÈÅé mp ÂèÉÊï∏ÈÄ≤Ë°åË®≠ÁΩÆÔºö
%D rules:under:dots    %rules:under:random
%D rules:under:dash    %rules:under:wave

%D Êñ∞Â¢û‰∏Ä‰∏™ align=autoright Êù•ËÆ© fillin ÂØπÈΩêÂè≥Êñπ„ÄÇ‰ΩÜÂøÖÈ°ªÂêåÊó∂ËÆæÁΩÆ n=0 Êâç‰ºöÊ≠£Â∏∏Â∑•‰Ωú„ÄÇ

\installnamespace          {fillin}
\installcommandhandler \????fillin    {fillin}    \????fillin

\setupfillin[%foregroundcolor=,
             %before=,after=,
             %left=,right=,
             %repeat=,mp=
              rule=fillin_text,% ÂºïÁî® bar ÂëΩ‰ª§
              empty=none,
              continue=yes,
              unit=em,
              order=foreground,
              method=0,
              %color=gray,
              width=4em,
              n=10,
              dy=-0.4,
              max=3,
              offset=-.1,
              rulethickness=.05,
              foregroundstyle=\ss,]

\tolerant\protected\def\fillin[#1]#:#2{%
  \item_pitemfalse\item_fillintrue
  \begingroup\removeunwantedspaces
  \iffirstargument\setupfillin[#1]\fi
  \setupbar[fillin_text][%
           rulethickness=\fillinparameter{rulethickness},
         foregroundcolor=\fillinparameter{foregroundcolor},
         foregroundstyle=\fillinparameter{foregroundstyle},
                continue=\fillinparameter{continue},
                    unit=\fillinparameter{unit},
                   order=\fillinparameter{order},
                  method=\fillinparameter{method},
                      dy=\fillinparameter{dy},
                     max=\fillinparameter{max},
                   width=\fillinparameter{width},
                    left=\fillinparameter{left},
                   right=\fillinparameter{right},
                  repeat=\fillinparameter{repeat},
                   color=\fillinparameter{color},
                  offset=\fillinparameter{offset},
                   empty=\fillinparameter{empty},
                      mp=\fillinparameter{mp}]%
  \global\advance\c_fillin_number by 1\relax
  \edef\p_n{\fillinparameter\c!n}%
  \edef\p_empty{\fillinparameter\c!empty}%
  \edef\p_number{\number\c_fillin_number}%
  \edef\p_align{\fillinparameter\c!align}%
  \edef\currentbar{\fillinparameter\c!rule}%
  \ifx\p_align\c!autoright
    \unskip\nobreak\hfill\penalty50\hskip2em\hbox{}\nobreak\hfill\fi
  \fillinparameter\c!before\fillinparameter\c!left
  \ifx\p_n\wildcardsymbol
     \donefalse
     \ifx\p_empty\v!yes\donetrue
     \else\ifx\p_empty\v!number\donetrue
     \else\ifx\p_empty\v!none\donetrue
     \fi\fi\fi
     \ifdone
      \ifmode_showanswer
        \setupfillin[empty=none]%
      \else
        \setupbar[\currentbar][\c!empty=\v!yes]%
      \fi
      \edef\p_empty{\fillinparameter\c!empty}%
    \fi
     \inlinebar[\currentbar]\bgroup
        \wordboundary#2\egroup
   \else
    \ifmode_showanswer\setupfillin[empty=none]\fi
    \edef\p_empty{\fillinparameter\c!empty}%
    \inlinebar[\currentbar]\bgroup
      \wordboundary\scratchcounter\numexpr\p_n\relax
      \ifx\p_empty\v!yes
        \interwordspacesbefore\scratchcounter
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!number
        \interwordspacesbefore\scratchcounter
        \zwnj\runninghbox{\resetbar\p_number}\zwnj
        \interwordspacesafter\scratchcounter
      \else\ifx\p_empty\v!none
        \scratchcounter\numexpr\p_n/\plustwo\relax
        \interwordspacesbefore\scratchcounter
        \zwnj{{#2}}\zwnj
        \interwordspacesafter\scratchcounter
      \else#2\fi\fi\fi
    \egroup
   \fi
  \fillinparameter\c!right\fillinparameter\c!after
  \ifx\p_align\c!autoright
    \parfillskip=0pt \finalhyphendemerits=0 \par\fi
  \aftergrouped{\edef\currentanswer{\collectanswer{#2}#2}}
  \endgroup}

%D \section{Ë®≠ÁΩÆ material Áí∞Â¢É}
%D È°ßÂêçÊÄùÁæ©Ôºå\tex{material} Áí∞Â¢ÉÁî®‰æÜÊîæÁΩÆÂ§ßÊÆµÊñáÊú¨ÊùêÊñô„ÄÇ
%D Ë©≤Áí∞Â¢ÉÊØîËºÉÁâπÊÆäÔºåÂÆÉË®≠ÁΩÆ‰∫ÜÂ§öÂÄãÂ≠êÂØ¶‰æã‰æÜÈÄ≤Ë°åÊõ¥ÂÆåÂñÑÁöÑË®≠ÁΩÆ„ÄÇ
%D Èô§‰∫Ü \tex{setupmaterial[number]} ÈÄôÂÄãÂØ¶‰æãÁπºÊâø‰∫Ü \tex{setupcounter} ÁöÑÂÖ®ÈÉ®ÈçµÂÄº‰πãÂ§ñÔºå
%D ÂÖ∂‰ªñÂØ¶‰æãÈÉΩÊòØÊñ∞ÂÆöÁæ©ÁöÑÈçµÂÄº„ÄÇ

%D ÈÄô‰∫õÂØ¶‰æãÂàÜÂà•ÊòØÔºö
%D \startitemize[nowhite,joinedup,packed]
%D \item \tex{setupmaterial[number]}    Ë®≠ÁΩÆ Ë©≤Áí∞Â¢ÉÊ®ôÈ°åÁöÑ {\bf Â∫èËôü};
%D \item \tex{setupmaterial[title]}     Ë®≠ÁΩÆ Ë©≤Áí∞Â¢ÉÁöÑ {\bf Ê®ôÈ°å} Áõ∏ÈóúÁöÑÊ®£Âºè;
%D \item \tex{setupmaterial[author]}    Ë®≠ÁΩÆ Ë©≤Áí∞Â¢ÉÊñáÁ´†ÁöÑ {\bf ‰ΩúËÄÖ} Áõ∏ÈóúÁöÑÊ®£Âºè;
%D \item \tex{setupmaterial[source]}    Ë®≠ÁΩÆ Ë©≤Áí∞Â¢ÉÊñáÁ´†ÁöÑ {\bf ÂÖ∑È´î‰æÜÊ∫ê} ÁöÑÁõ∏ÈóúÊ®£Âºè„ÄÇ
%D \item \tex{setupmaterial[indicator]} Ë®≠ÁΩÆ Ë©≤Áí∞Â¢ÉÊñáÁ´†ÁöÑ {\bf Áï´Á∑öÂ∫èËôüÊñáÂ≠ó} ÁöÑÁõ∏ÈóúÊ®£Âºè„ÄÇ
%D \stopitemize

%D Ê≠§Â§ñÔºå\type{title},\type{author},\type{source} ÁöÑÂêçÁ®±ÊòØÈÄöÈÅé \tex{setupmaterial}
%D ‰æÜÁõ¥Êé•Ë®≠ÁΩÆ„ÄÇÊ≠§Â§ñÔºå Ë©≤Áí∞Â¢ÉÂÖ∑Êúâ‰∏ÄÂÄãÁâπÊÆäÁöÑÂ≠êÂëΩ‰ª§ \tex{indicator} ‰æÜÊ®ôË®òÊñáÁ´†‰∏≠ÁöÑÊèêÂïèÁöÑÈÉ®ÂàÜ‰∏¶
%D ÈÄ≤Ë°åÊ∑ªÂä†Êï∏Â≠óÊ®ôË≠ò --- Ôºà‰∏ÄÔºâÁï´Á∑öÊñáÂ≠ó„ÄÇÂõ†Ê≠§Ôºå\tex{setupmaterial} ÈÇÑÂÖ∑Êúâ‰∏ÄÂÄãÈçµÂÄº indicator
%D ÈÄöÈÅé \type{indicator=reset} Â∞ç indicator ÈÄ≤Ë°åÈáçÁΩÆÔºåÊØèÁï∂ÈñãÂïì‰∏ÄÂÄãÊñ∞ÁöÑ material Áí∞Â¢É„ÄÇ
%D ÈÄöÈÅé \type{indicator=continue} Â∞ç indicator ÂèñÊ∂àÈáçÁΩÆÔºåÂÆÉÂ∞áÊåÅÁ∫åË®àÊï∏„ÄÇ
%D Áï∂ÁÑ∂Ôºå‰πüÂèØ‰ª•Áõ¥Êé•ÈÄöÈÅé \tex{setupmaterial[indicator][reset=true]} ‰æÜÂïìÁî®ÈáçÊñ∞Ë®àÊï∏

%D ‰ª•‰∏äÊâÄÊúâÂØ¶‰æãÈÉΩÂÖ∑Êúâ‰ª•‰∏ãÈçµÂÄºÔºö
%D before after align style color
%D Ê≠§Â§ñÔºå\tex{setupmaterial} ÂèØ‰ª•ÈÄöËøá spacebefore Âíåspaceafter Êù•ÊéßÂà∂ÁéØÂ¢ÉÂâçÂêéÁöÑÂûÇÁõ¥Ë∑ùÁ¶ª

%D notice , if you want change [start = number] after a chapter ,
%D you should use \tex{resetcount[COUNTER_NAME]} to reset current counter
%D to the number of start you've setted.
%D otherwise, you need put [start = number] before the chapter you want
%D to reset the counter.

%D \startbuffer
%D \setupmaterial[title][color=green]
%D \startmaterial[title={Knuth},author={Mos},source={Yelu}]
%D \input knuth
%D \stopmaterial
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\installnamespace          {material}
\installcommandhandler \????material  {material}  \????material
\installcounterassociation {material}

\appendtoks
   \registermaterialcounter\currentmaterial
   \definecounter[\currentmaterial]%
\to \everydefinematerial

\appendtoks
   \synchronizematerialcounters
\to \everysetupmaterial

\definematerial [material]
\definematerial [number]
\definematerial [indicator]
\definematerial [indicator_helper]

\setupmaterial [\c!align=center,
                %\c!color=,
                %\c!style=,
                \c!spacebefore=1em,
                \c!spaceafter=1em,
                %\c!title=,
                %\c!author=,
                %\c!source=,
                \c!indicator=continue,
                indent={first,always,2em},]
\setupmaterial [\c!number] [\c!before={(},\c!after={)},
                            \c!prefix=no,\c!start=0,
                            \c!style=\namedmaterialparameter\c!title\c!style,
                            \c!color=\namedmaterialparameter\c!title\c!color,
                            \c!numberconversion=cn,\c!way=\v!by\v!chapter]
\setupmaterial [\c!title]  [\c!style=\ss\tfa,\c!color=,\c!align=center,
                            \c!before=,]
\setupmaterial [\c!author] [\c!style=\tf,\c!color=,\c!align=flushright]
\setupmaterial [\c!source] [\c!before=\par,\c!align=flushright]
\setupmaterial [indicator,indicator_helper]
               [style=\ss\bf,before={ (~},after={~) },prefix=no,
                numberconversion=cn,type=line,reset=false]

\def\material_counter_parameter#1%
  {\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\c!title\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \incrementcounter[#1]\convertedcounter[#1]%
    \namedmaterialparameter\currentmaterial\c!after
   \endgroup}

\def\material_parameter#1%creat new element in material
  {{\begingroup
    \def\currentmaterial{#1}%
    \setupalign[\namedmaterialparameter\currentmaterial\c!align]
    \usematerialstyleandcolor\c!style\c!color
    \namedmaterialparameter\currentmaterial\c!before
    \rootmaterialparameter\currentmaterial
    \namedmaterialparameter\currentmaterial\c!after
    \par\endgroup}}

\tolerant\protected\def\startmaterial[#1]{\begingroup%
  \lettonothing\currentmaterial%%
  \edef\p_indicator{\rootmaterialparameter\c!indicator}
  \edef\p_reset{\namedmaterialparameter{indicator}\c!reset}
  \processaction[\p_indicator][
    reset=>\let\indicator_reset_helper\resetindicators,
  continue=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \processaction[\p_reset][
    true=>\let\indicator_reset_helper\resetindicators,
    false=>\continue_countertrue\let\indicator_reset_helper\relax,]
  \env_materialtrue\set_envitem_counter%
  \iffirstargument\setupcurrentmaterial[#1]\fi
  \indicator_reset_helper
  \usematerialstyleandcolor\c!style\c!color%
  \blank[\rootmaterialparameter\c!spacebefore]
  \startalignment[\rootmaterialparameter\c!align]
      \material_counter_parameter\c!number
      \material_parameter\c!title
      \material_parameter\c!author
  \stopalignment
  \blank[\rootmaterialparameter\c!spaceafter]
  \setupindenting[\rootmaterialparameter{indent}]
  \removeunwantedspaces}
\def\stopmaterial{%
    \material_parameter\c!source
    \indicator_reset_helper
    \endgroup}

\tolerant\protected\def\indicator[#1]#:#2{\begingroup%
    \def\currentmaterial{indicator}
    \iffirstargument\setupmaterial[indicator][#1]\fi%
    \edef\indicator_type{\namedmaterialparameter\currentmaterial\c!type}%
    \edef\indicator_reset{\namedmaterialparameter\currentmaterial\c!reset}%
    \processaction[\indicator_type]%
              [line=>\let\indicator_type\underbar,%
               none=>\let\indicator_type\relax]%
    \usematerialstyleandcolor\c!style\c!color%
    \indicator_type{%
    \namedmaterialparameter\currentmaterial\c!before%
    \ifmode_check%
      \ifenv_material\color[red]{material}\else\color[red]{\currentitemgroup}\fi%
      \ifcontinue_counter\color[red]{continue}\fi%
    \fi%
    \ifenv_material%
      \ifmode_check\color[red]{::indicator}\fi%
      \incrementcounter[\currentmaterial]%
      \convertedcounter[\currentmaterial]%
    \else%
      \ifmode_check\color[red]{::helper}\fi%
      \incrementcounter[indicator_helper]%
      \convertedcounter[indicator_helper]%
    \fi%
    \namedmaterialparameter\currentmaterial\c!after%
    #2}
\endgroup}

\def\indicators{%%% TODO Â¢ûÂº∑Ë©≤ÂëΩ‰ª§ÁöÑÁî®Ê≥ï
  \ifenv_material
    \ifmode_check\color[red]{::indicator}\fi
    \incrementcounter[indicator]%
    \convertedcounter[indicator]%
  \else
    \ifmode_check\color[red]{::helper}\fi
    \incrementcounter[indicator_helper]%
    \convertedcounter[indicator_helper]%
  \fi}
\def\resetindicators{\setcounter[indicator][0]%
                     \setcounter[indicator_helper] [0]}
%%%%%%%%%%%%%%%%
%D \section{ËÆæÁΩÆ close ÁéØÂ¢É}

\c_closetest=1\relax
\tolerant\protected\def\closebar#1{
  \startbar[underbar]
    \scratchcounter\numexpr16/\plustwo\relax
    \interwordspacesbefore\scratchcounter
      \zwj\runninghbox{\resetbar{#1}}\zwj
    \interwordspacesafter\scratchcounter
  \stopbar}

%D close Áí∞Â¢ÉËøë‰πéÊòØÂñÆÁç®Ë®≠Ë®àÁöÑ„ÄÇÈÇÑÈúÄË¶ÅÊîπÈÄ≤ÔºöÁõ¥Êé•‰ΩøÁî® itemgroup ÈáçÁΩÆÔºåË©≤Áí∞Â¢É‰∏ªË¶Å‰ΩøÁî®ÂÖ©ÂÄãÂëΩ‰ª§Ôºö
%D \tex{startclose} Âíå \tex{stopclose} Áî®‰æÜÂâµÂª∫Ë©≤Áí∞Â¢ÉÔºå
%D \tex{closechoice} Áî®‰æÜÊ®ôË®òÁí∞Â¢ÉÂÖßÁöÑÈÅ∏È†ÖÔºåË©≤ÂëΩ‰ª§Èö®Ë°åÊñáÊîæÁΩÆÂç≥ÂèØ„ÄÇÈÅ∏È†ÖÁÑ°È†àÂÜçÊ¨°Âú®ÊñáÁ´†ÂæåÊîæÁΩÆÔºå
%D \tex{stopclose} ÊúÉËá™Ë°åÊîæÁΩÆ„ÄÇ
%D Âõ†ÁÇ∫ \type{close} Áí∞Â¢ÉÁöÑÂ≠êÈ†ÖÁõÆ \tex{closechoice} ÊòØÈÄöÈÅé choice Áí∞Â¢ÉË®≠ÁΩÆÁöÑ„ÄÇ
%D Âõ†Ê≠§ÔºåÂèØ‰ª•ÈÄöÈÅé \type{[*]} ‰æÜÊ®ôË®òÊ≠£Á¢∫Á≠îÊ°à„ÄÇ

%D close Áí∞Â¢ÉÂêåÊ®£ÁπºÊâø‰∫Ü answer ÁöÑÈçµÂÄº„ÄÇ
%D Ê≠§Â§ñË®≠ÁΩÆ‰∫Ü reset Èçµ‰æÜÈÅ∏ÊìáÊòØÂê¶ÊØè‰∏ÄÁØáÈáçÁΩÆÈÅ∏È†ÖÁöÑÈ°åËôüÔºå
%D ÂÖ∂‰ªñÁöÑÈçµÂÄºÔºö barcolor barstyle Ë®≠ÁΩÆ ‰∏ãÂàíÁ∑öÊ®£Âºè
%D            before after style color Áî®ÊñºÊï¥È´îÁí∞Â¢É
%D            width frame stopper distance Áî®ÊñºÈÅ∏È†ÖÂâçÈ°åËôüÊ®£Âºè

%D \startbuffer
%D \startclose
%D On Oct. 11, hundreds of runners competed in a cross-country race in Minnesota.
%D Melanie Bailey should have \closechoice[designed,followed,changed,finished] the
%D course earlier than she did. Her \closechoice[delay,chance,trouble,excuse] came
%D because she was carrying a \closechoice[judge,volunteer,classmate,competitor]
%D across the finish line.
%D
%D As reported by a local newspaper, Bailey was more than two-thirds of the way
%D through her \closechoice[race,school,town,training] when a runner in front of
%D her began crying in pain. She \closechoice[agreed,returned,stopped,promised]
%D to help her fellow runner, Danielle Lenoue. Bailey took her arm to see if she
%D could walk forward with \closechoice[courage,aid,patience,advice] . She couldn't.
%D Bailey then \closechoice[went away,stood up,stepped aside,bent down] to let Lenoue
%D climb onto her back and carried her all the way to the finish line, then another
%D 300 feet to where Lenoue could get \closechoice[medical,public,constant,equal] attention.
%D
%D Once there, Lenoue was \closechoice[interrupted,assessed,identified,appreciated]
%D and later taken to a hospital, where she learned that she had serious injuries in
%D one of her knees. She would have struggled with extreme \closechoice[hunger,pain,cold,tiredness]
%D to make it to that aid checkpoint without Bailey's help.
%D
%D As for Bailey, she is more \closechoice[worried,ashamed,confused,discouraged]
%D about why her act is considered a big \closechoice[game,problem,lesson,deal] .
%D "She was just crying. I couldn't \closechoice[leave,cure,bother,understand] her,"
%D Bailey told the reporter. "I feel like I was just doing the right thing.‚Äù
%D
%D Although the two young women were strangers before the \closechoice[ride,test,meet,show] ,
%D they've since become friends. Neither won the race, but the \closechoice[secret,display,benefit,exchange]
%D of human kindness won the day.
%D \stopclose
%D \stopbuffer
%D \typebuffer
%D \framed[width=\textwidth,align={flushleft,lohi}]{\getbuffer}

\setupclose[%showanswer=false,
            reset=true,
            %mp=,
            answerstyle=\ss,
            answercolor=red,
            width=2em,% set order width
            frame=off,% set order frame
            stopper=.,% set order stopper
            distance=.5em,% set order distance
            after=\blank[halfline]]

\def\closechoice[#1]{%ÂÆöÁæ©ÊñáÁ´†ÂÖßÁöÑÂ∫èËôü„ÄÇÈÄôÊòØÁî®Êà∂ÂëΩ‰ª§ÔºåÁî®‰æÜË®òÈåÑÈÅ∏È†Ö(ÂÆöÁæ©ÈÅ∏È†ÖÂàóË°®)
  \expandafter\gdef\csname close:\romannumerals\c_closetest\endcsname{#1}%
  % c_closetest Áî®ÊñºÊ®ôË®òÈÅ∏È†ÖÂàóË°®ÔºåÊúÉÈö®ËëóÈÅ∏È†ÖÈ°åÁõÆÂ¢ûÂä†ÔºåÁÑ°Ë´ñÊòØÂê¶ÂïìÁî®ÈáçÁΩÆÔºåË©≤Ë®àÊï∏Âô®ÈÉΩÊúÉË®òÈåÑ‰∏¶Ëá™Â¢û
  % Âú®ÁîüÊàêÈÅ∏È†ÖÂ∫èÂàóÊôÇÔºåË©≤Ë®àÊï∏Âô®ÂèØ‰ª•ÈÄ≤Ë°åÔºö(1) ÊòØÂê¶Ë®≠ÁΩÆ‰∫ÜÈÅ∏È†Ö (2) ÈÅûÂ¢ûÂá∫ÈÅ∏È†ÖÂ∫èÂàó
  % Ë©≤Ë®àÊï∏Âô®Â±¨ÊñºÂ±ÄÂüüÔºåÊØèÁØáÊñáÁ´†ÈÉΩÊúÉÈáçÁΩÆÂõû 1„ÄÇ
  \ifclose_counter_reset%
    \begingroup%
      \switchtocolor[\closeparameter{barcolor}]%
      \closeparameter{barstyle}%
      \closebar{\number\c_closetest}%
    \endgroup%
  \else%
    \begingroup\let\par\relax% Â∞áÂÖ∂Â∞ÅË£ùÂú®Â±ÄÂüüÔºåÈÅøÂÖç par ÂëΩ‰ª§Â§±Êïà
      \switchtocolor[\closeparameter{barcolor}]%
      \closeparameter{barstyle}%
      \startitemgroup[env_question][n,continue,text,nostopper]%
                                   [lefttext=\closebar,righttext=]%
      \item \save_question_order%
      \stopitemgroup%
    \endgroup%
  \fi\advance\c_closetest by 1\relax}

\def\docloseitem#1{\startcitem #1\stopcitem}
\def\close_order{%ÈÅ∏È†ÖÂâçÁöÑÂ∫èËôüÊ®£ÂºèÔºåÂ∫èËôüÈÄöÈÅé tempa Ë®≠ÂÆö
  \noindent\unskip%
  \inframed[width=\closeparameter\c!width,
            frame=\closeparameter\c!frame,
            foreground=color,
            foregroundcolor=\closeparameter\c!color,
            foregroundstyle=\closeparameter\c!style]{%
     \convertnumber{n}{\number\c_closetest_tempa}%
     \closeparameter\c!stopper%
     \increaseQuestionID%
     \installpointoranswer[close][answer]}%
   \hskip\closeparameter\c!distance\relax
   \global\advance\c_closetest_tempa by 1\relax
  \unskip}

\def\placeclosechoice{%
  \ifnum\c_closetest=1\relax
        \color[red]{it seems that there is no
                    "closechoice" be setted,
                     please check it!}%
  \fi%
  \scratchcounter\numexpr\c_closetest-1\relax
  \c_closetest=1\relax%
  \def\closetest_list{\csname close:\romannumerals\c_closetest\endcsname}%
  \useclosestyleandcolor\c!style\c!color%
   \dorecurse{\number\scratchcounter}{% start recurse
     \hbox{% start first box
       \hsize=\textwidth%
       \edef\currentitemnumber{\the\c_closetest_tempa}%
       \edef\currentcloseuserorder{%
         \number\c_closetest_tempa%ÊîæÁΩÆÂú®ÈÄôË£°ÊâçËÉΩÊ≠£Á¢∫Áç≤ÂèñÈ°åËôü
         \ifnum\rawcountervalue[Unicode_botlevel]=0\else% ÊäΩÂá∫ order ÂÆöÁæ©Ôºå
         (\rawcountervalue[Unicode_botlevel])\fi}% Âõ†ÁÇ∫Ë©≤Áí∞Â¢ÉÊ≤íÊúâ‰∏äÁ¥ö question Áí∞Â¢É
       \hbox{\close_order}% close question index  box
       \hbox{\vtop{%        close question choice box start
          \startchoice%
            \processcommacommand[\closetest_list]\docloseitem%
          \stopchoice}}%    close question choice box stop
     }% stop first hbox
   \advance\c_closetest by 1\relax}% stop reucrse
  \c_closetest=1\relax%
}

\tolerant\protected\def\startclose[#1]{\begingroup%
  \env_closetrue\set_envitem_counter%%
  \iffirstargument\setupclose[#1]\fi%
  \edef\p_reset{\closeparameter\c!reset}
  \ifx\p_reset\s!true%
       \close_counter_resettrue%
  \else\close_counter_resetfalse\fi%
  \restore_question_order%
  \ifclose_counter_reset\c_closetest_tempa=1\relax\else%
    \c_closetest_tempa=\number\scratchcounter%tempa Ê†áËÆ∞ÊñáÁ´†ÂÜÖÁöÑÂ∫èÂè∑ÂíåÈÄâÈ°πÂâçÁöÑÂ∫èÂè∑
    \c_closetest_tempa=\numexpr\c_closetest_tempa+1\relax
  \fi\closeparameter\c!before\removeunwantedspaces}

\def\stopclose{%
  \closeparameter\c!after%
  \placeclosechoice%
  \endgroup%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Ë®≠ÁΩÆ optclose Áí∞Â¢É}
%D Ë©≤Áí∞Â¢ÉÊòØ close Áí∞Â¢ÉÁöÑËÆäÈ´îÔºå‰ΩÜÁõÆÂâç‰∏¶Êú™Â∞çË©≤Áí∞Â¢ÉÈÄ≤Ë°åÊõ¥Â§öÁöÑË®≠ÁΩÆ„ÄÇ
%D Ë©≤Áí∞Â¢ÉÁöÑ‰∏ªË¶ÅÂëΩ‰ª§ÊúâÂÖ©ÂÄãÔºö
%D \tex{startoptclose} Âíå \tex{stopoptclose} Áî®‰æÜÂâµÂª∫Ë©≤Áí∞Â¢ÉÔºå
%D \tex{ocitem} Áî®‰æÜÊ®ôË®òÁí∞Â¢ÉÂÖßÁöÑÈÅ∏È†ÖÔºåË©≤ÂëΩ‰ª§Èö®Ë°åÊñáÊîæÁΩÆÂç≥ÂèØ„ÄÇ
%D \tex{ocitem[answer=blabla]}\type{blablabla}

%D Ê≠§Â§ñÔºåÈÇÑÊúâ‰∏ÄÂÄãÁâπÊÆäÁöÑÂëΩ‰ª§Ôºå\tex{specialocitem} ÂÉÖÂÖ∑Êúâ answer ÈçµÂÄº„ÄÇÂèØ‰ª•ÈÄöÈÅé
%D \tex{setupocitem} ‰æÜË™øÊï¥Ë©≤ÂëΩ‰ª§ÁöÑÊ®£Âºè„ÄÇË©≤ÂëΩ‰ª§Ê®ôË®òÁ≠îÊ°àÔºå‰∏îÁÑ°È†à‰ªª‰ΩïÁí∞Â¢ÉÂåÖË£π„ÄÇ

\installnamespace          {ocitem}
\installcommandhandler \????ocitem    {ocitem}    \????ocitem

\setupocitem [%answer=,
              %color=,
              %point=,
              %showanswer=false,
              answerlabel={answer: },
              answercolor=red,answerstyle=\ss,]

\tolerant\protected\def\startoptclose[#1]{%
  \begingroup\env_closetrue\set_envitem_counter%%
  \iffirstargument\setupclose[#1]\fi%
  \edef\p_reset{\closeparameter\c!reset}%
  \ifx\p_reset\s!true\resetcounter [itemgroup:env_question]\fi%
  \useclosestyleandcolor\c!style\c!color%
  \startitemgroup[env_question][n,continue,text,nostopper][lefttext=\closebar,righttext=]%
  \leftskip=0pt\relax\set_count_envlevel[question]%
  \removeunwantedspaces}

\def\stopoptclose{\stopitemgroup\endgroup}

\tolerant\protected\def\ocitem[#1]#:#2%
   {\begingroup%
    \iffirstargument\setupocitem[#1]\fi%
    \useocitemstyleandcolor\c!style\c!color%
    \let\par\relax\increaseQuestionID%
    \item \parentitemnumber=\currentitemnumber\relax
          \set_count_itemlevel[ocitem]%%%% ÂøÖÈ†àÂëΩ‰ª§ÔºåË®≠ÂÆöÂ∫èËôü
          % Ê≥®ÊÑèÔºåÊ≠§Êó∂ toplevel Âπ∂Ê≤°ÊúâÊ≠£Á°ÆÁöÑÂÖ≥Èó≠ÔºåÂõ†Ê≠§ÊúÄÁªàÁöÑÁªìÊûú‰æùÁÑ∂ÊòØ toplevel„ÄÇ
          % ‰ΩÜÊòØËØ•ÁéØÂ¢ÉÊú¨Ë∫´Â∞±Ë¢´ËßÜ‰∏∫ toplevel                =>  5
          % Â¶ÇÊûúËØ•ÁéØÂ¢ÉË¢´ËßÜ‰∏∫Â≠êÈ°πÁõÆÊó∂ÔºåÂàôÈúÄË¶ÅÂÖ≥Èó≠ toplevel„ÄÇ==> 5(1)
          % Âè¶Â§ñÔºåÂÖ≥Èó≠ toplevel ÈúÄË¶ÅÂú® set_count_itemlevel ÂëΩ‰ª§‰πãÂâçÊâç‰ºöÁîüÊïà„ÄÇ
          \allowbreak\doifsomethingelse{#2}{(#2)}{}%
          \installpointoranswer[ocitem][point]%
          \installpointoranswer[ocitem][answer]%
          \installdatacollector%
          \installdatacollectorhelper%
          \initcollectanswer
          \save_question_order%
  \endgroup}

\tolerant\protected\def\specialocitem[#1]{%
  \begingroup\let\par\relax%
  \iffirstargument\setupocitem[#1]\fi%
  \useocitemstyleandcolor\c!style\c!color%
  \startitemgroup[env_question][n,continue,text,nostopper][lefttext=\closebar,righttext=]%
  \item \parentitemnumber=\currentitemnumber\relax
        \increaseQuestionID%
        \installpointoranswer[ocitem][point]%
        \set_count_itemlevel [ocitem]%
        % ÂÖ≥‰∫é toplevel ÁöÑÈóÆÈ¢òÂèÇËßÅ ocitem ÁöÑËß£Èáä„ÄÇ
        % ÊòØÂê¶ÈúÄË¶ÅËÆæÁΩÆÂ≠êÈ°πÁõÆËøòÊúâÂæÖËÄÉËôë„ÄÇ
        \def\prevanswer{\ocitemparameter\c!answer}
        \installpointoranswer[ocitem][point]%
        \installpointoranswer[ocitem][answer]%
        \installdatacollector%
        \installdatacollectorhelper%
        \initcollectanswer
        \save_question_order%
  \stopitemgroup\removeunwantedspaces\endgroup}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{score}
%D ÊîæÁΩÆÂú® answer Áí∞Â¢ÉÂÖßÊ®ôË®òÂæóÂàÜ„ÄÇ

%D \starttyping
%D   score\score{3}\\
%D   score\score[type=dotfill]{30}\\
%D   \resetscore\\
%D   score\score[type=cdotfill]{30}\\
%D   \setupscore[score=calculation]
%D   score\score[type=space]{3}\\
%D   score\score[type=hfill]{3}\\
%D \stoptyping

\def\score_calc#1{% only show number
  \global\c_stepscore_temp=#1\relax%
  \ifnum\c_stepscore=0\global\c_stepscore=#1\relax\else%
  \global\c_stepscore=\numexpr\c_stepscore+\c_stepscore_temp\relax%
  \fi\number\c_stepscore%
}
\def\dotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil.\hfil}%
  \hfill\kern 0pt\relax}
\def\cdotfill{\leavevmode%
  \xleaders\hbox to 0.25em{\hfil$\cdot$\hfil}%
  \hfill\kern 0pt\relax}

\installnamespace                 {score}
\installcommandhandler \????score {score} \????score

\setupscore[style=\ssa,color=red,dotstyle=\ss,dotcolor=red,score=]

\tolerant\protected\def\score[#1]#:#2{\begingroup% format style
  \iffirstargument\setupscore[#1]\fi%
  \scoreparameter\c!before%
  \usescorestyleandcolor\c!style\c!color%
  \start\space\scoreparameter{dotstyle}%
  \switchtocolor[\scoreparameter{dotcolor}]%
  \doif{\scoreparameter\c!type}{}{\dotfill}%
  \doif{\scoreparameter\c!type}{space}{}%
  \doif{\scoreparameter\c!type}{hfill}{\unskip\hfill}%
  \doif{\scoreparameter\c!type}{dotfill}{\dotfill}%
  \doif{\scoreparameter\c!type}{cdotfill}{\cdotfill}%
  \space\stop\scoreparameter\c!left%
  \doif{\scoreparameter{score}}{}           {#2}%
  \doif{\scoreparameter{score}}{default}    {#2}%
  \doif{\scoreparameter{score}}{calculation}{\score_calc{#2}}%
  \doif{\scoreparameter{score}}{complex}    {#2 : \score_calc{#2}}%
  \scoreparameter\c!right\scoreparameter\c!after%
\par\endgroup}
\def\resetscore{%
  \c_stepscore_temp=0\relax%
       \c_stepscore=0\relax%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\installnamespace          {writingbox}
\installcommandhandler \????writingbox    {writingbox}    \????writingbox
\setupwritingbox[row=10,column=18,width=2em,height=2em,midheight=1em]
\newcount \tbl_row
\newcount \tbl_col
\def\makewritingbox{\dosingleempty\makewritingbox_indeed}
\def\makewritingbox_indeed[#1]{\begingroup%
    \tbl_row=\writingboxparameter{row} % yoko
    \tbl_col=\writingboxparameter{column} % tate
    \setupTABLE[split=yes]
    \setupTABLE[column][width=\writingboxparameter{width}]
    \setupTABLE[row][odd][height=\writingboxparameter{midheight}]
    \setupTABLE[row][even][height=\writingboxparameter{height}]
    \bTABLE
        \bTR \bTD[nc=\number\tbl_col] {} \eTD \eTR
        \dorecurse{\number\tbl_row}{
        \bTR
            \dorecurse{\number\tbl_col}{\bTD {} \eTD}
        \eTR
        \bTR \bTD[nc=\number\tbl_col] {} \eTD \eTR}
    \eTABLE
\endgroup}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Ê®°Êãü‰æãÂ≠ê}

\dorecurse{2000}{% ÊèêÈ´òËøô‰∏™Êï∞Â≠óÔºåÂèØ‰ª•ÊèêÂçáÂèØÁîüÊàê‰æãÂ≠êÁöÑÊÄªÊï∞„ÄÇÊâÄÊúâ‰æãÂ≠êÂÖ±Áî®‰∏Ä‰∏™ÊÄªÊï∞
\expandafter\getrandomnumber \csname n_\romannumeral\recurselevel\endcsname  {1} {20}}

\dorecurse{2000}{% ‰∏ÄÊó¶ÊÄª‰æãÂ≠êÊï∞Ë∂ÖËøáÔºåÂàôÊó†Ê≥ïÁªßÁª≠ÁîüÊàêÔºåÂπ∂ÊäõÂá∫ÈîôËØØ„ÄÇ
\expandafter\getrandomnumber \csname nn_\romannumeral\recurselevel\endcsname {1} {20}}

\def\longtesttxt[#1]{%%1. \longtesttxt[\romannumeral 1]
  \ifcase\csname n_#1\endcsname%
    Â∞±ÂÉèÊåâ S Êù•ÂìçÂ∫îÈîôËØØ‰∏ÄÊ†∑„ÄÇ\or%0
    Ëøô‰∏™‰æãÂ≠ê‰∏çÂ§™ÂÆåÊï¥ÔºåÂõ†‰∏∫È°µÁ†ÅÊ≤°ÊúâÂ≠òÂÇ®Âú®ÊúâÁî®ÁöÑÂú∞Êñπ„ÄÇ\or%1
    TeX Â§ÑÁêÜÊï∞Â≠¶ÊòæÁ§∫ÂêéÔºåÂÆÉÂ∞Ü‰ª•‰∏ãÈ°πÁõÆÊ∑ªÂä†Âà∞ÂΩìÂâçÂûÇÁõ¥ÂàóË°®‰∏≠Ôºö ÊÉ©ÁΩö„ÄÅËÉ∂Ê∞¥„ÄÅÂÆûÈôÖÊòæÁ§∫„ÄÅËÉ∂Ê∞¥ÂíåÊÉ©ÁΩö„ÄÇ\or%2
    ÁÑ∂ËÄåÔºåÂÆÉÊòæÁ§∫‰∫Ü‰∏ÄÁßçÂ¢ûÂä†ÊàñÂáèÂ∞ëËÆ°Êï∞Âô®ÁöÑÊñπÊ≥ïÔºåÂπ∂ËÆæÁΩÆÊï∞Â≠ó‰∏≠ÁöÑÊï∞Â≠óÊàñÁõ∏ÂΩì‰∫éÊï∞Â≠óÁöÑÁΩóÈ©¨Êï∞Â≠ó‰∏≠ÁöÑÂ≠óÊØç„ÄÇ\or%3
    Âü∫Êú¨ÈóÆÈ¢òÊòØ ‚ÄúÂØπ TeXbook ÁöÑÈ°µÈù¢ÂºïÁî®Â∫îËØ•Â¶Ç‰ΩïÂá∫Áé∞Âú®ÂèÇËÄÉÈ°µÈù¢ÁöÑÊèèËø∞Âå∫Âüü‰∏≠Ôºü‚Äù Ëøô‰∏™‰æãÂ≠êÊòæÁ§∫‰∫Ü‰∏âÁßçÂèØËÉΩÊÄß„ÄÇ\or%4
    Ê≠£Â¶Ç TeX ‰∏ç‰ºöÈöèÊú∫ËøûÂ≠óÁ¨¶ÂçïËØç‰∏ÄÊ†∑ÔºåÂÆÉ‰πü‰∏ç‰ºöÂú®ÊÆµËêΩ‰∏≠ÁöÑË°å‰πãÈó¥ÈöèÊú∫ÊâìÊñ≠Êï∞Â≠¶Ë°®ËææÂºè„ÄÇ\or%5
    TeX ‰ªÖËÄÉËôëÂú®ÂÖ≥Á≥ªÔºà‰æãÂ¶Ç = Êàñ < ÔºâÊàñ‰∫åËøõÂà∂Êìç‰ΩúÔºà‰æãÂ¶Ç + Êàñ √ó Ôºâ‰πãÂêéËøõË°å‰∏≠Êñ≠„ÄÇ\or%6
    Ê≠§ÂëΩ‰ª§Êèê‰æõÂØπÂΩìÂâçÂ≠ó‰Ωì‰∏≠ÊâÄÊúâÂ≠óÁ¨¶ÁöÑËÆøÈóÆ„ÄÇÂè∑Á†ÅÂ∫îËØ•Âú® 0 -- 255 ËåÉÂõ¥ÂÜÖ„ÄÇ\or%7
    Junkjunk.texÊñá‰ª∂‰∏çÂåÖÂê´‰ªª‰ΩïÊúâÁî®ÁöÑ‰∏úË•øÔºå‰ΩÜËøô‰∫õË°åËØ¥Êòé‰∫Ü‰∏ÄÁßçËØªÂèñËæÖÂä©Êñá‰ª∂ÁöÑÊñπÊ≥ï„ÄÇ\or%8
    Ê≠§ÂëΩ‰ª§Â∞ÜÊ°ÜÂØÑÂ≠òÂô®‰∏≠ÁöÑÂàóË°®ÂâØÊú¨Ê∑ªÂä†Âà∞ÂΩìÂâçÂàóË°®‰∏≠„ÄÇ\or%9
    ËØ∑Ê≥®ÊÑèÔºåÊØè‰∏™ÂØÑÂ≠òÂô®Âú®ÂàõÂª∫ÂêéÈÉΩ‰ºöË¢´ÂàùÂßãÂåñ„ÄÇ\or%0
    Ê≠§ÂëΩ‰ª§Êèê‰æõ‰∫Ü‰∏ÄÁßçÁõ¥Êé•ÊåáÂÆöÂàÜÈöîÁ¨¶ÁöÑÊñπÊ≥ï„ÄÇ\or%1
    Êï∞Â≠óÂ∫îËØ•ÊòØ‰∏É‰∏™ÂçÅÂÖ≠ËøõÂà∂Êï∞Â≠ó„ÄÇ\or%2
    ÂÆÉÁöÑÂâçÂØºÊï∞Â≠óÂøÖÈ°ªÂú® 0-7 ËåÉÂõ¥ÂÜÖ„ÄÇËØ•Êï∞Â≠óÁî®‰ΩúÁ±ªÂè∑ÔºåÂÖ∂‰ΩôÂÖ≠‰ΩçÊï∞Â≠óÁî®‰Ωú \type{\delcode} ÂÄº„ÄÇ\or%3
    Plain TeX Êúâ‰∫åÂçÅÂ§ö‰∏™ÂÆö‰πâÔºåÁ±ª‰ºº‰∫éÔºö`\type{\def\rceil{\delimiter"5265307 }}'„ÄÇ\or%4
    Ëøô‰∏™ÂÆö‰πâÊÑèÂë≥ÁùÄ \type{\rceil} Âú®ÂÆ∂Â∫≠5ÔºàÂÖ≥Èó≠ÔºâÔºåÂÖ∂Â∞èÂΩ¢ÂºèÂú®ÂÆ∂Â∫≠2‰ΩçÁΩÆ"65ÔºåÂÖ∂Â§ßÂΩ¢ÂºèÂú®ÂÆ∂Â∫≠3‰ΩçÁΩÆ"07"„ÄÇ\or%5
    \type{\Delimiter} ÊåáÂÆö‰∫Ü‰∏Ä‰∏™Êï∞Â≠¶Á¨¶Âè∑ÔºåÂπ∂‰ª•‰∏§ÁßçÊñπÂºèÂ∑•‰Ωú„ÄÇ\or%6
    ÂΩì TeX ÂØªÊâæÂàÜÈöîÁ¨¶Êó∂Ôºà‰æãÂ¶ÇÔºåÂú® \type{\left} ‰πãÂêéÔºâÔºåÂÆÉÂøΩÁï•‰∫ÜÁ±ªÊï∞Â≠óÔºåÂπ∂‰ΩøÁî®Ââ©‰ΩôÁöÑÂÖ≠‰ΩçÊï∞Â≠ó‰Ωú‰∏∫ \type{\delcode}„ÄÇ\or%7
    ‰ΩÜÊòØÔºåÂΩìÂàÜÈöîÁ¨¶Âú®ÂÖ∂‰ªñ‰∏ä‰∏ãÊñá‰∏≠Âá∫Áé∞Êó∂ÔºåÂè≥‰∏â‰ΩçÊï∞Â≠óË¢´Âà†Èô§ÔºåÂÖ∂‰ΩôÂõõ‰ΩçÊï∞Â≠óÊàê‰∏∫Á¨¶Âè∑ÁöÑ \type{\mathcode}„ÄÇ\or%8
    ÂØπ‰∫é \type{\rceil}ÔºåËøôÊÑèÂë≥ÁùÄ \type{\delcode} ÊòØ"265307Ôºå\type{\mathcode} ÊòØ"5265"„ÄÇ\or%9
    ÂÆÉÈ¶ñÂÖàËÆ°ÁÆóÂ≠êÂÖ¨ÂºèÂú®ËΩ¥‰∏äÊñπÂíå‰∏ãÂª∂‰º∏ÁöÑË∑ùÁ¶ª„ÄÇÊé•‰∏ãÊù•ÔºåÂÆÉ‰Ωø y Á≠â‰∫éÂàöÂàöËÆ°ÁÆóÁöÑÊúÄÂ§ßË∑ùÁ¶ªÁöÑ‰∏§ÂÄç„ÄÇ\fi}

\def\shorttesttxt[#1]{%%1. \shorttesttxt[i]
  \ifcase\csname nn_#1\endcsname%
    ÊÇ¨ÊåÇÂéãÁóïÁöÑÊï∞Èáè\or%0
    ÊÆµËêΩ‰∏≠Ê≠£Á∫øÁöÑÂÆΩÂ∫¶\or%1
    ÂºÄÂßã‰∏Ä‰∏™Ê≤°ÊúâÁº©ËøõÁöÑÊñ∞ÊÆµËêΩ\or%2
    ÂëäËØâTeXÂ∞ùËØïÂ¢ûÂä†ÊàñÂáèÂ∞ëÊÆµËêΩ‰∏≠ÁöÑË°åÊï∞\or%3
    Êâ©Â±ï‰ª§ÁâåÔºå‰ΩÜÂú®Âà∞ËææÈùûÁ©∫Èó¥‰ª§Áâå‰πãÂâç‰ªÄ‰πàÈÉΩ‰∏çÂÅö\or%4
    Âè™ÊúâÂΩì‰∏ªÂûÇÁõ¥ÂàóË°®‰∏∫Á©∫Êó∂ÔºåÂÆÉÊâç‰ºöÁªìÊùüÂΩìÂâçÂ∑•‰Ωú\or%5
    ËØ•ÂëΩ‰ª§Âú®ÂÜÖÈÉ®ÂûÇÁõ¥Ê®°Âºè‰∏ãÊòØ‰∏çÂÖÅËÆ∏ÁöÑ\or%6
    ‰ªªÊÑè‰∏≠Êñ≠Áî±‰∏â‰∏™Â≠óÁ¨¶Â∫èÂàóÁªÑÊàê\or%7
    Âè¶‰∏Ä‰∏™Êó†ÊïàÂè∑Á†ÅË¢´‰º†ÈÄí‰∫Ü\or%8
    Êù•Ëá™ÂÅáÈÉ®ÂàÜÁöÑÊù°‰ª∂ÂëΩ‰ª§\or%9
    Á∫øË∑ØÈúÄË¶ÅËΩ¨ÁßªÁöÑÈáëÈ¢ù\or%0
    Áî®‰∫éÊåáÂÆöÊòæÁ§∫Ê†∑Âºè\or%1
    ÂÖ≥Á≥ªÂêéÊñ≠Á∫øÁöÑÊÉ©ÁΩö\or%2
    Ê≠§ÂëΩ‰ª§ÂÆö‰πâ‰∫ÜÂÆè\or%3
    ÂÆ∂Â∫≠ÁöÑËÑöÊú¨Â≠ó‰Ωì\or%4
    Â∞∫ÂØ∏Ê≤°ÊúâÂèòÂåñ\or%5
    È¢ùÂ§ñÁöÑÁ©∫Èó¥\or%6
    Â∑¶ËæπÁöÑÊÆµËêΩ\or%7
    ÂΩìÂâçÁ∫øÂÆΩ\or%8
    ÊñáÊú¨Ê†∑Âºè\or%9
    Â∫èÂàó\fi}

\tolerant\protected\def\choicenum[#1][#2][#3]{
  \ifnum\csname nn_#1\endcsname < 6
    \expandafter\startcitem[*]{\shorttesttxt[\romannumeral #2]} \stopcitem
  \else
    \expandafter\startcitem   {\shorttesttxt[\romannumeral #3]} \stopcitem
  \fi
}

\newcount\LNUM\LNUM=1\relax
\newcount\CNUM\CNUM=1\relax
\newcount\DNUM\DNUM=1\relax
\newcount\ENUM\ENUM=2\relax

\protected\def\example@choice#1{
    \setupquestion[point=2]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax\global\advance\DNUM by 2\relax\global\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax\advance\DNUM by 1\relax\advance\ENUM by 2\relax
            \stopchoice
            % \startanswer
            % \input knuthmath
            % \stopanswer
    \stopquestion}
}
\def\example@fillin#1{
    \setuppitem   [point=3]
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem
          \longtesttxt[\romannumeral\CNUM]\fillin[]{\fillinanswer}
        \stoppitem
        % \startanswer
        %       \input knuthmath
        %     \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@pitem#1{
    \startquestion
      \longtesttxt[\romannumeral\LNUM]
      \def\fillinanswer{\shorttesttxt[\romannumeral\CNUM]}
      \startproblem
      \dorecurse{#1}{
        \startpitem[answer={answer : \recurselevel},point={\number\CNUM}]
        \longtesttxt[\romannumeral\CNUM]\stoppitem
        % \startanswer
        %       \input knuthmath
        % \stopanswer
        \global\advance\CNUM by 1\relax}
      \stopproblem
      \stopquestion
}
\def\example@material#1{
    \startmaterial
    \input knuthmath
    \stopmaterial
    \setupquestion[point=6]
    \dorecurse{#1}{
      \startquestion
      \longtesttxt[\romannumeral\LNUM]\global\advance\LNUM by 1\relax
            \startchoice
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \global\advance\CNUM by 1\relax%
            \global\advance\DNUM by 2\relax%
            \global\advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \choicenum[\romannumeral\CNUM][\the\DNUM][\the\ENUM]
            \advance\CNUM by 1\relax%
            \advance\DNUM by 1\relax%
            \advance\ENUM by 2\relax%
            \stopchoice
            % \startanswer
            %   \input knuthmath
            % \stopanswer
    \stopquestion}
}
\def\example@close#1{
    \startclose
    \def\closechoicex{\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\closechoice[\closechoicex,{[*]\closechoicex},\closechoicex]
      \longtesttxt[\romannumeral\CNUM]}
    \stopclose
}

\def\example@optclose#1{
    \startoptclose
    \def\closechoicex{{\ss\shorttesttxt[\romannumeral\DNUM]\global\advance\DNUM by 1\relax}}
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\ocitem[point=4,answer={\shorttesttxt[\romannumeral\DNUM]}]{\closechoicex,\closechoicex,\closechoicex}
      \longtesttxt[\romannumeral\CNUM]}
    \stopoptclose
}

\def\example@specialoptclose#1{
    \dorecurse{#1}{
        \dorecurse{3}{
          \longtesttxt[\romannumeral\CNUM]
        \global\advance\CNUM by 1\relax
        }\specialocitem[point=2,answer={\shorttesttxt[\romannumeral\DNUM]}]
        \global\advance\DNUM by 1\relax
      \longtesttxt[\romannumeral\CNUM]}
}

%\setupanswer[showanswer=true,showscript=true,
%              frame=on,framecolor=red,
%              rulethickness=2pt,
%              scriptcontent={\null\vbox to 4\baselineskip{}\relax}]
%\chapter{}
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%%
%\chapter{}
%
%\section{1}\example@choice{5}
%\section{2}\example@fillin{5}
%\section{3}\example@pitem{5}
%\section{4}\example@material{5}
%\section{5}\example@close{5}
%\section{6}\example@optclose{5}
%\section{7}\example@specialoptclose{5}
%\page
%\dorecurse{30}{\typeanswerbychap{1}\par}
%\resetanswerid%
%\dorecurse{30}{\typeanswerbychap{2}\par}
%\resetanswerid
%\noindent\typeanswerlist[1][6]{30}
%\resetanswerid
%\noindent\typeanswerlist[2][6]{30}
%\type@answer@i[6*5,1,28]

\newcount\qid_in_chap\qid_in_chap=1\relax
\def\resetanswerid{\qid_in_chap=1\relax}
\def\typeanswerbychap{\dosingleempty\typeanswerbychap_indeed}
\def\typeanswerbychap_indeed[#1]#2{% #1 = chapter numberÔºåË©≤ÂëΩ‰ª§ÊúÉËá™Ë°åÈÅûÂ¢ûË®àÊï∏Âô®‰æÜÁç≤ÂèñÁ≠îÊ°à
  \iffirstargument\qid_in_chap=#1\relax\fi%
  \datasetvariable{Answer_collector}{#2-\the\qid_in_chap}{answer}%
  \advance\qid_in_chap by 1\relax}
\def\typeanswerdirect#1{% #1 = qidÔºåÈúÄË¶ÅËá™Ë°åËº∏ÂÖ•‰æÜÁç≤ÂèñÊüêÂÄãÈ°åÁõÆÁöÑÁ≠îÊ°à
  \datasetvariable{Answer_collector}{#1}{answer}}
\def\typeanswerlist{\dodoubleempty\typeanswerlist_indeed}
\def\typeanswerlist_indeed[#1][#2]#3{%#1 = chapter number
  \ifsecondargument\qid_in_chap=#2\fi% #2 = from which question to start
  \dorecurse{#3}{% answer amount
    \datasetvariable{Answer_collector}{#1-\the\qid_in_chap}{answer}%
  \advance\qid_in_chap by 1\relax}
}

\newcount\answer@seq@tempa\answer@seq@tempa=0\relax%
\newcount\answer@seq@tempb\answer@seq@tempb=0\relax%
\newcount\answer@seq@tempc
\def\type@answer@i[#1*#2,#3,#4]{% #1 for row #2 for column %
                                % #3 chapter number #4 last answer id%
  \answer@seq@tempc=\numexpr#4-1\relax%
    \bTABLE
      \dorecurse{#1}{\bTR
        \dorecurse{#2}{%
        \ifnum\answer@seq@tempa>\answer@seq@tempc \bTD\eTD\relax\else%
              \advance\answer@seq@tempa by 1\relax%
                \expanded{\bTD
                  \datasetvariable{Answer_collector}{#3-\the\answer@seq@tempa}{userorder}
      \eTD}\fi}
      \eTR\bTR
        \dorecurse{#2}{%
          \ifnum\answer@seq@tempb>\answer@seq@tempc \bTD\eTD\relax\else%
        \advance\answer@seq@tempb by 1\relax%
            \expanded{\bTD
            \datasetvariable{Answer_collector}{#3-\the\answer@seq@tempb}{answer}
        \eTD}\fi}
      \eTR}
    \eTABLE
}

\def\type@answer@ii{
\answer_seq=0\relax
\bTABLE
\dorecurse{4}{\bTR
  \dorecurse{5}{
        \advance\answer_seq by 1\relax%
            \expanded{\bTD\the\answer_seq\eTD}
      \expanded{\bTD
        \datasetvariable{Answer_collector}{\the\answer_seq}{answer}
    \eTD}}
\eTR}
\eTABLE}
%\type@answer@i{4}{5}{18}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%D \section{Ê®°ÂºèË®≠ÁΩÆ}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\definemode[teacher][keep]
\definemode[student][keep]
\definemode[check]  [keep]
\startmode[teacher]
  \mode_showanswertrue
  \mode_showpointtrue
  % \setupquestion[showanswer=true,showpoint=true]
  % \setupchoice  [showanswer=true,showpoint=true]
  % \setupcitem   [showanswer=true,showpoint=true]
  % \setuppitem   [showanswer=true,showpoint=true]
  % \setupclose   [showanswer=true,showpoint=true]
  % \setupocitem  [showanswer=true,showpoint=true]
  % \setupanswer  [showanswer=true,showpoint=true,showscript=false]
\stopmode
\startmode[student]
  \mode_showanswerfalse
  \mode_showpointfalse
  % \setupquestion[showanswer=false,showpoint=true]
  % \setupchoice  [showanswer=false,showpoint=true]
  % \setupcitem   [showanswer=false,showpoint=true]
  % \setuppitem   [showanswer=false,showpoint=true]
  % \setupclose   [showanswer=false,showpoint=true]
  % \setupocitem  [showanswer=false,showpoint=true]
  % \setupanswer  [showanswer=false,showpoint=true,showscript=false]
\stopmode
\startmode[check]
  \mode_checktrue
\stopmode
\def\showanswer{\mode_showanswertrue\setupanswer[showscript=false]}
\def\hideanswer{\mode_showanswerfalse\setupanswer[showscript=true]}
\let\showpoint\mode_showpointtrue
\let\hidepoint\mode_showanswerfalse
\let\showchekinfo\mode_checktrue
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%   EXAM MODULE   %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\protect
\stopmodule
\endinput